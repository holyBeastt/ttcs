<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Học Viện Kỹ Thuật Mật Mã</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" />
  <link rel="stylesheet" href="/css/styles.css" />
  <link rel="stylesheet" href="/css/gvmList.css" />
  <link rel="stylesheet" href="/css/table.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css" />
  <!-- SweetAlert2 CSS -->
  <link href="https://cdn.jsdelivr.net/npm/sweetalert2@11.6.16/dist/sweetalert2.min.css" rel="stylesheet" />
  <!-- SweetAlert2 JavaScript -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.6.16/dist/sweetalert2.all.min.js"></script>
  <!-- Note: Removed docx-preview library as we now use PDF preview -->

  <style>
    .teacher-group {
      border: 2px solid black;
      border-collapse: separate;
      margin-bottom: 10px;
    }

    .teacher-group td,
    .teacher-group th {
      padding: 8px;
      text-align: left;
      border: 2px solid black;
    }

    .total-label {
      margin-left: auto;
      margin-right: 0;
      font-family: Arial, sans-serif;
      font-size: 16px;
      background-color: #f4f4f4;
      padding: 10px;
      border-radius: 8px;
      width: fit-content;
      display: block;
    }

    .total-label label {
      font-weight: bold;
      color: #000;
      margin-right: 8px;
      cursor: pointer;
      padding: 5px 10px;
      border: 1px solid #ccc;
      border-radius: 4px;
    }

    .total-label label,
    .total-label label span {
      background-color: #007bff;
      color: #fff;
    }

    .total-label span {
      font-weight: bold;
      color: #333;
    }

    .btn {
      height: 45px !important;
    }

    #saveDataDoAn {
      white-space: nowrap;
      font-size: 14px;
    }

    .alert-sotiet {
      background-color: #ffcccc !important;
    }

    .table {
      border-collapse: collapse;
      width: 100%;
    }

    .table th,
    .table td {
      border: 1px solid #ccc;
      padding: 6px;
      text-align: center;
      font-size: 12px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 120px;
    }

    .table th {
      font-size: 11px;
      font-weight: 600;
      background-color: #343a40 !important;
    }

    .table .wide-col {
      max-width: 120px;
    }

    .table .narrow-col {
      max-width: 60px;
    }

    .table .name-col {
      max-width: 250px !important;
      min-width: 200px !important;
      width: 250px !important;
      word-wrap: break-word;
      white-space: normal;
    }

    .table .action-col {
      min-width: 320px;
      width: 320px;
      white-space: normal;
    }

    .btn-sm {
      padding: 2px 6px;
      font-size: 10px;
    }

    .container-fluid {
      padding: 0 !important;
    }

    .table-responsive {
      font-size: 12px;
      margin-left: 15px;
      /* Add left margin to tables */
      margin-right: 15px;
      /* Add right margin to tables */
    }

    .over-f {
      overflow-x: auto;
      max-width: none;
      margin-left: 15px;
      /* Add left margin to tables */
      margin-right: 15px;
      /* Add right margin to tables */
    }

    .table-dark th {
      background-color: #343a40;
      color: white;
    }

    .d_none {
      display: none;
    }

    /* Modal fixes to ensure proper closing behavior */
    .modal-backdrop {
      z-index: 1040;
    }

    .modal {
      z-index: 1050;
    }

    .total-label .row {
      margin: 0;
    }

    .total-label .col-md-3 {
      padding: 5px;
      font-weight: bold;
      color: white;
      text-align: center;
    }

    .modal.fade .modal-dialog {
      transition: transform 0.3s ease-out;
    }

    /* Center modal properly */
    .modal-dialog {
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: calc(100vh - 1rem);
      margin: 0.5rem auto;
    }

    .modal-dialog.modal-xl {
      max-width: 1600px;
      width: 90%;
    }

    /* Ensure modal content is properly centered */
    .modal-content {
      width: 100%;
      margin: 0 auto;
    }

    /* Simple Dropdown menu styles */
    .dropdown-menu {
      z-index: 1050;
      min-width: 180px;
      border: 1px solid #dee2e6;
      border-radius: 4px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      background-color: #ffffff;
    }

    .dropdown-item {
      cursor: pointer;
      padding: 8px 12px;
    }

    .dropdown-item:hover {
      background-color: #007bff;
      color: white;
    }

    .dropdown-item.active {
      background-color: #28a745;
      color: white;
      font-weight: 600;
    }

    .btn-group .dropdown-toggle {
      height: 45px;
      border-radius: 4px;
    }

    /* Simple button styles for approve and save buttons */
    #approveContractBtn {
      background-color: #007bff;
      border: 1px solid #007bff;
      border-radius: 4px;
      color: white;
    }

    #approveContractBtn:hover {
      background-color: #0056b3;
      border-color: #004085;
    }

    .btn-warning-custom {
      background-color: #ffc107;
      border: 1px solid #ffc107;
      border-radius: 4px;
      color: #212529;
    }

    .btn-warning-custom:hover {
      background-color: #e0a800;
      border-color: #d39e00;
    }


    #saveDataDoAn {
      border-radius: 4px;
      background-color: #007bff;
      border: 1px solid #007bff;
      color: white;
    }

    #saveDataDoAn:hover {
      background-color: #0056b3;
      border-color: #004085;
    }

    /* Contract Save Status Styles */
    .card-body .card-title {
      margin-bottom: 10px;
      font-weight: 600;
    }

    #contractSaveStatus {
      font-size: 14px;
      font-weight: 600;
      display: inline-block;
      color: #333;
    }

    #checkContractStatusBtn {
      height: 38px;
      border-radius: 4px;
    }

    #checkContractStatusBtn:hover {
      background-color: #0056b3;
      border-color: #004085;
    }

    /* Contract status cell styling */
    .contract-status-cell {
      text-align: center;
      vertical-align: middle;
      padding-left: 8px !important;
      /* Add left padding for status text */
    }

    /* TC duyệt cell styling - match contract status cells */
    .contract-tcduyet-cell {
      text-align: center;
      vertical-align: middle;
      padding-left: 8px !important;
      /* Add left padding for status text */
    }

    /* Column width styling */
    .status-col {
      width: 100px;
      min-width: 100px;
    }

    .status-col2 {
      width: 100px;
      min-width: 100px;
    }

    /* Training Program Group Styles */
    .training-program-group {
      margin-bottom: 30px;
      border: 1px solid #dee2e6;
      border-radius: 8px;
      overflow: hidden;
      margin-left: 15px;
      margin-right: 15px;
    }

    .training-program-header {
      background: linear-gradient(135deg, #007bff, #0056b3);
      color: white;
      padding: 15px 20px;
      font-size: 18px;
      font-weight: 600;
    }

    .training-program-summary {
      background-color: #f8f9fa;
      padding: 15px 20px;
      border-bottom: 1px solid #dee2e6;
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
    }

    .training-program-summary .summary-item {
      display: flex;
      align-items: center;
      gap: 5px;
    }

    .training-program-summary .summary-value {
      font-weight: 600;
      color: #007bff;
    }

    .training-program-table {
      padding: 0;
    }

    .training-program-table .table-responsive {
      margin: 0;
    }

    .training-program-table .over-f {
      margin: 0;
    }

    /* Status cell styling for heDaoTao view */
    .contract-status-cell-hedaotao,
    .contract-tcduyet-cell-hedaotao {
      text-align: center;
      vertical-align: middle;
      padding-left: 8px !important;
    }
  </style>

</head>

<body>
  <!-- Phần header -->
  <%- include('header') %>

    <!-- Phần nội dung -->

    <div class="container-fluid">
      <!-- Main content -->
      <div class="gvmList hd_du_kien_css">
        <div class="m-3 reCss">
          <h1>TÀI CHÍNH - DUYỆT HỢP ĐỒNG - ĐỒ ÁN</h1>

          <div class="controls-container" style="width: 100%">
            <select class="form-select w-100px mx-2 selectop" id="combobox-dot">
              <option value="">Đợt</option>
            </select>

            <select class="form-select mx-2 selectop" id="comboboxki">
              <option value="">Kỳ</option>
            </select>

            <select class="form-select mx-2 selectop" style="width: max-content" id="NamHoc">
              <option value="">Năm học</option>
            </select>

            <select class="form-select mx-1 selectop" style="width: max-content" id="MaPhongBan">
              <option value="">Tất cả khoa</option>
            </select>

            <select class="form-select mx-1 selectop" id="loaiHopDong">
              <option value="Đồ án">Đồ án</option>
            </select>

            <div class="btn-group">
              <button type="button" class="btn btn-primary dropdown-toggle" data-bs-toggle="dropdown"
                aria-expanded="false">
                Hiển thị
              </button>
              <ul class="dropdown-menu">
                <li><a class="dropdown-item" href="#" id="viewDataByTeacher">Theo giảng viên</a></li>
                <li><a class="dropdown-item" href="#" id="viewDataByHeDaoTao">Theo hệ đào tạo</a></li>
              </ul>
            </div>
          </div>

          <div id="control" class="controls-container d-flex justify-content-between align-items-center">
            <input type="text" id="searchGiangVien" placeholder="Tìm theo tên giảng viên" class="form-control search"
              style="width: 300px" />
            <div class="d-flex gap-2">
              <button id="approveContractBtn" class="btn btn-success" style="display: none;">
                Duyệt hợp đồng
              </button>
              <button id="unapproveContractBtn" class="btn btn-warning-custom" style="display: none;">
                Bỏ duyệt hợp đồng
              </button>
              <button id="saveDataDoAn" class="btn btn-info" style="display: none; height: 45px;">
                Lưu dữ liệu hợp đồng đồ án
              </button>
              <button id="unsaveDataDoAn" class="btn btn-warning-custom" style="display: none;">
                Bỏ lưu dữ liệu hợp đồng đồ án
              </button>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Data Table Section -->
      <div class="mt-4">
        <!-- Quota information -->
        <div style="margin-left: 20px;" id="quotaInfo"></div>
        <div id="resultsDiv" style="display: none;">
          <!-- Teacher Summary Table -->
          <div class="mb-4">
            <div class="table-responsive">
              <div class="over-f">
                <table class="table table-striped table-hover table-bordered" id="summaryTable">
                  <thead class="table-dark">
                    <tr>
                      <th class="narrow-col">STT</th>
                      <th class="narrow-col">Danh xưng</th>
                      <th class="name-col">Họ tên</th>
                      <th class="wide-col">Khoa</th>
                      <th class="narrow-col">Học hàm, học vị</th>
                      <th class="wide-col">Tiền/Tiết</th>
                      <th class="narrow-col">Số tiết</th>
                      <th class="wide-col">Số tiền</th>
                      <th class="narrow-col">Trừ thuế</th>
                      <th class="wide-col">Thực nhận</th>
                      <th class="status-col2">TC Duyệt</th>
                      <th class="status-col">Trạng thái</th>
                      <th class="action-col" id="action-header-1">Thao tác</th>
                    </tr>
                  </thead>
                  <tbody id="summaryTableBody">
                  </tbody>
                </table>
              </div>
            </div>
          </div> <!-- Label tổng số tiết và tổng tiền tách riêng với bảng -->
          <div class="total-label">
            <label><span class="value" id="totalQC"></span></label>
          </div>
        </div>

        <!-- Training Program Results Table - Detailed View -->
        <div id="heDaoTaoResultsDiv" style="display: none;">
          <div class="mb-4">
            <br>
            <!-- Container for grouped data by training programs -->
            <div id="heDaoTaoGroupedContainer">
              <!-- Training program groups will be generated by JavaScript -->
            </div>
          </div>
          <!-- Label tổng số tiết và tổng tiền cho hệ đào tạo -->
          <div class="total-label">
            <label><span class="value" id="totalHeDaoTao"></span></label>
          </div>
        </div>

        <!-- No data message -->
        <div id="noDataMessage" class="text-center py-4" style="display: block;">
          <h5 class="text-muted">Vui lòng chọn điều kiện lọc và nhấn "Xem dữ liệu" để hiển thị danh sách hợp đồng
          </h5>
        </div>

        <!-- Loading spinner -->
        <div id="loadingSpinner" class="text-center py-4" style="display: none;">
          <div class="spinner-border" role="status">
            <span class="visually-hidden">Loading...</span>
          </div>
          <p class="mt-2">Đang tải dữ liệu...</p>
        </div>
      </div>
    </div>
    </div>
    </div> <!-- Detail Modal -->
    <div class="modal fade" id="detailModal" tabindex="-1" aria-labelledby="detailModalLabel" aria-hidden="true"
      data-bs-backdrop="true" data-bs-keyboard="true">
      <div class="modal-dialog modal-fullscreen">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="detailModalLabel">Thông tin chi tiết giảng viên</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <!-- Personal Information -->
            <div class="mb-4">
              <h6 class="text-primary border-bottom pb-2">Thông tin cá nhân</h6>
              <div class="row">
                <div class="col-md-6">
                  <p><strong>Họ tên:</strong> <span id="modal-hoten"></span></p>
                  <p><strong>Ngày sinh:</strong> <span id="modal-ngaysinh"></span></p>
                  <p><strong>CCCD:</strong> <span id="modal-cccd"></span></p>
                  <p><strong>Nơi cấp CCCD:</strong> <span id="modal-noicapcccd"></span></p>
                  <p><strong>Ngày cấp CCCD:</strong> <span id="modal-ngaycap"></span></p>
                </div>
                <div class="col-md-6">
                  <p><strong>Học hàm/Học vị:</strong> <span id="modal-hocvi"></span></p>
                  <p><strong>Chức vụ:</strong> <span id="modal-chucvu"></span></p>
                  <p><strong>Điện thoại:</strong> <span id="modal-dienthoai"></span></p>
                  <p><strong>Email:</strong> <span id="modal-email"></span></p>
                </div>
              </div>
            </div>

            <!-- Financial Information -->
            <div class="mb-4">
              <h6 class="text-primary border-bottom pb-2">Thông tin tài chính</h6>
              <div class="row">
                <div class="col-md-6">
                  <p><strong>Số tiền:</strong> <span id="modal-thanhtien"></span></p>
                  <p><strong>Thuế 10%:</strong> <span id="modal-thue"></span></p>
                  <p><strong>Thực nhận:</strong> <span id="modal-thucnhan"></span></p>
                </div>
                <div class="col-md-6">
                  <p><strong>Số tài khoản:</strong> <span id="modal-stk"></span></p>
                  <p><strong>Ngân hàng:</strong> <span id="modal-nganhang"></span></p>
                  <p><strong>Mã số thuế:</strong> <span id="modal-masothue"></span></p>
                </div>
              </div>
            </div>

            <!-- Additional Information -->
            <div class="mb-4">
              <h6 class="text-primary border-bottom pb-2">Thông tin bổ sung</h6>
              <div class="row">
                <div class="col-md-6">
                  <p><strong>Ngày ký HĐ:</strong> <span id="modal-ngayky"></span></p>
                  <p><strong>Ngày thanh lý HĐ:</strong> <span id="modal-ngaythanhly"></span></p>
                  <p><strong>Địa chỉ:</strong> <span id="modal-diachi"></span></p>
                </div>
                <div class="col-md-6">
                  <p><strong>Nơi công tác:</strong> <span id="modal-noicongtac"></span></p>
                  <p><strong>Bộ môn:</strong> <span id="modal-bomon"></span></p>
                  <p><strong>Thuộc khoa:</strong> <span id="modal-khoa"></span></p>
                </div>
              </div>
            </div>

            <!-- Contract Information -->
            <div class="mb-4">
              <h6 class="text-primary border-bottom pb-2">Thông tin hợp đồng</h6>
              <div class="row">
                <div class="col-md-6">
                  <p><strong>Trạng thái HĐ:</strong> <span id="modal-trangthai"></span></p>
                  <p><strong>Số hợp đồng:</strong> <span id="modal-sohopdong"></span></p>
                </div>
                <div class="col-md-6">
                  <p><strong>Tổng số tiết:</strong> <span id="modal-tongtiet"></span></p>
                  <p><strong>Loại hợp đồng:</strong> <span id="modal-loaihopdong"></span></p>
                </div>
              </div>
            </div>

            <!-- Additional dynamic content for training program breakdown -->
            <div id="modal-content-additional">
              <!-- Training program breakdown will be inserted here dynamically -->
            </div>
          </div>
          <!-- <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
            <button type="button" class="btn btn-success" id="modal-preview-contract">
              Xem trước HĐ
            </button>
            <button type="button" class="btn btn-info" id="modal-view-contract" style="display: none;">
              Xem hợp đồng
            </button>
            <button type="button" class="btn btn-warning" id="modal-edit-contract" style="display: none;">
              Sửa hợp đồng
            </button>
          </div> -->
        </div>
      </div>
    </div>

    <!-- Success/Error Messages -->
    <div class="toast-container position-fixed bottom-0 end-0 p-3">
      <div id="successToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="toast-header bg-success text-white">
          <strong class="me-auto">Thành công</strong>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast"></button>
        </div>
        <div class="toast-body" id="successMessage"></div>
      </div>

      <div id="errorToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="toast-header bg-danger text-white">
          <strong class="me-auto">Lỗi</strong>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast"></button>
        </div>
        <div class="toast-body" id="errorMessage"></div>
      </div>
    </div>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/bootstrap/dist/js/jquery-3.7.1.min.js"></script>
    <script src="/bootstrap/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Hỗ trợ site duyệt hợp đồng đồ án -->
    <script src="/js/duyethopdongdoan/tien-ich.js"></script>
    
    <!-- Phân role hiển thị -->
    <script src="/js/duyethopdongdoan/phan-quyen.js"></script>
    
    <!-- Check duyệt -->
    <script src="/js/duyethopdongdoan/trang-thai.js"></script>
    
    <!-- Modal xem chi tiết -->
    <script src="/js/duyethopdongdoan/chi-tiet-modal.js"></script>
    
    <!-- Render bảng sau khi tải -->
    <script src="/js/duyethopdongdoan/hien-thi-bang.js"></script>
    <script src="/js/duyethopdongdoan/hien-thi-bang-2.js"></script>
    
    <!-- Lọc tìm kiếm -->
    <script src="/js/duyethopdongdoan/loc-tim-kiem.js"></script>
    
    <!-- Tải data bảng -->
    <script src="/js/duyethopdongdoan/tai-du-lieu.js"></script>
    
    <!-- Duyệt, lưu, xem trước hợp đồng -->
    <script src="/js/duyethopdongdoan/duyet-hop-dong.js"></script>
    <script src="/js/duyethopdongdoan/luu-du-lieu.js"></script>
    <script src="/js/duyethopdongdoan/xem-truoc-hop-dong.js"></script>
    
    <!-- Tạo các event listener - load cuối cùng -->
    <script src="/js/duyethopdongdoan/khoi-tao.js"></script>
    

    <script src="/js/moigiang/href.js"></script>
    <script src="/js/moigiang/getdata.js"></script>
    <script src="/js/moigiang/hideBtn.js"></script>
</body>

</html>
