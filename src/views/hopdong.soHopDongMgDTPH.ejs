<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Học Viện Kỹ Thuật Mật Mã - Phân hiệu học viện</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" />
  <link rel="stylesheet" href="/css/styles.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css" />

  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <!-- SweetAlert2 CSS -->
  <link href="https://cdn.jsdelivr.net/npm/sweetalert2@11.6.16/dist/sweetalert2.min.css" rel="stylesheet" />
  <!-- SweetAlert2 JavaScript -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.6.16/dist/sweetalert2.all.min.js"></script>

  <style>
    .loc {
      align-items: center;
      gap: 8px;
    }

    .selectop {
      height: 38px;
      vertical-align: middle;
      border: 1px solid #ced4da;
      border-radius: 0.375rem;
      padding: 0.375rem 0.75rem;
      font-size: 1rem;
      background-color: #fff;
      color: #495057;
      text-align: left;
      box-sizing: border-box;
    }

    .selectop:hover {
      border-color: #adb5bd;
    }

    .selectop:focus {
      border-color: #86b7fe;
      box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
      outline: 0;
    }

    /* Khoa display styling */
    .khoa-display {
      height: 38px;
      display: flex;
      align-items: center;
      padding: 0.375rem 0.75rem;
      background-color: #e3f2fd;
      border: 2px solid #1976d2;
      border-radius: 0.375rem;
      font-weight: 600;
      color: #1976d2;
      min-width: 120px;
    }

    /* Styling cho dropdown hệ đào tạo */
    button.selectop.dropdown-toggle {
      display: flex !important;
      align-items: center !important;
      justify-content: space-between !important;
      width: 100% !important;
      height: 38px !important;
      padding: 0.375rem 0.75rem !important;
      font-size: 1rem !important;
      font-weight: 400 !important;
      line-height: 1.5 !important;
      text-align: left !important;
      background-image: none !important;
      background-color: #fff !important;
      border: 1px solid #ced4da !important;
      border-radius: 0.375rem !important;
      color: #495057 !important;
      box-shadow: none !important;
      transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out !important;
    }

    button.selectop.dropdown-toggle:hover {
      background-color: #fff !important;
      border-color: #adb5bd !important;
      color: #495057 !important;
      box-shadow: none !important;
    }

    button.selectop.dropdown-toggle:focus,
    button.selectop.dropdown-toggle:active,
    button.selectop.dropdown-toggle.show {
      background-color: #fff !important;
      border-color: #86b7fe !important;
      color: #495057 !important;
      box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25) !important;
      outline: 0 !important;
    }

    button.selectop.dropdown-toggle::after {
      border-top: 0.3em solid #495057 !important;
      border-right: 0.3em solid transparent !important;
      border-bottom: 0 !important;
      border-left: 0.3em solid transparent !important;
      margin-left: auto !important;
      vertical-align: 0 !important;
      content: "" !important;
    }

    .dropdown button.selectop {
      width: 100% !important;
      display: flex !important;
      align-items: center !important;
      justify-content: space-between !important;
      box-sizing: border-box !important;
    }

    .dropdown button.selectop::after {
      margin-left: auto !important;
    }

    .btn {
      vertical-align: middle;
    }

    #view {
      margin-top: 15px;
    }

    /* CSS cho multi-select checkbox dropdown cho hệ đào tạo */
    .checkbox-dropdown {
      max-height: 250px;
      overflow-y: auto;
      padding: 0;
      min-width: 200px;
    }
    
    .checkbox-dropdown .dropdown-item {
      padding: 8px 16px;
      cursor: pointer;
      display: flex;
      align-items: center;
    }
    
    .checkbox-dropdown .dropdown-item:hover {
      background-color: #f8f9fa;
    }
    
    .checkbox-dropdown input[type="checkbox"] {
      margin-right: 8px;
    }
    
    .selected-items {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      z-index: 10;
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
      margin-top: 2px;
      max-height: 60px;
      overflow-y: auto;
      padding: 4px;
      border-radius: 4px;
      background-color: #fff;
      border: 1px solid #dee2e6;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      transition: all 0.2s ease;
    }
    
    .selected-items:empty {
      display: none;
    }
    
    .dropdown {
      position: relative !important;
    }
    
    .selected-tag {
      background: #0d6efd;
      color: white;
      padding: 3px 8px;
      border-radius: 8px;
      font-size: 12px;
      display: flex;
      align-items: center;
      gap: 4px;
      white-space: nowrap;
      max-width: 140px;
      overflow: hidden;
      text-overflow: ellipsis;
      flex-shrink: 0;
    }
    
    .remove-tag {
      cursor: pointer;
      font-weight: bold;
      font-size: 12px;
      line-height: 1;
      padding: 0 2px;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.3);
      transition: background-color 0.2s ease;
    }
    
    .remove-tag:hover {
      background: rgba(255, 255, 255, 0.5);
    }
    
    /* Scrollbar styling for selected items */
    .selected-items::-webkit-scrollbar {
      width: 4px;
      height: 4px;
    }
    
    .selected-items::-webkit-scrollbar-track {
      background: #f1f1f1;
      border-radius: 2px;
    }
    
    .selected-items::-webkit-scrollbar-thumb {
      background: #c1c1c1;
      border-radius: 2px;
    }
    
    .selected-items::-webkit-scrollbar-thumb:hover {
      background: #a8a8a8;
    }
  </style>
</head>

<body>
  <!-- Phần header -->
  <%- include('header') %>

    <div class="container-fluid my-4" style="padding-left: 20px">
      <div class="flex-grow-1">

        <div class="header-actions">
          <div class="right" style="margin-top: 0px">
            <div class="loc d-flex align-items-center">
              <select class="selectop" id="combobox-dot" style="width: 70px">
                <option value="">Đợt</option>
              </select>
              <select class="selectop" id="comboboxki" style="width: 70px">
                <option value="">Kì</option>
              </select>
              <select class="selectop" id="NamHoc">
                <option value="">Chọn năm học</option>
              </select>
              
              <!-- Khoa cố định - ĐTPH -->
              <div class="khoa-display">
                <i class="fas fa-building me-2"></i>
                <strong>Khoa: ĐTPH</strong>
              </div>

              <!-- Multi-select Hệ đào tạo với checkbox -->
              <div class="dropdown" style="width: 180px;">
                <button class="selectop dropdown-toggle" 
                        type="button" 
                        id="heDropdown" 
                        data-bs-toggle="dropdown"
                        style="width: 100%;">
                  <span id="heButtonText">Hệ đào tạo</span>
                </button>
                <div class="dropdown-menu checkbox-dropdown w-100" id="heCheckboxMenu">
                  <label class="dropdown-item">
                    <input type="checkbox" value="ALL" id="selectAllHe" /> 
                    <strong>Tất cả hệ</strong>
                  </label>
                  <div class="dropdown-divider"></div>
                  <label class="dropdown-item">
                    <input type="checkbox" value="Đại học (Đóng học phí)" /> Hệ đóng học phí
                  </label>
                  <label class="dropdown-item">
                    <input type="checkbox" value="Đại học (Mật mã)" /> Hệ mật mã
                  </label>
                  <label class="dropdown-item">
                    <input type="checkbox" value="Cao học (Đóng học phí)" /> Cao học
                  </label>
                  <label class="dropdown-item">
                    <input type="checkbox" value="Nghiên cứu sinh (Đóng học phí)" /> Nghiên cứu sinh
                  </label>
                </div>
                <div class="selected-items" id="selectedHe"></div>
              </div>

            </div>
          </div>

          <!-- Unified Setup Section -->
          <div class="content-section mt-4" id="setupOptions">
            <div class="card">
              <div class="card-header">
                <h5 class="mb-0">
                  <i class="fas fa-cog me-2"></i>Tạo số hợp đồng và số thanh lý hợp đồng - Phân hiệu học viện
                </h5>
              </div>
              <div class="card-body">

                <div class="row mb-3">
                  <div class="col-12">
                    <div class="alert alert-info">
                      <div class="mb-2">
                        <i class="fas fa-info-circle me-2"></i>
                        <strong>Định dạng số được tạo:</strong>
                      </div>
                      <div class="row">
                        <div class="col-md-6">
                          <div class="d-flex align-items-center mb-1">
                            <i class="fas fa-file-contract text-primary me-2"></i>
                            <span><strong>Số hợp đồng:</strong> <code>[Số]/[Kí hiệu HĐ]</code></span>
                          </div>
                          <small class="text-muted ms-3">Ví dụ: 001/HĐ-ĐT</small>
                        </div>
                        <div class="col-md-6">
                          <div class="d-flex align-items-center mb-1">
                            <i class="fas fa-file-times text-info me-2"></i>
                            <span><strong>Số thanh lý:</strong> <code>[Số]/[Kí hiệu TL]</code></span>
                          </div>
                          <small class="text-muted ms-3">Ví dụ: 001/HĐNT-ĐT</small>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>

                <div class="row">
                  <div class="col-md-6">
                    <div id="unifiedStartingNumberDiv" class="mt-3" style="display: block;">
                      <div class="row">
                        <div class="col-md-2">
                          <label for="unifiedStartingNumber" class="form-label">
                            <strong>Số bắt đầu</strong>
                            <span class="text-danger">*</span>
                          </label>
                          <input type="number" class="form-control" id="unifiedStartingNumber"
                            name="unifiedStartingNumber" value="1" min="1" placeholder="Nhập số bắt đầu (VD: 1)"
                            oninput="updateNumberPreview()">
                        </div>
                        <div class="col-md-2">
                          <label for="kiHieuHopDong" class="form-label">
                            <strong>Kí hiệu hợp đồng</strong>
                            <span class="text-danger">*</span>
                          </label>
                          <input type="text" class="form-control" id="kiHieuHopDong"
                            name="kiHieuHopDong" value="HĐ-ĐT" placeholder="Nhập kí hiệu hợp đồng"
                            oninput="updateNumberPreview()">
                        </div>
                        <div class="col-md-2">
                          <label for="kiHieuThanhLy" class="form-label">
                            <strong>Kí hiệu thanh lý</strong>
                            <span class="text-danger">*</span>
                          </label>
                          <input type="text" class="form-control" id="kiHieuThanhLy"
                            name="kiHieuThanhLy" value="HĐNT-ĐT" placeholder="Nhập kí hiệu thanh lý"
                            oninput="updateNumberPreview()">
                        </div>
                        <div class="col-md-6">
                          <label for="coSoDaoTao" class="form-label">
                            <strong>Cơ sở đào tạo</strong>
                            <span class="text-danger">*</span>
                          </label>
                          <input type="text" class="form-control" id="coSoDaoTao"
                            name="coSoDaoTao" value="Phân hiệu Học viện Kỹ thuật mật mã" placeholder="Nhập cơ sở đào tạo">
                        </div>
                      </div>
                      <div class="row mt-3">
                        <div class="col-12">
                          <div class="p-3 bg-light border rounded">
                            <div class="row">
                              <div class="col-md-6">
                                <div class="mb-2">
                                  <strong>Ví dụ số hợp đồng:</strong> <span id="contractExample"
                                    class="text-primary">001/HĐ-ĐT</span>
                                </div>
                              </div>
                              <div class="col-md-6">
                                <div>
                                  <strong>Ví dụ số thanh lý:</strong> <span id="terminationExample"
                                    class="text-info">001/HĐNT-ĐT</span>
                                </div>
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                  <div class="col-md-6">
                    <!-- Unified action buttons -->
                    <div class="d-flex gap-2 mt-4" id="unifiedContractButtons">
                      <button type="button" class="btn btn-outline-primary" id="previewContractBtn"
                        onclick="handleContractOperation('previewContract')">
                        <i class="fas fa-eye"></i> Xem trước khi tạo
                      </button>
                      <button type="button" class="btn btn-success" id="executeContractBtn"
                        onclick="handleContractOperation('executeContract')">
                        <i class="fas fa-play"></i> Tạo
                      </button>
                    </div>


                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Main content area -->
          <div class="content-section mt-4">
            <div class="card">
              <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                  <i class="fas fa-file-contract me-2"></i>Danh sách hợp đồng - Phân hiệu học viện
                </h5>
                <!-- Bộ lọc theo tên giảng viên -->
                <div class="d-flex align-items-center">
                  <label for="searchTeacher" class="form-label me-2 mb-0">
                    <i class="fas fa-search me-1"></i>Tìm kiếm:
                  </label>
                  <input type="text" 
                         class="form-control" 
                         id="searchTeacher" 
                         placeholder="Nhập tên giảng viên..."
                         style="width: 250px;">
                </div>
              </div>
              <div class="card-body">
                <!-- Results Table -->
                <div id="resultsDiv" style="display: none;">
                  <div class="table-responsive">
                    <table class="table table-striped table-hover" id="contractsTable">
                      <thead class="table-dark">
                        <tr>
                          <th>STT</th>
                          <th>Họ tên giảng viên</th>
                          <th>Hệ đào tạo</th>
                          <th>Cơ sở đào tạo</th>
                          <th>Số HĐ hiện tại</th>
                          <th>Số TL hiện tại</th>
                          <th>Số HĐ mới</th>
                          <th>Số TL mới</th>
                        </tr>
                      </thead>
                      <tbody id="contractsTableBody">
                      </tbody>
                    </table>
                  </div>
                </div>

                <!-- Loading spinner -->
                <div id="loadingSpinner" class="text-center py-4" style="display: none;">
                  <div class="spinner-border" role="status">
                    <span class="visually-hidden">Loading...</span>
                  </div>
                  <p class="mt-2">Đang tải dữ liệu...</p>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Success/Error Messages -->
      <div class="toast-container position-fixed bottom-0 end-0 p-3">
        <div id="successToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
          <div class="toast-header bg-success text-white">
            <strong class="me-auto">Thành công</strong>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast"></button>
          </div>
          <div class="toast-body" id="successMessage"></div>
        </div>

        <div id="errorToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
          <div class="toast-header bg-danger text-white">
            <strong class="me-auto">Lỗi</strong>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast"></button>
          </div>
          <div class="toast-body" id="errorMessage"></div>
        </div>
      </div>

      <!-- External scripts -->
      <script src="/js/moigiang/href.js"></script>
      <script src="/js/moigiang/getdata.js"></script>
      <script src="/js/moigiang/hideBtn.js"></script>
      
      <!-- ĐTPH specific script -->
      <script>
        // ===== CONSTANTS FOR ĐTPH =====
        const FIXED_KHOA = 'ĐTPH';
        let selectedHeValues = [];

        // ===== SIMPLIFIED MULTI-SELECT FOR HỆ ĐÀO TẠO =====
        function initHeMultiSelect() {
          console.log('Initializing hệ đào tạo multi-select...');
          const container = document.getElementById('heCheckboxMenu');
          const buttonText = document.getElementById('heButtonText');
          const selectedDisplay = document.getElementById('selectedHe');
          
          if (!container || !buttonText || !selectedDisplay) {
            console.error('Missing elements for hệ đào tạo multi-select');
            return;
          }
          
          // Xử lý checkbox clicks
          container.addEventListener('change', function(e) {
            if (e.target.type === 'checkbox') {
              const value = e.target.value;
              console.log('Hệ đào tạo checkbox changed:', value, 'checked:', e.target.checked);
              
              if (value === 'ALL') {
                // Toggle tất cả
                const allCheckboxes = container.querySelectorAll('input[type="checkbox"]:not([value="ALL"])');
                allCheckboxes.forEach(cb => {
                  cb.checked = e.target.checked;
                });
                
                if (e.target.checked) {
                  selectedHeValues.length = 0;
                  selectedHeValues.push('ALL');
                } else {
                  selectedHeValues.length = 0;
                }
              } else {
                // Xử lý checkbox riêng lẻ
                if (e.target.checked) {
                  // Bỏ check "Tất cả" nếu chọn riêng lẻ
                  const selectAllCheckbox = container.querySelector('input[value="ALL"]');
                  if (selectAllCheckbox) selectAllCheckbox.checked = false;
                  // Xóa 'ALL' khỏi array nếu có
                  const allIndex = selectedHeValues.indexOf('ALL');
                  if (allIndex > -1) selectedHeValues.splice(allIndex, 1);
                  // Thêm giá trị mới
                  if (!selectedHeValues.includes(value)) {
                    selectedHeValues.push(value);
                  }
                } else {
                  const index = selectedHeValues.indexOf(value);
                  if (index > -1) {
                    selectedHeValues.splice(index, 1);
                  }
                }
              }
              
              console.log('Current selectedHeValues:', [...selectedHeValues]);
              updateHeDisplay();
            }
          });
        }

        function updateHeDisplay() {
          const buttonText = document.getElementById('heButtonText');
          const selectedDisplay = document.getElementById('selectedHe');
          const container = document.getElementById('heCheckboxMenu');
          
          // Luôn hiển thị text cố định cho button
          buttonText.textContent = 'Hệ đào tạo';
          
          // Cập nhật tags
          selectedDisplay.innerHTML = '';
          selectedHeValues.forEach(value => {
            if (value === 'ALL') {
              // Hiển thị tag "ALL" khi chọn tất cả
              const tag = document.createElement('span');
              tag.className = 'selected-tag';
              tag.innerHTML = `Tất cả hệ đào tạo <span class="remove-tag" onclick="removeHeTag('${value}')">×</span>`;
              selectedDisplay.appendChild(tag);
            } else {
              const checkbox = container.querySelector(`input[value="${value}"]`);
              if (checkbox) {
                const label = checkbox.closest('label').textContent.trim();
                const tag = document.createElement('span');
                tag.className = 'selected-tag';
                tag.innerHTML = `${label} <span class="remove-tag" onclick="removeHeTag('${value}')">×</span>`;
                selectedDisplay.appendChild(tag);
              }
            }
          });
        }

        // Hàm remove tag cho hệ đào tạo
        function removeHeTag(value) {
          const container = document.getElementById('heCheckboxMenu');
          if (container) {
            const checkbox = container.querySelector(`input[value="${value}"]`);
            if (checkbox) {
              checkbox.checked = false;
              checkbox.dispatchEvent(new Event('change', { bubbles: true }));
            }
          }
        }

        // Hàm lấy giá trị đã chọn
        function getSelectedKhoa() {
          return [FIXED_KHOA]; // Luôn trả về ĐTPH
        }

        function getSelectedHe() {
          console.log('selectedHeValues:', selectedHeValues);
          if (selectedHeValues.length === 0 || selectedHeValues.includes('ALL')) {
            return ['ALL'];
          }
          return selectedHeValues;
        }

        // Cập nhật ví dụ số hợp đồng khi người dùng thay đổi số bắt đầu hoặc kí hiệu
        function updateNumberPreview() {
          const startingNumber = parseInt($('#unifiedStartingNumber').val()) || 1;
          const formattedNumber = String(startingNumber).padStart(3, '0');
          const kiHieuHopDong = $('#kiHieuHopDong').val() || 'HĐ-ĐT';
          const kiHieuThanhLy = $('#kiHieuThanhLy').val() || 'HĐNT-ĐT';

          $('#contractExample').text(`${formattedNumber}/${kiHieuHopDong}`);
          $('#terminationExample').text(`${formattedNumber}/${kiHieuThanhLy}`);
        }

        // ===== CORE FUNCTIONS (REUSED FROM ORIGINAL) =====

        // Xem trước cài đặt đồng bộ số hợp đồng và thanh lý
        function previewSynchronizedSetup() {
          console.log('[DEBUG DTPH] Starting previewSynchronizedSetup...');
          
          const dot = $('#combobox-dot').val();
          const ki = $('#comboboxki').val();
          const nam = $('#NamHoc').val();
          
          console.log('[DEBUG DTPH] Basic values:', { dot, ki, nam });

          if (!dot || !ki || !nam) {
            console.log('[DEBUG DTPH] Missing required fields');
            showError('Vui lòng chọn đầy đủ Đợt, Kì và Năm trước khi xem trước');
            return;
          }

          const startingNumber = parseInt($('#unifiedStartingNumber').val()) || 1;
          
          console.log('[DEBUG DTPH] Starting number:', startingNumber);

          if (!startingNumber || startingNumber < 1) {
            console.log('[DEBUG DTPH] Invalid starting number');
            showError('Vui lòng nhập số bắt đầu hợp lệ (≥ 1)');
            return;
          }

          showLoading(true);
          showSuccess('Đang xem trước cài đặt đồng bộ số hợp đồng và thanh lý...');

          const teacherName = $('#searchTeacher').val().trim();

          const kiHieuHopDong = $('#kiHieuHopDong').val() || 'HĐ-ĐT';
          const kiHieuThanhLy = $('#kiHieuThanhLy').val() || 'HĐNT-ĐT';

          const coSoDaoTao = $('#coSoDaoTao').val() || 'Phân hiệu Học viện Kỹ thuật mật mã';

          const data = {
            dot: dot,
            ki: ki,
            nam: nam,
            khoaList: getSelectedKhoa(), // Luôn ['ĐTPH']
            heDaoTaoList: getSelectedHe(),
            loaiHopDong: "Mời giảng",
            startingNumber: startingNumber,
            kiHieuHopDong: kiHieuHopDong,
            kiHieuThanhLy: kiHieuThanhLy,
            coSoDaoTao: coSoDaoTao,
            teacherName: teacherName
          };

          console.log('[DEBUG DTPH] Final data being sent:', data);
          console.log('[DEBUG DTPH] Ki hieu hop dong:', data.kiHieuHopDong);
          console.log('[DEBUG DTPH] Ki hieu thanh ly:', data.kiHieuThanhLy);
          console.log('[DEBUG DTPH] Starting number:', data.startingNumber);

          // Gọi API preview đồng bộ
          $.post('/api/preview-so-hop-dong-moi-giang', data)
            .done(function (response) {
              console.log('[DEBUG DTPH] Preview response received:', response);
              if (response.success) {
                console.log('[DEBUG DTPH] Response data:', response.data);
                displaySynchronizedPreviewResults(response.data);
                showSuccess('Xem trước đồng bộ thành công. Kiểm tra kết quả bên dưới.');
              } else {
                console.log('[DEBUG DTPH] Preview failed:', response.message);
                showError(response.message || 'Có lỗi xảy ra khi xem trước đồng bộ');
              }
            })
            .fail(function (xhr, status, error) {
              console.error('[DEBUG DTPH] Preview request failed:', { xhr, status, error });
              console.error('[DEBUG DTPH] Response text:', xhr.responseText);
              showError('Lỗi kết nối server khi preview: ' + error);
            })
            .always(function () {
              showLoading(false);
            });
        }

        // Thực hiện cài đặt đồng bộ số hợp đồng và thanh lý
        function executeSynchronizedSetup() {
          const dot = $('#combobox-dot').val();
          const ki = $('#comboboxki').val();
          const nam = $('#NamHoc').val();

          if (!dot || !ki || !nam) {
            showError('Vui lòng chọn đầy đủ Đợt, Kì và Năm trước khi thực hiện cài đặt');
            return;
          }

          const startingNumber = parseInt($('#unifiedStartingNumber').val()) || 1;
          const kiHieuHopDong = $('#kiHieuHopDong').val() || 'HĐ-ĐT';
          const kiHieuThanhLy = $('#kiHieuThanhLy').val() || 'HĐNT-ĐT';

          if (!startingNumber || startingNumber < 1) {
            showError('Vui lòng nhập số bắt đầu hợp lệ (≥ 1)');
            return;
          }

          if (!kiHieuHopDong.trim()) {
            showError('Vui lòng nhập kí hiệu hợp đồng');
            return;
          }

          if (!kiHieuThanhLy.trim()) {
            showError('Vui lòng nhập kí hiệu thanh lý');
            return;
          }

          // Dialog xác nhận chi tiết
          const contractExample = String(startingNumber).padStart(3, '0');
          const terminationExample = String(startingNumber).padStart(3, '0');

          Swal.fire({
            title: 'Xác nhận tạo số hợp đồng và số thanh lý',
            html: `<div class="text-start">
                 <p>Số bắt đầu: <strong>${startingNumber}</strong></p>
                 <p>Khoa: <strong>${FIXED_KHOA}</strong></p>
                 <p>Kí hiệu hợp đồng: <strong>${kiHieuHopDong}</strong></p>
                 <p>Kí hiệu thanh lý: <strong>${kiHieuThanhLy}</strong></p>
                 <div class="row mt-3">
                   <div class="col-12 mb-2">
                       <span>Số hợp đồng: <strong class="text-primary">${contractExample}</strong> | Kí hiệu: <strong>${kiHieuHopDong}</strong></span>
                   </div>
                   <div class="col-12">
                       <span>Số thanh lý: <strong class="text-info">${terminationExample}</strong> | Kí hiệu: <strong>${kiHieuThanhLy}</strong></span>
                   </div>
                 </div>
               </div>`,
            icon: 'question',
            showCancelButton: true,
            confirmButtonColor: '#0d6efd',
            cancelButtonColor: '#6c757d',
            confirmButtonText: 'Thực hiện đồng bộ',
            cancelButtonText: 'Hủy bỏ',
            width: '500px'
          }).then((result) => {
            if (result.isConfirmed) {
              performSynchronizedSetup();
            }
          });
        }

        // Thực hiện cài đặt đồng bộ (gọi từ dialog xác nhận)
        function performSynchronizedSetup() {
          showLoading(true);

          // Trích dữ liệu từ bảng
          const tableData = [];
          let lastGroupInfo = '';

          $('#contractsTableBody tr').each(function () {
            const $cells = $(this).find('td');

            if (!$cells.length) return;
            if ($cells.first().attr('colspan')) return;

            let rowData = null;

            if ($cells.length === 7) {
              lastGroupInfo = $cells.eq(2).text().trim();
              
              rowData = {
                HoTen: $cells.eq(1).text().trim(),
                groupInfo: lastGroupInfo,
                currentSoHopDong: $cells.eq(3).text().trim(),
                currentSoThanhLy: $cells.eq(4).text().trim(),
                newSoHopDong: $cells.eq(5).find('strong').text().trim() ||
                  $cells.eq(5).text().trim(),
                newSoThanhLy: $cells.eq(6).find('strong').text().trim() ||
                  $cells.eq(6).text().trim()
              };
            } else if ($cells.length === 6) {
              rowData = {
                HoTen: $cells.eq(1).text().trim(),
                groupInfo: lastGroupInfo,
                currentSoHopDong: $cells.eq(2).text().trim(),
                currentSoThanhLy: $cells.eq(3).text().trim(),
                newSoHopDong: $cells.eq(4).find('strong').text().trim() ||
                  $cells.eq(4).text().trim(),
                newSoThanhLy: $cells.eq(5).find('strong').text().trim() ||
                  $cells.eq(5).text().trim()
              };
            } else {
              return;
            }

            if (rowData.HoTen &&
              rowData.newSoHopDong &&
              rowData.newSoHopDong !== 'Chưa tạo') {
              tableData.push(rowData);
            }
          });

          const teacherName = $('#searchTeacher').val().trim();
          const coSoDaoTao = $('#coSoDaoTao').val() || 'Phân hiệu Học viện Kỹ thuật mật mã';
          const data = {
            dot: $('#combobox-dot').val(),
            ki: $('#comboboxki').val(),
            nam: $('#NamHoc').val(),
            khoaList: getSelectedKhoa(), // ['ĐTPH']
            heDaoTaoList: getSelectedHe(),
            loaiHopDong: "Mời giảng",
            startingNumber: parseInt($('#unifiedStartingNumber').val()) || 1,
            kiHieuHopDong: $('#kiHieuHopDong').val() || 'HĐ-ĐT',
            kiHieuThanhLy: $('#kiHieuThanhLy').val() || 'HĐNT-ĐT',
            coSoDaoTao: coSoDaoTao,
            contractsData: tableData,
            teacherName: teacherName
          };

          console.log('data contract ĐTPH:', data);

          $.post('/api/setup-so-hopdong-toan-bo', data)
            .done(function (response) {
              if (response.success) {
                Swal.fire({
                  title: 'Thành công!',
                  text: response.message,
                  icon: 'success',
                  confirmButtonText: 'OK'
                }).then(() => {
                  loadContracts();
                });
              } else {
                showError(response.message || 'Có lỗi xảy ra khi cài đặt');
              }
            })
            .fail(function () {
              showError('Có lỗi xảy ra khi kết nối với server');
            })
            .always(function () {
              showLoading(false);
            });
        }

        // Hiển thị kết quả preview đồng bộ
        function displaySynchronizedPreviewResults(groupedContracts) {
          console.log('[DEBUG DTPH] Displaying preview results:', groupedContracts);
          const tbody = $('#contractsTableBody');
          tbody.empty();

          // Flatten data để dễ xử lý
          const rows = [];
          console.log('[DEBUG DTPH] Starting to flatten data...');
          Object.keys(groupedContracts).forEach(he => {
            Object.keys(groupedContracts[he]).forEach(khoa => {
              groupedContracts[he][khoa].forEach((contract, idx) => {
                rows.push({
                  ...contract,
                  groupInfo: he, // Chỉ hiển thị hệ đào tạo vì khoa đã fix
                  index: rows.length + 1
                });
              });
            });
          });

          if (rows.length === 0) {
            tbody.append(`
              <tr>
                <td colspan="7" class="text-center text-muted">
                  <i class="fas fa-inbox"></i> Không có dữ liệu để hiển thị
                </td>
              </tr>
            `);
            $('#resultsDiv').show();
            return;
          }

          // Render từng row với grouping theo hệ đào tạo
          let lastGroup = null;
          const groupSizes = {};
          rows.forEach(r => {
            groupSizes[r.groupInfo] = (groupSizes[r.groupInfo] || 0) + 1;
          });

          rows.forEach(r => {
            const isNewGroup = r.groupInfo !== lastGroup;
            const rowspan = isNewGroup ? groupSizes[r.groupInfo] : null;

            const oldContractNumber = r.SoHopDong || '<span class="text-muted">Chưa có</span>';
            const oldTerminationNumber = r.SoThanhLyHopDong || '<span class="text-muted">Chưa có</span>';
            const newContractNumber = r.newSoHopDong || '<span class="text-muted">Chưa tạo</span>';
            const newTerminationNumber = r.newSoThanhLy || '<span class="text-muted">Chưa tạo</span>';

            let tr = `<tr${isNewGroup ? ' class="table-warning"' : ''} 
                           data-cccd="${r.CCCD || ''}" 
                           data-he-dao-tao="${r.HeDaoTao || r.he_dao_tao || ''}"
                           data-id-gvm="${r.id_Gvm || ''}"
                           data-hoten="${r.HoTen || ''}"
                           data-khoa="${r.Khoa || ''}"
                           data-new-so-hop-dong="${r.newSoHopDong || ''}"
                           data-new-so-thanh-ly="${r.newSoThanhLy || ''}">`;
            tr += `<td>${r.index}</td>`;
            tr += `<td>${r.HoTen}</td>`;

            // Chỉ hiển thị hệ đào tạo
            if (isNewGroup) {
              tr += `<td rowspan="${rowspan}">${r.groupInfo}</td>`;
              lastGroup = r.groupInfo;
            }

            const coSoDaoTao = $('#coSoDaoTao').val() || 'Phân hiệu Học viện Kỹ thuật mật mã';
            tr += `<td>${coSoDaoTao}</td>`;
            tr += `<td>${oldContractNumber}</td>`;
            tr += `<td>${oldTerminationNumber}</td>`;
            tr += `<td>${newContractNumber}</td>`;
            tr += `<td>${newTerminationNumber}</td>`;
            tr += `</tr>`;

            tbody.append(tr);
          });

          $('#resultsDiv').show();
        }

        // Tải danh sách hợp đồng theo điều kiện lọc
        function loadContracts() {
          const dot = $('#combobox-dot').val();
          const ki = $('#comboboxki').val();
          const nam = $('#NamHoc').val();

          if (!dot || !ki || !nam) {
            showError('Vui lòng chọn đầy đủ Đợt, Kì và Năm');
            return;
          }

          showLoading(true);
          $('#resultsDiv').hide();

          const selectedHe = getSelectedHe();
          const teacherName = $('#searchTeacher').val().trim();
          
          console.log('Selected Khoa for API call (ĐTPH):', getSelectedKhoa());
          console.log('Selected He for API call:', selectedHe);
          console.log('Teacher name search:', teacherName);
          
          const params = {
            dot: dot,
            ki: ki,
            nam: nam,
            khoaList: JSON.stringify(getSelectedKhoa()), // ['ĐTPH']
            heDaoTaoList: JSON.stringify(selectedHe),
            loaiHopDong: "Mời giảng",
            teacherName: teacherName
          };

          console.log('Sending params to loadContracts (ĐTPH):', params);

          $.get('/api/hopdong-list', params)
            .done(function (response) {
              if (response.success) {
                console.log('Contracts loaded (ĐTPH):', response.data);
                displayContracts(response.data);
              } else {
                showError(response.message || 'Có lỗi xảy ra khi tải danh sách hợp đồng');
              }
            })
            .fail(function () {
              showError('Có lỗi xảy ra khi kết nối với server');
            })
            .always(function () {
              showLoading(false);
            });
        }

        // Hiển thị danh sách hợp đồng theo nhóm hệ đào tạo
        function displayContracts(grouped) {
          const tbody = $('#contractsTableBody');
          tbody.empty();

          const systems = Object.keys(grouped);
          if (systems.length === 0) {
            tbody.append(`
              <tr>
                <td colspan="7" class="text-center text-muted">
                  <i class="fas fa-inbox"></i> Không có dữ liệu để hiển thị
                </td>
              </tr>
            `);
            $('#resultsDiv').show();
            return;
          }

          let idx = 0;
          systems.forEach(system => {
            const faculties = grouped[system];
            const facultyKeys = Object.keys(faculties);
            facultyKeys.forEach(faculty => {
              const list = faculties[faculty];
              const rowSpan = list.length;
              
              list.forEach((contract, j) => {
                idx++;
                const isFirst = (j === 0);

                const currentContractNumber = contract.SoHopDong || '<span class="text-muted">Chưa có</span>';
                const currentTerminationNumber = contract.SoThanhLyHopDong || '<span class="text-muted">Chưa có</span>';
                const newContractNumber = '<span class="text-muted">Chưa có</span>';
                const newTerminationNumber = '<span class="text-muted">Chưa có</span>';

                tbody.append(`
                  <tr ${isFirst ? 'class="table-warning"' : ''}
                       data-cccd="${contract.CCCD || ''}" 
                       data-he-dao-tao="${contract.HeDaoTao || ''}"
                       data-id-gvm="${contract.id_Gvm || ''}"
                       data-hoten="${contract.HoTen || ''}"
                       data-khoa="${faculty || ''}"
                       data-new-so-hop-dong=""
                       data-new-so-thanh-ly="">
                    <td>${idx}</td>
                    <td>${contract.HoTen || ''}</td>
                    ${isFirst
                      ? `<td rowspan="${rowSpan}" class="text-center align-middle bg-light">
                         <strong>${system}</strong>
                       </td>`
                      : ''
                    }
                    <td>${contract.CoSoDaoTao || ($('#coSoDaoTao').val() || 'Phân hiệu Học viện Kỹ thuật mật mã')}</td>
                    <td>${currentContractNumber}</td>
                    <td>${currentTerminationNumber}</td>
                    <td>${newContractNumber}</td>
                    <td>${newTerminationNumber}</td>
                  </tr>
                `);
              });
            });
          });

          $('#resultsDiv').show();
        }

        // Utility functions
        function showLoading(show) {
          if (show) {
            $('#loadingSpinner').show();
          } else {
            $('#loadingSpinner').hide();
          }
        }

        function showSuccess(message) {
          $('#successMessage').text(message);
          const toast = new bootstrap.Toast($('#successToast')[0]); 
          toast.show();
        }

        function showError(message) {
          $('#errorMessage').text(message);
          const toast = new bootstrap.Toast($('#errorToast')[0]);
          toast.show();
        }

        // Xử lý các thao tác hợp đồng theo loại
        function handleContractOperation(operation) {
          switch (operation) {
            case 'load':
              loadContracts();
              break;
            case 'previewContract':
              previewSynchronizedSetup();
              break;
            case 'executeContract':
              executeSynchronizedSetup();
              break;
          }
        }

        // Khởi tạo giao diện khi document ready
        $(document).ready(function () {
          console.log('Document ready, initializing ĐTPH site...');
          
          // Đặt mặc định cho hệ đào tạo
          selectedHeValues = ['ALL'];

          // Khởi tạo multi-select cho hệ đào tạo
          setTimeout(() => {
            console.log('Initializing hệ đào tạo multi-select...');
            initHeMultiSelect();
            // Set mặc định cho checkbox "Tất cả"
            $('#selectAllHe').prop('checked', true);
            updateHeDisplay();
          }, 500);

          // Khởi tạo giao diện
          updateNumberPreview();

          // Thêm event handler cho số bắt đầu và kí hiệu thay đổi
          $('#unifiedStartingNumber').on('input', updateNumberPreview);
          $('#kiHieuHopDong').on('input', updateNumberPreview);
          $('#kiHieuThanhLy').on('input', updateNumberPreview);

          // Thêm event listener cho tìm kiếm tên giảng viên
          $('#searchTeacher').on('input', debounce(function() {
            const dot = $('#combobox-dot').val();
            const ki = $('#comboboxki').val();
            const nam = $('#NamHoc').val();
            
            if (dot && ki && nam) {
              loadContracts();
            }
          }, 500));

          // Hàm debounce
          function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
              const later = function() {
                clearTimeout(timeout);
                func(...args);
              };
              clearTimeout(timeout);
              timeout = setTimeout(later, wait);
            };
          }
        });
      </script>
</body>

</html>