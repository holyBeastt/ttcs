<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>H·ªçc Vi·ªán K·ªπ Thu·∫≠t M·∫≠t M√£</title>
    <link rel="stylesheet" href="/css/table.css" />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css"
    />
    <link rel="stylesheet" href="/css/styles.css" />
    <link rel="stylesheet" href="/css/import.css" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css"
    />
  </head>
  <style>
    .btn {
      height: 45px;
      margin-bottom: 0px;
      text-wrap: nowrap;
    }

    /* Css ph·∫ßn suggestion */
    .suggestions {
      position: absolute;
      /* ƒê·∫£m b·∫£o g·ª£i √Ω n·∫±m b√™n tr√™n c√°c th√†nh ph·∫ßn kh√°c */
      top: calc(100% + 5px);
      /* ƒê·∫∑t g·ª£i √Ω ph√≠a tr√™n input v·ªõi m·ªôt kho·∫£ng c√°ch */
      font-size: 12px;
      left: 0;
      background-color: #f0f0f0;
      color: #000;
      border: 1px solid #ccc;
      box-shadow: 0px 4px 8px rgba(0, 0, 0, 0.1);
      z-index: 1000;
      /* ƒê·∫£m b·∫£o g·ª£i √Ω n·∫±m tr√™n c√°c th√†nh ph·∫ßn kh√°c */
      border-radius: 4px;
      max-height: 300px;
      overflow-y: auto;
    }

    /* Hi·ªáu ·ª©ng lung linh khi hover */
    .suggestions:hover {
      background-color: #e0e0e0;
      /* Thay ƒë·ªïi m√†u n·ªÅn khi hover */
      box-shadow: 0px 8px 16px rgba(0, 0, 0, 0.2);
      /* TƒÉng ƒë·ªô b√≥ng khi hover */
    }

    /* CSS cho t·ª´ng m·ª•c g·ª£i √Ω */
    .suggestion-item {
      padding: 8px 12px;
      /* Kho·∫£ng c√°ch b√™n trong t·ª´ng m·ª•c */
      cursor: pointer;
      /* Con tr·ªè chu·ªôt thay ƒë·ªïi khi hover */
      transition: background-color 0.2s ease;
      /* T·∫°o hi·ªáu ·ª©ng chuy·ªÉn ƒë·ªïi m∆∞·ª£t m√† khi hover */
    }

    /* Hi·ªáu ·ª©ng khi ng∆∞·ªùi d√πng di chu·ªôt v√†o m·ª•c g·ª£i √Ω */
    .suggestion-item:hover {
      background-color: #f0f0f0;
      /* M√†u n·ªÅn khi hover */
    }

    /* ƒê·∫∑t l·∫°i m·ªôt s·ªë thu·ªôc t√≠nh khi input m·∫•t focus */
    input:focus + .suggestions {
      display: block;
      /* ƒê·∫£m b·∫£o khung hi·ªÉn th·ªã khi input ƒë∆∞·ª£c focus */
    }

    /* ƒê·∫£m b·∫£o container g·ª£i √Ω kh√¥ng b·ªã tr√†n ra ngo√†i khung n·∫øu c√≥ */
    .suggestions {
      overflow: hidden;
    }

    /* Ph·∫ßn ng√†y b·∫Øt ƒë·∫ßu, ng√†y k·∫øt th√∫c */
    .input-group-group {
      display: flex;
      align-items: center;
      gap: 16px;
      /* Kho·∫£ng c√°ch gi·ªØa hai √¥ */
      width: fit-content;
      /* Ch·ªâ chi·∫øm kh√¥ng gian theo n·ªôi dung */
    }

    .input-group {
      display: flex;
      align-items: center;
      border: 1px solid #ccc;
      /* ƒê∆∞·ªùng vi·ªÅn */
      border-radius: 8px;
      /* G√≥c bo */
      padding: 5px;
      /* Kho·∫£ng c√°ch trong */
      background-color: #42c2f5;
      /* M√†u n·ªÅn nh·∫°t */
      width: 350px;
      /* Chi·ªÅu r·ªông t·ª´ng √¥ */
    }

    .input-group-text {
      font-weight: bold;
      background-color: transparent;
      /* N·ªÅn trong su·ªët */
      border: none;
      /* Lo·∫°i b·ªè vi·ªÅn */
    }

    .form-control {
      border: none;
      outline: none;
      /* B·ªè vi·ªÅn focus m·∫∑c ƒë·ªãnh */
      width: 100%;
      /* Chi·∫øm h·∫øt kh√¥ng gian c√≤n l·∫°i */
    }

    /* ƒê·∫∑t chi·ªÅu r·ªông c·ªë ƒë·ªãnh cho c·∫£ input[type="date"] v√† input[type="text"] */
    input[type="date"],
    input[type="text"] {
      width: 120px;
      /* ƒêi·ªÅu ch·ªânh gi√° tr·ªã n√†y theo mong mu·ªën */
      box-sizing: border-box;
      padding: 5px;
      /* Gi·ªØ padding nh∆∞ c≈© */
    }

    #SoQD-list {
      font-style: italic;
      /* Ch·ªØ nghi√™ng */
      font-weight: bold;
      /* M√†u x√°m nh·∫°t h∆°n */
      list-style-type: none;
      /* B·ªè d·∫•u ch·∫•m ƒë·∫ßu d√≤ng */
      margin-left: 10px;
      /* D·ªãch sang tr√°i m·ªôt ch√∫t */
      margin-bottom: 3px;
    }

    #SoQD-list li::before {
      content: "* ";
    }

  </style>
  <style>
    /* T√πy ch·ªânh danh s√°ch g·ª£i √Ω */
    .ui-autocomplete {
      background: white;
      border: 1px solid #ccc;
      max-height: 200px;
      overflow-y: auto;
      box-shadow: 0px 4px 6px rgba(0, 0, 0, 0.1);
      font-size: 14px;
      padding: 5px;
      width: 200px;
      /* Gi·∫£m ƒë·ªô r·ªông */
      font-size: 12px !important;
    }

    /* Hi·ªÉn th·ªã ƒë·∫πp h∆°n, kh√¥ng c·∫ßn hover */
    .ui-menu-item {
      padding: 8px;
      cursor: default;
    }
  </style>
  <style>
    .summary-container {
      font-size: 12px;
      position: fixed;
      bottom: 20px;
      right: 10px; /* gi·∫£m kho·∫£ng c√°ch b√™n ph·∫£i */
      z-index: 1050;
      display: flex;
      align-items: flex-end;
    }

    .floating-box {
      width: 180px;
      background-color: white;
      border: 1px solid #ddd;
      border-radius: 12px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
      padding: 15px;
      display: none;
      transition: all 0.3s ease;
    }

    .detail-popup {
      position: absolute;
      bottom: 60px;
      right: 0;
      width: 100%;
      max-height: 200px;
      overflow-y: auto;
      background-color: #f8f9fa;
      border: 1px solid #ccc;
      border-radius: 8px;
      padding: 10px;
      display: none;
    }

    .toggle-btn {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background-color: #0d6efd;
      color: white;
      border: none;
      font-size: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-left: 8px;
      cursor: pointer;
    }

    .toggle-btn svg {
      width: 20px;
      height: 20px;
      transition: transform 0.3s ease;
    }

    .detail-item {
      font-size: 12px;
      margin-bottom: 4px;
    }

    .xem-chi-tiet {
      font-style: italic;
      text-decoration: underline;
      font-size: 12px;
      color: #007bff;
      cursor: pointer;
      margin-top: 6px;
      display: inline-block;
    }
  </style>
  <body>
    <!-- Ph·∫ßn header -->
    <%- include('header') %>

    <!-- Ph·∫ßn n·ªôi dung -->

    <div class="container-fluid m-4 box d-flex justify-content-start">
      <div class="mx-2" style="width: 100%">
        <div class="d-flex align-items-center mb-3">
          <input
            type="file"
            id="fileInput"
            accept=".pdf, .docx"
            style="display: none"
          />

          <!-- Combo ch·ªçn ƒë·ª£t -->
          <select class="selectop w-100px mx-1" id="combobox-dot">
            <option value="">ƒê·ª£t</option>
          </select>

          <!-- Combobox ch·ªçn k√¨ -->
          <select class="selectop w-100px mx-1" id="combobox-ki">
            <option value="">K√¨</option>
          </select>

          <!-- Combo box NƒÉm -->
          <select class="selectop mx-1" id="NamHoc">
            <option value="">Ch·ªçn nƒÉm h·ªçc</option>
          </select>

          <!-- Combo box v·ªõi c√°c gi√° tr·ªã CNTT, ATTT, DTVT -->
          <select class="selectop" id="MaPhongBan">
            <option value="">Khoa</option>
          </select>

          <select class="mx-1 selectop" id="he_dao_tao">
          </select>

          <button id="infoDoAn" class="btn text-nowrap mx-2">Hi·ªÉn th·ªã</button>
          <button class="btn mx-2" id="updateDoAn">C·∫≠p nh·∫≠t</button>

          <button
            class="btn text-nowrap mx-2"
            id="export-file-btn"
            style="display: inline-block; height: 45px;"
            onclick="exportToExcel()"
          >
            Xu·∫•t file
          </button>

          <button
            class="btn mx-2 ms-auto"
            id="saveDataDoAn"
            style="display: none; height: 45px"
          >
            L∆∞u d·ªØ li·ªáu h·ª£p ƒë·ªìng
          </button>
        </div>

        <div class="d-flex my-3" style="height: 70px; width: 100%">
          <input
            type="text"
            id="filterName"
            placeholder="T√¨m theo t√™n sinh vi√™n"
            class="form-control m-2 search"
            style="width: 20%"
          />
          <input
            type="text"
            id="filterMaSV"
            placeholder="T√¨m theo m√£ SV"
            class="form-control m-2 search"
            style="width: 15%"
          />
          <input
            type="text"
            id="filterClass"
            placeholder="T√¨m theo t√™n ƒë·ªÅ t√†i"
            class="form-control m-2 search"
            style="width: 20%"
          />
          <input
            type="text"
            id="filterNameGV"
            placeholder="T√¨m theo t√™n gi·∫£ng vi√™n"
            class="form-control m-2 search"
            style="width: 18%"
          />

          <div class="date-all-container" style="display: none; width: 100%">
            <div class="input-group my-2 mx-1" style="width: 40%" id="batdau">
              <label for="startDateAll" class="input-group-text"
                >Ng√†y b·∫Øt ƒë·∫ßu</label
              >
              <input
                required
                type="date"
                id="startDateAll"
                class="form-control"
              />
            </div>
            <div class="input-group my-2 mx-1" style="width: 40%" id="ketthuc">
              <label for="endDateAll" class="input-group-text"
                >Ng√†y k·∫øt th√∫c</label
              >
              <input
                required
                type="date"
                id="endDateAll"
                class="form-control"
              />
            </div>
            <button
              id="fillDay"
              class="btn text-nowrap my-2 mx-1"
              style="width: 18%"
            >
              Ch√®n ng√†y
            </button>
          </div>
        </div>

        <ul id="SoQD-list"></ul>

        <div id="renderInfo">
          <table class="text-center">
            <thead>
              <tr>
                <th style="width: 30px">TT</th>
                <th style="width: 120px">Sinh Vi√™n</th>
                <th style="width: 75px">M√£ SV</th>
                <th style="width: 60px">Kh√≥a</th>
                <th style="width: 120px">Ng√†nh</th>
                <th style="display: none; width: 50px">Khoa</th>
                <th style="width: 300px">T√™n ƒë·ªÅ t√†i</th>
                <th style="width: 200px">Gi·∫£ng Vi√™n H∆∞·ªõng D·∫´n</th>
                <th style="width: 260px">Gi·∫£ng Vi√™n H∆∞·ªõng D·∫´n 1</th>
                <th style="width: 260px">Gi·∫£ng Vi√™n H∆∞·ªõng D·∫´n 2</th>
                <th style="min-width: 90px">Ng√†y b·∫Øt ƒë·∫ßu</th>
                <th style="min-width: 90px">Ng√†y k·∫øt th√∫c</th>
                <th style="width: 50px">Ghi ch√∫</th>
                <th style="width: 70px" id="khoaColumn">
                  <div class="form-check d-flex">
                    <input
                      class="check"
                      type="checkbox"
                      id="checkAllKhoa"
                      onclick="checkAll('khoa')"
                    />
                    <label class="form-check-label" for="checkAllKhoa"
                      >Khoa</label
                    >
                  </div>
                </th>
                <th style="width: 50px" id="daoTaoColumn">
                  <div class="form-check d-flex">
                    <input
                      class="check"
                      type="checkbox"
                      id="checkAllDaoTao"
                      onclick="checkAll('<%= APP_DEPARTMENTS.daoTao.toLowerCase() %>')"
                    />
                    <label
                      class="form-check-label text-nowrap"
                      for="checkAllDaoTao"
                      >ƒê√†o T·∫°o</label
                    >
                  </div>
                </th>
                <th style="width: 50px" id="VPColumn">
                  <div class="form-check d-flex">
                    <input
                      class="check"
                      type="checkbox"
                      id="checkAllVP"
                      onclick="checkAll('<%= APP_DEPARTMENTS.vanPhong %>')"
                    />
                    <label class="form-check-label text-nowrap" for="checkAllVP"
                      >VƒÉn ph√≤ng</label
                    >
                  </div>
                </th>
              </tr>
            </thead>
            <tbody id="tableBody">
              <tr>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td id="ankhoa"></td>
              </tr>
            </tbody>
          </table>
          <!-- Floating Summary Container -->
          <div class="summary-container">
            <div class="floating-box" id="summaryBox">
              <div>
                <strong>T·ªïng ti·∫øt m·ªùi gi·∫£ng:</strong>
                <span id="tietMoi">0</span>
              </div>
              <div>
                <strong>T·ªïng ti·∫øt c∆° h·ªØu:</strong>
                <span id="tietCoHuu">0</span>
              </div>
              <div id="tongTietChuaRoBox">
                <strong>T·ªïng ti·∫øt ch∆∞a r√µ:</strong>
                <span id="tietChuaRo">0</span>
              </div>
              <div>
                <strong>T·ªïng s·ªë ti·∫øt:</strong>
                <span id="tongTiet">0</span>
              </div>

              <!-- Link xem chi ti·∫øt -->
              <div>
                <span id="xemChiTiet" class="xem-chi-tiet popup-font-size"
                  >Xem chi ti·∫øt</span
                >
              </div>

              <div class="detail-popup" id="popupChiTiet"></div>
            </div>

            <button class="toggle-btn" id="toggleBtn">
              <!-- M≈©i t√™n SVG -->
              <svg
                id="arrowIcon"
                xmlns="http://www.w3.org/2000/svg"
                fill="none"
                stroke="currentColor"
                stroke-width="3"
                viewBox="0 0 24 24"
              >
                <path d="M15 6l-6 6 6 6" />
              </svg>
            </button>
          </div>
        </div>
        <div id="dataTableContainer" class="h-75"></div>
        <!-- Modal form -->
        <div id="modalBackdrop" style="display: none"></div>
        <!-- N·ªÅn t·ªëi -->
        <div id="noteForm" style="display: none">
          <h3>Ghi ch√∫</h3>
          <label for="noteInput">N·ªôi dung:</label>
          <textarea id="noteInput"></textarea>
          <!-- S·ª≠ d·ª•ng textarea cho ghi ch√∫ d√†i -->
          <br />
          <label for="deadlineInput">H·∫°n:</label>
          <input
            type="date"
            id="deadlineInput"
            style="
              width: 100%;
              padding: 5px;
              border: 1px solid #ccc;
              border-radius: 4px;
            "
          />
          <br />
          <div class="d-flex text-nowrap" style="text-align: right">
            <button onclick="saveNote()">L∆∞u</button>
            <button onclick="doneNote()">Ho√†n Th√†nh</button>
            <button class="cancel" onclick="closeNoteForm()">ƒê√≥ng</button>
          </div>
        </div>
      </div>
    </div>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Link script Sweet alert 2 -->
    <!-- SweetAlert2 CSS -->
    <link
      href="https://cdn.jsdelivr.net/npm/sweetalert2@11.6.16/dist/sweetalert2.min.css"
      rel="stylesheet"
    />

    <!-- SweetAlert2 JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.6.16/dist/sweetalert2.all.min.js"></script>

    <!-- Th√™m jQuery v√† jQuery UI -->
    <link
      rel="stylesheet"
      href="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css"
    />
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>

    <!-- jQuery UI CSS -->
    <link
      rel="stylesheet"
      href="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css"
    />

    <script>
      var globalData = [];
      let SoQDList = [];
      let tongTiet;

      document.addEventListener("DOMContentLoaded", function () {
        loadHeDoAnToSelect();

        const button = document.getElementById("infoDoAn");

        // G·ªçi h√†m hi·ªÉn th·ªã th√¥ng tin
        button.addEventListener("click", async function () {
          await loadData();

          if (SoQDList) {
            const listContainer = document.getElementById("SoQD-list");
            listContainer.innerHTML = SoQDList.map(
              (item) => `<li>Theo Qƒê s·ªë: ${item.SoQD}</li>`
            ).join("");
          }
        });

        async function loadData() {
          const isKhoa = localStorage.getItem("isKhoa");
          const MaKhoaHienTai = localStorage.getItem("MaPhongBan");

          try {
            let Dot = document.getElementById("combobox-dot").value;
            let ki = document.getElementById("combobox-ki").value;
            let NamHoc = document.getElementById("NamHoc").value;
            let MaPhongBan = document.getElementById("MaPhongBan").value;
            const he_dao_tao = document.getElementById("he_dao_tao").value;

            if (isKhoa == 1) {
              MaPhongBan = MaKhoaHienTai;
            }
            // T·∫°o ƒë·ªëi t∆∞·ª£ng d·ªØ li·ªáu ƒë·ªÉ g·ª≠i
            const requestData = {
              Dot: Dot,
              ki: ki,
              NamHoc: NamHoc,
              MaPhongBan: MaPhongBan,
              he_dao_tao,
            };

            // Fetch t√™n gi·∫£ng vi√™n m·ªùi
            const [infoGiangVienResponse, checkAllResponse, infoDoAnResponse] =
              await Promise.all([
                fetch("/getInfoGiangVien"),
                fetch(`/getCheckAllDoantotnghiep`, {
                  method: "POST", // S·ª≠ d·ª•ng ph∆∞∆°ng th·ª©c POST
                  headers: {
                    "Content-Type": "application/json", // ƒê·∫∑t Content-Type l√† application/json
                  },
                  body: JSON.stringify(requestData), // Chuy·ªÉn ƒë·ªïi ƒë·ªëi t∆∞·ª£ng th√†nh chu·ªói JSON
                }),
                fetch("/getInfoDoAn", {
                  method: "POST", // S·ª≠ d·ª•ng ph∆∞∆°ng th·ª©c POST
                  headers: {
                    "Content-Type": "application/json", // ƒê·∫∑t Content-Type l√† application/json
                  },
                  body: JSON.stringify(requestData), // Chuy·ªÉn ƒë·ªïi ƒë·ªëi t∆∞·ª£ng th√†nh chu·ªói JSON
                }),
              ]);

            if (!infoDoAnResponse.ok || !infoGiangVienResponse.ok) {
              Swal.fire({
                title: "Th√¥ng b√°o",
                html: "Kh√¥ng t√¨m th·∫•y d·ªØ li·ªáu",
                icon: "success",
                confirmButtonText: "OK",
                width: "auto", // T·ª± ƒë·ªông ƒëi·ªÅu ch·ªânh chi·ªÅu r·ªông
                padding: "20px", // Gi·ªØ kho·∫£ng c√°ch cho n·ªôi dung
              });
            }

            const dataDoAn = await infoDoAnResponse.json();
            const infoDoAn = dataDoAn.result;
            SoQDList = dataDoAn.SoQDList;
            tongTiet = dataDoAn.tongTiet;

            loadDataPopup();

            const infoGiangVien = await infoGiangVienResponse.json();
            const checkAll = await checkAllResponse.json();

            localStorage.setItem(
              "KhoaCheck",
              JSON.stringify(checkAll.KhoaCheck)
            );
            localStorage.setItem(
              "DaoTaoCheck",
              JSON.stringify(checkAll.DaoTaoCheck)
            );
            localStorage.setItem("VPCheck", JSON.stringify(checkAll.VPCheck));

            globalData = infoDoAn;
            localStorage.setItem("tableData", JSON.stringify(infoDoAn));
            localStorage.setItem(
              "allGV",
              JSON.stringify(infoGiangVien.data.allGV)
            );
            localStorage.setItem(
              "duplicateGV",
              JSON.stringify(infoGiangVien.data.duplicateGV)
            );

            renderTable(globalData); // G·ªçi h√†m renderTable sau khi ƒë√£ c√≥ ƒë·ªß d·ªØ li·ªáu
          } catch (error) {
            console.error("ƒê√£ c√≥ l·ªói x·∫£y ra:", error);
          }
        }
      });

      async function loadHeDoAnToSelect() {
        try {
          const res = await fetch('/api/gvm/v1/he-do-an');
          const json = await res.json();

          if (!json.success) {
            console.error('API l·ªói');
            return;
          }

          const select = document.getElementById('he_dao_tao');
          if (!select) return;

          // clear option c≈© (n·∫øu c·∫ßn reload)
          select.innerHTML = '';

          json.data.forEach(item => {
            const option = document.createElement('option');
            option.value = item.id;
            option.textContent = item.he_dao_tao;
            select.appendChild(option);
          });

        } catch (err) {
          console.error('L·ªói load h·ªá ƒë·ªì √°n:', err);
        }
      }

      const loadDataPopup = async () => {
        // Ph·∫ßn popup hi·ªÉn th·ªã t·ªïng s·ªë ti·∫øt
        const tietMapMoi = tongTiet.detailMoiGiang;
        const tietMapCoHuu = tongTiet.detailCoHuu;

        document.getElementById("tietMoi").innerText =
          tongTiet.tongTietMoiGiang;
        document.getElementById("tietCoHuu").innerText = tongTiet.tongTietCoHuu;
        document.getElementById("tongTiet").innerText = tongTiet.tongTietAll;

        if (tongTiet.tongTietChuaRo == 0) {
          document.getElementById("tongTietChuaRoBox").style.display = "none";
        } else {
          document.getElementById("tietChuaRo").innerText =
            tongTiet.tongTietChuaRo;
        }

        const popup = document.getElementById("popupChiTiet");
        const xemChiTiet = document.getElementById("xemChiTiet");

        xemChiTiet.addEventListener("click", (e) => {
          e.stopPropagation();
          popup.innerHTML = "";

          // --- Ph·∫ßn M·ªùi Gi·∫£ng ---
          const titleMoi = document.createElement("h6");
          titleMoi.innerText = "Gi·∫£ng vi√™n m·ªùi:";
          popup.appendChild(titleMoi);

          for (let gv in tietMapMoi) {
            const div = document.createElement("div");
            div.className = "detail-item";
            div.innerText = `${gv}: ${tietMapMoi[gv]} ti·∫øt`;
            popup.appendChild(div);
          }

          // --- Ph·∫ßn C∆° H·ªØu ---
          const titleCoHuu = document.createElement("h6");
          titleCoHuu.innerText = "Gi·∫£ng vi√™n c∆° h·ªØu:";
          titleCoHuu.style.marginTop = "10px";
          popup.appendChild(titleCoHuu);

          for (let gv in tietMapCoHuu) {
            const div = document.createElement("div");
            div.className = "detail-item";
            div.innerText = `${gv}: ${tietMapCoHuu[gv]} ti·∫øt`;
            popup.appendChild(div);
          }

          popup.style.display = "block";
        });

        document.addEventListener("click", () => {
          popup.style.display = "none";
        });

        popup.addEventListener("click", (e) => e.stopPropagation());

        const toggleBtn = document.getElementById("toggleBtn");
        const arrowIcon = document.getElementById("arrowIcon");
        const summaryBox = document.getElementById("summaryBox");

        let isVisible = false;
        toggleBtn.addEventListener("click", () => {
          isVisible = !isVisible;
          summaryBox.style.display = isVisible ? "block" : "none";
          arrowIcon.style.transform = isVisible
            ? "rotate(180deg)"
            : "rotate(0deg)";
        });
      };

      // H√†m l·ªçc th√¥ng tin trong b·∫£ng
      function filterTable() {
        const nameFilter = document
          .getElementById("filterName")
          .value.toLowerCase();
        const maSVFilter = document
          .getElementById("filterMaSV")
          .value.toLowerCase();
        const classFilter = document
          .getElementById("filterClass")
          .value.toLowerCase();
        const gvFilter = document
          .getElementById("filterNameGV")
          .value.toLowerCase();

        const tableRows = document.querySelectorAll("#tableBody tr");

        tableRows.forEach((row) => {
          const nameCell = row.querySelector("td:nth-child(2)"); // C·ªôt t√™n sinh vi√™n
          const maSVCell = row.querySelector("td:nth-child(3)"); // C·ªôt m√£ SV
          const classCell = row.querySelector("td:nth-child(7)"); // C·ªôt t√™n ƒë·ªÅ t√†i
          const gvCell1 = row.querySelector("td:nth-child(9)"); // GVHD 1
          const gvCell2 = row.querySelector("td:nth-child(10)"); // GVHD 2
          
          const gvInput1 = gvCell1 ? gvCell1.querySelector("input") : null;
          const gvInput2 = gvCell2 ? gvCell2.querySelector("input") : null;
          
          const name = nameCell ? nameCell.textContent.toLowerCase() : "";
          const maSV = maSVCell ? maSVCell.textContent.toLowerCase() : "";
          const className = classCell ? classCell.textContent.toLowerCase() : "";
          const gv1 = gvInput1 ? gvInput1.value.toLowerCase() : "";
          const gv2 = gvInput2 ? gvInput2.value.toLowerCase() : "";

          // Ki·ªÉm tra ƒëi·ªÅu ki·ªán l·ªçc
          const matchesName = name.includes(nameFilter);
          const matchesMaSV = maSV.includes(maSVFilter);
          const matchesClass = className.includes(classFilter);
          const matchesGV = gv1.includes(gvFilter) || gv2.includes(gvFilter);

          // Hi·ªán ho·∫∑c ·∫©n h√†ng d·ª±a tr√™n ƒëi·ªÅu ki·ªán l·ªçc
          if (matchesName && matchesMaSV && matchesClass && matchesGV) {
            row.style.display = ""; // Hi·ªán h√†ng n·∫øu t·∫•t c·∫£ c√°c ƒëi·ªÅu ki·ªán ƒë·ªÅu kh·ªõp
          } else {
            row.style.display = "none"; // ·∫®n h√†ng n·∫øu kh√¥ng kh·ªõp
          }
        });
      }

      // G√°n s·ª± ki·ªán cho c√°c input filter
      document
        .getElementById("filterName")
        .addEventListener("input", filterTable);
      document
        .getElementById("filterMaSV")
        .addEventListener("input", filterTable);
      document
        .getElementById("filterClass")
        .addEventListener("input", filterTable);
      document
        .getElementById("filterNameGV")
        .addEventListener("input", filterTable);

      // H√†m format l·∫°i Ng√†y ph√π h·ª£p v·ªõi m√∫i gi·ªù
      // H√†m chuy·ªÉn ƒë·ªãnh d·∫°ng chu·ªói t·ª´ ISO sang ƒë·ªãnh d·∫°ng YYYY-MM-DD
      function formatDateToInput(dateString) {
        if (!dateString) return ""; // Ki·ªÉm tra n·∫øu kh√¥ng c√≥ gi√° tr·ªã

        const utcBatDau = new Date(dateString);
        dateString = utcBatDau.toLocaleDateString("vi-VN"); // Ch·ªâ l·∫•y ph·∫ßn ng√†y

        // Chia t√°ch chu·ªói ng√†y th√†nh c√°c ph·∫ßn: nƒÉm, th√°ng, ng√†y
        const parts = dateString.split("/"); // T√°ch theo d·∫•u '-'
        if (parts.length != 3) return ""; // ƒê·∫£m b·∫£o ƒë·ªãnh d·∫°ng ƒë√∫ng

        const year = parts[2];
        const month = ("0" + parts[1]).slice(-2); // ƒê·∫£m b·∫£o th√°ng c√≥ 2 ch·ªØ s·ªë
        const day = ("0" + parts[0]).slice(-2); // ƒê·∫£m b·∫£o ng√†y c√≥ 2 ch·ªØ s·ªë

        // Tr·∫£ v·ªÅ chu·ªói ng√†y theo ƒë·ªãnh d·∫°ng "YYYY-MM-DD"
        return `${year}-${month}-${day}`;
      }

      function addDoubleClickEvents() {
        // get all date input fields
        let dateInputs = document.querySelectorAll('[type="date"]');

        dateInputs.forEach((el) => {
          // register double-click event to change date input to text input and select the value
          el.addEventListener("dblclick", () => {
            el.type = "text";

            // After changing input type with JS, .select() needs a timeout to work
            setTimeout(() => {
              el.select();
            });
          });

          // register the focusout event to reset the input back to a date input field
          el.addEventListener("focusout", () => {
            el.type = "date";
          });
        });
      }

      // H√†m hi·ªÉn th·ªã th√¥ng tin ra m√†n h√¨nh
      function renderTable(data) {
        const role = localStorage.getItem("userRole");
        const MaPhongBan = localStorage.getItem("MaPhongBan");
        const isKhoa = localStorage.getItem("isKhoa");
        const tableBody = document.getElementById("tableBody");
        tableBody.innerHTML = ""; // X√≥a n·ªôi dung c≈©

        // id truy·ªÅn v√†o ƒë·ªÉ ƒë√°nh d·∫•u m·ªói d√≤ng, m·ª•c ƒë√≠ch l·∫•y ph·∫ßn t·ª≠ v√† so s√°nh v·ªõi b·∫£ng trong localStorage
        data.forEach((row, id) => {
          const tableRow = document.createElement("tr");
          // G√°n ID trong csdl th√†nh attribute c·ªßa t·ª´ng h√†ng
          tableRow.setAttribute("data-id", row.ID);

          // TT
          const ttTd = document.createElement("td");
          ttTd.textContent = `${row.TT}` || "";
          tableRow.appendChild(ttTd);

          // Sinh Vi√™n
          const sinhVienTd = document.createElement("td");
          //sinhVienTd.style.maxWidth = "300px";
          sinhVienTd.textContent = row.SinhVien || "";
          tableRow.appendChild(sinhVienTd);

          // M√£ SV
          const maSVTd = document.createElement("td");
          maSVTd.textContent = row.MaSV || "";
          tableRow.appendChild(maSVTd);

          // Kh√≥a sinh vi√™n
          const khoaSinhVienTd = document.createElement("td");
          khoaSinhVienTd.textContent = row.khoa_sinh_vien || "";
          tableRow.appendChild(khoaSinhVienTd);

          // Ng√†nh
          const nganhTd = document.createElement("td");
          nganhTd.textContent = row.nganh || "";
          tableRow.appendChild(nganhTd);

          // T·∫°o c·ªôt Khoa ƒë·ªÉ ki·ªÉm tra check
          const MaPhongBanTd = document.createElement("td");
          MaPhongBanTd.textContent = row.MaPhongBan || ""; // L·∫•y gi√° tr·ªã Khoa tr·ª±c ti·∫øp t·ª´ row
          MaPhongBanTd.style.display = "none"; // ·∫®n c·ªôt n√†y
          tableRow.appendChild(MaPhongBanTd);

          // T√™n ƒë·ªÅ t√†i
          const tenDeTaiTd = document.createElement("td");
          tenDeTaiTd.textContent = row.TenDeTai || "";
          tableRow.appendChild(tenDeTaiTd);

          // Gi·∫£ng vi√™n h∆∞·ªõng d·∫´n
          const giangVienTd = document.createElement("td");

          // Thay th·∫ø xu·ªëng d√≤ng (\n) b·∫±ng th·∫ª <br> v√† g√°n v√†o innerHTML
          giangVienTd.innerHTML = (row.GiangVienDefault || "").replace(
            /\n/g,
            "<br>"
          );

          tableRow.appendChild(giangVienTd);

          // Gi·∫£ng vi√™n h∆∞·ªõng d·∫´n 1
          const giaoVienHuongDan1Td = document.createElement("td");
          const giaoVienHuongDan1Input = document.createElement("input");
          giaoVienHuongDan1Input.style.width = "100%";
          giaoVienHuongDan1Input.style.boxSizing = "border-box";

          giaoVienHuongDan1Input.type = "text";
          giaoVienHuongDan1Input.placeholder = "Nh·∫≠p t√™n gi·∫£ng vi√™n 1";
          giaoVienHuongDan1Input.value = row.GiangVien1 || "";
          // G√°n id cho input
          giaoVienHuongDan1Input.id = `GiangVien1-${id}`;
          giaoVienHuongDan1Input.name = "GV1";

          giaoVienHuongDan1Td.appendChild(giaoVienHuongDan1Input);
          tableRow.appendChild(giaoVienHuongDan1Td);

          giaoVienHuongDan1Td.appendChild(giaoVienHuongDan1Input);
          tableRow.appendChild(giaoVienHuongDan1Td);

          // Gi·∫£ng vi√™n h∆∞·ªõng d·∫´n 2

          const giaoVienHuongDan2Td = document.createElement("td");
          const giaoVienHuongDan2Input = document.createElement("input");
          giaoVienHuongDan2Input.style.width = "100%";
          giaoVienHuongDan2Input.style.boxSizing = "border-box";

          giaoVienHuongDan2Input.type = "text";
          giaoVienHuongDan2Input.placeholder = "Nh·∫≠p t√™n gi·∫£ng vi√™n 2";
          giaoVienHuongDan2Input.value = row.GiangVien2 || "";
          // G√°n id cho input
          giaoVienHuongDan2Input.id = `GiangVien2-${id}`;
          giaoVienHuongDan2Input.name = "GV2";

          giaoVienHuongDan2Td.appendChild(giaoVienHuongDan2Input);
          tableRow.appendChild(giaoVienHuongDan2Td);

          giaoVienHuongDan2Td.appendChild(giaoVienHuongDan2Input);
          tableRow.appendChild(giaoVienHuongDan2Td);

          // G·ªçi autocomplete ngay sau khi t·∫°o input
          showSuggestionsGiangVien(
            giaoVienHuongDan1Input,
            row.GiangVien1Real,
            1,
            row.ID,
            id
          );
          showSuggestionsGiangVien(
            giaoVienHuongDan2Input,
            row.GiangVien2Real,
            2,
            row.ID,
            id
          );

          // T·∫°o 2 c·ªôt l∆∞u t√™n gi·∫£ng vi√™n ƒë·ªÉ so s√°nh
          const GiangVien1Real = document.createElement("td");
          GiangVien1Real.textContent = row.GiangVien1Real || "";
          GiangVien1Real.id = `GiangVien1Real-${id}`;
          GiangVien1Real.style.display = "none"; // ·∫®n input b·∫±ng CSS
          tableRow.appendChild(GiangVien1Real);

          const GiangVien2Real = document.createElement("td");
          GiangVien2Real.textContent = row.GiangVien2Real || "";
          GiangVien2Real.id = `GiangVien2Real-${id}`;
          GiangVien2Real.style.display = "none"; // ·∫®n input b·∫±ng CSS
          tableRow.appendChild(GiangVien2Real);

          // Ng√†y B·∫Øt ƒê·∫ßu

          const NgayBatDauTd = document.createElement("td");
          const NgayBatDauInput = document.createElement("input");
          NgayBatDauTd.style.maxWidth = "95px"; // Ho·∫∑c k√≠ch th∆∞·ªõc mong mu·ªën
          NgayBatDauInput.style.width = "100%";
          NgayBatDauInput.style.boxSizing = "border-box";

          NgayBatDauInput.type = "date";
          NgayBatDauInput.id = `NgayBatDau-${id}`; // Th√™m id
          NgayBatDauInput.value = formatDateToInput(row.NgayBatDau);
          NgayBatDauTd.appendChild(NgayBatDauInput);
          tableRow.appendChild(NgayBatDauTd);

          // Ng√†y K·∫øt Th√∫c
          const NgayKetThucTd = document.createElement("td");
          const NgayKetThucInput = document.createElement("input");
          NgayKetThucTd.style.maxWidth = "95px"; // Ho·∫∑c k√≠ch th∆∞·ªõc mong mu·ªën
          NgayKetThucInput.style.width = "100%";
          NgayKetThucInput.style.boxSizing = "border-box";

          NgayKetThucInput.type = "date";
          NgayKetThucInput.id = `NgayKetThuc-${id}`; // Th√™m id
          NgayKetThucInput.value = formatDateToInput(row.NgayKetThuc);
          NgayKetThucTd.appendChild(NgayKetThucInput);
          tableRow.appendChild(NgayKetThucTd);

          // Ghi ch√∫
          const ghiChuTd = document.createElement("td");
          const ghiChuValue =
            row.GhiChu && row.GhiChu.trim() !== "" ? row.GhiChu : false;
          const deadlineValue = row.Deadline || ""; // L·∫•y gi√° tr·ªã Deadline
          const hoanThanh = row.HoanThanh;
          if (role === APP_ROLES.gv || role === APP_ROLES.thuong) {
            ghiChuTd.innerHTML = "üìú"; // Hi·ªÉn th·ªã bi·ªÉu t∆∞·ª£ng ghi ch√∫ n·∫øu role l√† GV ho·∫∑c Th∆∞·ªùng
            ghiChuTd.style.cursor = "not-allowed"; // Thay ƒë·ªïi con tr·ªè chu·ªôt th√†nh 'not-allowed' ƒë·ªÉ b√°o hi·ªáu kh√¥ng th·ªÉ t∆∞∆°ng t√°c
            ghiChuTd.title = "B·∫°n kh√¥ng c√≥ quy·ªÅn truy c·∫≠p"; // Th√™m tooltip ƒë·ªÉ gi·∫£i th√≠ch l√Ω do kh√¥ng th·ªÉ nh·∫•n
          } else {
            if (ghiChuValue) {
              if (hoanThanh) {
                ghiChuTd.innerHTML = `üìú <span class="bi bi-check2-circle" style="color: green;"></span>`; // Hi·ªÉn th·ªã bi·ªÉu t∆∞·ª£ng ghi ch√∫ v√† ch·∫•m ƒë·ªè
              } else {
                ghiChuTd.innerHTML = `üìú <span class="bi bi-circle" style="color: red;"></span>`; // Hi·ªÉn th·ªã bi·ªÉu t∆∞·ª£ng ghi ch√∫ v√† ch·∫•m ƒë·ªè
              }
            } else {
              ghiChuTd.innerHTML = "üìú"; // Hi·ªÉn th·ªã bi·ªÉu t∆∞·ª£ng ghi ch√∫ n·∫øu kh√¥ng c√≥ ghi ch√∫
            }
            ghiChuTd.style.cursor = "pointer"; // Thay ƒë·ªïi con tr·ªè chu·ªôt khi di chu·ªôt qua bi·ªÉu t∆∞·ª£ng
            ghiChuTd.onclick = () =>
              openNoteForm(tableRow, ghiChuValue, deadlineValue); // G·ªçi h√†m m·ªü form khi nh·∫•n v√†o bi·ªÉu t∆∞·ª£ng
          }
          tableRow.appendChild(ghiChuTd); // Th√™m √¥ ghi ch√∫ v√†o h√†ng

          let khoaCheckboxTd, khoaCheckbox;
          // Checkbox cho Khoa
          khoaCheckboxTd = document.createElement("td");
          khoaCheckbox = document.createElement("input");
          khoaCheckbox.type = "checkbox";
          khoaCheckbox.style.marginLeft = "30px";
          khoaCheckbox.name = "khoa"; // Th√™m thu·ªôc t√≠nh name
          khoaCheckbox.checked = row.KhoaDuyet || false; // D√πng m·ªôt tr∆∞·ªùng cho checkbox
          khoaCheckbox.onchange = () => updateCheckAll("khoa"); // G·ªçi h√†m khi checkbox thay ƒë·ªïi
          khoaCheckboxTd.appendChild(khoaCheckbox);
          tableRow.appendChild(khoaCheckboxTd);
          // ·∫©n ƒëi
          khoaCheckbox.style.display = "none";

          let daoTaoCheckboxTd, daoTaoCheckbox;

          // Checkbox cho ƒê√†o T·∫°o
          daoTaoCheckboxTd = document.createElement("td");
          daoTaoCheckbox = document.createElement("input");
          daoTaoCheckbox.type = "checkbox";
          daoTaoCheckbox.style.marginLeft = "30px";
          daoTaoCheckbox.name = "<%= APP_DEPARTMENTS.daoTao.toLowerCase() %>"; // Th√™m thu·ªôc t√≠nh name
          daoTaoCheckbox.checked = row.DaoTaoDuyet || false; // D√πng m·ªôt tr∆∞·ªùng cho checkbox
          daoTaoCheckbox.onchange = () => updateCheckAll("<%= APP_DEPARTMENTS.daoTao.toLowerCase() %>"); // G·ªçi h√†m khi checkbox thay ƒë·ªïi
          daoTaoCheckboxTd.appendChild(daoTaoCheckbox);
          tableRow.appendChild(daoTaoCheckboxTd);
          // ·∫©n ƒëi
          daoTaoCheckbox.style.display = "none";

          // Checkbox t√†i ch√≠nh
          let VPCheckboxTd, VPCheckbox;

          VPCheckboxTd = document.createElement("td");
          VPCheckbox = document.createElement("input");
          VPCheckbox.type = "checkbox";
          VPCheckbox.style.marginLeft = "30px";
          VPCheckbox.name = "<%= APP_DEPARTMENTS.vanPhong %>"; // Th√™m thu·ªôc t√≠nh name
          VPCheckbox.checked = row.TaiChinhDuyet || false; // D√πng m·ªôt tr∆∞·ªùng cho checkbox
          VPCheckbox.onchange = () => updateCheckAll("<%= APP_DEPARTMENTS.vanPhong %>"); // G·ªçi h√†m khi checkbox thay ƒë·ªïi
          VPCheckboxTd.appendChild(VPCheckbox);
          tableRow.appendChild(VPCheckboxTd);
          // ·∫®n ƒëi
          VPCheckbox.style.display = "none";

          if (isKhoa == 1 && role == APP_ROLES.lanhDao_khoa) {
            khoaCheckbox.style.display = "block";
          } else if (isKhoa == 0 && (role == APP_ROLES.troLy_phong || role == APP_ROLES.lanhDao_phong)) {
            if (MaPhongBan == APP_DEPARTMENTS.daoTao) {
              khoaCheckbox.style.display = "block";
              daoTaoCheckbox.style.display = "block";
              VPCheckbox.style.display = "none";
            } else if (MaPhongBan == APP_DEPARTMENTS.vanPhong) {
              // S·ª≠a l·ªói: hi·ªÉn th·ªã checkbox cho c·ªôt VƒÉn Ph√≤ng
              khoaCheckbox.style.display = "block";
              daoTaoCheckbox.style.display = "block";
              VPCheckbox.style.display = "block";
            }
          }

          // N·∫øu kh√¥ng ph·∫£i khoa -> kh√¥ng c√≥ quy·ªÅn nh·∫≠p

          if (isKhoa == 0) {
            giaoVienHuongDan1Input.disabled = true;
            giaoVienHuongDan2Input.disabled = true;
            NgayBatDauInput.disabled = true;
            NgayKetThucInput.disabled = true;
          }

          if (
            (isKhoa == 1 && role == APP_ROLES.gv) ||
            (isKhoa == 1 && row.KhoaDuyet == 1)
          ) {
            giaoVienHuongDan1Input.disabled = true;
            giaoVienHuongDan2Input.disabled = true;
            NgayBatDauInput.disabled = true;
            NgayKetThucInput.disabled = true;
          }

          const KhoaCheck = localStorage.getItem("KhoaCheck");
          const DaoTaoCheck = localStorage.getItem("DaoTaoCheck");
          const VPCheck = localStorage.getItem("VPCheck");
          // Ph√¢n quy·ªÅn theo ph√≤ng ban
          if (isKhoa == 1) {
            // N·∫øu l√† khoa
            if (KhoaCheck.includes(MaPhongBan)) {
              //giaoVienGiangDayInput.disabled = true;
              giaoVienHuongDan1Input.disabled = true;

              giaoVienHuongDan2Input.disabled = true;
              khoaCheckbox.disabled = true;

              disableCheckAll("khoa");
            }
          }

          if (
            MaPhongBan.toLowerCase() === APP_DEPARTMENTS.daoTao.toLowerCase() &&
            role.toLowerCase() !== APP_ROLES.thuong.toLowerCase()
          ) {
            const isKhoaChecked = KhoaCheck.includes(row.MaPhongBan);
            const isDaoTaoChecked = DaoTaoCheck.includes(row.MaPhongBan);
            
            // Logic cho Tr·ª£ l√Ω ph√≤ng
            if (role.toLowerCase() === APP_ROLES.troLy_phong.toLowerCase()) {
              if (!isKhoaChecked) {
                // N·∫øu khoa ch∆∞a check ‚Üí V√¥ hi·ªáu h√≥a c·∫£ c·ªôt Khoa v√† ƒê√†o T·∫°o
                khoaCheckbox.disabled = true;
                daoTaoCheckbox.disabled = true;
              } else if (isKhoaChecked && !isDaoTaoChecked) {
                // N·∫øu khoa ƒë√£ check v√† ƒê√†o T·∫°o ch∆∞a duy·ªát ‚Üí Cho ph√©p thao t√°c c·∫£ 2 c·ªôt
                khoaCheckbox.disabled = false;
                daoTaoCheckbox.disabled = false;
              } else if (isDaoTaoChecked) {
                // N·∫øu ƒê√†o T·∫°o ƒë√£ duy·ªát ‚Üí V√¥ hi·ªáu h√≥a c·∫£ 2 c·ªôt
                khoaCheckbox.disabled = true;
                daoTaoCheckbox.disabled = true;
              }
            }
            // Logic cho L√£nh ƒë·∫°o ph√≤ng
            else if (role.toLowerCase() === APP_ROLES.lanhDao_phong.toLowerCase()) {
              // Kh√¥ng ƒë∆∞·ª£c thao t√°c c·ªôt Khoa
              khoaCheckbox.disabled = true;
              
              if (isDaoTaoChecked) {
                // N·∫øu ƒê√†o T·∫°o ƒë√£ duy·ªát ‚Üí Cho ph√©p b·ªè duy·ªát (ch·ªâ t·ª´ checked ‚Üí unchecked)
                daoTaoCheckbox.disabled = false;
                // Th√™m x·ª≠ l√Ω ƒë·ªÉ ch·ªâ cho ph√©p b·ªè duy·ªát, kh√¥ng cho ph√©p duy·ªát m·ªõi
                daoTaoCheckbox.addEventListener('change', function() {
                  if (this.checked && isDaoTaoChecked) {
                    // N·∫øu c·ªë g·∫Øng check l·∫°i khi ƒë√£ ƒë∆∞·ª£c duy·ªát, kh√¥ng cho ph√©p
                    this.checked = false;
                  }
                });
              } else {
                // N·∫øu ƒê√†o T·∫°o ch∆∞a duy·ªát ‚Üí Kh√¥ng cho ph√©p duy·ªát m·ªõi
                daoTaoCheckbox.disabled = true;
              }
            }
          }

          if (
            MaPhongBan.toLowerCase() === APP_DEPARTMENTS.vanPhong.toLowerCase() &&
            role.toLowerCase() !== APP_ROLES.thuong.toLowerCase()
          ) {
            // N·∫øu ƒë√†o t·∫°o ch∆∞a check th√¨ disable checkbox VP
            if (!DaoTaoCheck.includes(row.MaPhongBan)) {
              // NgƒÉn thay ƒë·ªïi tr·∫°ng th√°i check box ƒë√†o t·∫°o v√† VP
              daoTaoCheckbox.disabled = true;
              VPCheckbox.disabled = true;
            }

            // N·∫øu VP ƒë√£ check th√¨ disable t·∫•t c·∫£ checkbox
            if (VPCheck.includes(row.MaPhongBan)) {
              // NgƒÉn thay ƒë·ªïi tr·∫°ng th√°i check box
              khoaCheckbox.disabled = true;
              daoTaoCheckbox.disabled = true;
              VPCheckbox.disabled = true;
            }
          }

          // Th√™m h√†ng v√†o body c·ªßa b·∫£ng
          tableBody.appendChild(tableRow);
        });

        // Th√™m ƒë·ªÉ chuy·ªÉn ki·ªÉu d·ªØ li·ªáu ng√†y th√†nh text khi double click v√†o
        addDoubleClickEvents();
      }

      // Fill all startDate and endDate
      document.getElementById("fillDay").addEventListener("click", function () {
        const startDateValue = document.getElementById("startDateAll").value;
        const endDateValue = document.getElementById("endDateAll").value;

        // Ch·ªâ ti·∫øp t·ª•c n·∫øu ng∆∞·ªùi d√πng ƒë√£ ch·ªçn c·∫£ ng√†y b·∫Øt ƒë·∫ßu v√† ng√†y k·∫øt th√∫c
        if (!startDateValue || !endDateValue) {
          Swal.fire({
            title: "Th√¥ng b√°o",
            html: "Vui l√≤ng ch·ªçn c·∫£ ng√†y b·∫Øt ƒë·∫ßu v√† ng√†y k·∫øt th√∫c.",
            icon: "info",
            confirmButtonText: "OK",
            width: "auto", // T·ª± ƒë·ªông ƒëi·ªÅu ch·ªânh chi·ªÅu r·ªông
            padding: "20px", // Gi·ªØ kho·∫£ng c√°ch cho n·ªôi dung
          });
          return;
        }

        // Ch√®n ng√†y b·∫Øt ƒë·∫ßu, b·ªè qua c√°c √¥ b·ªã disable
        document
          .querySelectorAll("input[id^='NgayBatDau-']")
          .forEach((input) => {
            if (!input.disabled && input.offsetParent !== null) {
              input.value = startDateValue;
            }
          });

        // Ch√®n ng√†y k·∫øt th√∫c, b·ªè qua c√°c √¥ b·ªã disable
        document
          .querySelectorAll("input[id^='NgayKetThuc-']")
          .forEach((input) => {
            if (!input.disabled && input.offsetParent !== null) {
              input.value = endDateValue;
            }
          });

        let data = getDataToStored();

        fetch("/updateDoAnDateAll", {
          method: "POST", // Ph∆∞∆°ng th·ª©c POST
          headers: {
            "Content-Type": "application/json", // ƒê·ªãnh d·∫°ng g·ª≠i l√† JSON
          },
          body: JSON.stringify(data), // Chuy·ªÉn ƒë·ªïi data ƒë√£ c·∫≠p nh·∫≠t th√†nh chu·ªói JSON
        })
          .then((response) => {
            if (!response.ok) {
              throw new Error("L·ªói khi g·ª≠i d·ªØ li·ªáu");
            }
            return response.json(); // Chuy·ªÉn ƒë·ªïi ph·∫£n h·ªìi th√†nh JSON
          })
          .then((data) => {
            // Hi·ªÉn th·ªã th√¥ng b√°o t·ª´ server
            Swal.fire({
              title: "Th√¥ng b√°o",
              html: data.message,
              icon: "success",
              confirmButtonText: "OK",
              width: "auto", // T·ª± ƒë·ªông ƒëi·ªÅu ch·ªânh chi·ªÅu r·ªông
              padding: "20px", // Gi·ªØ kho·∫£ng c√°ch cho n·ªôi dung
            });
          })
          .catch((error) => {
            Swal.fire({
              title: "Th√¥ng b√°o",
              html: "C√≥ l·ªói x·∫£y ra khi c·∫≠p nh·∫≠t d·ªØ li·ªáu.",
              icon: "info",
              confirmButtonText: "OK",
              width: "auto", // T·ª± ƒë·ªông ƒëi·ªÅu ch·ªânh chi·ªÅu r·ªông
              padding: "20px", // Gi·ªØ kho·∫£ng c√°ch cho n·ªôi dung
            });
          });
      });

      function checkAll(type) {
        const checkboxes = document.querySelectorAll(
          `input[type="checkbox"][name="${type}"]`
        );
        
        // Map type names to correct ID names for checkAll checkbox
        let checkAllId;
        if (type === 'khoa') {
          checkAllId = 'checkAllKhoa';
        } else if (type === '<%= APP_DEPARTMENTS.daoTao.toLowerCase() %>') {
          checkAllId = 'checkAllDaoTao';
        } else if (type === '<%= APP_DEPARTMENTS.vanPhong %>') {
          checkAllId = 'checkAllVP';
        } else {
          // Fallback for other types - use original logic
          checkAllId = `checkAll${type.charAt(0).toUpperCase() + type.slice(1)}`;
        }
        
        const checkAllCheckbox = document.getElementById(checkAllId);

        for (const checkbox of checkboxes) {
          if (checkbox.disabled || !checkbox.offsetParent) {
            continue; // B·ªè qua checkbox b·ªã v√¥ hi·ªáu h√≥a
          }

          const row = checkbox.closest("tr");
          if (row.style.display == "none") {
            // Ki·ªÉm tra n·∫øu d√≤ng hi·ªán tr√™n m√†n h√¨nh
            continue; // G√°n tr·∫°ng th√°i checkbox "Check All" cho checkbox hi·ªÉn th·ªã
          }

          checkbox.checked = checkAllCheckbox.checked; // G√°n gi√° tr·ªã checked cho checkbox kh√¥ng b·ªã v√¥ hi·ªáu h√≥a
        }
      }

      function updateCheckAll(type) {
        const checkboxes = document.querySelectorAll(
          `input[type="checkbox"][name="${type}"]`
        );
        
        // Map type names to correct ID names for checkAll checkbox
        let checkAllId;
        if (type === 'khoa') {
          checkAllId = 'checkAllKhoa';
        } else if (type === '<%= APP_DEPARTMENTS.daoTao.toLowerCase() %>') {
          checkAllId = 'checkAllDaoTao';
        } else if (type === '<%= APP_DEPARTMENTS.vanPhong %>') {
          checkAllId = 'checkAllVP';
        } else {
          // Fallback for other types - use original logic
          checkAllId = `checkAll${type.charAt(0).toUpperCase() + type.slice(1)}`;
        }
        
        const checkAllCheckbox = document.getElementById(checkAllId);

        // Ki·ªÉm tra n·∫øu t·∫•t c·∫£ checkbox c√° nh√¢n ƒë·ªÅu ƒë∆∞·ª£c ch·ªçn
        const allChecked = Array.from(checkboxes).every(
          (checkbox) => checkbox.checked
        );
        checkAllCheckbox.checked = allChecked; // C·∫≠p nh·∫≠t tr·∫°ng th√°i c·ªßa checkbox "Check All"
      }

      function disableCheckAll(type) {
        // Map type names to correct ID names for checkAll checkbox
        let checkAllId;
        if (type === 'khoa') {
          checkAllId = 'checkAllKhoa';
        } else if (type === '<%= APP_DEPARTMENTS.daoTao.toLowerCase() %>') {
          checkAllId = 'checkAllDaoTao';
        } else if (type === '<%= APP_DEPARTMENTS.vanPhong %>') {
          checkAllId = 'checkAllVP';
        } else {
          // Fallback for other types - use original logic
          checkAllId = `checkAll${type.charAt(0).toUpperCase() + type.slice(1)}`;
        }
        
        const checkAllCheckbox = document.getElementById(checkAllId);

        if (checkAllCheckbox) {
          // NgƒÉn kh√¥ng cho ng∆∞·ªùi d√πng thay ƒë·ªïi checkbox t·ªïng
          checkAllCheckbox.addEventListener("click", function (e) {
            e.preventDefault(); // NgƒÉn thay ƒë·ªïi tr·∫°ng th√°i
          });
        }
      }

      // L·∫•y d·ªØ li·ªáu ƒë·ªÉ l∆∞u
      function getDataToStored() {
        const isKhoa = localStorage.getItem("isKhoa");
        const rows = document.querySelectorAll("#tableBody tr"); // L·∫•y t·∫•t c·∫£ c√°c h√†ng trong b·∫£ng
        const data = JSON.parse(localStorage.getItem("tableData"));

        rows.forEach((row, id) => {
          // L·∫•y gi√° tr·ªã ng√†y b·∫Øt ƒë·∫ßu, ng√†y k·∫øt th√∫c

          const NgayBatDau = document.getElementById(`NgayBatDau-${id}`);
          const NgayKetThuc = document.getElementById(`NgayKetThuc-${id}`);

          // L·∫•y c√°c gi√° tr·ªã t·ª´ c√°c √¥ nh·∫≠p Gi·∫£ng vi√™n
          const GiangVien1 = document.getElementById(`GiangVien1-${id}`);
          const GiangVien2 = document.getElementById(`GiangVien2-${id}`);

          // L·∫•y gi√° tr·ªã c·ªßa checkbox "Khoa", "ƒê√†o T·∫°o", v√† "T√†i Ch√≠nh"
          const khoaCheckbox = row.querySelector(
            'input[type="checkbox"][name="khoa"]'
          );
          const daoTaoCheckbox = row.querySelector(
            'input[type="checkbox"][name="<%= APP_DEPARTMENTS.daoTao.toLowerCase() %>"]'
          );
          const VPCheckbox = row.querySelector(
            'input[type="checkbox"][name="<%= APP_DEPARTMENTS.vanPhong %>"]'
          );

          // L·∫•y tr·∫°ng th√°i c·ªßa checkbox "Khoa"
          let khoaDuyet = khoaCheckbox ? khoaCheckbox.checked : false;

          // L·∫•y tr·∫°ng th√°i c·ªßa checkbox "ƒê√†o T·∫°o"
          const daoTaoDuyet = daoTaoCheckbox ? daoTaoCheckbox.checked : false;

          // L·∫•y tr·∫°ng th√°i c·ªßa checkbox "T√†i Ch√≠nh"
          let VPDuyet = VPCheckbox ? VPCheckbox.checked : false;

          if (isKhoa == 1) {
            // C·∫≠p nh·∫≠t v√†o m·∫£ng globalData t∆∞∆°ng ·ª©ng v·ªõi ch·ªâ m·ª•c h√†ng (index)

            data[id].GiangVien1 = GiangVien1.value;
            data[id].GiangVien2 = GiangVien2.value;

            data[id].NgayBatDau = NgayBatDau.value;
            data[id].NgayKetThuc = NgayKetThuc.value;
          }

          data[id].KhoaDuyet = khoaDuyet; // C·∫≠p nh·∫≠t Khoa

          data[id].DaoTaoDuyet = daoTaoDuyet; // C·∫≠p nh·∫≠t ƒê√†o T·∫°o

          data[id].TaiChinhDuyet = VPDuyet; // C·∫≠p nh·∫≠t T√†i Ch√≠nh
        });

        return data;
      }

      // L∆∞u d·ªØ li·ªáu v√†o table doantotnghiep
      document
        .getElementById("updateDoAn")
        .addEventListener("click", function () {
          const NamHoc = document.getElementById("NamHoc").value;
          const MaPhongBan = document.getElementById("MaPhongBan").value;
          const Dot = document.getElementById("combobox-dot").value;
          const ki = document.getElementById("combobox-ki").value;
          const he_dao_tao = document.getElementById("he_dao_tao").value;

          let data = getDataToStored();

          // G·ª≠i d·ªØ li·ªáu qua API
          fetch(
            `/api/doan/quy-chuan/update-do-an?NamHoc=${encodeURIComponent(
              NamHoc
            )}&MaPhongBan=${encodeURIComponent(
              MaPhongBan
            )}&Dot=${encodeURIComponent(Dot)}&ki=${encodeURIComponent(
              ki
            )}&he_dao_tao=${encodeURIComponent(he_dao_tao)}`,
            {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify(data),
            }
          )
            .then((response) => {
              if (!response.ok) {
                throw new Error("L·ªói khi g·ª≠i d·ªØ li·ªáu");
              }
              return response.json(); // Chuy·ªÉn ƒë·ªïi ph·∫£n h·ªìi th√†nh JSON
            })
            .then((data) => {
              let thongBao = "info";
              if (data.message.toLowerCase() == "c·∫≠p nh·∫≠t th√†nh c√¥ng") {
                thongBao = "success";
              }

              const messageWithLineBreaks = data.message.replace(/\n/g, "<br>");

              Swal.fire({
                title: "Th√¥ng b√°o",
                html: messageWithLineBreaks,
                icon: thongBao,
                confirmButtonText: "OK",
                width: "auto", // T·ª± ƒë·ªông ƒëi·ªÅu ch·ªânh chi·ªÅu r·ªông
                padding: "20px", // Gi·ªØ kho·∫£ng c√°ch cho n·ªôi dung
              });
            })
            .catch((error) => {
              console.error("C√≥ l·ªói x·∫£y ra:", error);
              Swal.fire({
                title: "Th√¥ng b√°o",
                html: "C√≥ l·ªói x·∫£y ra khi c·∫≠p nh·∫≠t d·ªØ li·ªáu.",
                icon: "info",
                confirmButtonText: "OK",
                width: "auto", // T·ª± ƒë·ªông ƒëi·ªÅu ch·ªânh chi·ªÅu r·ªông
                padding: "20px", // Gi·ªØ kho·∫£ng c√°ch cho n·ªôi dung
              });
            });
        });

      // L∆∞u d·ªØ li·ªáu sau khi t√†i ch√≠nh ƒë√£ duy·ªát v√†o table exportdoan
      document
        .getElementById("saveDataDoAn")
        .addEventListener("click", function () {
          const NamHoc = document.getElementById("NamHoc").value;
          const MaPhongBan = document.getElementById("MaPhongBan").value;
          const Dot = document.getElementById("combobox-dot").value;
          const ki = document.getElementById("combobox-ki").value;
          const he_dao_tao = document.getElementById("he_dao_tao").value;

          const requestData = {
            Dot: Dot,
            ki: ki,
            NamHoc: NamHoc,
            MaPhongBan: MaPhongBan,
            he_dao_tao,
          };

          // G·ª≠i d·ªØ li·ªáu qua API
          fetch(`/saveToExportDoAn`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify(requestData),
          })
            .then((response) => {
              if (!response.ok) {
                throw new Error("L·ªói khi g·ª≠i d·ªØ li·ªáu");
              }
              return response.json(); // Chuy·ªÉn ƒë·ªïi ph·∫£n h·ªìi th√†nh JSON
            })
            .then((data) => {
              Swal.fire({
                title: "Th√¥ng b√°o",
                html: data.message,
                icon: "success",
                confirmButtonText: "OK",
                width: "auto", // T·ª± ƒë·ªông ƒëi·ªÅu ch·ªânh chi·ªÅu r·ªông
                padding: "20px", // Gi·ªØ kho·∫£ng c√°ch cho n·ªôi dung
              });
            })
            .catch((error) => {
              console.error("C√≥ l·ªói x·∫£y ra:", error);
              Swal.fire({
                title: "Th√¥ng b√°o",
                html: "C√≥ l·ªói x·∫£y ra khi c·∫≠p nh·∫≠t d·ªØ li·ªáu.",
                icon: "info",
                confirmButtonText: "OK",
                width: "auto", // T·ª± ƒë·ªông ƒëi·ªÅu ch·ªânh chi·ªÅu r·ªông
                padding: "20px", // Gi·ªØ kho·∫£ng c√°ch cho n·ªôi dung
              });
            });
        });

      // H√†m hi·ªÉn th·ªã g·ª£i √Ω ƒë√£ ƒë∆∞·ª£c c·∫≠p nh·∫≠t
      function showSuggestions(input, GiangVienDefault, position, id, stt) {
        // id ƒë·ªÉ l·∫•y ch√≠nh x√°c d·ªØ li·ªáu gi·∫£ng vi√™n trong csdl, stt ƒë·ªÉ l·∫•y thu·ªôc t√≠nh id c·ªßa d√≤ng
        const value = input.value.toLowerCase(); // L·∫•y gi√° tr·ªã nh·∫≠p v√†o v√† chuy·ªÉn th√†nh ch·ªØ th∆∞·ªùng
        hideSuggestions(); // ·∫®n g·ª£i √Ω c≈© tr∆∞·ªõc khi hi·ªÉn th·ªã g·ª£i √Ω

        // T·∫°o th·∫ª div ch·ª©a g·ª£i √Ω
        const suggestionsContainer = document.createElement("div");
        suggestionsContainer.className = "suggestions"; // ƒê·∫∑t class cho khung g·ª£i √Ω

        // ƒê·∫∑t v·ªã tr√≠ cho suggestionsContainer
        const { bottom, left, width } = input.getBoundingClientRect();
        suggestionsContainer.style.position = "absolute";
        suggestionsContainer.style.top = `${bottom + window.scrollY}px`;
        suggestionsContainer.style.left = `${left + window.scrollX}px`;
        suggestionsContainer.style.width = `${width}px`;
        suggestionsContainer.style.zIndex = "1000";
        suggestionsContainer.style.maxHeight = "200px";
        suggestionsContainer.style.overflowY = "auto";

        // Th√™m suggestionsContainer v√†o DOM
        document.body.appendChild(suggestionsContainer);

        let suggestions = [];

        // L·∫•y d·ªØ li·ªáu t·ª´ localStorage
        const duplicateGV =
          JSON.parse(localStorage.getItem("duplicateGV")) || [];
        const allGV = JSON.parse(localStorage.getItem("allGV")) || [];

        // So s√°nh xem gi·∫£ng vi√™n c√≥ b·ªã tr√πng kh√¥ng
        /*
        if (position == '1') {
          suggestions = duplicateGV
          .filter(item => item.HoTenReal == GiangVienDefault)  // ƒêi·ªÅu ki·ªán l·ªçc
          .map(item => `${item.HoTen} - ${item.BienChe} - ${item.CCCD}`);
        } else if (position == '2') {
          suggestions = duplicateGV
          .filter(item => item.HoTenReal == GiangVienDefault)  // ƒêi·ªÅu ki·ªán l·ªçc
          .map(item => `${item.HoTen} - ${item.BienChe} - ${item.CCCD}`);
        }
          */

        let isAll = false;
        if (suggestions.length < 1) {
          isAll = true;
          suggestions = allGV.map(
            (item) => `${item.HoTen} - ${item.BienChe} - ${item.CCCD}`
          );
        }

        // L·ªçc g·ª£i √Ω theo gi√° tr·ªã nh·∫≠p v√†o
        if (value) {
          suggestions = suggestions.filter((name) =>
            name.toLowerCase().includes(value)
          );
        }

        // N·∫øu kh√¥ng c√≥ g·ª£i √Ω, ·∫©n container
        if (suggestions.length === 0) {
          suggestionsContainer.remove();
          return;
        }

        // T·∫°o c√°c suggestionItem cho m·ªói g·ª£i √Ω
        suggestions.forEach((name) => {
          const suggestionItem = document.createElement("div"); // T·∫°o m·ªõi ph·∫ßn t·ª≠ cho g·ª£i √Ω
          suggestionItem.className = "suggestion-item"; // ƒê·∫∑t class cho g·ª£i √Ω
          suggestionItem.textContent = name; // Thi·∫øt l·∫≠p n·ªôi dung cho g·ª£i √Ω

          // Th√™m s·ª± ki·ªán click
          suggestionItem.onclick = function () {
            const tableData = JSON.parse(localStorage.getItem("tableData"));
            // T√¨m item d·ª±a tr√™n `TT` (ho·∫∑c b·∫•t k·ª≥ thu·ªôc t√≠nh n√†o b·∫°n so s√°nh)
            const itemID = tableData.find((item) => item.ID == id);

            // L·∫•y t√™n gi·∫£ng vi√™n t·ª´ g·ª£i √Ω ƒë√£ ch·ªçn
            const selectedName = name.split(" - ")[0]; // T√°ch t√™n ra kh·ªèi Bi√™n ch·∫ø v√† CCCD
            const selectedCCCD = name.split(" - ")[2];

            let arrayGV;

            if (isAll) {
              arrayGV = Array.isArray(allGV) ? allGV : Object.values(allGV);
            } else {
              arrayGV = Array.isArray(duplicateGV)
                ? duplicateGV
                : Object.values(duplicateGV);
            }

            const lecturerFound = arrayGV.find(
              (lecturer) => lecturer.CCCD.trim() == selectedCCCD.trim()
            );

            if (lecturerFound) {
              if (itemID !== -1) {
                // Ki·ªÉm tra n·∫øu c√≥ id
                if (position == 1) {
                  const GiangVien1 = document.getElementById(
                    `GiangVien1-${stt}`
                  );
                  GiangVien1.value =
                    lecturerFound.HoTen +
                    " - " +
                    lecturerFound.BienChe +
                    " - " +
                    lecturerFound.CCCD;
                } else {
                  const GiangVien2 = document.getElementById(
                    `GiangVien2-${stt}`
                  );
                  GiangVien2.value =
                    lecturerFound.HoTen +
                    " - " +
                    lecturerFound.BienChe +
                    " - " +
                    lecturerFound.CCCD;
                }
              }
            }

            hideSuggestions(); // ·∫®n g·ª£i √Ω sau khi ch·ªçn
          };

          suggestionsContainer.appendChild(suggestionItem); // Th√™m suggestionItem v√†o container
        });

        // ·∫®n g·ª£i √Ω khi input kh√¥ng c√≤n focus
        input.onblur = function () {
          setTimeout(() => {
            hideSuggestions();
          }, 100);
        };
      }

      let duplicateGV = JSON.parse(localStorage.getItem("duplicateGV")) || [];
      let allGV = JSON.parse(localStorage.getItem("allGV")) || [];
      let suggestions = allGV.map(
        (item) => `${item.HoTen} - ${item.BienChe} - ${item.CCCD}`
      );

      function showSuggestionsGiangVien(
        input,
        GiangVienDefault,
        position,
        id,
        stt
      ) {
        $(input).autocomplete({
          source: function (request, response) {
            const value = request.term.trim().toLowerCase();

            let filteredSuggestions = suggestions;
            if (value) {
              filteredSuggestions = suggestions.filter((name) =>
                name.toLowerCase().includes(value)
              );
            }

            response(filteredSuggestions);
          },
          minLength: 0,
          delay: 0,
          autoFocus: true,
          select: function (event, ui) {
            const selectedName = ui.item.value.split(" - ")[0].trim();
            const selectedCCCD = ui.item.value.split(" - ")[2].trim();

            const lecturerFound = allGV.find(
              (lecturer) => lecturer.CCCD.trim() == selectedCCCD
            );

            if (lecturerFound) {
              if (position == 1) {
                document.getElementById(`GiangVien1-${stt}`).value =
                  ui.item.value;
              } else {
                document.getElementById(`GiangVien2-${stt}`).value =
                  ui.item.value;
              }
            }

            return false;
          },
        });

        $(input)
          .off("focus")
          .on("focus", function () {
            $(this).autocomplete("search", "");
          });
      }
    </script>

    <script>
      let currentRow; // Bi·∫øn to√†n c·ª•c ƒë·ªÉ l∆∞u h√†ng hi·ªán t·∫°i

      function openNoteForm(row, GhiChu, Deadline) {
        currentRow = row; // L∆∞u h√†ng hi·ªán t·∫°i
        document.getElementById("noteForm").style.display = "block"; // Hi·ªÉn th·ªã form
        document.getElementById("modalBackdrop").style.display = "block"; // Hi·ªÉn th·ªã n·ªÅn t·ªëi

        // Hi·ªÉn th·ªã gi√° tr·ªã ghi ch√∫ v√† h·∫°n
        document.getElementById("noteInput").value = GhiChu || ""; // Hi·ªÉn th·ªã ghi ch√∫
        document.getElementById("deadlineInput").value =
          formatInputDate(Deadline) || ""; // Hi·ªÉn th·ªã h·∫°n
      }

      function closeNoteForm() {
        document.getElementById("noteForm").style.display = "none"; // ·∫®n form
        document.getElementById("modalBackdrop").style.display = "none"; // ·∫®n n·ªÅn t·ªëi
      }

      window.onclick = function (event) {
        const modal = document.getElementById("noteForm");
        const modalBackdrop = document.getElementById("modalBackdrop");
        if (event.target === modalBackdrop) {
          closeNoteForm();
        }
      };

      async function saveNote() {
        const note = document.getElementById("noteInput").value;
        const deadline = document.getElementById("deadlineInput").value;

        if (currentRow) {
          const id = currentRow.getAttribute("data-id"); // L·∫•y ID t·ª´ thu·ªôc t√≠nh `data-id` c·ªßa h√†ng

          // Ki·ªÉm tra ID c√≥ t·ªìn t·∫°i
          if (id) {
            // G·ª≠i d·ªØ li·ªáu ƒë·∫øn API ƒë·ªÉ l∆∞u v√†o CSDL
            try {
              const response = await fetch("/saveNoteDoAn", {
                method: "POST",
                headers: {
                  "Content-Type": "application/json",
                },
                body: JSON.stringify({ id, ghiChu: note, deadline }),
              });
              const result = await response.json();
              if (!result.success) {
                Swal.fire({
                  title: "Th√¥ng b√°o",
                  html: "L·ªói khi l∆∞u ghi ch√∫ v√†o CSDL: " + result.message,
                  icon: "info",
                  confirmButtonText: "OK",
                  width: "auto", // T·ª± ƒë·ªông ƒëi·ªÅu ch·ªânh chi·ªÅu r·ªông
                  padding: "20px", // Gi·ªØ kho·∫£ng c√°ch cho n·ªôi dung
                });
              } else {
                Swal.fire({
                  title: "Th√¥ng b√°o",
                  html: "C·∫≠p nh·∫≠t th√†nh c√¥ng",
                  icon: "success",
                  confirmButtonText: "OK",
                  width: "auto", // T·ª± ƒë·ªông ƒëi·ªÅu ch·ªânh chi·ªÅu r·ªông
                  padding: "20px", // Gi·ªØ kho·∫£ng c√°ch cho n·ªôi dung
                });
              }
            } catch (error) {
              Swal.fire({
                title: "Th√¥ng b√°o",
                html: "L·ªói khi g·ª≠i y√™u c·∫ßu ƒë·∫øn server: " + error,
                icon: "info",
                confirmButtonText: "OK",
                width: "auto", // T·ª± ƒë·ªông ƒëi·ªÅu ch·ªânh chi·ªÅu r·ªông
                padding: "20px", // Gi·ªØ kho·∫£ng c√°ch cho n·ªôi dung
              });
            }
          } else {
            Swal.fire({
              title: "Th√¥ng b√°o",
              html: "ID c·ªßa h√†ng hi·ªán t·∫°i kh√¥ng t·ªìn t·∫°i",
              icon: "info",
              confirmButtonText: "OK",
              width: "auto", // T·ª± ƒë·ªông ƒëi·ªÅu ch·ªânh chi·ªÅu r·ªông
              padding: "20px", // Gi·ªØ kho·∫£ng c√°ch cho n·ªôi dung
            });
          }
        } else {
          Swal.fire({
            title: "Th√¥ng b√°o",
            html: "currentRow kh√¥ng ƒë∆∞·ª£c x√°c ƒë·ªãnh",
            icon: "info",
            confirmButtonText: "OK",
            width: "auto", // T·ª± ƒë·ªông ƒëi·ªÅu ch·ªânh chi·ªÅu r·ªông
            padding: "20px", // Gi·ªØ kho·∫£ng c√°ch cho n·ªôi dung
          });
        }

        closeNoteForm();
      }
      async function doneNote() {
        const note = document.getElementById("noteInput").value;
        const deadline = document.getElementById("deadlineInput").value;

        if (currentRow) {
          const id = currentRow.getAttribute("data-id"); // L·∫•y ID t·ª´ thu·ªôc t√≠nh `data-id` c·ªßa h√†ng

          // Ki·ªÉm tra ID c√≥ t·ªìn t·∫°i
          if (id) {
            // G·ª≠i d·ªØ li·ªáu ƒë·∫øn API ƒë·ªÉ l∆∞u v√†o CSDL
            try {
              const response = await fetch("/doneNoteDoAn", {
                method: "POST",
                headers: {
                  "Content-Type": "application/json",
                },
                body: JSON.stringify({ id, ghiChu: note, deadline }),
              });
              const result = await response.json();
              if (!result.success) {
                Swal.fire({
                  title: "Th√¥ng b√°o",
                  html: "L·ªói khi l∆∞u ghi ch√∫ v√†o CSDL: " + result.message,
                  icon: "info",
                  confirmButtonText: "OK",
                  width: "auto", // T·ª± ƒë·ªông ƒëi·ªÅu ch·ªânh chi·ªÅu r·ªông
                  padding: "20px", // Gi·ªØ kho·∫£ng c√°ch cho n·ªôi dung
                });
              } else {
                Swal.fire({
                  title: "Th√¥ng b√°o",
                  html: "C·∫≠p nh·∫≠t th√†nh c√¥ng",
                  icon: "success",
                  confirmButtonText: "OK",
                  width: "auto", // T·ª± ƒë·ªông ƒëi·ªÅu ch·ªânh chi·ªÅu r·ªông
                  padding: "20px", // Gi·ªØ kho·∫£ng c√°ch cho n·ªôi dung
                });
              }
            } catch (error) {
              Swal.fire({
                title: "Th√¥ng b√°o",
                html: "L·ªói khi g·ª≠i y√™u c·∫ßu ƒë·∫øn server: " + error,
                icon: "success",
                confirmButtonText: "OK",
                width: "auto", // T·ª± ƒë·ªông ƒëi·ªÅu ch·ªânh chi·ªÅu r·ªông
                padding: "20px", // Gi·ªØ kho·∫£ng c√°ch cho n·ªôi dung
              });
            }
          } else {
            Swal.fire({
              title: "Th√¥ng b√°o",
              html: "ID c·ªßa h√†ng hi·ªán t·∫°i kh√¥ng t·ªìn t·∫°i.",
              icon: "info",
              confirmButtonText: "OK",
              width: "auto", // T·ª± ƒë·ªông ƒëi·ªÅu ch·ªânh chi·ªÅu r·ªông
              padding: "20px", // Gi·ªØ kho·∫£ng c√°ch cho n·ªôi dung
            });
          }
        } else {
          Swal.fire({
            title: "Th√¥ng b√°o",
            html: "currentRow kh√¥ng ƒë∆∞·ª£c x√°c ƒë·ªãnh.",
            icon: "info",
            confirmButtonText: "OK",
            width: "auto", // T·ª± ƒë·ªông ƒëi·ªÅu ch·ªânh chi·ªÅu r·ªông
            padding: "20px", // Gi·ªØ kho·∫£ng c√°ch cho n·ªôi dung
          });
        }

        closeNoteForm();
      }

      // H√†m ƒë·ªÉ chuy·ªÉn ƒë·ªïi ƒë·ªãnh d·∫°ng ng√†y
      function formatInputDate(dateString) {
        const date = new Date(dateString);
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, "0"); // L·∫•y th√°ng (0-11) v√† ƒë·∫£m b·∫£o c√≥ 2 ch·ªØ s·ªë
        const day = String(date.getDate()).padStart(2, "0"); // L·∫•y ng√†y v√† ƒë·∫£m b·∫£o c√≥ 2 ch·ªØ s·ªë

        return `${year}-${month}-${day}`; // Tr·∫£ v·ªÅ ƒë·ªãnh d·∫°ng yyyy-mm-dd cho input
      }

      // S·ª± ki·ªán click ngo√†i modal ƒë·ªÉ ƒë√≥ng modal
      window.onclick = function (event) {
        const modal = document.getElementById("noteForm");
        const modalBackdrop = document.getElementById("modalBackdrop");
        if (event.target === modalBackdrop) {
          closeNoteForm();
        }
      };
    </script>

    <!-- link  -->
    <script>
      document.addEventListener("DOMContentLoaded", () => {
        const role = localStorage.getItem("userRole");
        const MaPhongBan = localStorage.getItem("MaPhongBan");
        const isKhoa = localStorage.getItem("isKhoa");

        // Th√™m s·ª± ki·ªán click cho ph·∫ßn t·ª≠ c√≥ id="ThongTinGD"
        const ThongTinGD = document.getElementById("ThongTinGD");

        ThongTinGD.addEventListener("click", function (event) {
          event.preventDefault(); // NgƒÉn ch·∫∑n h√†nh vi m·∫∑c ƒë·ªãnh c·ªßa li√™n k·∫øt

          const isKhoa = localStorage.getItem("isKhoa"); // L·∫•y role t·ª´ localStorage

          if (isKhoa == 0) {
            // N·∫øu l√† ƒë√†o t·∫°o ho·∫∑c t√†i ch√≠nh
            window.location.href = "/info2";
          } else {
            window.location.href = "/info";
          }
        });

        // Th√™m s·ª± ki·ªán click cho ph·∫ßn t·ª≠ c√≥ id="Home"

        const Home = document.getElementById("Home");

        Home.addEventListener("click", function (event) {
          event.preventDefault(); // NgƒÉn ch·∫∑n h√†nh vi m·∫∑c ƒë·ªãnh c·ªßa li√™n k·∫øt

          const isKhoa = localStorage.getItem("isKhoa");

          if (isKhoa == 0) {
            // N·∫øu l√† ƒë√†o t·∫°o ho·∫∑c t√†i ch√≠nh
            window.location.href = "/maindt";
          } else {
            window.location.href = "/mainkhoa";
          }
        });

        // N·∫øu l√† ph√≤ng ban th√¨ hi·ªán l·ªçc theo khoa
        if (isKhoa == 1) {
          document.getElementById("MaPhongBan").style.display = "none";
        }

        if (role == APP_ROLES.thuong || role.includes("<%= APP_ROLES.gv %>")) {
          if (!role.includes("CNBM")) {
            document.getElementById("updateDoAn").style.display = "none";
          }
        }

        if (isKhoa == 1 && (role == APP_ROLES.lanhDao_khoa || role == APP_ROLES.gv_cnbm)) {
          // Hi·ªÉn th·ªã n√∫t xu·∫•t file cho l√£nh ƒë·∫°o khoa v√† gi·∫£ng vi√™n CNBM
          document.getElementById("export-file-btn").style.display = "inline-block";
        } else if (isKhoa == 0 && (role == APP_ROLES.troLy_phong || role === APP_ROLES.lanhDao_phong)) {
          if (MaPhongBan == APP_DEPARTMENTS.daoTao) {
            // ·∫®n c·ªôt 'VPColumn'
            document.getElementById("VPColumn").style.display = "none";
            document.getElementById("updateDoAn").style.display =
              "inline-block";
            // Hi·ªÉn th·ªã n√∫t xu·∫•t file cho ƒê√†o t·∫°o
            document.getElementById("export-file-btn").style.display = "inline-block";
          } else if (MaPhongBan == APP_DEPARTMENTS.vanPhong) {
            // Hi·ªÉn th·ªã t·∫•t c·∫£ c√°c c·ªôt cho VP
            document.getElementById("khoaColumn").style.display = "table-cell";
            document.getElementById("daoTaoColumn").style.display =
              "table-cell";
            document.getElementById("VPColumn").style.display = "table-cell";
            document.getElementById("updateDoAn").style.display =
              "inline-block";
            document.getElementById("saveDataDoAn").style.display =
              "inline-block";
            // Hi·ªÉn th·ªã n√∫t xu·∫•t file cho VP
            document.getElementById("export-file-btn").style.display = "inline-block";
          }
        }

        // Ph√¢n quy·ªÅn, n·∫øu kh√¥ng c√≥ quy·ªÅn khoa ch·ªânh s·ª≠a s·∫Ω ·∫©n ng√†y all ƒëi
        const dateContainer = document.querySelector(".date-all-container");
        if (isKhoa == 1 && role != APP_ROLES.gv) {
          dateContainer.style.display = "flex";
        }
      });
    </script>

    <script>
      document
        .getElementById("changePasswordLink")
        .addEventListener("click", function (event) {
          event.preventDefault(); // NgƒÉn ch·∫∑n h√†nh vi m·∫∑c ƒë·ªãnh c·ªßa th·∫ª a
          const tenDangNhap = localStorage.getItem("TenDangNhap"); // L·∫•y TenDangNhap t·ª´ localStorage

          if (tenDangNhap) {
            // Chuy·ªÉn h∆∞·ªõng ƒë·∫øn trang changePassword v√† truy·ªÅn TenDangNhap trong URL
            window.location.href = `/changePassword?tenDangNhap=${encodeURIComponent(
              tenDangNhap
            )}`;
          } else {
            Swal.fire({
              title: "Th√¥ng b√°o",
              html: "Kh√¥ng t√¨m th·∫•y TenDangNhap trong localStorage.",
              icon: "info",
              confirmButtonText: "OK",
              width: "auto", // T·ª± ƒë·ªông ƒëi·ªÅu ch·ªânh chi·ªÅu r·ªông
              padding: "20px", // Gi·ªØ kho·∫£ng c√°ch cho n·ªôi dung
            });
          }
        });
    </script>
    <script>
      $(document).ready(function () {
        $('#NamHoc option[value=""]').remove();
        $('#combobox-ki option[value=""]').remove();
        $('#combobox-dot option[value=""]').remove();

        $.ajax({
          url: "/getNamHoc",
          method: "GET",
          success: function (response) {
            if (response.success) {
              response.NamHoc.forEach(function (item) {
                $("#NamHoc").append(
                  `<option value="${item.NamHoc}">${item.NamHoc}</option>`
                );
              });

              response.Ki.forEach(function (item) {
                $("#combobox-ki").append(
                  `<option value="${item.value}">${item.Ki}</option>`
                );
              });
              response.Dot.forEach(function (item) {
                $("#combobox-dot").append(
                  `<option value="${item.value}">${item.Dot}</option>`
                );
              });
            } else {
              console.error(
                "Kh√¥ng l·∫•y ƒë∆∞·ª£c d·ªØ li·ªáu nƒÉm h·ªçc:",
                response.message
              );
            }
          },
          error: function (error) {
            console.error("L·ªói khi l·∫•y d·ªØ li·ªáu nƒÉm h·ªçc:", error);
          },
        });
      });
    </script>

    <script>
      $(document).ready(function () {
        $('#MaPhongBan option[value=""]').remove();
        // G·ªçi AJAX ƒë·ªÉ l·∫•y d·ªØ li·ªáu JSON t·ª´ API
        $.ajax({
          url: "/api/shared/faculty-code-list", // ƒê∆∞·ªùng d·∫´n t·ªõi API getPhongBan
          method: "GET",
          success: function (response) {
            // Ki·ªÉm tra n·∫øu response th√†nh c√¥ng
            const MaPhongBan = response.MaPhongBan;
            if (response.success) {
              $("#MaPhongBan").prepend(
                '<option value="ALL">T·∫•t c·∫£ khoa</option>'
              );
              // L·∫∑p qua t·ª´ng m·ª•c trong m·∫£ng MaPhongBan
              response.MaPhongBan.forEach(function (item) {
                // N·∫øu item.MaPhongBan b·∫±ng boMon.MaPhongBan, hi·ªÉn th·ªã tr∆∞·ªõc
                $("#MaPhongBan").append(
                  `<option value="${item.MaPhongBan}">${item.MaPhongBan}</option>`
                );
              });

              // N·∫øu kh√¥ng c√≥ ph√≤ng ban n√†o t∆∞∆°ng ·ª©ng, b·∫°n c√≥ th·ªÉ th√™m t√πy ch·ªçn m·∫∑c ƒë·ªãnh ·ªü ƒë√¢y
              if (!$("#MaPhongBan option:selected").length) {
                $("#MaPhongBan").prepend(
                  '<option value="">Ch·ªçn Ph√≤ng Ban</option>'
                );
              }
            } else {
              console.error(
                "Kh√¥ng l·∫•y ƒë∆∞·ª£c d·ªØ li·ªáu phongBan:",
                response.message
              );
            }
          },
          error: function (error) {
            console.error("L·ªói khi l·∫•y d·ªØ li·ªáu phongBan:", error);
          },
        });
      });
    </script>
    <script>
      document
        .getElementById("infome")
        .addEventListener("click", function (event) {
          event.preventDefault(); // NgƒÉn ch·∫∑n h√†nh vi m·∫∑c ƒë·ªãnh c·ªßa th·∫ª a
          const id_User = localStorage.getItem("id_User"); // L·∫•y id_User t·ª´ localStorage\
          if (id_User) {
            // Chuy·ªÉn h∆∞·ªõng ƒë·∫øn trang infome v√† truy·ªÅn id_User trong URL
            window.location.href = `/infome/${id_User}`;
          } else {
            Swal.fire({
              title: "Th√¥ng b√°o",
              html: "Kh√¥ng t√¨m th·∫•y id_User trong localStorage.",
              icon: "info",
              confirmButtonText: "OK",
              width: "auto", // T·ª± ƒë·ªông ƒëi·ªÅu ch·ªânh chi·ªÅu r·ªông
              padding: "20px", // Gi·ªØ kho·∫£ng c√°ch cho n·ªôi dung
            });
          }
        });
    </script>
    <script>
      document.addEventListener("DOMContentLoaded", () => {
        const role = localStorage.getItem("userRole");

        // ·∫®n button ngay khi trang ƒë∆∞·ª£c t·∫£i
        const actionButton = document.getElementById("changeMessage");
        //·∫®n site th√™m th√¥ng b√°o
        if (role === APP_ROLES.troLy_phong || role === APP_ROLES.lanhDao_phong || role === APP_ROLES.lanhDao_khoa || role === APP_ROLES.gv_cnbm) {
          actionButton.style.display = "";
          // Hi·ªÉn th·ªã n√∫t xu·∫•t file cho c√°c role c√≥ quy·ªÅn
          document.getElementById("export-file-btn").style.display = "inline-block";
        } else {
          actionButton.style.display = "none";
          // ·∫®n n√∫t xu·∫•t file cho c√°c role kh√¥ng c√≥ quy·ªÅn
          document.getElementById("export-file-btn").style.display = "none";
        }
      });
    </script>
    <script>
      document
        .getElementById("changeMessage")
        .addEventListener("click", function (event) {
          event.preventDefault(); // NgƒÉn ch·∫∑n h√†nh vi m·∫∑c ƒë·ªãnh c·ªßa th·∫ª a
          const MaPhongBan = localStorage.getItem("MaPhongBan"); // L·∫•y MaPhongBan t·ª´ localStorage

          if (MaPhongBan) {
            // Chuy·ªÉn h∆∞·ªõng ƒë·∫øn trang changeMessage v√† truy·ªÅn MaPhongBan trong URL
            window.location.href = `/changeMessage/${MaPhongBan}`;
          } else {
            Swal.fire({
              title: "Th√¥ng b√°o",
              html: "Kh√¥ng t√¨m th·∫•y MaPhongBan trong localStorage.",
              icon: "success",
              confirmButtonText: "OK",
              width: "auto", // T·ª± ƒë·ªông ƒëi·ªÅu ch·ªânh chi·ªÅu r·ªông
              padding: "20px", // Gi·ªØ kho·∫£ng c√°ch cho n·ªôi dung
            });
          }
        });
    </script>

    <!-- Ph·∫ßn xu·∫•t file -->
    <script>

      async function exportToExcel() {
        if (!globalData || globalData.length === 0) {
          Swal.fire({
            title: 'Th√¥ng b√°o',
            html: "Kh√¥ng c√≥ d·ªØ li·ªáu ƒë·ªÉ xu·∫•t file",
            icon: 'warning',
            confirmButtonText: 'OK',
            width: 'auto',
            padding: '20px',
          });
          return;
        }

        // L·∫•y gi√° tr·ªã t·ª´ c√°c combo box ƒë·ªÉ t·∫°o t√™n file
        const dot = document.getElementById('combobox-dot').value;
        const ki = document.getElementById('combobox-ki').value;
        const namHoc = document.getElementById('NamHoc').value;
        const maPhongBan = document.getElementById('MaPhongBan').value;
        const heDaoTao = document.getElementById('he_dao_tao').value;

        try {
          // G·ª≠i d·ªØ li·ªáu ƒë·∫øn controller ƒë·ªÉ x·ª≠ l√Ω
          const response = await fetch("/doan-export-excel", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({ renderData: globalData }),
          });

          if (!response.ok) {
            throw new Error(`Failed to export: ${response.statusText}`);
          }

          // T·∫°o blob t·ª´ response
          const blob = await response.blob();
          const url = window.URL.createObjectURL(blob);
          const a = document.createElement("a");
          a.href = url;
          a.download = `do_an_tot_nghiep_${dot}_${ki}_${namHoc}_${maPhongBan}_${heDaoTao}.xlsx`;
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          window.URL.revokeObjectURL(url);

          Swal.fire({
            title: 'Th√¥ng b√°o',
            html: "Xu·∫•t file th√†nh c√¥ng!",
            icon: 'success',
            confirmButtonText: 'OK',
            width: 'auto',
            padding: '20px',
          });

        } catch (error) {
          console.error("Error exporting data:", error);
          Swal.fire({
            title: 'Th√¥ng b√°o',
            html: "C√≥ l·ªói x·∫£y ra khi xu·∫•t file",
            icon: 'error',
            confirmButtonText: 'OK',
            width: 'auto',
            padding: '20px',
          });
        }
      }
    </script>
  </body>
</html>
