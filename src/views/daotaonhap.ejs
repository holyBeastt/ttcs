<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Học Viện Kỹ Thuật Mật Mã</title>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css"
    />
    <link rel="stylesheet" href="/css/forminput.css" />
    <link rel="stylesheet" href="/css/styles.css" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css"
    />
    <style>
      .thuocQuanDoiBox {
        height: 30px;
        line-height: 30px;
        align-items: center;
        gap: 8px; /* Khoảng cách giữa checkbox và nhãn */
      }

      .thuocQuanDoi-input {
        width: 20px;
        height: 20px;
        cursor: pointer;
      }

      .thuocQuanDoi-label {
        display: inline-block; /* Đảm bảo nhãn hiển thị riêng biệt */
        margin-right: 20px !important;
        font-size: 16px;
        color: #333;
        margin: 0;
        cursor: pointer;
      }
    </style>
  </head>

  <body>
    <!-- Phần header -->
    <%- include('header') %>

    <!-- Phần nội dung -->
    <div class="m-3">
      <form
        action="/daotaonhap"
        enctype="multipart/form-data"
        class="form"
        method="POST"
      >
        <fieldset>
          <div class="row mb-3">
            <div style="width: 20%; padding-right: 0px">
              <label for="HoTen">Họ tên:</label>
              <input
                required
                class="form-control"
                type="text"
                name="HoTen"
                id="HoTen"
              />
            </div>

            <div style="width: 12%">
              <label for="ngaySinh">Ngày sinh:</label>
              <input
                required
                class="form-control"
                type="date"
                name="NgaySinh"
                id="ngaySinh"
              />
            </div>

            <div style="width: 13%">
              <label for="CCCD">CCCD:</label>
              <input
                required
                class="form-control"
                type="text"
                name="CCCD"
                id="CCCD"
              />
            </div>

            <div class="col-md-1">
              <label for="gioitinh">Giới tính:</label>
              <select class="form-control" name="GioiTinh" id="gioitinh">
                <option value="Nam">Nam</option>
                <option value="Nu">Nữ</option>
              </select>
            </div>
            <div class="col-md-2">
              <label>Mã phòng ban:</label>
              <input
                class="form-control"
                id="Ma_Khoa_Label"
                type="text"
                disabled
              />
              <!-- <label id="Ma_Khoa_Label"></label> -->
            </div>
            <div style="padding: 0px; width: 30%">
              <label for="monGiangDayChinh">Bộ môn:</label>
              <select
                class="form-control"
                type="text"
                name="monGiangDayChinh"
                id="monGiangDayChinh"
              ></select>
            </div>
          </div>

          <div class="row mb-3">
            <div class="col-md-2">
              <label for="NgayCapCCCD">Ngày cấp CCCD:</label>
              <input
                required
                class="form-control"
                type="date"
                name="NgayCapCCCD"
                id="NgayCapCCCD"
              />
            </div>
            <div class="col-md-4">
              <label for="NoiCapCCCD">Nơi cấp CCCD:</label>
              <input
                required
                class="form-control"
                type="text"
                name="NoiCapCCCD"
                id="NoiCapCCCD"
              />
            </div>

            <div class="col-md-6">
              <label for="DiaChi">Địa chỉ theo CCCD:</label>
              <input
                required
                class="form-control"
                type="text"
                name="DiaChi"
                id="DiaChi"
              />
            </div>
          </div>

          <div class="row mb-3">
            <div class="col-md-4">
              <label>Mặt trước CCCD:</label>
              <img id="imagetruocinput" src="" alt="Mặt trước CCCD" />
              <input
                class="form-control"
                type="file"
                name="truocCCCD"
                id="truocCCCD"
              />
            </div>
            <div class="col-md-4">
              <label>Mặt sau CCCD:</label>
              <img id="imagesauInput" src="" alt="Mặt sau CCCD" />
              <input
                class="form-control"
                type="file"
                name="sauCCCD"
                id="sauCCCD"
              />
            </div>
            <div class="col-md-4">
              <label>Bằng tốt nghiệp:</label>
              <img id="imagebang" alt="Bằng tốt nghiệp" />
              <input
                class="form-control"
                type="file"
                name="bangTotNghiep"
                id="bangTotNghiep"
              />
            </div>
          </div>
          <div class="row mb-3">
            <div class="col-md-2">
              <label for="dienThoai">Điện thoại:</label>
              <input
                required
                class="form-control"
                type="text"
                name="DienThoai"
                id="dienThoai"
              />
            </div>
            <div class="col-md-8">
              <label for="nganHang">Ngân hàng:</label>
              <input
                required
                class="form-control"
                type="text"
                name="NganHang"
                id="nganHang"
              />
            </div>
            <div class="col-md-2">
              <label for="hocVi">Bằng cấp cao nhất:</label>
              <select class="form-control" name="hocVi" id="hocVi">
                <option value="Cử nhân">Cử nhân</option>
                <option value="Kỹ sư">Kỹ sư</option>
                <option value="Thạc sĩ">Thạc sĩ</option>
                <option value="Tiến sĩ">Tiến sĩ</option>
                <option value="Phó giáo sư">Phó giáo sư</option>
                <option value="Giáo sư">Giáo sư</option>
                <option value="Tiếng khơ-me">Tiếng khơ-me</option>
                <option value="Võ sư">Võ sư</option>
              </select>
            </div>
          </div>

          <div class="row">
            <div class="col-md-8">
              <!-- Dòng 1 -->
              <div class="row">
                <div style="width: 75%">
                  <label for="NoiCongTac">Nơi công tác:</label>
                  <input
                    required
                    class="form-control"
                    type="text"
                    name="NoiCongTac"
                    id="NoiCongTac"
                  />
                </div>
                <div style="width: 25%; padding-right: 0px">
                  <label for="stk">Số tài khoản:</label>
                  <input
                    required
                    class="form-control"
                    type="text"
                    name="STK"
                    id="stk"
                  />
                </div>
              </div>
              <!-- Dòng 2 -->
              <div class="row">
                <p></p>
                <div style="width: 20%; padding-right: 0px">
                  <label for="msthue">Mã số thuế:</label>
                  <input
                    class="form-control"
                    type="text"
                    name="MaSoThue"
                    id="msthue"
                  />
                </div>
                <div style="width: 20%; padding-right: 0px">
                  <label for="chucvu">Chức vụ:</label>
                  <input
                    class="form-control"
                    type="text"
                    name="ChucVu"
                    id="chucvu"
                  />
                </div>
                <div style="width: 60%">
                  <label for="email">Email:</label>
                  <input
                    class="form-control"
                    type="email"
                    name="email"
                    id="email"
                  />
                </div>
              </div>
              <!-- Dòng 3 -->
              <div class="row">
                <p></p>
                <div style="width: 20%; padding-right: 0px">
                  <label for="hsl">Hệ số lương:</label>
                  <input
                    required
                    class="form-control"
                    type="text"
                    name="HeSoLuong"
                    id="hsl"
                  />
                </div>
                <div style="width: 20%; padding-right: 0px">
                  <label for="BangTotNghiepLoai">Bằng tốt nghiệp loại:</label>
                  <select
                    class="form-control"
                    name="BangTotNghiepLoai"
                    id="BangTotNghiepLoai"
                  >
                    <option value="Trung bình">Trung bình</option>
                    <option value="Khá">Khá</option>
                    <option value="Giỏi">Giỏi</option>
                    <option value="Xuất sắc">Xuất sắc</option>
                  </select>
                </div>
                <div style="width: 30%; padding-right: 0px">
                  <label for="tinhTrang">Tình trạng giảng dạy:</label>
                  <select
                    class="form-control"
                    name="tinhTrangGiangDay"
                    id="tinhTrang"
                  >
                    <option value="true">Đang giảng dạy</option>
                    <option value="false">Đã ngừng giảng dạy</option>
                  </select>
                </div>
                <div
                  style="width: 30%; padding-right: 0px"
                  class="thuocQuanDoiBox"
                >
                  <div class="form-group">
                    <label for="thuocQuanDoi" class="thuocQuanDoi-label"
                      >Thuộc quân đội:</label
                    >
                    <input
                      type="checkbox"
                      class="thuocQuanDoi-input"
                      id="thuocQuanDoi"
                      name="thuocQuanDoi"
                      value="1"
                    />
                  </div>
                </div>
              </div>
              <!-- Dòng 3.5 -->
              <div class="row">
                <p></p>
                <div
                  style="width: 30%; padding-right: 0px"
                  class="thuocQuanDoiBox"
                >
                  <div class="form-group">
                    <label for="isNghiHuu" class="thuocQuanDoi-label"
                      >Đã nghỉ hưu:</label
                    >
                    <input
                      type="checkbox"
                      class="thuocQuanDoi-input"
                      id="isNghiHuu"
                      name="isNghiHuu"
                      value="1"
                    />
                  </div>
                </div>
              </div>
              <!-- Dòng 4 -->
              <div class="row">
                <p></p>
                <div class="col-md-6">
                  <label>File bổ sung:</label>
                  <input
                    class="form-control"
                    type="file"
                    name="fileBoSung"
                    id="fileBoSung"
                  />
                <p style="font-size:13px; font-style:italic; color:#2E8B57;">
                  (*) File pdf/word cần chứa ảnh CCCD mặt trước + mặt sau (ở trong cùng 1 trang); 
                  trang thứ 2 chứa bằng tốt nghiệp cao nhất.
                </p>
                </div>
                <div class="col-md-6">
                  <label>File lý lịch (PDF):</label>
                  <input
                    class="form-control"
                    type="file"
                    name="FileLyLich"
                    id="FileLyLich"
                  />
                </div>
              </div>
              <!-- Dòng 5 -->
              <div class="row mb-3" style="padding-top: 130px">
                <div class="justify-content-between">
                  <button class="btn" id="submit">Thêm mới</button>
                  <button
                    class="btn"
                    id="return"
                    style="margin-left: 20px"
                    onclick="goBack()"
                  >
                    Quay lại
                  </button>
                </div>
              </div>
            </div>
            <div class="col-md-4" style="position: relative; top: -40px">
              <div class="col-md-12">
                <label>QR Code:</label>
                <img id="QrCodeImg" src="" alt="QR CODE" />
                <input
                  class="form-control"
                  type="file"
                  name="QrCode"
                  id="QrCode"
                />
              </div>
            </div>
          </div>
        </fieldset>
      </form>
    </div>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Link script Sweet alert 2 -->
    <!-- SweetAlert2 CSS -->
    <link
      href="https://cdn.jsdelivr.net/npm/sweetalert2@11.6.16/dist/sweetalert2.min.css"
      rel="stylesheet"
    />

    <!-- SweetAlert2 JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.6.16/dist/sweetalert2.all.min.js"></script>

    <script>
      document.addEventListener("DOMContentLoaded", function () {
        const maPhongBan = localStorage.getItem("MaPhongBan");
        document.getElementById("Ma_Khoa_Label").value = maPhongBan;

        fetch(`/getMaBoMon/${maPhongBan}`)
          .then((response) => response.json())
          .then((data) => {
            console.log(data); // In ra phản hồi để kiểm tra
            const maBoMonSelect = document.getElementById("monGiangDayChinh");
            maBoMonSelect.innerHTML = ""; // Xóa các option cũ

            // Kiểm tra isKhoa và cập nhật quyền dựa theo giá trị
            if (data.success && data.maBoMon) {
              // Vòng lặp qua từng mục trong maBoMon và tạo thẻ option
              data.maBoMon.forEach((item) => {
                if (maPhongBan === item.MaPhongBan) {
                  const option = document.createElement("option");
                  option.value = item.MaBoMon; // Giả sử MaBoMon là thuộc tính cần làm value
                  option.textContent = `${item.TenBoMon} - ${item.MaBoMon}`; // Giả sử TenBoMon là tên bộ môn cần hiển thị
                  maBoMonSelect.appendChild(option);
                }
              });
            } else {
              console.error(
                "Dữ liệu maBoMon không tồn tại hoặc không thành công"
              );
            }
          })
          .catch((error) => console.error("Error:", error));
      });
    </script>
    <script>
      // Lấy query string từ URL
      const urlParams = new URLSearchParams(window.location.search);
      const message = urlParams.get("message");

      // Lấy phần tử div để hiển thị thông báo
      const messageDiv = document.getElementById("message");

      // Hiển thị thông báo dựa trên giá trị của message
      if (message === "insertSuccess") {
        Swal.fire({
          title: "Thông báo",
          html: "Thêm thành công",
          icon: "success",
          confirmButtonText: "OK",
          width: "auto", // Tự động điều chỉnh chiều rộng
          padding: "20px", // Giữ khoảng cách cho nội dung
        });
      } else if (message === "insertFalse") {
        Swal.fire({
          title: "Thông báo",
          html: "Thêm thất bại",
          icon: "error",
          confirmButtonText: "OK",
          width: "auto", // Tự động điều chỉnh chiều rộng
          padding: "20px", // Giữ khoảng cách cho nội dung
        });
      }

      // Quay lại trang cũ
      function goBack() {
        window.history.back(); // Quay lại trang trước đó
      }

      // Sau khi hiển thị thông báo, xóa query string để tránh hiển thị lại khi refresh
      if (message) {
        // Sử dụng window.history để xóa query string mà không refresh lại trang
        const newUrl = window.location.origin + window.location.pathname;
        window.history.replaceState({}, document.title, newUrl);
      }
      const Home = document.getElementById("Home");

      Home.addEventListener("click", function (event) {
        event.preventDefault(); // Ngăn chặn hành vi mặc định của liên kết

        const isKhoa = localStorage.getItem("isKhoa");

        if (isKhoa == 0) {
          // Nếu là đào tạo hoặc tài chính
          window.location.href = "/maindt";
        } else {
          window.location.href = "/mainkhoa";
        }
      });
    </script>

<script>
      // Cấu hình: 5MB = 5 * 1024 * 1024 bytes
      const MAX_FILE_SIZE = 5 * 1024 * 1024;

      // Hàm xử lý chung: Vừa kiểm tra dung lượng, vừa hiển thị ảnh
      function validateAndPreview(event, imgId) {
        const input = event.target;
        const file = input.files[0];

        // Nếu người dùng hủy chọn file (không có file) thì thoát
        if (!file) return;

        // 1. KIỂM TRA DUNG LƯỢNG
        if (file.size > MAX_FILE_SIZE) {
          const sizeMB = (file.size / (1024 * 1024)).toFixed(2);
          
          // Hiển thị cảnh báo đẹp bằng SweetAlert
          Swal.fire({
            title: 'File quá lớn!',
            html: `File bạn chọn nặng <b>${sizeMB} MB</b>.<br>Vui lòng chọn file nhỏ hơn <b>5MB</b>.`,
            icon: 'warning',
            confirmButtonText: 'Đã hiểu'
          });

          // Reset input (xóa file vừa chọn để không gửi lên server)
          input.value = ""; 

          // Nếu là input ảnh thì ẩn ảnh preview đi (nếu đang hiện ảnh cũ)
          if (imgId) {
            const img = document.getElementById(imgId);
            if (img) {
              img.src = "";
              img.style.display = "none";
            }
          }
          return; // Dừng lại, không chạy tiếp phần hiển thị ảnh
        }

        // 2. HIỂN THỊ ẢNH PREVIEW (Chỉ chạy nếu imgId được truyền vào)
        if (imgId) {
          const reader = new FileReader();
          reader.onload = function (e) {
            const img = document.getElementById(imgId);
            if (img) {
              img.src = e.target.result;
              img.style.display = "block";
            }
          };
          reader.readAsDataURL(file);
        }
      }

      // --- GÁN SỰ KIỆN CHO CÁC INPUT ---

      // 1. Nhóm Input Ảnh (Có hiển thị Preview)
      document.getElementById("truocCCCD").addEventListener("change", function (e) {
        validateAndPreview(e, "imagetruocinput");
      });

      document.getElementById("sauCCCD").addEventListener("change", function (e) {
        validateAndPreview(e, "imagesauInput");
      });

      document.getElementById("bangTotNghiep").addEventListener("change", function (e) {
        validateAndPreview(e, "imagebang");
      });

      document.getElementById("QrCode").addEventListener("change", function (e) {
        validateAndPreview(e, "QrCodeImg");
      });

      // 2. Nhóm Input File khác (PDF, Word...) - Chỉ cần check dung lượng, không cần preview
      // (Mình thêm đoạn này vì trong form của bạn có input fileBoSung và FileLyLich)
      const otherFiles = ["fileBoSung", "FileLyLich"];
      otherFiles.forEach(id => {
        const el = document.getElementById(id);
        if(el) {
          el.addEventListener("change", function(e) {
            validateAndPreview(e, null); // Truyền null vì không có ảnh để hiển thị
          });
        }
      });

    </script>
    <script>
      document
        .getElementById("changePasswordLink")
        .addEventListener("click", function (event) {
          event.preventDefault(); // Ngăn chặn hành vi mặc định của thẻ a
          const tenDangNhap = localStorage.getItem("TenDangNhap"); // Lấy TenDangNhap từ localStorage

          if (tenDangNhap) {
            // Chuyển hướng đến trang changePassword và truyền TenDangNhap trong URL
            window.location.href = `/changePassword?tenDangNhap=${encodeURIComponent(
              tenDangNhap
            )}`;
          } else {
            alert("Không tìm thấy TenDangNhap trong localStorage.");
          }
        });
    </script>
    <script>
      document
        .getElementById("infome")
        .addEventListener("click", function (event) {
          event.preventDefault(); // Ngăn chặn hành vi mặc định của thẻ a
          const id_User = localStorage.getItem("id_User"); // Lấy id_User từ localStorage\
          if (id_User) {
            // Chuyển hướng đến trang infome và truyền id_User trong URL
            window.location.href = `/infome/${id_User}`;
          } else {
            alert("Không tìm thấy id_User trong localStorage.");
          }
        });
    </script>
    <script>
      document.addEventListener("DOMContentLoaded", () => {
        const Quyen = localStorage.getItem("userRole");

        // Ẩn button ngay khi trang được tải
        const actionButton = document.getElementById("changeMessage");
        //Ẩn site thêm thông báo
        if (Quyen === "<%= APP_ROLES.troLy_phong %>" || Quyen === "<%= APP_ROLES.lanhDao_phong %>") {
          actionButton.style.display = "";
        } else {
          actionButton.style.display = "none";
        }
      });
    </script>
    <script>
      document
        .getElementById("changeMessage")
        .addEventListener("click", function (event) {
          event.preventDefault(); // Ngăn chặn hành vi mặc định của thẻ a
          const MaPhongBan = localStorage.getItem("MaPhongBan"); // Lấy MaPhongBan từ localStorage

          if (MaPhongBan) {
            // Chuyển hướng đến trang changeMessage và truyền MaPhongBan trong URL
            window.location.href = `/changeMessage/${MaPhongBan}`;
          } else {
            alert("Không tìm thấy MaPhongBan trong localStorage.");
          }
        });
    </script>
  </body>
</html>
