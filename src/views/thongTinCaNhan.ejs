<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Học Viện Kỹ Thuật Mật Mã</title>
  <link rel="stylesheet" href="/css/admin.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
  <link rel="stylesheet" href="/css/styles.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css">
</head>

<body>
  <!-- Phần header -->
  <%- include('header') %>

  <!-- Main content -->
  <div class="container my-5 box">
    <h2>Sửa Nhân Viên</h2>
    <!-- <form id="infome" action="/infome/:id_User" method="POST"> -->
    <form id="formData">
      <div class="row mb-3">
        <input type="hidden" name="Id_User" value="<%= user.id_User %> ">
        <div class="col-md-4 input-wrapper">
          <label for="TenNhanVien" class="form-label">Tên Nhân Viên</label>
          <input type="text" class="form-control" id="TenNhanVien" name="TenNhanVien" value="<%= user.TenNhanVien %> "
            readonly>
        </div>
        <div class="col-md-4 input-wrapper">
          <label for="NgaySinh" class="form-label">Ngày Sinh</label>
          <input type="date" class="form-control" id="NgaySinh" name="NgaySinh" value="<%= new Date(user.NgaySinh.getTime() - (new Date().getTimezoneOffset() * 60000))
           .toISOString().split('T')[0] %>">
        </div>
        <div class="col-md-4 input-wrapper">
          <label for="HocVi" class="form-label">Học Hàm/Học Vị</label>
          <select class="form-control" name="HocVi" id="HocVi">
            <option value="Cử nhân" <%= user.HocVi === "Cử nhân" ? "selected" : "" %>>Cử nhân</option>
            <option value="Kỹ sư" <%= user.HocVi === "Kỹ sư" ? "selected" : "" %>>Kỹ sư</option>
            <option value="Thạc sĩ" <%= user.HocVi === "Thạc sĩ" ? "selected" : "" %>>Thạc sĩ</option>
            <option value="Tiến sĩ" <%= user.HocVi === "Tiến sĩ" ? "selected" : "" %>>Tiến sĩ</option>
            <option value="Phó giáo sư. Tiến sĩ" <%= user.HocVi === "Phó giáo sư. Tiến sĩ" ? "selected" : "" %>>Phó giáo sư. Tiến sĩ</option>
            <option value="Giáo sư. Tiến sĩ" <%= user.HocVi === "Giáo sư. Tiến sĩ" ? "selected" : "" %>>Giáo sư. Tiến sĩ</option>
          </select>        
          <!-- <input type="text" class="form-control" id="HocVi" name="HocVi" value="<%= user.HocVi %>"> -->
        </div>
      </div>
      <!-- <div class="row mb-3">
        <div class="col-md-4 input-wrapper">
          <label for="CCCD" class="form-label">CCCD</label>
          <input type="text" class="form-control" id="CCCD" name="CCCD" value="<%= user.CCCD %>">
        </div>
        <div class="col-md-4 input-wrapper">
          <label for="NgayCapCCCD" class="form-label">Ngày Cấp CCCD</label>
          <input type="date" class="form-control" id="NgayCapCCCD" name="NgayCapCCCD"
            value="<%= new Date((user.NgayCapCCCD).getTime() + 7 * 60 * 60 * 1000).toISOString().split('T')[0] %>">
        </div>
        <div class="col-md-4 input-wrapper">
          <label for="NoiCapCCCD" class="form-label">Nơi Cấp CCCD</label>
          <input type="text" class="form-control" id="NoiCapCCCD" name="NoiCapCCCD" value="<%= user.NoiCapCCCD %>">
        </div>
      </div>
      <div class="row mb-3">
        <div class="col-md-4 input-wrapper">
          <label for="gioitinh">Giới tính</label>
          <input class="form-control text-center" type="text" name="GioiTinh" id="gioitinh" value="<%= user.GioiTinh%>"
            readonly>
        </div>
        <div class="col-md-4 input-wrapper">
          <label for="DienThoai" class="form-label">Điện Thoại</label>
          <input type="tel" class="form-control" id="DienThoai" name="DienThoai" value="<%= user.DienThoai %>">
        </div>
        <div class="col-md-4 input-wrapper">
          <label for="DiaChiCCCD" class="form-label">Địa Chỉ Trong CCCD</label>
          <input type="text" class="form-control" id="DiaChiCCCD" name="DiaChiCCCD" value="<%= user.DiaChiCCCD %>">
        </div>
      </div> -->
      <div class="row mb-3">
        <div class="col-md-4 input-wrapper">
          <label for="ChucVu" class="form-label">Chức Vụ</label>
          <input type="text" class="form-control text-center" id="ChucVu" name="ChucVu" value="<%= user.ChucVu %>"
            required>
        </div>
        <div class="col-md-4 input-wrapper d-flex justify-content-between">
          <!-- <div>
            <label for="MaPhongBan" class="form-label">Mã Phòng Ban*</label>
            <select class="form-control" id="MaPhongBan" name="MaPhongBan" onchange="fetchQuyen(), fetchBoMon()">
              <option value="<%= role.MaPhongBan %>">
                <%= role.MaPhongBan %>
              </option>
              <% departmentLists.forEach(function(department) { %>
                <% if (department.MaPhongBan !==role.MaPhongBan) { %>
                  <option value="<%= department.MaPhongBan %>">
                    <%= department.MaPhongBan %>
                  </option>
                  <% } %>
                    <% }); %>
            </select>
          </div> -->
          <div class="">
            <label for="PhanTramMienGiam" class="form-label">Phần trăm miễn giảm</label>
            <input type="text" class="form-control text-center" id="PhanTramMienGiam" name="PhanTramMienGiam" value="<%= user.PhanTramMienGiam %>" required>
          </div>
          <div class="">
            <label for="HSL" class="form-label">Hệ số lương*</label>
            <input type="text" class="form-control text-center" id="HSL" name="HSL" value="<%= user.HSL %>" required>
          </div>
        </div>
        <div class="col-md-4 input-wrapper">
          <label for="Luong" class="form-label">Lương</label>
          <input type="text" class="form-control" id="Luong" name="Luong"
            value="<%= user.Luong %>">
        </div>
        <!-- <div class="col-md-4 input-wrapper">
          <label for="DiaChiHienNay" class="form-label">Địa Chỉ Hiện Nay*</label>
          <input type="text" class="form-control" id="DiaChiHienNay" name="DiaChiHienNay"
            value="<%= user.DiaChiHienNay %>">
        </div> -->
      </div>
      <!-- <div class="row mb-3">
        <div class="col-md-4 input-wrapper">
          <label for="SoTaiKhoan" class="form-label">Số Tài Khoản*</label>
          <input type="text" class="form-control" id="SoTaiKhoan" name="SoTaiKhoan" value="<%= user.SoTaiKhoan %>">
        </div>
        <div class="col-md-4 input-wrapper">
          <label for="NganHang" class="form-label">Ngân Hàng*</label>
          <input type="text" class="form-control" id="NganHang" name="NganHang" value="<%= user.NganHang %>">
        </div>
        <div class="col-md-4 input-wrapper">
          <label for="ChiNhanh" class="form-label">Chi Nhánh*</label>
          <input type="text" class="form-control" id="ChiNhanh" name="ChiNhanh" value="<%= user.ChiNhanh %>">
        </div>
      </div>
      <div class="row mb-3">
        <div class="col-md-4 input-wrapper">
          <label for="MaSoThue" class="form-label">Mã Số Thuế*</label>
          <input type="text" class="form-control" id="MaSoThue" name="MaSoThue" value="<%= user.MaSoThue %>">
        </div>

        <div class="col-md-4 input-wrapper">
          <label for="MonGiangDayChinh" class="form-label">Bộ môn*</label>
          <select class="form-control" name="MonGiangDayChinh" id="MonGiangDayChinh"></select>
          <input type="text" id="boMon" value="<%= user.MonGiangDayChinh %>" hidden>
        </div>
        <div class="col-md-4 input-wrapper">
          <label for="CacMonLienQuan" class="form-label">Các Môn Liên Quan*</label>
          <input type="text" class="form-control" id="CacMonLienQuan" name="CacMonLienQuan"
            value="<%= user.CacMonLienQuan %>">
        </div>
      </div> -->
      <button type="submit" class="btn" id="submitBtn">Cập nhật</button>
      <button class="btn mx-5" type="button" onclick="window.history.back()">Trở về</button>
    </form>
  </div>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    document.getElementById("changePasswordLink").addEventListener("click", function (event) {
      event.preventDefault(); // Ngăn chặn hành vi mặc định của thẻ a
      const tenDangNhap = localStorage.getItem("TenDangNhap"); // Lấy TenDangNhap từ localStorage

      if (tenDangNhap) {
        // Chuyển hướng đến trang changePassword và truyền TenDangNhap trong URL
        window.location.href = `/changePassword?tenDangNhap=${encodeURIComponent(tenDangNhap)}`;
      } else {
        alert("Không tìm thấy TenDangNhap trong localStorage.");
      }
    });
  </script>

  <!-- Phần phân quyền -->
  <script>
    document.addEventListener("DOMContentLoaded", () => {
      // Thêm sự kiện click cho phần tử có id="ThongTinGD"
      const ThongTinGD = document.getElementById("ThongTinGD");

      ThongTinGD.addEventListener("click", function (event) {
        event.preventDefault(); // Ngăn chặn hành vi mặc định của liên kết

        const isKhoa = localStorage.getItem("isKhoa"); // Lấy role từ localStorage

        if (isKhoa == 0) {
          // Nếu là đào tạo hoặc tài chính
          window.location.href = "/info2";
        } else {
          window.location.href = "/info";
        }
      });

      // Thêm sự kiện click cho phần tử có id="Home"

      const Home = document.getElementById("Home");

      Home.addEventListener("click", function (event) {
        event.preventDefault(); // Ngăn chặn hành vi mặc định của liên kết

        const isKhoa = localStorage.getItem("isKhoa");

        if (isKhoa == 0) {
          // Nếu là đào tạo hoặc tài chính
          window.location.href = "/maindt";
        } else {
          window.location.href = "/mainkhoa";
        }
      });
    });
  </script>

  <script>
    document.getElementById("changePasswordLink").addEventListener("click", function (event) {
      event.preventDefault(); // Ngăn chặn hành vi mặc định của thẻ a
      const tenDangNhap = localStorage.getItem("TenDangNhap"); // Lấy TenDangNhap từ localStorage

      if (tenDangNhap) {
        // Chuyển hướng đến trang changePassword và truyền TenDangNhap trong URL
        window.location.href = `/changePassword?tenDangNhap=${encodeURIComponent(tenDangNhap)}`;
      } else {
        alert("Không tìm thấy TenDangNhap trong localStorage.");
      }
    });
  </script>
  <script>
    document.getElementById("infome").addEventListener("click", function (event) {
      event.preventDefault(); // Ngăn chặn hành vi mặc định của thẻ a
      const id_User = localStorage.getItem("id_User"); // Lấy id_User từ localStorage\
      if (id_User) {
        // Chuyển hướng đến trang infome và truyền id_User trong URL
        window.location.href = `/infome/${id_User}`;
      } else {
        alert("Không tìm thấy id_User trong localStorage.");
      }
    });
  </script>

  <script>
    document.addEventListener("DOMContentLoaded", function () {
      // Lắng nghe sự kiện click trên nút có id là submitBtn
      document.getElementById("submitBtn").addEventListener("click", function (event) {
        event.preventDefault();  // Ngừng hành vi gửi form mặc định

        const form = document.getElementById("formData");  // Lấy form theo id

        // Kiểm tra xem form có tồn tại không
        if (form) {
          // Tạo đối tượng FormData từ form
          const formData = new FormData(form);

          // Chuyển FormData thành một đối tượng JSON để dễ đọc và xử lý
          const formObject = {};
          formData.forEach((value, key) => {
            formObject[key] = value;
          });

          // Lấy id_User từ dữ liệu trong form
          const id_User = formObject.Id_User; // `Id_User` là tên của trường ẩn trong form

          if (id_User) {
            // Kiểm tra giá trị Luong trong formObject
            const luong = formObject.Luong;
            const phantram = formObject.PhanTramMienGiam;

            // Kiểm tra xem Luong có phải là chuỗi số không
            if (!/^\d*$/.test(luong)) {
                alert("Giá trị Lương phải là một dãy số hợp lệ hoặc để trống.");
                return; // Dừng việc gửi dữ liệu nếu không hợp lệ
            }
            if (!/^\d*$/.test(luong)) {
                alert("Giá trị Phần trăm miễn giảm phải là một dãy số hợp lệ hoặc để trống.");
                return; // Dừng việc gửi dữ liệu nếu không hợp lệ
            }

            // Sử dụng fetch để gửi dữ liệu đến server
            fetch(`/infome/${id_User}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json', // Gửi dữ liệu dưới dạng JSON
                },
                body: JSON.stringify(formObject) // Chuyển đổi đối tượng dữ liệu thành chuỗi JSON
            })
            .then(response => response.json()) // Giả sử server trả về dữ liệu JSON
            .then(data => {
                console.log("Dữ liệu phản hồi từ server:", data);
                alert(data.message);
                // Xử lý dữ liệu từ server, ví dụ như thông báo thành công
            })
            .catch(error => {
                console.error("Có lỗi xảy ra:", error);
                // Xử lý lỗi nếu có
            });
          } else {
            alert("Không tìm thấy id_User trong form.");
          }
        } else {
          console.log("Không tìm thấy form với id 'infome'.");
        }
      });
    });


  </script>
<script>
      document.addEventListener("DOMContentLoaded", () => {
        const Quyen = localStorage.getItem("userRole");

        // Ẩn button ngay khi trang được tải
        const actionButton = document.getElementById('changeMessage');
        //Ẩn site thêm thông báo
        if (Quyen === "Duyệt") {
          actionButton.style.display = '';
        } else {
          actionButton.style.display = 'none';
        }
      });
    </script>
  <script>
      document.getElementById("changeMessage").addEventListener("click", function(event) {
        event.preventDefault(); // Ngăn chặn hành vi mặc định của thẻ a
        const MaPhongBan = localStorage.getItem("MaPhongBan"); // Lấy MaPhongBan từ localStorage

        if (MaPhongBan) {
            // Chuyển hướng đến trang changeMessage và truyền MaPhongBan trong URL
            window.location.href = `/changeMessage/${MaPhongBan}`;
        } else {
            alert("Không tìm thấy MaPhongBan trong localStorage.");
        }
      });
    </script>
  </body>

</html>