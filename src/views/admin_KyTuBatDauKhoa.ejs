<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Học Viện Kỹ Thuật Mật Mã</title>

  <!-- Bootstrap CSS -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" />

  <!-- Custom CSS -->
  <link rel="stylesheet" href="/css/table.css" />
  <link rel="stylesheet" href="/css/admin.css" />
  <link rel="stylesheet" href="/css/styles.css" />

  <!-- AG Grid Styles -->
  <link rel="stylesheet" href="https://unpkg.com/ag-grid-community/styles/ag-grid.css" />
  <link rel="stylesheet" href="https://unpkg.com/ag-grid-community/styles/ag-theme-alpine.css" />

  <!-- SweetAlert2 CSS -->
  <link href="https://cdn.jsdelivr.net/npm/sweetalert2@11.6.16/dist/sweetalert2.min.css" rel="stylesheet" />

  <!-- Toastify CSS -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css" />

  <style>
    .ag-theme-alpine {
      --ag-header-background-color: #f8f9fa;
      --ag-odd-row-background-color: #ffffff;
      --ag-row-hover-color: #e3f2fd;
      --ag-border-color: #dee2e6;
      --ag-row-border-color: #e0e0e0;
      font-family: inherit;
      font-size: 14px;
    }

    .ag-theme-alpine .ag-header {
      border-bottom: 2px solid #dee2e6;
    }

    .ag-theme-alpine .ag-header-cell-label {
      font-weight: 600;
      color: #495057;
      justify-content: center;
    }

    .ag-theme-alpine .ag-cell {
      display: flex;
      align-items: center;
      justify-content: center;
      line-height: 1.5;
    }

    .ag-theme-alpine .ag-row {
      border-bottom: 1px solid #e0e0e0;
    }

    .ag-theme-alpine button.btn-sm {
      padding: 6px 12px;
      font-size: 13px;
      border-radius: 4px;
      transition: all 0.2s;
    }

    .ag-theme-alpine button.btn-sm:hover {
      transform: translateY(-1px);
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    }

    /* Custom button styling */
    .ag-theme-alpine .btn-danger {
      background-color: #dc3545;
      border-color: #dc3545;
      color: white;
    }

    .ag-theme-alpine .btn-danger:hover {
      background-color: #c82333;
      border-color: #bd2130;
    }

    /* Form styling */
    .form-control:focus {
      border-color: #4a90e2;
      box-shadow: 0 0 0 0.2rem rgba(74, 144, 226, 0.25);
    }

    .btn-primary {
      background-color: #4a90e2;
      border-color: #4a90e2;
    }

    .btn-primary:hover {
      background-color: #357abd;
      border-color: #2d6da3;
    }
  </style>
</head>

<body>
  <%- include('adminHeader') %>

    <div class="container my-5 box">
      <h3 class="mb-4">Quản lý Ký Tự Bắt Đầu Khoa</h3>

      <!-- Form thêm mới -->
      <form id="add-form" class="row g-3 mb-4">
        <div class="col-md-4">
          <label for="viet_tat" class="form-label">Viết tắt *</label>
          <input type="text" class="form-control" id="viet_tat" name="viet_tat" maxlength="5" placeholder="B, C, D..."
            style="text-transform: uppercase;" required />
        </div>

        <div class="col-md-4">
          <label for="khoa" class="form-label">Khoa *</label>
          <select class="form-select" id="khoa" name="khoa" required>
          </select>
        </div>

        <div class="col-md-2 d-flex align-items-end">
          <button type="submit" class="btn w-100" style="margin-bottom: 0 !important;">
            Thêm mới
          </button>
        </div>
      </form>

      <!-- AG Grid Container -->
      <div id="grid-container" class="ag-theme-alpine" style="height: 500px; width: 100%;"></div>
    </div>

    <!-- jQuery -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <!-- SweetAlert2 JS -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.6.16/dist/sweetalert2.all.min.js"></script>

    <!-- Toastify JS -->
    <script src="https://cdn.jsdelivr.net/npm/toastify-js"></script>

    <!-- AG Grid JS (Local) -->
    <script src="/js/TKB/ag-grid-community.min.js"></script>

    <script>
      let gridApi;
      let khoaList = []; // Danh sách khoa từ API
      let khoaMap = {}; // Map ID -> Tên khoa

      // ========== Custom Cell Editor cho Khoa ==========
      class KhoaSelectEditor {
        init(params) {
          this.params = params;

          // Tạo select element
          this.eSelect = document.createElement('select');
          this.eSelect.className = 'form-select';
          this.eSelect.style.width = '100%';
          this.eSelect.style.height = '100%';

          // Populate options: value = ID, text = Tên khoa
          khoaList.forEach(khoa => {
            const option = document.createElement('option');
            option.value = khoa.id;  // ✅ Value là ID khoa
            option.text = khoa.TenPhongBan;  // ✅ Text là Tên khoa
            this.eSelect.appendChild(option);
          });

          // Set giá trị hiện tại (pre-select)
          this.eSelect.value = params.value;

          // ✅ Tự động cập nhật khi user chọn xong
          this.eSelect.addEventListener('change', () => {
            // Stop editing ngay khi chọn xong
            params.stopEditing();
          });

          // ✅ Tự động cập nhật khi click ra ngoài
          this.eSelect.addEventListener('blur', () => {
            // Stop editing khi mất focus
            setTimeout(() => params.stopEditing(), 0);
          });

          // Focus vào select
          setTimeout(() => this.eSelect.focus(), 0);
        }

        getGui() {
          return this.eSelect;
        }

        getValue() {
          // Trả về ID khoa (number)
          return parseInt(this.eSelect.value);
        }

        destroy() {
          // Cleanup
        }

        isPopup() {
          return false;
        }
      }

      // ========== Custom Cell Editor cho Viết Tắt ==========
      class VietTatEditor {
        init(params) {
          this.params = params;

          // Tạo input element
          this.eInput = document.createElement('input');
          this.eInput.type = 'text';
          this.eInput.className = 'form-control';
          this.eInput.style.width = '100%';
          this.eInput.style.height = '100%';
          this.eInput.style.textTransform = 'uppercase';  // ✅ Tự động HOA
          this.eInput.maxLength = 5;

          // Set giá trị hiện tại
          this.eInput.value = params.value || '';

          // Tự động uppercase khi nhập
          this.eInput.addEventListener('input', (e) => {
            e.target.value = e.target.value.toUpperCase();
          });

          // Stop editing khi blur
          this.eInput.addEventListener('blur', () => {
            setTimeout(() => params.stopEditing(), 0);
          });

          // Stop editing khi nhấn Enter
          this.eInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
              params.stopEditing();
            }
          });

          // Focus và select all
          setTimeout(() => {
            this.eInput.focus();
            this.eInput.select();
          }, 0);
        }

        getGui() {
          return this.eInput;
        }

        getValue() {
          return this.eInput.value.toUpperCase().trim();
        }

        destroy() {
          // Cleanup
        }

        isPopup() {
          return false;
        }
      }

      // Load danh sách khoa từ API
      async function loadKhoaList() {
        try {
          const response = await fetch('/api/shared/phong-ban-info');
          const data = await response.json();
          khoaList = data;

          // Tạo map để tra cứu nhanh
          khoaList.forEach(khoa => {
            khoaMap[khoa.id] = khoa.TenPhongBan;
          });

          // Populate select dropdown
          const khoaSelect = document.getElementById('khoa');
          khoaList.forEach(khoa => {
            const option = document.createElement('option');
            option.value = khoa.id;
            option.textContent = khoa.TenPhongBan;
            khoaSelect.appendChild(option);
          });
        } catch (error) {
          console.error('Error loading khoa list:', error);
        }
      }

      // Column Definitions
      const columnDefs = [
        {
          headerName: "STT",
          valueGetter: (params) => params.node.rowIndex + 1,
          width: 100,
          maxWidth: 100,
          editable: false,
          cellStyle: {
            fontWeight: "bold",
            textAlign: "center",
            display: "flex",
            alignItems: "center",
            justifyContent: "center"
          }
        },
        {
          field: "id",
          headerName: "ID",
          width: 80,
          editable: false,
          hide: true // Ẩn ID, chỉ dùng cho backend
        },
        {
          field: "viet_tat",
          headerName: "Viết tắt",
          flex: 1,
          minWidth: 150,
          editable: true,
          cellEditor: VietTatEditor,  // ✅ Dùng Custom Editor
          cellStyle: {
            display: "flex",
            alignItems: "center",
            justifyContent: "center",
            textTransform: "uppercase"  // ✅ Hiển thị bằng chữ HOA
          }
        },
        {
          field: "khoa",
          headerName: "Khoa",
          flex: 1,
          minWidth: 200,
          editable: true,
          cellEditor: KhoaSelectEditor,  // ✅ Dùng Custom Editor
          valueFormatter: (params) => {
            // Hiển thị tên khoa thay vì ID
            return khoaMap[params.value] || params.value;
          },
          cellStyle: {
            display: "flex",
            alignItems: "center",
            justifyContent: "center"
          }
        },
        {
          headerName: "Hành động",
          width: 120,
          maxWidth: 120,
          editable: false,
          cellStyle: {
            display: "flex",
            alignItems: "center",
            justifyContent: "center"
          },
          cellRenderer: (params) => {
            return `
              <button 
                type="button" 
                class="btn btn-sm btn-danger" 
                onclick="deleteRecord(${params.data.id})"
                title="Xóa bản ghi"
              >
                <i class="bi bi-trash3"></i>
              </button>
            `;
          }
        }
      ];

      // Grid Options
      const gridOptions = {
        columnDefs: columnDefs,
        rowData: [],
        defaultColDef: {
          resizable: true,
          sortable: true,
          filter: true,
          cellStyle: {
            display: "flex",
            alignItems: "center",
            justifyContent: "center"
          }
        },
        rowHeight: 45,
        headerHeight: 45,
        getRowId: (params) => params.data.id,
        onGridReady: (params) => {
          gridApi = params.api;
          loadData();
          // Auto-size columns to fit
          params.api.sizeColumnsToFit();
        },
        onCellValueChanged: onCellEdit,
        singleClickEdit: true,
        suppressClickEdit: false,
        overlayNoRowsTemplate: '<span style="padding: 10px; color: #999;">Không có dữ liệu</span>',
        overlayLoadingTemplate: '<span style="padding: 10px;">Đang tải dữ liệu...</span>'
      };

      document.addEventListener('DOMContentLoaded', async function () {
        // Load khoa list first
        await loadKhoaList();

        const gridDiv = document.getElementById('grid-container');
        new agGrid.Grid(gridDiv, gridOptions);

        // Setup Add Form Handler
        document.getElementById('add-form').addEventListener('submit', handleAddNew);
      });

      // Load Data
      async function loadData() {
        try {
          gridApi.showLoadingOverlay();

          const response = await fetch('/api/kytubatdau/list');
          const data = await response.json();

          gridApi.setRowData(data);

          if (data.length === 0) {
            gridApi.showNoRowsOverlay();
          } else {
            gridApi.hideOverlay();
          }
        } catch (error) {
          console.error('Error loading data:', error);
          Swal.fire('Lỗi', 'Không thể tải dữ liệu', 'error');
          gridApi.hideOverlay();
        }
      }

      // Handle Cell Edit
      async function onCellEdit(event) {
        const { data, colDef, newValue, oldValue } = event;

        console.log('Edited data:', data);
        console.log('Column:', colDef.field);
        console.log('Old Value:', oldValue);
        console.log('New Value:', newValue);

        if (newValue === oldValue) return;

        try {
          const response = await fetch(`/api/kytubatdau/${data.id}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              viet_tat: data.viet_tat,
              khoa: data.khoa  // ✅ Gửi ID khoa (đã được convert bởi valueParser)
            })
          });

          const result = await response.json();

          if (response.ok) {
            Toastify({
              text: "✅ Cập nhật thành công!",
              duration: 2000,
              gravity: "top",
              position: "right",
              backgroundColor: "#4CAF50"
            }).showToast();
          } else {
            throw new Error(result.message || 'Cập nhật thất bại');
          }
        } catch (error) {
          console.error('Update error:', error);
          Swal.fire('Lỗi', error.message, 'error');
          loadData(); // Reload to revert changes
        }
      }

      // Handle Add New
      async function handleAddNew(e) {
        e.preventDefault();

        const vietTat = document.getElementById('viet_tat').value.toUpperCase().trim();
        const khoa = document.getElementById('khoa').value;

        if (!vietTat || !khoa) {
          Swal.fire('Lỗi', 'Vui lòng điền đầy đủ thông tin', 'warning');
          return;
        }

        try {
          const response = await fetch('/api/kytubatdau', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              viet_tat: vietTat,
              khoa: khoa
            })
          });

          const result = await response.json();

          if (response.ok) {
            Swal.fire({
              title: 'Thành công',
              text: 'Thêm mới thành công!',
              icon: 'success',
              timer: 1500,
              showConfirmButton: false
            });

            document.getElementById('add-form').reset();
            loadData(); // Reload grid
          } else {
            throw new Error(result.message || 'Thêm mới thất bại');
          }
        } catch (error) {
          console.error('Add error:', error);
          Swal.fire('Lỗi', error.message, 'error');
        }
      }

      // Handle Delete
      async function deleteRecord(id) {
        const result = await Swal.fire({
          title: 'Xác nhận xóa',
          text: 'Bạn có chắc chắn muốn xóa bản ghi này?',
          icon: 'warning',
          showCancelButton: true,
          confirmButtonColor: '#d33',
          cancelButtonColor: '#3085d6',
          confirmButtonText: 'Xóa',
          cancelButtonText: 'Hủy'
        });

        if (!result.isConfirmed) return;

        try {
          const response = await fetch(`/api/kytubatdau/${id}`, {
            method: 'DELETE'
          });

          const data = await response.json();

          if (response.ok) {
            Swal.fire('Đã xóa!', 'Xóa thành công', 'success');
            gridApi.applyTransaction({ remove: [{ id }] });
          } else {
            throw new Error(data.message || 'Xóa thất bại');
          }
        } catch (error) {
          console.error('Delete error:', error);
          Swal.fire('Lỗi', error.message, 'error');
        }
      }

      // Change password link handler
      document.addEventListener('DOMContentLoaded', function () {
        const changePasswordLink = document.getElementById("changePasswordLink");
        if (changePasswordLink) {
          changePasswordLink.addEventListener("click", function (event) {
            event.preventDefault();
            const tenDangNhap = localStorage.getItem("TenDangNhap");

            if (tenDangNhap) {
              window.location.href = `/changePassword?tenDangNhap=${encodeURIComponent(tenDangNhap)}`;
            } else {
              alert("Không tìm thấy TenDangNhap trong localStorage.");
            }
          });
        }
      });
    </script>
</body>

</html>