<!DOCTYPE html>
<html lang="vi">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Học Viện Kỹ Thuật Mật Mã - UNC ngoài - Import file</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
  <link rel="stylesheet" href="/css/styles.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css">
  
  <!-- SweetAlert2 CSS -->
  <link href="https://cdn.jsdelivr.net/npm/sweetalert2@11.6.16/dist/sweetalert2.min.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.6.16/dist/sweetalert2.all.min.js"></script>
</head>

<body>
  <%- include('header') %>

  <div class="container-fluid my-4" style="padding-left: 20px">
    <div class="card">
      <div class="card-header">
        <h5 class="mb-0">
          <i class="fas fa-file-import me-2"></i>UNC ngoài - Import file
        </h5>
      </div>
      <div class="card-body">
        <!-- Form upload file -->
        <div class="mb-4">
          <label for="excel-file" class="form-label"><strong>Chọn file Excel</strong></label>
          <input type="file" class="form-control" id="excel-file" accept=".xlsx,.xls">
          <small class="form-text text-muted">
            File Excel cần có 4 cột: <strong>STT</strong>, <strong>Tên khách hàng</strong>, <strong>Số tài khoản</strong>, <strong>Tên ngân hàng</strong>
          </small>
        </div>
        <div class="mb-3">
          <button type="button" class="btn btn-primary" onclick="importExcel()">
            <i class="fas fa-upload me-1"></i>Import file
          </button>
          <button type="button" class="btn btn-success ms-2" onclick="exportExcel()">
            <i class="fas fa-file-excel me-1"></i>Xuất file Excel (từ CSDL)
          </button>
        </div>

        <!-- Bảng hiển thị dữ liệu -->
        <div id="data-table-container" style="display: none;">
          <h6 class="mb-3">Dữ liệu đã import (có thể sửa/xóa trực tiếp):</h6>
          <div class="alert alert-info mb-3">
            <i class="fas fa-info-circle me-1"></i>
            <strong>Lưu ý:</strong> STT trong file Excel chỉ để tham khảo. Khi lưu vào CSDL, STT sẽ tự động tăng từ số lớn nhất hiện có + 1.
          </div>
          <div class="table-responsive">
            <table class="table table-bordered table-hover" id="imported-data-table">
              <thead class="table-light">
                <tr>
                  <th style="width: 80px;">STT (tham khảo)</th>
                  <th>Tên khách hàng</th>
                  <th>Số tài khoản</th>
                  <th>Tên ngân hàng</th>
                  <th style="width: 120px;">Thao tác</th>
                </tr>
              </thead>
              <tbody id="imported-data-tbody">
              </tbody>
            </table>
          </div>
          <div class="mt-3">
            <button type="button" class="btn btn-primary" onclick="saveAllToDatabase()">
              <i class="fas fa-save me-1"></i>Lưu tất cả vào CSDL
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    let importedData = []; // Lưu dữ liệu đã import

    // Hàm import file Excel
    function importExcel() {
      const fileInput = document.getElementById('excel-file');
      const file = fileInput.files[0];

      if (!file) {
        Swal.fire({
          title: 'Thông báo',
          text: 'Vui lòng chọn file Excel',
          icon: 'warning'
        });
        return;
      }

      const formData = new FormData();
      formData.append('file', file);

      Swal.fire({
        title: 'Đang xử lý...',
        text: 'Vui lòng chờ trong giây lát',
        allowOutsideClick: false,
        didOpen: () => {
          Swal.showLoading();
        }
      });

      fetch('/uy-nhiem-chi/unc-ngoai/nhap-du-lieu/import-file/api/import', {
        method: 'POST',
        body: formData
      })
        .then(response => response.json())
        .then(data => {
          Swal.close();
          if (data.success) {
            importedData = data.data || [];
            displayImportedData();
            Swal.fire({
              title: 'Thành công',
              text: `Đã import ${importedData.length} dòng dữ liệu`,
              icon: 'success'
            });
          } else {
            Swal.fire({
              title: 'Lỗi',
              text: data.message || 'Không thể import file',
              icon: 'error'
            });
          }
        })
        .catch(error => {
          Swal.close();
          console.error('Error:', error);
          Swal.fire({
            title: 'Lỗi',
            text: 'Có lỗi xảy ra khi import file',
            icon: 'error'
          });
        });
    }

    // Hiển thị dữ liệu đã import
    function displayImportedData() {
      const tbody = document.getElementById('imported-data-tbody');
      const container = document.getElementById('data-table-container');
      
      if (importedData.length === 0) {
        container.style.display = 'none';
        return;
      }

      container.style.display = 'block';
      tbody.innerHTML = '';

      importedData.forEach((row, index) => {
        const tr = document.createElement('tr');
        tr.setAttribute('data-index', index);
        tr.innerHTML = `
          <td>
            <input type="number" class="form-control form-control-sm" value="${row.stt || ''}" 
                   readonly style="background-color: #f8f9fa;" title="STT sẽ tự động tăng khi lưu">
          </td>
          <td>
            <input type="text" class="form-control form-control-sm" value="${row.tenkhachhang || ''}" 
                   onchange="updateImportedData(${index}, 'tenkhachhang', this.value)">
          </td>
          <td>
            <input type="text" class="form-control form-control-sm" value="${row.sotaikhoan || ''}" 
                   onchange="updateImportedData(${index}, 'sotaikhoan', this.value)">
          </td>
          <td>
            <input type="text" class="form-control form-control-sm" value="${row.tennganhang || ''}" 
                   onchange="updateImportedData(${index}, 'tennganhang', this.value)">
          </td>
          <td>
            <button type="button" class="btn btn-sm btn-danger" onclick="deleteImportedRow(${index})">
              <i class="fas fa-trash"></i> Xóa
            </button>
          </td>
        `;
        tbody.appendChild(tr);
      });
    }

    // Cập nhật dữ liệu đã import
    function updateImportedData(index, field, value) {
      if (importedData[index]) {
        importedData[index][field] = value;
      }
    }

    // Xóa một dòng
    function deleteImportedRow(index) {
      Swal.fire({
        title: 'Xác nhận xóa',
        text: 'Bạn có chắc chắn muốn xóa dòng này?',
        icon: 'warning',
        showCancelButton: true,
        confirmButtonText: 'Xóa',
        cancelButtonText: 'Hủy'
      }).then((result) => {
        if (result.isConfirmed) {
          importedData.splice(index, 1);
          displayImportedData();
          if (importedData.length === 0) {
            document.getElementById('btn-export').style.display = 'none';
          }
        }
      });
    }

    // Lưu tất cả vào CSDL
    function saveAllToDatabase() {
      if (importedData.length === 0) {
        Swal.fire({
          title: 'Thông báo',
          text: 'Không có dữ liệu để lưu',
          icon: 'warning'
        });
        return;
      }

      // Validate dữ liệu (không validate STT vì sẽ tự động tăng)
      const invalidRows = [];
      importedData.forEach((row, index) => {
        if (!row.tenkhachhang || !row.sotaikhoan || !row.tennganhang) {
          invalidRows.push(index + 1);
        }
      });

      if (invalidRows.length > 0) {
        Swal.fire({
          title: 'Lỗi',
          text: `Vui lòng điền đầy đủ thông tin cho các dòng: ${invalidRows.join(', ')}`,
          icon: 'error'
        });
        return;
      }

      Swal.fire({
        title: 'Xác nhận',
        text: `Bạn có chắc chắn muốn lưu ${importedData.length} dòng vào CSDL?`,
        icon: 'question',
        showCancelButton: true,
        confirmButtonText: 'Lưu',
        cancelButtonText: 'Hủy'
      }).then((result) => {
        if (!result.isConfirmed) return;

        Swal.fire({
          title: 'Đang lưu...',
          text: 'Vui lòng chờ trong giây lát',
          allowOutsideClick: false,
          didOpen: () => {
            Swal.showLoading();
          }
        });

        fetch('/uy-nhiem-chi/unc-ngoai/nhap-du-lieu/import-file/api/save-all', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ data: importedData })
        })
          .then(response => response.json())
          .then(data => {
            Swal.close();
            if (data.success) {
              Swal.fire({
                title: 'Thành công',
                text: data.message || `Đã lưu ${importedData.length} dòng vào CSDL`,
                icon: 'success'
              });
              // Reset
              importedData = [];
              document.getElementById('excel-file').value = '';
              document.getElementById('data-table-container').style.display = 'none';
            } else {
              Swal.fire({
                title: 'Lỗi',
                text: data.message || 'Không thể lưu dữ liệu',
                icon: 'error'
              });
            }
          })
          .catch(error => {
            Swal.close();
            console.error('Error:', error);
            Swal.fire({
              title: 'Lỗi',
              text: 'Có lỗi xảy ra khi lưu dữ liệu',
              icon: 'error'
            });
          });
      });
    }

    // Xuất file Excel từ CSDL
    function exportExcel() {
      Swal.fire({
        title: 'Đang xuất file...',
        text: 'Vui lòng chờ trong giây lát',
        allowOutsideClick: false,
        didOpen: () => {
          Swal.showLoading();
        }
      });

      fetch('/uy-nhiem-chi/unc-ngoai/nhap-du-lieu/import-file/api/export-from-db', {
        method: 'GET'
      })
        .then(response => {
          if (response.ok) {
            return response.blob();
          } else {
            return response.json().then(data => {
              throw new Error(data.message || 'Có lỗi xảy ra');
            });
          }
        })
        .then(blob => {
          Swal.close();
          const url = window.URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = `UNC_ngoai_${new Date().getTime()}.xlsx`;
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          window.URL.revokeObjectURL(url);
          
          Swal.fire({
            title: 'Thành công',
            text: 'Đã xuất file Excel thành công',
            icon: 'success'
          });
        })
        .catch(error => {
          Swal.close();
          console.error('Error:', error);
          Swal.fire({
            title: 'Lỗi',
            text: error.message || 'Có lỗi xảy ra khi xuất file Excel',
            icon: 'error'
          });
        });
    }
  </script>
</body>

</html>


