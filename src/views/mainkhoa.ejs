<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>H·ªçc Vi·ªán K·ªπ Thu·∫≠t M·∫≠t M√£</title>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css"
    />
    <link rel="stylesheet" href="/css/styles.css" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css"
    />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
      .notification {
        max-width: 500px;
        border-width: 1px;
        border-color: rgba(219, 234, 254, 1);
        border-radius: 1rem;
        background-color: rgba(255, 255, 255, 1);
        padding: 1rem;
        display: none;
        /* ·∫®n form ban ƒë·∫ßu */
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        border-radius: 10px;
        /* G√≥c tr√≤n */
        padding: 20px;
        background-color: white;
        z-index: 2000;
        width: 500px;
        box-shadow: 0px 6px 16px rgba(0, 0, 0, 0.2);
        /* TƒÉng b√≥ng ƒë·ªï */
        font-family: Arial, sans-serif;
      }

      .header {
        display: flex;
        align-items: center;
        grid-gap: 1rem;
        gap: 1rem;
      }

      .icon {
        flex-shrink: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 9999px;
        background-color: rgba(96, 165, 250, 1);
        padding: 0.5rem;
        color: rgba(255, 255, 255, 1);
      }

      .icon svg {
        height: 1rem;
        width: 1rem;
      }

      .alert {
        font-weight: 600;
        color: rgba(107, 114, 128, 1);
      }

      .message {
        margin-top: 1rem;
        color: rgba(107, 114, 128, 1);
      }

      .actions {
        margin-top: 1.5rem;
      }

      .actions button {
        text-decoration: none;
      }

      .mark-as-read,
      .read {
        display: inline-block;
        border-radius: 0.5rem;
        width: 100%;
        padding: 0.75rem 1.25rem;
        text-align: center;
        font-size: 0.875rem;
        line-height: 1.25rem;
        font-weight: 600;
      }

      .read {
        background-color: rgba(59, 130, 246, 1);
        color: rgba(255, 255, 255, 1);
        border: none;
      }

      .mark-as-read {
        margin-top: 0.5rem;
        background-color: rgba(249, 250, 251, 1);
        color: rgba(107, 114, 128, 1);
        transition: all 0.15s ease;
      }

      .mark-as-read:hover {
        background-color: rgb(230, 231, 233);
      }
    </style>
    </style>
    <style>
      /* ƒê·ªãnh d·∫°ng cho b·∫£ng */
      .table {
        width: 70%;
        border-collapse: separate;
        border-spacing: 0;
        margin-top: 20px;
        font-size: 0.9em;
        box-shadow: 0 0 20px rgba(0, 0, 0, 0.15);
        border-radius: 8px;
        overflow: hidden;
        justify-self: center;
      }

      .table th,
      .table td {
        padding: 10px;
        text-align: left;
        border: 1px solid #dee2e6;
        border-right: 2px solid #dee2e6;
        border-left: 2px solid #dee2e6;
      }

      .table th {
        background-color: blue;
        color: white;
        font-weight: bold;
        border-right: 2px solid #fff;
      }

      .table th:last-child {
        border-right: 2px solid #dee2e6;
      }

      .table tbody tr {
        border-bottom: 1px solid #dddddd;
        transition: all 0.3s ease;
      }

      .table tbody tr:nth-child(even) {
        background-color: #f3f3f3;
      }

      .table tbody tr:last-of-type {
        border-bottom: 2px solid #009879;
      }

      .table tbody tr:hover {
        background-color: #f5f5f5;
        transform: scale(1.01);
      }

      /* ƒê·ªãnh d·∫°ng cho bi·ªÉu ƒë·ªì */
      .chart {
        width: 80%;
        margin-left: 10%;
      }

      /* ƒê·ªãnh d·∫°ng cho ti√™u ƒë·ªÅ */
      h3 {
        color: #009879;
        text-align: center;
        margin: 30px 0;
        font-weight: 600;
        position: relative;
        padding-bottom: 10px;
      }

      h3:after {
        content: "";
        position: absolute;
        bottom: 0;
        left: 50%;
        transform: translateX(-50%);
        width: 100px;
        height: 3px;
        background: #009879;
      }

      /* ƒê·ªãnh d·∫°ng cho t·ªïng s·ªë ti·∫øt */
      .total-label {
        background: #f8f9fa;
        padding: 15px 20px;
        border-radius: 8px;
        margin: 20px auto;
        width: fit-content;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        font-weight: bold;
        color: #009879;
      }

      .value {
        color: #dc3545;
        font-size: 1.1em;
        margin-left: 5px;
      }

      /* Container cho c√°c controls */
      .controls-container {
        display: flex;
        justify-content: start;
        align-items: center;
        gap: 10px;
        margin: 20px;
        flex-wrap: wrap;
      }

      /* Responsive design */
      @media (max-width: 768px) {
        #thongkethonghopCanvas {
          width: 70%;
          height: 300px;
        }

        .table {
          font-size: 0.8em;
        }
      }

      /* Th√™m container cho 2 bi·ªÉu ƒë·ªì t·∫•t c·∫£ khoa */
      .charts-container {
        display: flex;
        justify-content: flex-start;
        align-items: flex-start;
        gap: 20px;
        margin: 5px 0;
        flex-wrap: wrap; /* ƒê·∫£m b·∫£o t∆∞∆°ng th√≠ch v·ªõi m√†n h√¨nh nh·ªè */
      }

      .chart-wrapper {
        flex: 1; /* Chia ƒë·ªÅu chi·ªÅu r·ªông */
        min-width: 300px; /* ƒê·∫£m b·∫£o k√≠ch th∆∞·ªõc t·ªëi thi·ªÉu */
        max-width: 33%; /* ƒê·∫£m b·∫£o kh√¥ng v∆∞·ª£t qu√° 33% chi·ªÅu r·ªông */
        background: white;
        border-radius: 12px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        padding: 15px;
      }
    </style>
</head>

<body>
<%- include('header') %>

<div class="d-flex justify-content-start align-items-end mb-3">

       <!-- Combo box k√¨ -->
       <select class="form-select mx-1 selectop" id="comboboxki">
        <option value="ALL">C·∫£ nƒÉm</option>
      </select>

      <!-- Combo box NƒÉm -->
      <select
        class="form-select mx-1 selectop"
        style="width: 200px"
        id="NamHoc"
      >
        <option value="ALL">T·∫•t c·∫£ nƒÉm</option>
      </select>
    </div>
    <!-- Ph·∫ßn n·ªôi dung -->

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <div class="chart">
      <h3>Th·ªëng k√™ t·ªïng h·ª£p</h3>
      <canvas id="chart"></canvas>
    </div>
    <div class="charts-container">
      <!-- Bi·ªÉu ƒë·ªì tr√≤n 1: S·ªë ti·∫øt m·ªùi gi·∫£ng -->
      <div class="chart-wrapper">
        <h3>Ph·∫ßn trƒÉm s·ªë ti·∫øt m·ªùi gi·∫£ng</h3>
        <canvas id="moiGiangPieChart"></canvas>
      </div>

      <!-- Bi·ªÉu ƒë·ªì tr√≤n 2: S·ªë ti·∫øt v∆∞·ª£t gi·ªù -->
      <div class="chart-wrapper">
        <h3>Ph·∫ßn trƒÉm s·ªë ti·∫øt v∆∞·ª£t gi·ªù</h3>
        <canvas id="vuotGioPieChart"></canvas>
      </div>

      <!-- Bi·ªÉu ƒë·ªì tr√≤n 3: T·ªïng s·ªë ti·∫øt -->
      <div class="chart-wrapper">
        <h3>T·ªïng s·ªë ti·∫øt (M·ªùi gi·∫£ng + V∆∞·ª£t gi·ªù)</h3>
        <canvas id="tongTietPieChart"></canvas>
      </div>
    </div>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
      async function fetchData1() {
        try {
          const ki = document.getElementById("comboboxki").value;
          const nam = document.getElementById("NamHoc").value;

          const response = await fetch(
            `/api/thongketonghop-data?kihoc=${ki}&namhoc=${nam}`
          );
          const data = await response.json();
          console.log("D·ªØ li·ªáu nh·∫≠n ƒë∆∞·ª£c:", data);

          const labels = data.map((item) => item.Khoa);
          const moiGiangData = data.map((item) => item.TongSoTietMoiGiang);
          const vuotGioData = data.map((item) => item.TongSoTiet);

          // X√≥a d·ªØ li·ªáu c≈©
          if (!data || data.length === 0) {
            console.log("Kh√¥ng c√≥ d·ªØ li·ªáu");
            document.getElementById("chart").style.display = "none";
            return;
          }

          // Destroy existing chart if it exists
          if (window.myChart) {
            window.myChart.destroy();
          }

          // T·∫°o bi·ªÉu ƒë·ªì
          const ctx = document.getElementById("chart").getContext("2d");
          window.myChart = new Chart(ctx, {
            type: "bar",
            data: {
              labels: labels,
              datasets: [
                {
                  label: "T·ªïng s·ªë ti·∫øt m·ªùi gi·∫£ng",
                  data: moiGiangData,
                  backgroundColor: "red",
                  borderColor: "rgba(75, 192, 192, 1)",
                  borderWidth: 1,
                },
                {
                  label: "T·ªïng s·ªë ti·∫øt t√≠nh v∆∞·ª£t gi·ªù",
                  data: vuotGioData,
                  backgroundColor: "blue",
                  borderColor: "rgba(255, 99, 132, 1)",
                  borderWidth: 1,
                },
              ],
            },
            options: {
              responsive: true,
              plugins: {
                legend: {
                  position: "top",
                },
                tooltip: {
                  callbacks: {
                    label: function (context) {
                      const rawValue = context.raw || 0;
                      const chart = context.chart;
                      const datasets = chart.data.datasets;
                      const index = context.dataIndex;
                      const totalAtIndex = datasets.reduce((sum, ds) => {
                        const v = Array.isArray(ds.data)
                          ? parseFloat(ds.data[index]) || 0
                          : 0;
                        return sum + v;
                      }, 0);
                      const percentage = totalAtIndex > 0 ? ((rawValue / totalAtIndex) * 100).toFixed(1) : 0;
                      const value = (parseFloat(rawValue) || 0).toFixed(2);
                      return `${context.dataset.label}: ${value} ti·∫øt (${percentage}%)`;
                    },
                  },
                },
              },
              scales: {
                x: {
                  stacked: true, // Ch·ªìng c·ªôt tr√™n tr·ª•c X
                  title: {
                    display: true,
                    text: "Khoa",
                  },
                },
                y: {
                  stacked: true, // Ch·ªìng c·ªôt tr√™n tr·ª•c Y
                  title: {
                    display: true,
                    text: "S·ªë ti·∫øt",
                  },
                  beginAtZero: true,
                },
              },
            },
          });
        } catch (error) {
          console.error("L·ªói khi t·∫£i d·ªØ li·ªáu:", error);
        }
      }

      fetchData1();
    </script>

    <h3 style="margin-top: 30px; text-align: center">
      Chi ti·∫øt s·ªë ti·∫øt gi·∫£ng d·∫°y
    </h3>
    <table
      class="table table-bordered my-2"
      border="1"
      id="thongketonghopTable"
    >
      <thead>
        <tr>
          <th>Khoa</th>
          <th>S·ªë ti·∫øt m·ªùi gi·∫£ng</th>
          <th>S·ªë ti·∫øt t√≠nh v∆∞·ª£t gi·ªù</th>
          <th>
            <span title="M·ªùi gi·∫£ng + V∆∞·ª£t gi·ªù">T·ªïng s·ªë</span>
          </th>
        </tr>
      </thead>
      <tbody id="detailTable">
        <!-- D·ªØ li·ªáu s·∫Ω ƒë∆∞·ª£c th√™m v√†o ƒë√¢y -->
      </tbody>
    </table>

    <script>
      async function fetchThongKeMGData() {
        try {
          const ki = document.getElementById("comboboxki").value;
          const nam = document.getElementById("NamHoc").value;

          const response = await fetch(
            `/api/thongketonghop-data?kihoc=${ki}&namhoc=${nam}`
          );
          const data = await response.json();
          console.log("D·ªØ li·ªáu nh·∫≠n ƒë∆∞·ª£c:", data);
          // C·∫≠p nh·∫≠t b·∫£ng
          const tableBody = document.querySelector("table tbody");
          tableBody.innerHTML = ""; // X√≥a n·ªôi dung c≈© c·ªßa b·∫£ng
          if (!data || data.length === 0) {
            console.log("Kh√¥ng c√≥ d·ªØ li·ªáu");
            const row = tableBody.insertRow();
            const cell = row.insertCell(0);
            cell.colSpan = 4;
            cell.style.textAlign = "center";
            cell.textContent = "Kh√¥ng c√≥ d·ªØ li·ªáu cho kho·∫£ng th·ªùi gian n√†y";
            return;
          }

          const totalTong = data.reduce((sum, x) => sum + parseFloat(x.Tongso || 0), 0);
          data.forEach((item) => {
            const row = document.createElement("tr");
            const mg = parseFloat(item.TongSoTietMoiGiang || 0);
            const vg = parseFloat(item.TongSoTiet || 0);
            const rowTotal = mg + vg;
            const percentMG = rowTotal > 0 ? ((mg / rowTotal) * 100).toFixed(1) : 0;
            const percentVG = rowTotal > 0 ? ((vg / rowTotal) * 100).toFixed(1) : 0;
            const percentTong = totalTong > 0 ? ((parseFloat(item.Tongso || 0) / totalTong) * 100).toFixed(1) : 0;
            row.innerHTML = `
                <td>${item.Khoa} (${percentTong}%)</td>
                <td>${mg.toFixed(2)} (${percentMG}%)</td>
                <td>${vg.toFixed(2)} (${percentVG}%)</td>
                <td>${parseFloat(item.Tongso || 0).toFixed(2)}</td>
            `;
            tableBody.appendChild(row);
          });
        } catch (error) {
          console.error("L·ªói khi t·∫£i d·ªØ li·ªáu:", error);
        }
      }

      fetchThongKeMGData();
    </script>

    <script>
      async function fetchData2() {
        try {
          const ki = document.getElementById("comboboxki").value;
          const nam = document.getElementById("NamHoc").value;

          const response = await fetch(
            `/api/thongketonghop-data?kihoc=${ki}&namhoc=${nam}`
          );
          const data = await response.json();
          console.log("D·ªØ li·ªáu nh·∫≠n ƒë∆∞·ª£c:", data);

          if (!data || data.length === 0) {
            console.log("Kh√¥ng c√≥ d·ªØ li·ªáu");
            document.getElementById("moiGiangPieChart").style.display = "none";
            document.getElementById("vuotGioPieChart").style.display = "none";
            document.getElementById("tongTietPieChart").style.display = "none";
            return;
          }

          const labels = data.map((item) => item.Khoa);
          const moiGiangData = data.map((item) =>
            parseFloat(item.TongSoTietMoiGiang)
          );
          const vuotGioData = data.map((item) => parseFloat(item.TongSoTiet));
          const tongSoTietData = data.map((item) => parseFloat(item.Tongso));

          // ƒê·ªãnh nghƒ©a m√†u s·∫Øc c·ªë ƒë·ªãnh cho c√°c khoa
          const colors = [
            "#FF6384", // M√†u ƒë·ªè
            "#36A2EB", // M√†u xanh d∆∞∆°ng
            "#FFCE56", // M√†u v√†ng
            "#4BC0C0", // M√†u xanh ng·ªçc
            "#9966FF", // M√†u t√≠m
            "#FF9F40", // M√†u cam
            "#C9CBCF", // M√†u x√°m
          ];
          // Destroy existing pie charts if they exist
          if (window.moiGiangPieChart instanceof Chart) {
            window.moiGiangPieChart.destroy();
          }
          if (window.vuotGioPieChart instanceof Chart) {
            window.vuotGioPieChart.destroy();
          }
          if (window.tongTietPieChart instanceof Chart) {
            window.tongTietPieChart.destroy();
          }
          // Bi·ªÉu ƒë·ªì tr√≤n: S·ªë ti·∫øt m·ªùi gi·∫£ng
          const moiGiangCtx = document
            .getElementById("moiGiangPieChart")
            .getContext("2d");
          const totalMoiGiang = moiGiangData.reduce((sum, v) => sum + (parseFloat(v) || 0), 0);
          window.moiGiangPieChart = new Chart(moiGiangCtx, {
            type: "pie",
            data: {
              labels: labels,
              datasets: [
                {
                  label: "S·ªë ti·∫øt m·ªùi gi·∫£ng",
                  data: moiGiangData,
                  backgroundColor: colors,
                },
              ],
            },
            options: {
              responsive: true,
              plugins: {
                legend: {
                  position: "top",
                  labels: {
                    generateLabels: function (chart) {
                      const data = chart.data;
                      if (data.labels.length && data.datasets.length) {
                        return data.labels.map((label, i) => {
                          const value = data.datasets[0].data[i];
                          const percentage = totalMoiGiang > 0 ? (((value || 0) / totalMoiGiang) * 100).toFixed(1) : 0;
                          return {
                            text: `${label} (${percentage}%)`,
                            fillStyle: data.datasets[0].backgroundColor[i],
                            hidden: isNaN(value) || value === 0,
                            index: i,
                          };
                        });
                      }
                      return [];
                    },
                  },
                },
                tooltip: {
                  callbacks: {
                    label: function (context) {
                      const raw = context.raw;
                      const value = (parseFloat(raw) || 0).toFixed(2);
                      const percentage = totalMoiGiang > 0 ? (((raw || 0) / totalMoiGiang) * 100).toFixed(1) : 0;
                      return `${context.label}: ${value} ti·∫øt (${percentage}%)`;
                    },
                  },
                },
              },
            },
          });

          // Bi·ªÉu ƒë·ªì tr√≤n: S·ªë ti·∫øt v∆∞·ª£t gi·ªù
          const vuotGioCtx = document
            .getElementById("vuotGioPieChart")
            .getContext("2d");
          const totalVuotGio = vuotGioData.reduce((sum, v) => sum + (parseFloat(v) || 0), 0);
          window.vuotGioPieChart = new Chart(vuotGioCtx, {
            type: "pie",
            data: {
              labels: labels,
              datasets: [
                {
                  label: "S·ªë ti·∫øt t√≠nh v∆∞·ª£t gi·ªù",
                  data: vuotGioData,
                  backgroundColor: colors,
                },
              ],
            },
            options: {
              responsive: true,
              plugins: {
                legend: {
                  position: "top",
                  labels: {
                    generateLabels: function (chart) {
                      const data = chart.data;
                      if (data.labels.length && data.datasets.length) {
                        return data.labels.map((label, i) => {
                          const value = data.datasets[0].data[i];
                          const percentage = totalVuotGio > 0 ? (((value || 0) / totalVuotGio) * 100).toFixed(1) : 0;
                          return {
                            text: `${label} (${percentage}%)`,
                            fillStyle: data.datasets[0].backgroundColor[i],
                            hidden: isNaN(value) || value === 0,
                            index: i,
                          };
                        });
                      }
                      return [];
                    },
                  },
                },
                tooltip: {
                  callbacks: {
                    label: function (context) {
                      const raw = context.raw;
                      const value = (parseFloat(raw) || 0).toFixed(2);
                      const percentage = totalVuotGio > 0 ? (((raw || 0) / totalVuotGio) * 100).toFixed(1) : 0;
                      return `${context.label}: ${value} ti·∫øt (${percentage}%)`;
                    },
                  },
                },
              },
            },
          });

          // Bi·ªÉu ƒë·ªì tr√≤n: T·ªïng s·ªë ti·∫øt
          const tongTietCtx = document
            .getElementById("tongTietPieChart")
            .getContext("2d");
          const totalTong = tongSoTietData.reduce((sum, v) => sum + (parseFloat(v) || 0), 0);
          window.tongTietPieChart = new Chart(tongTietCtx, {
            type: "pie",
            data: {
              labels: labels,
              datasets: [
                {
                  label: "T·ªïng s·ªë ti·∫øt",
                  data: tongSoTietData,
                  backgroundColor: colors,
                },
              ],
            },
            options: {
              responsive: true,
              plugins: {
                legend: {
                  position: "top",
                  labels: {
                    generateLabels: function (chart) {
                      const data = chart.data;
                      if (data.labels.length && data.datasets.length) {
                        return data.labels.map((label, i) => {
                          const value = data.datasets[0].data[i];
                          const percentage = totalTong > 0 ? (((value || 0) / totalTong) * 100).toFixed(1) : 0;
                          return {
                            text: `${label} (${percentage}%)`,
                            fillStyle: data.datasets[0].backgroundColor[i],
                            hidden: isNaN(value) || value === 0,
                            index: i,
                          };
                        });
                      }
                      return [];
                    },
                  },
                },
                tooltip: {
                  callbacks: {
                    label: function (context) {
                      const raw = context.raw;
                      const value = (parseFloat(raw) || 0).toFixed(2);
                      const percentage = totalTong > 0 ? (((raw || 0) / totalTong) * 100).toFixed(1) : 0;
                      return `${context.label}: ${value} ti·∫øt (${percentage}%)`;
                    },
                  },
                },
              },
            },
          });
        } catch (error) {
          console.error("L·ªói khi t·∫£i d·ªØ li·ªáu:", error);
        }
      }

      fetchData2();
    </script>

    <script>
      $(document).ready(async function () {
          // L·∫•y d·ªØ li·ªáu h·ªá ƒë√†o t·∫°o
          await preloadHeDaoTao();   // g·ªçi 1 l·∫ßn khi load

          // Kh·ªüi t·∫°o c√°c combobox
          function initializeComboboxes() {
              // L·∫•y d·ªØ li·ªáu cho combobox NƒÉm v√† K·ª≥
              $.ajax({
                  url: '/getNamHocTH',
                  method: 'GET',
                  success: function (response) {
                      if (response.success) {
                          // Populate combobox NamHoc
                          $('#NamHoc').empty();
                          response.NamHoc.forEach(function (item) {
                              $('#NamHoc').append(
                                  `<option value="${item.NamHoc}">${
                                      item.NamHoc === "ALL" ? "T·∫•t c·∫£ nƒÉm" : item.NamHoc
                                  }</option>`
                              );
                          });

                          // ƒê·∫∑t gi√° tr·ªã m·∫∑c ƒë·ªãnh l√† nƒÉm l·ªõn nh·∫•t
                          if (response.MaxNamHoc) {
                              $('#NamHoc').val(response.MaxNamHoc).trigger('change');
                          }

                          // Populate combobox Ki
                          $('#comboboxki').empty();
                          response.Ki.forEach(function (item) {
                              $('#comboboxki').append(
                                  `<option value="${item.Ki}">${
                                      item.Ki === "ALL" ? "C·∫£ nƒÉm" : item.Ki
                                  }</option>`
                              );
                          });
                      }
                  },
                  error: function (xhr, status, error) {
                      console.error("L·ªói khi t·∫£i d·ªØ li·ªáu:", error);
                  }
              });
          }

          // G·ªçi h√†m kh·ªüi t·∫°o khi trang ƒë∆∞·ª£c t·∫£i
          initializeComboboxes();

          // L·∫Øng nghe s·ª± ki·ªán thay ƒë·ªïi tr√™n c√°c combobox
          $('#comboboxki, #NamHoc').on('change', function () {
              fetchThongKeData(); // G·ªçi h√†m ƒë·ªÉ l·∫•y d·ªØ li·ªáu m·ªõi
          });

          async function fetchThongKeData() {
              const ki = $('#comboboxki').val();
              const nam = $('#NamHoc').val();

              let url = '/api/thongketonghop-data';
              const params = new URLSearchParams();

              // Ch·ªâ th√™m tham s·ªë n·∫øu kh√¥ng ph·∫£i l√† "ALL"
              if (ki && ki !== 'ALL') params.append('kihoc', ki);
              if (nam && nam !== 'ALL') params.append('namhoc', nam);

              // N·∫øu c√≥ tham s·ªë, th√™m v√†o URL
              if (params.toString()) {
                  url += '?' + params.toString();
              }

              try {
                  const response = await fetch(url);
                  const data = await response.json();
                  // C·∫≠p nh·∫≠t b·∫£ng v√† bi·ªÉu ƒë·ªì v·ªõi d·ªØ li·ªáu m·ªõi
                  fetchData1();
                  fetchThongKeMGData();
                  fetchData2();
              } catch (error) {
                  console.error("L·ªói khi t·∫£i d·ªØ li·ªáu:", error);
              }
          }
       });

       <!-- Th√™m event listeners cho c√°c combo box -->
       document.getElementById('comboboxki').addEventListener('change', () => {
         fetchData1();
         fetchThongKeMGData();
         fetchData2();
        });

        document.getElementById('NamHoc').addEventListener('change', () => {
          fetchData1();
          fetchThongKeMGData();
          fetchData2();
        });

        async function preloadHeDaoTao() {
          const CACHE_KEY = 'HE_DAO_TAO_CACHE';
          const CACHE_TIME_KEY = 'HE_DAO_TAO_CACHE_TIME';
          const TTL = 24 * 60 * 60 * 1000; // 24h

          const cached = localStorage.getItem(CACHE_KEY);
          const cachedTime = localStorage.getItem(CACHE_TIME_KEY);

          // ‚úÖ D√ôNG CACHE (TR·∫¢ V·ªÄ M·∫¢NG)
          if (cached && cachedTime && Date.now() - Number(cachedTime) < TTL) {
            console.log('H·ªá ƒë√†o t·∫°o: d√πng cache');
            try {
              return JSON.parse(cached); // üî• M·∫¢NG THU·∫¶N
            } catch (e) {
              console.warn('Cache l·ªói, g·ªçi l·∫°i API');
            }
          }

          // ‚úÖ G·ªåI API
          console.log('H·ªá ƒë√†o t·∫°o: g·ªçi API');
          const res = await fetch('/api/gvm/v1/he-dao-tao');
          const json = await res.json();

          if (!json.success || !Array.isArray(json.data)) {
            console.error('API l·ªói ho·∫∑c data kh√¥ng h·ª£p l·ªá');
            return [];
          }

          // ‚úÖ CHU·∫®N H√ìA DATA
          const formattedData = json.data.map(item => ({
            id: item.id,
            tenHe: item.he_dao_tao
          }));

          // ‚úÖ L∆ØU CACHE (CH·ªà L∆ØU M·∫¢NG)
          localStorage.setItem(CACHE_KEY, JSON.stringify(formattedData));
          localStorage.setItem(CACHE_TIME_KEY, Date.now());

          return formattedData;
        }

    </script>


    <!-- Tab th√¥ng b√°o -->
    <div id="notifications-container"></div>




      <!-- Tab th√¥ng b√°o -->
      <div id="notifications-container"></div>
      <!-- 4. N√∫t quay v·ªÅ ƒë·∫ßu trang -->
      <div class="container-fluid m-4">
        <footer class="text-center">
          <button onclick="topFunction()" id="backToTopBtn" class="btn">
            Quay v·ªÅ ƒë·∫ßu trang
          </button>
        </footer>
      </div>
    </div>
    
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
      document.addEventListener("DOMContentLoaded", () => {
        loadMessage();
      });
    </script>
    <script>
      async function loadMessage() {
        try {
          const response = await fetch(`/getMessage`, {
            method: "GET", // G·ª≠i y√™u c·∫ßu GET
          });
          if (!response.ok) {
            throw new Error(
              `Error: ${response.status} - ${response.statusText}`
            );
          }
          const data = await response.json(); // L·∫•y d·ªØ li·ªáu t·ª´ server
          console.log(data);
          if (data.success) {
            if (data.Message && data.Message.length > 0) {
              console.log("D·ªØ li·ªáu th√¥ng b√°o:", data);
              showNotifications(data);
            }
          } else {
            alert("Kh√¥ng t√¨m th·∫•y d·ªØ li·ªáu!");
          }
        } catch (error) {
          console.error("C√≥ l·ªói x·∫£y ra khi l·∫•y d·ªØ li·ªáu:", error);
        }
      }
    </script>
    <script>
      function formatDateTimeVN(isoString) {
        if (!isoString) return '';
        const date = new Date(isoString);
        const pad = num => String(num).padStart(2, '0');
        const weekdays = ['Ch·ªß Nh·∫≠t','Th·ª© Hai','Th·ª© Ba','Th·ª© T∆∞','Th·ª© NƒÉm','Th·ª© S√°u','Th·ª© B·∫£y'];
        return `l√∫c ${pad(date.getHours())}:${pad(date.getMinutes())} ${weekdays[date.getDay()]}, ${pad(date.getDate())} th√°ng ${pad(date.getMonth() + 1)}, ${date.getFullYear()}`;
      }

      function showNotifications(messages) {
        const container = document.getElementById("notifications-container");

        // X√≥a n·ªôi dung c≈© (n·∫øu c√≥)
        container.innerHTML = "";

        // Render t·ª´ng th√¥ng b√°o
        let i = 0;
        messages.Message.forEach((message, index) => {
          if (message.HetHan === 1) {
            return; // B·ªè qua th√¥ng b√°o n·∫øu ƒë√£ h·∫øt h·∫°n ho·∫∑c ho√†n th√†nh
          }

          const notification = document.createElement("div");
          notification.className = "notification";
          notification.style.display = "block";

          // N·ªôi dung th√¥ng b√°o
          notification.innerHTML = `
      <div class="header">
        <span class="icon">
          <svg fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
            <path clip-rule="evenodd" d="M18 3a1 1 0 00-1.447-.894L8.763 6H5a3 3 0 000 6h.28l1.771 5.316A1 1 0 008 18h1a1 1 0 001-1v-4.382l6.553 3.276A1 1 0 0018 15V3z" fill-rule="evenodd"></path>
          </svg>
        </span>
        <p class="alert" style="margin-top: 16px; font-size: 20px;">Th√¥ng b√°o m·ªõi !</p>
      </div>
      <p class="message">
        <strong style="font-size: 24px; text-transform: uppercase;">${
          message.Title
        }</strong> <br>
        <strong>Khoa (Ph√≤ng Ban): ${message.MaPhongBan} th√¥ng b√°o </strong> <br>
        <strong>L·ªùi nh·∫Øn:</strong> ${message.LoiNhan}<br>
        <strong>Ng√†y ƒëƒÉng:</strong> <span style="color:#222">${formatDateTimeVN(message.TimeTao)}</span><br>
        <strong>H·∫°n ch√≥t:</strong> <span style = "color:red">${new Date(
          message.Deadline
        ).toLocaleString("vi-VN", {
          weekday: "long",
          year: "numeric",
          month: "long",
          day: "numeric",
          hour: "2-digit",
          minute: "2-digit",
        })}</span>
      </p>
      <div class="actions">
        <button class="read" onclick="closeNotification(${i})">ƒê√£ xem</button>
      </div>
    `;

          // Th√™m th√¥ng b√°o v√†o container
          container.appendChild(notification);
          i++;
        });

        // Hi·ªÉn th·ªã container
        container.style.display = "block";
      }

      // H√†m ƒë√≥ng th√¥ng b√°o c·ª• th·ªÉ
      function closeNotification(index) {
        const container = document.getElementById("notifications-container");

        if (!container) {
          console.error("Kh√¥ng t√¨m th·∫•y container th√¥ng b√°o!");
          return;
        }

        const notifications = container.querySelectorAll(".notification");

        // Ki·ªÉm tra xem th√¥ng b√°o t·∫°i index c√≥ t·ªìn t·∫°i
        if (!notifications[index]) {
          console.error(`Kh√¥ng t√¨m th·∫•y th√¥ng b√°o t·∫°i index ${index}`);
          return; // N·∫øu kh√¥ng c√≤n th√¥ng b√°o n√†o ƒë·ªÉ ƒë√≥ng, d·ª´ng l·∫°i
        }

        // ·∫®n th√¥ng b√°o t·∫°i v·ªã tr√≠ index
        notifications[index].style.display = "none";

        // Ki·ªÉm tra n·∫øu t·∫•t c·∫£ th√¥ng b√°o ƒë√£ b·ªã ·∫©n
        const allHidden = Array.from(notifications).every(
          (notif) => notif.style.display === "none"
        );

        if (allHidden) {
          container.style.display = "none"; // ·∫®n container n·∫øu kh√¥ng c√≤n th√¥ng b√°o
          console.log("T·∫•t c·∫£ th√¥ng b√°o ƒë√£ ƒë∆∞·ª£c ƒë√≥ng.");
        }
      }

      // G·ªçi h√†m hi·ªÉn th·ªã th√¥ng b√°o
    </script>
    <script>
      // 3. Th·ªëng k√™ s·ªë ti·∫øt gi·∫£ng d·∫°y theo gi√°o vi√™n (S·ª≠ d·ª•ng Chart.js)
      var ctx = document.getElementById("teachingHoursChart").getContext("2d");
      var teachingHoursChart = new Chart(ctx, {
        type: "bar",
        data: {
          labels: ["Nguy·ªÖn VƒÉn A", "Tr·∫ßn Th·ªã B", "L√™ VƒÉn C"],
          datasets: [
            {
              label: "S·ªë ti·∫øt gi·∫£ng d·∫°y",
              data: [45, 30, 25],
              backgroundColor: [
                "rgba(75, 192, 192, 0.2)",
                "rgba(255, 99, 132, 0.2)",
                "rgba(54, 162, 235, 0.2)",
              ],
              borderColor: [
                "rgba(75, 192, 192, 1)",
                "rgba(255, 99, 132, 1)",
                "rgba(54, 162, 235, 1)",
              ],
              borderWidth: 1,
            },
          ],
        },
      });
      // N√∫t quay v·ªÅ ƒë·∫ßu trang
      function topFunction() {
        document.body.scrollTop = 0; // Cho Safari
        document.documentElement.scrollTop = 0; // Cho Chrome, Firefox, IE v√† Opera
      }
    </script>

    <!-- Ph·∫ßn ph√¢n quy·ªÅn -->
    <script>
      document.addEventListener("DOMContentLoaded", () => {
        // Th√™m s·ª± ki·ªán click cho ph·∫ßn t·ª≠ c√≥ id="ThongTinGD"
        const ThongTinGD = document.getElementById("ThongTinGD");

        ThongTinGD.addEventListener("click", function (event) {
          event.preventDefault(); // NgƒÉn ch·∫∑n h√†nh vi m·∫∑c ƒë·ªãnh c·ªßa li√™n k·∫øt

          const isKhoa = localStorage.getItem("isKhoa"); // L·∫•y role t·ª´ localStorage

          if (isKhoa == 0) {
            // N·∫øu l√† ƒë√†o t·∫°o ho·∫∑c t√†i ch√≠nh
            window.location.href = "/info2";
          } else {
            window.location.href = "/info";
          }
        });

        // Th√™m s·ª± ki·ªán click cho ph·∫ßn t·ª≠ c√≥ id="Home"

        const Home = document.getElementById("Home");

        Home.addEventListener("click", function (event) {
          event.preventDefault(); // NgƒÉn ch·∫∑n h√†nh vi m·∫∑c ƒë·ªãnh c·ªßa li√™n k·∫øt

          const isKhoa = localStorage.getItem("isKhoa");

          if (isKhoa == 0) {
            // N·∫øu l√† ƒë√†o t·∫°o ho·∫∑c t√†i ch√≠nh
            window.location.href = "/maindt";
          } else {
            window.location.href = "/mainkhoa";
          }
        });
      });
    </script>

    <script>
      document
        .getElementById("changePasswordLink")
        .addEventListener("click", function (event) {
          event.preventDefault(); // NgƒÉn ch·∫∑n h√†nh vi m·∫∑c ƒë·ªãnh c·ªßa th·∫ª a
          const tenDangNhap = localStorage.getItem("TenDangNhap"); // L·∫•y TenDangNhap t·ª´ localStorage

          if (tenDangNhap) {
            // Chuy·ªÉn h∆∞·ªõng ƒë·∫øn trang changePassword v√† truy·ªÅn TenDangNhap trong URL
            window.location.href = `/changePassword?tenDangNhap=${encodeURIComponent(
              tenDangNhap
            )}`;
          } else {
            alert("Kh√¥ng t√¨m th·∫•y TenDangNhap trong localStorage.");
          }
        });
    </script>
    <script>
      document
        .getElementById("infome")
        .addEventListener("click", function (event) {
          event.preventDefault(); // NgƒÉn ch·∫∑n h√†nh vi m·∫∑c ƒë·ªãnh c·ªßa th·∫ª a
          const id_User = localStorage.getItem("id_User"); // L·∫•y id_User t·ª´ localStorage\
          if (id_User) {
            // Chuy·ªÉn h∆∞·ªõng ƒë·∫øn trang infome v√† truy·ªÅn id_User trong URL
            window.location.href = `/infome/${id_User}`;
          } else {
            alert("Kh√¥ng t√¨m th·∫•y id_User trong localStorage.");
          }
        });
    </script>
  </body>
</html>
