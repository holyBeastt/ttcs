<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Học Viện Kỹ Thuật Mật Mã</title>
  <link rel="stylesheet" href="/css/table.css">
  <link rel="stylesheet" href="/css/admin.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
  <link rel="stylesheet" href="/css/styles.css">

  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</head>
<style>
  .vietTat-cell {
    cursor: pointer;
  }
  .edit-input {
    padding: 2px 5px;
    border: 1px solid #ddd;
    border-radius: 3px;
}

.save-btn, .cancel-btn {
    padding: 2px 8px;
    margin-left: 5px;
    border: none;
    border-radius: 3px;
    cursor: pointer;
}

.save-btn {
    background-color: #4CAF50;
    color: white;
}

.cancel-btn {
    background-color: #f44336;
    color: white;
}
.form-group{
  margin-bottom: 20px;
}

</style>
<body>

  <nav class="navbar-top ">
    <div class="container-fluid">
      <a class="navbar-brand" href="#">
        <img src="/Logo-Hoc-Vien-Ky-Thuat-Mat-Ma-ACTVN.webp" alt="Logo">
        <div class="navbar-title">
          <img src="/dongchu_banner.png" alt="banner">
        </div>
      </a>
    </div>
  </nav>

  <!-- Phần dưới của navbar chứa các mục nằm ngang -->
  <nav class="navbar navbar-expand-lg navbar-bottom">
    <div class="" style="width: 100%;">
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" style="width: 100%;" id="navbarNav">
          <div>
            <ul class="navbar-nav">
              <li class="nav-item">
                <a class="nav-link" href="/admin"><i class="bi bi-house"></i></a>
              </li>
              <li class="nav-item">
                <a class="nav-link" id="ThongTinTK" href="/thongTinTK">Thông Tin Tài Khoản </a>       
               </li>
                <li class="nav-item">
                  <a class="nav-link" id="NhanVien" href="/nhanVien">Nhân Viên </a>        
                 </li>
                 <li class="nav-item">
                  <a class="nav-link" id="PhongBan" href="/phongBan">Phòng Ban </a>        
                 </li>
                 <li class="nav-item">
                  <a class="nav-link" id="BoMon" href="/boMon">Bộ Môn </a>        
                 </li>
                 <li class="nav-item">
                  <a class="nav-link text-center" id="NamHoc" href="/namHoc" style="width: fit-content;">Năm học </a>        
                 </li>
                 <li class="nav-item">
                  <a class="nav-link active" id="KyTuBD" href="/kytubatdau">Ký tự bắt đầu </a>        
                 </li>
            </ul>
          </div>
            
          <div class="navbar-nav">
            <div class="nav-item dropdown">
              <a class="nav-link dropdown-toggle" href="/login" id="navbarDropdownUser" data-bs-toggle="dropdown" aria-expanded="false">
                Hi, ADMIN
                </a>
              <div class="dropdown-menu" aria-labelledby="dropdownMenuButton" style="right: 0; left: auto; z-index: 1000;">
                <a class="dropdown-item" href="#">Thông tin cá nhân</a>
                <a class="dropdown-item" id="changePasswordLink">Đổi mật khẩu</a>
                <a class="dropdown-item" href="/">Đăng xuất</a>
              </div>
            </div>
        </div>
    </div>
  </nav>
  <div class="container my-5 box">
    <form action="/kytubatdau" method="POST" class="row">
      <div class="col-md-5">
        <div class="form-group">
          <label for="LopViDu">Lớp ví dụ:</label>
          <input type="text" class="form-control" id="LopViDu" name="LopViDu" required>
        </div>
      </div>
      <div class="col-md-5">
        <div class="form-group">
          <label for="vietTat">Viết tắt:</label>
          <input type="text" class="form-control" id="vietTat" name="vietTat" required>
        </div>
      </div>
      <div class="col-md-2 d-flex align-items-end">
        <button type="submit" class="btn btn-primary w-100" style="z-index: -1;">Thêm mới</button>
      </div>
    </form>
        <!-- Nút Lọc màu giống nút Hiển thị -->

      <div class="pb-3">
        <table id="NamHocTable" class="table table-bordered">
          <thead>
            <tr>
              <th>STT</th>
              <th>Tên lớp</th>
              <th>Viết tắt</th>
              <th>Thao tác</th>
            </tr>
          </thead>
          <tbody id="data-table-body">
            <% if (kyTuBD && kyTuBD.length > 0) { %>
              <% for (var i = 0; i < kyTuBD.length; i++) { %>
                <tr data-lop-vi-du="<%= kyTuBD[i].LopViDu %>" data-viet-tat="<%= kyTuBD[i].VietTat %>">
                  <td><%= i + 1 %></td>
                  <td class="editable lopViDu-cell"><%= kyTuBD[i].LopViDu %></td>
                  <td class="editable vietTat-cell"><%= kyTuBD[i].VietTat %></td>
                  <td class="d-flex justify-content-center">
                    <button class="bi bi-pencil action-button edit-btn"></button>
                    <button class="bi bi-trash3 action-button me-2" 
                      onclick="deleteKyTuBD(this, '<%= kyTuBD[i].LopViDu %>')">
                    </button>
                  </td>
                </tr>
              <% } %>
            <% } %>
          </tbody>
        </table>
      </div>
  </div>
  <script>
       function deleteKyTuBD(button, id) {
    if (confirm(`Bạn có chắc chắn muốn xóa ký tự bắt đầu ${id} không?`)) {
      fetch(`/kytubatdau/${id}`, {
    method: 'DELETE',
    headers: {
        'Content-Type': 'application/json',
    }
})
.then(response => {
    if (response.ok) {
        alert("Xóa thành công!");
        button.closest("tr").remove();
    } else {
        return response.text().then(text => {
            // Kiểm tra nếu phản hồi là HTML, thường là trang đăng nhập hoặc lỗi
            if (text.startsWith("<!DOCTYPE html>")) {
                alert("Có lỗi xảy ra, có thể bạn cần đăng nhập lại hoặc endpoint không tồn tại.");
            } else {
                const data = JSON.parse(text); // Xử lý JSON nếu không phải HTML
                alert("Xóa thất bại: " + data.message);
            }
        });
    }
})
.catch(error => {
    alert("Có lỗi xảy ra: " + error.message);
});

}}
    </script>
    <script>
      $(document).ready(function() {
        let originalValues = {};
      
        $('.edit-btn').click(function() {
          const row = $(this).closest('tr');
          const id = row.data('id');
          
          // Lưu giá trị gốc
          originalValues[id] = {
            viettat: row.find('.viettat').text().trim()
          };
      
          // Chuyển text thành input
          row.find('.viettat').html(`
            <input type="text" class="form-control" value="${originalValues[id].viettat}">
          `);
      
          // Hiển thị/ẩn các nút
          row.find('.edit-btn').hide();
          row.find('.save-btn, .cancel-btn').show();
        });
      
        $('.save-btn').click(function() {
          const row = $(this).closest('tr');
          const id = row.data('id');
          const newVietTat = row.find('.viettat input').val();
      
          $.ajax({
            url: '/updateKyTuBD',
            method: 'POST',
            data: {
              LopViDu: id,
              vietTat: newVietTat
            },
            success: function(response) {
              // Cập nhật giao diện
              row.find('.viettat').text(newVietTat);
              row.find('.edit-btn').show();
              row.find('.save-btn, .cancel-btn').hide();
              
              // Hiển thị thông báo thành công
              toastr.success('Cập nhật thành công');
            },
            error: function(error) {
              toastr.error('Có lỗi xảy ra khi cập nhật');
            }
          });
        });
      
        $('.cancel-btn').click(function() {
          const row = $(this).closest('tr');
          const id = row.data('id');
          
          // Khôi phục giá trị gốc
          row.find('.viettat').text(originalValues[id].viettat);
          
          // Hiển thị/ẩn các nút
          row.find('.edit-btn').show();
          row.find('.save-btn, .cancel-btn').hide();
        });
      });
      </script>
<script>
  document.getElementById("changePasswordLink").addEventListener("click", function(event) {
event.preventDefault(); // Ngăn chặn hành vi mặc định của thẻ a
const tenDangNhap = localStorage.getItem("TenDangNhap"); // Lấy TenDangNhap từ localStorage

if (tenDangNhap) {
    // Chuyển hướng đến trang changePassword và truyền TenDangNhap trong URL
    window.location.href = `/changePassword?tenDangNhap=${encodeURIComponent(tenDangNhap)}`;
} else {
    alert("Không tìm thấy TenDangNhap trong localStorage.");
}
});
</script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const table = document.querySelector('table');
    
    // Xử lý khi click vào nút edit
    table.addEventListener('click', function(e) {
        if (e.target.classList.contains('edit-btn')) {
            const row = e.target.closest('tr');
            const lopViDuCell = row.querySelector('.lopViDu-cell');
            const vietTatCell = row.querySelector('.vietTat-cell');
            
            // Lưu giá trị gốc vào data attributes
            const originalLopViDu = lopViDuCell.textContent.trim();
            const originalVietTat = vietTatCell.textContent.trim();
            
            // Chuyển cells thành inputs
            lopViDuCell.innerHTML = `
                <input type="text" class="edit-input" value="${originalLopViDu}">
            `;
            
            vietTatCell.innerHTML = `
                <input type="text" class="edit-input" value="${originalVietTat}">
            `;
            
            // Thêm nút save/cancel vào cell cuối
            const actionCell = row.querySelector('td:last-child');
            actionCell.innerHTML = `
                <button class="save-btn btn btn-success btn-sm">Lưu</button>
                <button class="cancel-btn btn btn-danger btn-sm ms-2">Hủy</button>
            `;
        }
    });

    // Xử lý khi click save
    table.addEventListener('click', async function(e) {
        if (e.target.classList.contains('save-btn')) {
            const row = e.target.closest('tr');
            const newLopViDu = row.querySelector('.lopViDu-cell input').value;
            const newVietTat = row.querySelector('.vietTat-cell input').value;
            const originalLopViDu = row.dataset.lopViDu;

            try {
                const response = await fetch(`/kytubatdau/${originalLopViDu}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        LopViDu: newLopViDu,
                        VietTat: newVietTat
                    })
                });

                const data = await response.json();
                if (response.ok) {
                    // Cập nhật UI
                    row.dataset.lopViDu = newLopViDu;
                    row.dataset.vietTat = newVietTat;
                    row.querySelector('.lopViDu-cell').textContent = newLopViDu;
                    row.querySelector('.vietTat-cell').textContent = newVietTat;
                    
                    // Khôi phục nút edit và delete
                    const actionCell = row.querySelector('td:last-child');
                    actionCell.innerHTML = `
                        <button class="bi bi-pencil action-button edit-btn"></button>
                        <button class="bi bi-trash3 action-button me-2" 
                            onclick="deleteKyTuBD(this, '${newLopViDu}')">
                        </button>
                    `;
                    
                    alert('Cập nhật thành công!');
                } else {
                    throw new Error(data.message || 'Có lỗi xảy ra');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Lỗi khi cập nhật: ' + error.message);
            }
        }
    });

    // Xử lý khi click cancel
    table.addEventListener('click', function(e) {
        if (e.target.classList.contains('cancel-btn')) {
            const row = e.target.closest('tr');
            const originalLopViDu = row.dataset.lopViDu;
            const originalVietTat = row.dataset.vietTat;
            
            // Khôi phục giá trị gốc
            row.querySelector('.lopViDu-cell').textContent = originalLopViDu;
            row.querySelector('.vietTat-cell').textContent = originalVietTat;
            
            // Khôi phục nút edit và delete
            const actionCell = row.querySelector('td:last-child');
            actionCell.innerHTML = `
                <button class="bi bi-pencil action-button edit-btn"></button>
                <button class="bi bi-trash3 action-button me-2" 
                    onclick="deleteKyTuBD(this, '${originalLopViDu}')">
                </button>
            `;
        }
    });
});
</script>
</body>

</html>