<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>H·ªçc Vi·ªán K·ªπ Thu·∫≠t M·∫≠t M√£</title>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css"
    />
    <link rel="stylesheet" href="/css/styles.css" />
    <link rel="stylesheet" href="/css/gvmList.css" />
    <link rel="stylesheet" href="/css/table.css" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css"
    />
    <style>
      .teacher-group {
        border: 2px solid black;
        /* Vi·ªÅn ƒëen xung quanh nh√≥m gi·∫£ng vi√™n */
        border-collapse: separate;
        margin-bottom: 10px;
      }

      .teacher-group td,
      .teacher-group th {
        padding: 8px;
        text-align: left;
        border: 2px solid black;
        /* Vi·ªÅn ƒëen xung quanh nh√≥m gi·∫£ng vi√™n */
      }

      /* ph·∫ßn css cho label t·ªïng s·ªë ti·∫øt ki*/
      .total-label {
        margin-left: auto;
        /* CƒÉn ph·∫£i cho th·∫ª total-label */
        margin-right: 0;
        font-family: Arial, sans-serif;
        font-size: 16px;
        background-color: #f4f4f4;
        padding: 10px;
        border-radius: 8px;
        width: fit-content;
        /* box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1); */
        display: block;
        /* ƒê·∫£m b·∫£o th·∫ª div l√† kh·ªëi ƒë·ªÉ cƒÉn ph·∫£i ho·∫°t ƒë·ªông */
      }

      .total-label label {
        font-weight: bold;
        /* Gi·ªØ ch·ªØ in ƒë·∫≠m */
        color: #000;
        /* M√†u ch·ªØ ƒëen */
        margin-right: 8px;
        /* Th√™m kho·∫£ng c√°ch b√™n ph·∫£i */
        cursor: pointer;
        /* T·∫°o hi·ªáu ·ª©ng chuy·ªÉn m√†u n·ªÅn v√† m√†u ch·ªØ m·ªÅm m·∫°i */
        padding: 5px 10px;
        /* Th√™m padding cho label ƒë·ªÉ t·∫°o kh√¥ng gian */
        border: 1px solid #ccc;
        /* Khung cho label */
        border-radius: 4px;
        /* Bo g√≥c cho khung */
      }

      .total-label label,
      .total-label label span {
        background-color: #007bff;
        /* M√†u n·ªÅn khi hover */
        color: #fff;
        /* M√†u ch·ªØ tr·∫Øng khi hover */
      }

      .total-label span {
        font-weight: bold;
        /* Gi·ªØ ch·ªØ trong span c≈©ng in ƒë·∫≠m */
        color: #333;
        /* M√†u ch·ªØ ƒë·∫≠m cho gi√° tr·ªã */
      }

      .btn {
        height: 45px !important;
      }

      /* Ph·∫ßn c·∫£nh b√°o n·∫øu s·ªë ti·∫øt v∆∞·ª£t qu√° 300 */
      .alert-sotiet {
        background-color: #ffe4b5;
        color: #333;
        /* T√πy ch·ªçn: Thay ƒë·ªïi m√†u ch·ªØ ƒë·ªÉ d·ªÖ ƒë·ªçc h∆°n */
      }

      .no-shadow-page {
        /* box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2); */
      }

      .table {
        border-collapse: collapse;
        width: 100%;
        /*border: 2px solid #333 !important; /* Vi·ªÅn ngo√†i ƒë·∫≠m */
      }

      .table th,
      .table td {
        border: 1px solid #ccc;
        /* Vi·ªÅn gi·ªØa c√°c √¥ nh·∫°t h∆°n */
        padding: 8px;
        text-align: center;
      }

      .table-dark th {
        background-color: #343a40;
        color: white;
      }

      .alert-sotiet {
        background-color: #ffcccc !important;
        /* N·ªÅn ƒë·ªè nh·∫°t n·∫øu s·ªë ti·∫øt > 300 */
      }

      .hd_du_kien_css {
      }
    </style>
  </head>

  <body>
    <!-- Ph·∫ßn header -->
    <%- include('header') %>

    <!-- Ph·∫ßn n·ªôi dung -->

    <div class="container-fluid m-4 no-shadow-page">
      <div class="d-flex">
        <!-- Main content -->
        <div class="gvmList hd_du_kien_css">
          <div class="m-3 reCss">
            <h1>TH√îNG TIN H·ª¢P ƒê·ªíNG GI·∫¢NG VI√äN M·ªúI D·ª∞ KI·∫æN</h1>

            <div class="controls-container" style="width: 100%">
              <select
                class="form-select w-100px mx-2 selectop"
                id="combobox-dot"
              >
                <option value="">ƒê·ª£t</option>
              </select>

              <select class="form-select mx-2 selectop" id="comboboxki">
                <option value="">K·ª≥</option>
              </select>

              <select
                class="form-select mx-2 selectop"
                style="width: max-content"
                id="NamHoc"
              >
                <option value="">NƒÉm h·ªçc</option>
              </select>

              <select
                class="form-select mx-1 selectop"
                style="width: max-content"
                id="MaPhongBan"
              >
                <option value="">Ch·ªçn khoa</option>
              </select>

              <select class="form-select mx-1 selectop" id="he_dao_tao">
              </select>

              <!-- <button id="viewDataBtn" class="btn view">Xem d·ªØ li·ªáu</button> -->
              <button id="viewDataBtnDetail" class="btn view">
                Xem d·ªØ li·ªáu chi ti·∫øt
              </button>
              <br />
              <!-- <input
                type="text"
                id="searchGiangVien"
                placeholder="T√¨m gv gi·∫£ng d·∫°y"
                class="form-control m-2 search"
                style="width: 150px"
              />
              <button id="exportHDDK" class="btn view">
                Xu·∫•t th√¥ng tin Hƒê d·ª± ki·∫øn
              </button> -->
            </div>

            <div class="controls-container">
              <input
                type="text"
                id="searchGiangVien"
                placeholder="T√¨m gi·∫£ng vi√™n gi·∫£ng d·∫°y"
                class="form-control m-2 search"
                style="width: 300px"
              />
              <button id="exportHDDK" class="btn view">
                Xu·∫•t th√¥ng tin Hƒê d·ª± ki·∫øn
              </button>
            </div>

            <div id="tableContainer" style="display: none">
              <div class="table-responsive">
                
              <h4 class="mt-4 text-primary font-weight-bold">I. Danh s√°ch Gi·∫£ng vi√™n D√¢n s·ª±</h4>
                <div class="over-f">
                  <table class="table table-striped table-hover table-bordered table-css">
                    <thead class="table-dark">
                        <tr>
                          <th>S·ªë ti·∫øt</th>
                          <th>T·ªïng s·ªë ti·∫øt c·∫£ nƒÉm</th>
                          <th>Ng√†y k√≠ Hƒê</th>
                          <th>Ng√†y thanh l√Ω Hƒê</th>
                          <th>Danh x∆∞ng</th>
                          <th>H·ªç t√™n</th>
                          <th class="d_none">Ti·ªÅn m·ªùi gi·∫£ng</th>
                          <th class="d_none">Th√†nh ti·ªÅn</th>
                          <th class="d_none">Thu·∫ø 10%</th>
                          <th class="d_none">Th·ª±c nh·∫≠n</th>
                          <th>Ng√†y sinh</th>
                          <th>CCCD</th>
                          <th class="d_none">Ng√†y c·∫•p CCCD</th>
                          <th>H·ªçc h√†m/H·ªçc v·ªã</th>
                          <th>Ch·ª©c v·ª•</th>
                          <th>ƒêi·ªán tho·∫°i</th>
                          <th>Email</th>
                          <th>S·ªë t√†i kho·∫£n</th>
                          <th style="min-width: 150px">Ng√¢n h√†ng</th>
                          <th>M√£ s·ªë thu·∫ø</th>
                          <th style="display: none">Khoa</th>
                          <th style="min-width: 150px" class="d_none">ƒê·ªãa ch·ªâ</th>
                          <th style="min-width: 150px" class="d_none">N∆°i c√¥ng t√°c</th>
                          <th class="d_none">B·ªô m√¥n</th>
                          <th class="d_none">Xem</th>
                        </tr>
                    </thead>
                    <tbody id="tbodyCivilian"></tbody>
                  </table>
                </div>
                <div class="text-right total-label">
                    <label>T·ªïng s·ªë ti·∫øt: <span id="totalCivilian">0</span></label>
                </div>

              <h4 class="mt-4 text-danger font-weight-bold">II. Danh s√°ch Gi·∫£ng vi√™n kh√¥ng t√≠nh m·ªùi gi·∫£ng (Qu√¢n ƒë·ªôi/C√¥ng an)</h4>
                <div class="over-f">
                  <table class="table table-striped table-hover table-bordered table-css">
                    <thead class="table-dark">
                      <tr>
                          <th>S·ªë ti·∫øt</th>
                          <th>T·ªïng s·ªë ti·∫øt c·∫£ nƒÉm</th>
                          <th>Ng√†y k√≠ Hƒê</th>
                          <th>Ng√†y thanh l√Ω Hƒê</th>
                          <th>Danh x∆∞ng</th>
                          <th>H·ªç t√™n</th>
                          <th class="d_none">Ti·ªÅn m·ªùi gi·∫£ng</th>
                          <th class="d_none">Th√†nh ti·ªÅn</th>
                          <th class="d_none">Thu·∫ø 10%</th>
                          <th class="d_none">Th·ª±c nh·∫≠n</th>
                          <th>Ng√†y sinh</th>
                          <th>CCCD</th>
                          <th class="d_none">Ng√†y c·∫•p CCCD</th>
                          <th>H·ªçc h√†m/H·ªçc v·ªã</th>
                          <th>Ch·ª©c v·ª•</th>
                          <th>ƒêi·ªán tho·∫°i</th>
                          <th>Email</th>
                          <th>S·ªë t√†i kho·∫£n</th>
                          <th style="min-width: 150px">Ng√¢n h√†ng</th>
                          <th>M√£ s·ªë thu·∫ø</th>
                          <th style="display: none">Khoa</th>
                          <th style="min-width: 150px" class="d_none">ƒê·ªãa ch·ªâ</th>
                          <th style="min-width: 150px" class="d_none">N∆°i c√¥ng t√°c</th>
                          <th class="d_none">B·ªô m√¥n</th>
                          <th class="d_none">Xem</th>
                        </tr>
                    </thead>
                    <tbody id="tbodyMilitary"></tbody>
                  </table>
                </div>
                <div class="total-label">
                    <label>T·ªïng s·ªë ti·∫øt: <span id="totalMilitary">0</span></label>
                </div>

              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <!-- ph·∫ßn d·ªØ li·ªáu ƒë·ªÉ hi·ªÉn th·ªã tr√™n b·∫£ng -->
    <script>
      var renderData = [];
      let SoTietDinhMuc = 0;
      let SoTietDinhMucNghiHuu = 0;

      document
        .getElementById("exportHDDK")
        .addEventListener("click", function (event) {
          // NgƒÉn ch·∫∑n l·ªói
          if (Array.isArray(renderData) && renderData.length === 0) {
            alert("Kh√¥ng c√≥ d·ªØ li·ªáu"); // Hi·ªÉn th·ªã th√¥ng b√°o khi m·∫£ng r·ªóng
            return;
          }
          exportToExcel();
        });

      async function exportToExcel() {
        const requestData = {
          renderData: renderData,
        };

        try {
          const response = await fetch("/hddk-export-excel", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify(requestData),
          });

          if (!response.ok) {
            throw new Error(`Failed to export: ${response.statusText}`);
          }

          const blob = await response.blob();
          const url = window.URL.createObjectURL(blob);
          const a = document.createElement("a");
          a.href = url;
          a.download = `thong_tin_hop_dong_du_kien_ki_${renderData[0].KiHoc}_nam_hoc_${renderData[0].NamHoc}.xlsx`;
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          window.URL.revokeObjectURL(url);
        } catch (error) {
          console.error("Error exporting data:", error);
        }
      }

      document.addEventListener("DOMContentLoaded", function () {


      const viewDataBtnDetail = document.getElementById("viewDataBtnDetail");
      const isKhoa = localStorage.getItem("isKhoa");
      const MaPhongBan = localStorage.getItem("MaPhongBan");

      viewDataBtnDetail.addEventListener("click", async function () {
        try {
          const namHoc = document.getElementById("NamHoc").value;
          const dot = document.getElementById("combobox-dot").value;
          const ki = document.getElementById("comboboxki").value;
          const he_dao_tao = document.getElementById("he_dao_tao").value;
          let khoa = MaPhongBan;

          // Validation
          if (!namHoc || !dot || !ki || !he_dao_tao) {
            alert("Vui l√≤ng ch·ªçn ƒë·∫ßy ƒë·ªß NƒÉm h·ªçc, ƒê·ª£t v√† K·ª≥");
            return;
          }

          if (isKhoa == 0) {
            khoa = document.getElementById("MaPhongBan").value;
          }

          // Fetch d·ªØ li·ªáu
          const url = `/hop-dong-du-kien?namHoc=${encodeURIComponent(namHoc)}&dot=${encodeURIComponent(dot)}&ki=${encodeURIComponent(ki)}&he_dao_tao=${encodeURIComponent(he_dao_tao)}&khoa=${encodeURIComponent(khoa)}`;
          
          const response = await fetch(url);
          if (!response.ok) throw new Error("Network response was not ok");
          
          const data = await response.json();
          renderData = data.dataDuKien;
          SoTietDinhMuc = data.SoTietDinhMuc; // Bi·∫øn global
          SoTietDinhMucNghiHuu = data.SoTietDinhMucNghiHuu; // Bi·∫øn global

          // 1. Ph√¢n lo·∫°i d·ªØ li·ªáu
          const listCivilian = renderData.filter(item => item.isQuanDoi == 0 || item.isQuanDoi == "0");
          const listMilitary = renderData.filter(item => item.isQuanDoi == 1 || item.isQuanDoi == "1");

          // 2. Hi·ªÉn th·ªã l·∫°i c√°c c·ªôt b·ªã ·∫©n (n·∫øu c·∫ßn)
          document.querySelectorAll(".d_none").forEach(el => el.style.display = "table-cell");
          document.querySelectorAll(".reCss").forEach(el => el.style.removeProperty("margin-left"));

          // 3. Render v√† t√≠nh t·ªïng cho t·ª´ng b·∫£ng
          renderTableAndSum(listCivilian, "tbodyCivilian", "totalCivilian", he_dao_tao);
          renderTableAndSum(listMilitary, "tbodyMilitary", "totalMilitary", he_dao_tao);

          // Hi·ªÉn th·ªã container
          document.getElementById("tableContainer").style.display = "block";

        } catch (error) {
          console.error("Error:", error);
          alert("ƒê√£ x·∫£y ra l·ªói khi t·∫£i d·ªØ li·ªáu");
        }
      });

      /**
       * H√†m Render Table v√† T√≠nh T·ªïng (Clean & Optimized)
       * @param {Array} items - Danh s√°ch d·ªØ li·ªáu
       * @param {String} tbodyId - ID c·ªßa tbody c·∫ßn render
       * @param {String} totalLabelId - ID c·ªßa span hi·ªÉn th·ªã t·ªïng
       * @param {String} heDaoTao - H·ªá ƒë√†o t·∫°o ƒë·ªÉ check hi·ªÉn th·ªã ti·ªÅn
       */
      function renderTableAndSum(items, tbodyId, totalLabelId, heDaoTao) {
          const tbody = document.getElementById(tbodyId);
          let totalTiet = 0;

          // T·∫°o chu·ªói HTML (Nhanh h∆°n insertRow r·∫•t nhi·ªÅu)
          const htmlString = items.map(item => {
              // C·ªông d·ªìn t·ªïng ti·∫øt (d·ª±a tr√™n c·ªôt TongTiet - cell 0)
              totalTiet += parseFloat(item.TongTiet) || 0;

              // X·ª≠ l√Ω formatting helper
              const fmtDate = (date) => date ? new Date(date).toLocaleDateString("vi-VN", {day:"2-digit", month:"2-digit", year:"numeric"}) : "";
              const fmtMoney = (val) => {
                const num = Number(val);
                if (Number.isNaN(num)) return '0 ‚Ç´';

                if (typeof formatCurrency === 'function') {
                  return formatCurrency(num);
                }
                return num.toLocaleString('vi-VN');
              };

              let isAlert = false;

              if (item.isNghiHuu == 1) {
                if (item.TongSoTiet > SoTietDinhMucNghiHuu) {
                  isAlert = true;
                }
              } else {
                if (item.TongSoTiet > SoTietDinhMuc) {
                  isAlert = true;
                }
              }

              const alertClass = isAlert ? "alert-sotiet" : "";
              const danhXung = item.GioiTinh.toLowerCase() === "nam" ? "√îng" : "B√†";
              const tienMoiGiang = heDaoTao === "0" ? "T√πy h·ªá" : fmtMoney(item.TienMoiGiang);

              return `
                  <tr class="${alertClass}">
                      <td>${Number.parseFloat(item.TongTiet).toFixed(2)}</td>
                      <td>${Number.parseFloat(item.TongSoTiet).toFixed(2)}</td>
                      <td>${fmtDate(item.NgayBatDau)}</td>
                      <td>${fmtDate(item.NgayKetThuc)}</td>
                      <td>${danhXung}</td>
                      <td>${item.GiangVien}</td>
                      
                      <td>${tienMoiGiang}</td>
                      <td>${fmtMoney(item.ThanhTien)}</td>
                      <td>${fmtMoney(item.Thue)}</td>
                      <td>${fmtMoney(item.ThucNhan)}</td>

                      <td>${fmtDate(item.NgaySinh)}</td>
                      <td>${item.CCCD}</td>
                      <td>${fmtDate(item.NgayCapCCCD)}</td>
                      <td>${item.HocVi}</td>
                      <td>${item.ChucVu}</td>
                      <td>${item.DienThoai}</td>
                      <td>${item.Email}</td>
                      <td>${item.STK}</td>
                      <td>${item.NganHang}</td>
                      <td>${item.MaSoThue}</td>
                      
                      <td style="display: none"></td> <td>${item.DiaChi || ''}</td>
                      <td>${item.NoiCongTac || ''}</td>
                      <td>${item.MonGiangDayChinh || ''}</td>
                      
                      <td>
                          <button class="action-button view" onclick="viewClass(this, '${parseInt(item.id_Gvm) - 1}')">üëÅÔ∏è</button>
                      </td>
                  </tr>
              `;
          }).join("");

          // Render ra DOM 1 l·∫ßn duy nh·∫•t
          tbody.innerHTML = htmlString;

          // Hi·ªÉn th·ªã t·ªïng
          const totalEl = document.getElementById(totalLabelId);
          if(totalEl) totalEl.textContent = totalTiet.toFixed(2);
      }

      });

      function formatCurrency(value) {
        if (typeof value === "number" && !isNaN(value)) {
          return value.toLocaleString("vi-VN", {
            style: "currency",
            currency: "VND",
          });
        }
        return "0¬†‚Ç´"; // ho·∫∑c 'Ch∆∞a c√≥', ho·∫∑c gi·ªØ tr·ªëng ''
      }

      function filterTable() {
        const input = document.getElementById("searchGiangVien");
        if (!input) return;
        
        const filterValue = input.value.toLowerCase().trim();

        // H√†m con ƒë·ªÉ l·ªçc t·ª´ng b·∫£ng c·ª• th·ªÉ
        const filterSpecificTable = (tbodyId, totalLabelId) => {
          const tbody = document.getElementById(tbodyId);
          if (!tbody) return;

          const rows = tbody.querySelectorAll("tr");
          rows.forEach(row => {
            // C·ªôt t√™n gi·∫£ng vi√™n l√† c·ªôt th·ª© 6 (index 5) theo h√†m render c·ªßa b·∫°n
            const nameCell = row.cells[5]; 
            if (nameCell) {
              const name = nameCell.textContent.toLowerCase();
              // Hi·ªán/·∫®n d√≤ng
              if (name.includes(filterValue)) {
                row.style.display = ""; 
              } else {
                row.style.display = "none";
              }
            }
          });

          // SAU KHI L·ªåC XONG -> T√çNH L·∫†I T·ªîNG NGAY
          updateVisibleTotal(tbodyId, totalLabelId);
        };

        // Th·ª±c hi·ªán l·ªçc cho c·∫£ 2 b·∫£ng
        filterSpecificTable("tbodyCivilian", "totalCivilian");
        // filterSpecificTable("tbodyMilitary", "totalMilitary");
      }

      // G√°n s·ª± ki·ªán (ƒë·∫£m b·∫£o code n√†y ch·∫°y sau khi DOM ƒë√£ load)
      document.addEventListener("DOMContentLoaded", function() {
          const searchInput = document.getElementById("searchGiangVien");
          if(searchInput){
              searchInput.addEventListener("keyup", filterTable); // D√πng keyup ƒë·ªÉ m∆∞·ª£t h∆°n input
          }
      });

      // H√†m t√≠nh t·ªïng l·∫°i d·ª±a tr√™n c√°c d√≤ng ƒëang hi·ªÉn th·ªã
      function updateVisibleTotal(tbodyId, totalLabelId) {
        const tbody = document.getElementById(tbodyId);
        const totalLabel = document.getElementById(totalLabelId);
        
        if (!tbody || !totalLabel) return;

        let total = 0;
        const rows = tbody.querySelectorAll("tr");

        rows.forEach(row => {
          // Ch·ªâ c·ªông nh·ªØng d√≤ng KH√îNG b·ªã ·∫©n
          if (row.style.display !== "none") {
            // C·ªôt 0 l√† c·ªôt S·ªë Ti·∫øt (d·ª±a theo h√†m render c·ªßa b·∫°n)
            const cellValue = row.cells[0].textContent;
            total += parseFloat(cellValue) || 0;
          }
        });

        // C·∫≠p nh·∫≠t text hi·ªÉn th·ªã
        totalLabel.textContent = total.toFixed(2);
      }
    </script>

    <script src="/bootstrap/dist/js/jquery-3.7.1.min.js"></script>
    <script src="/bootstrap/dist/js/bootstrap.bundle.min.js"></script>

    <script>
      function viewClass(button, index) {
        var hre = "/viewGvm/" + index;
        window.location.href = hre;
      }

      // L·∫•y query string t·ª´ URL
      const urlParams = new URLSearchParams(window.location.search);
      const message = urlParams.get("message");

      // L·∫•y ph·∫ßn t·ª≠ div ƒë·ªÉ hi·ªÉn th·ªã th√¥ng b√°o
      const messageDiv = document.getElementById("message");

      // Hi·ªÉn th·ªã th√¥ng b√°o d·ª±a tr√™n gi√° tr·ªã c·ªßa message
      if (message === "insertSuccess") {
        alert("Update Success");
      } else if (message === "insertFalse") {
        alert("Update False");
      }

      // Sau khi hi·ªÉn th·ªã th√¥ng b√°o, x√≥a query string ƒë·ªÉ tr√°nh hi·ªÉn th·ªã l·∫°i khi refresh
      if (message) {
        // S·ª≠ d·ª•ng window.history ƒë·ªÉ x√≥a query string m√† kh√¥ng refresh l·∫°i trang
        const newUrl = window.location.origin + window.location.pathname;
        window.history.replaceState({}, document.title, newUrl);
      }
    </script>

    <script>
      document
        .getElementById("changePasswordLink")
        .addEventListener("click", function (event) {
          event.preventDefault(); // NgƒÉn ch·∫∑n h√†nh vi m·∫∑c ƒë·ªãnh c·ªßa th·∫ª a
          const tenDangNhap = localStorage.getItem("TenDangNhap"); // L·∫•y TenDangNhap t·ª´ localStorage

          if (tenDangNhap) {
            // Chuy·ªÉn h∆∞·ªõng ƒë·∫øn trang changePassword v√† truy·ªÅn TenDangNhap trong URL
            window.location.href = `/changePassword?tenDangNhap=${encodeURIComponent(
              tenDangNhap
            )}`;
          } else {
            alert("Kh√¥ng t√¨m th·∫•y TenDangNhap trong localStorage.");
          }
        });
    </script>
    <script>
      $(document).ready(function () {
        signHeDaoTaoOptions();

        $('#NamHoc option[value=""]').remove();
        $('#comboboxki option[value=""]').remove();
        $('#combobox-dot option[value=""]').remove();

        $.ajax({
          url: "/getNamHoc",
          method: "GET",
          success: function (response) {
            if (response.success) {
              response.NamHoc.forEach(function (item) {
                $("#NamHoc").append(
                  `<option value="${item.NamHoc}">${item.NamHoc}</option>`
                );
              });

              $("#comboboxki").prepend(
                '<option value="AllKi">K√¨ 1 + K√¨ 2</option>'
              );

              response.Ki.forEach(function (item) {
                $("#comboboxki").append(
                  `<option value="${item.value}">${item.Ki}</option>`
                );
              });
              response.Dot.forEach(function (item) {
                $("#combobox-dot").append(
                  `<option value="${item.value}">${item.Dot}</option>`
                );
              });
            } else {
              console.error(
                "Kh√¥ng l·∫•y ƒë∆∞·ª£c d·ªØ li·ªáu nƒÉm h·ªçc:",
                response.message
              );
            }
          },
          error: function (error) {
            console.error("L·ªói khi l·∫•y d·ªØ li·ªáu nƒÉm h·ªçc:", error);
          },
        });
      });

      signHeDaoTaoOptions = () => {
        const select = document.getElementById('he_dao_tao');

        const heDaoTaoList = JSON.parse(
          localStorage.getItem('HE_DAO_TAO_CACHE')
        ) || [];

        // reset option c≈©
        select.innerHTML = '';

        // option ALL
        const allOption = document.createElement('option');
        allOption.value = '0';               // ho·∫∑c 'AllHe'
        allOption.textContent = 'T·∫•t c·∫£ h·ªá ƒë√†o t·∫°o';
        select.appendChild(allOption);

        // option t·ª´ng h·ªá
        heDaoTaoList.forEach(item => {
          const option = document.createElement('option');
          option.value = item.id;
          option.textContent = item.tenHe;
          select.appendChild(option);
        });
      };
    </script>

    <script>
      function calculateTotals() {
        const table = document.getElementById("dataTable"); // L·∫•y b·∫£ng
        const tbody = table.querySelector("tbody"); // L·∫•y ph·∫ßn th√¢n b·∫£ng (tbody)

        let total = 0; // Bi·∫øn l∆∞u tr·ªØ t·ªïng s·ªë ti·∫øt

        // Duy·ªát qua t·∫•t c·∫£ c√°c h√†ng trong b·∫£ng
        for (let row of tbody.rows) {
          // Ki·ªÉm tra xem h√†ng c√≥ b·ªã ·∫©n hay kh√¥ng
          if (row.style.display === "none") {
            continue; // B·ªè qua h√†ng n√†y n·∫øu b·ªã ·∫©n
          }

          const cell = row.cells[0]; // C·ªôt s·ªë ti·∫øt l√† c·ªôt th·ª© 14 (ch·ªâ s·ªë b·∫Øt ƒë·∫ßu t·ª´ 0)
          const soTiet = parseFloat(cell.textContent, 10); // Chuy·ªÉn gi√° tr·ªã trong √¥ th√†nh s·ªë nguy√™n
          if (!isNaN(soTiet)) {
            // Ki·ªÉm tra n·∫øu gi√° tr·ªã h·ª£p l·ªá
            total += soTiet; // C·ªông d·ªìn v√†o t·ªïng
          }
        }

        // Hi·ªÉn th·ªã t·ªïng s·ªë ti·∫øt
        const totalElement = document.getElementById("totalQC"); // Gi·∫£ s·ª≠ c√≥ m·ªôt ph·∫ßn t·ª≠ ƒë·ªÉ hi·ªÉn th·ªã t·ªïng s·ªë ti·∫øt
        totalElement.textContent = `T·ªïng s·ªë ti·∫øt Quy Chu·∫©n: ${total.toFixed(
          2
        )}`; // Hi·ªÉn th·ªã t·ªïng
      }
    </script>
    <script>
      $(document).ready(function () {
        const isKhoa = localStorage.getItem("isKhoa");

        // N·∫øu l√† khoa th√¨ ·∫©n
        if (isKhoa == 1) {
          $("#MaPhongBan").remove(); // ·∫©n c·∫£ label v√† select n·∫øu b·ªçc trong form-group
          return; // kh√¥ng c·∫ßn g·ªçi AJAX n·ªØa
        }

        // N·∫øu l√† ph√≤ng ban th√¨ hi·ªÉn th·ªã option ch·ªçn khoa
        $('#MaPhongBan option[value=""]').remove();
        // G·ªçi AJAX ƒë·ªÉ l·∫•y d·ªØ li·ªáu JSON t·ª´ API
        $.ajax({
          url: "/api/shared/faculty-code-list", // ƒê∆∞·ªùng d·∫´n t·ªõi API getPhongBan
          method: "GET",
          success: function (response) {
            // Ki·ªÉm tra n·∫øu response th√†nh c√¥ng
            const MaPhongBan = response.MaPhongBan;
            if (response.success) {
              $("#MaPhongBan").prepend(
                '<option value="ALL">T·∫•t c·∫£ khoa</option>'
              );
              // L·∫∑p qua t·ª´ng m·ª•c trong m·∫£ng MaPhongBan
              response.MaPhongBan.forEach(function (item) {
                // N·∫øu item.MaPhongBan b·∫±ng boMon.MaPhongBan, hi·ªÉn th·ªã tr∆∞·ªõc
                $("#MaPhongBan").append(
                  `<option value="${item.MaPhongBan}">${item.MaPhongBan}</option>`
                );
              });

              // N·∫øu kh√¥ng c√≥ ph√≤ng ban n√†o t∆∞∆°ng ·ª©ng, b·∫°n c√≥ th·ªÉ th√™m t√πy ch·ªçn m·∫∑c ƒë·ªãnh ·ªü ƒë√¢y
              if (!$("#MaPhongBan option:selected").length) {
                $("#MaPhongBan").prepend(
                  '<option value="">Ch·ªçn Ph√≤ng Ban</option>'
                );
              }
            } else {
              console.error(
                "Kh√¥ng l·∫•y ƒë∆∞·ª£c d·ªØ li·ªáu phongBan:",
                response.message
              );
            }
          },
          error: function (error) {
            console.error("L·ªói khi l·∫•y d·ªØ li·ªáu phongBan:", error);
          },
        });
      });
    </script>
    <script>
      document
        .getElementById("infome")
        .addEventListener("click", function (event) {
          event.preventDefault(); // NgƒÉn ch·∫∑n h√†nh vi m·∫∑c ƒë·ªãnh c·ªßa th·∫ª a
          const id_User = localStorage.getItem("id_User"); // L·∫•y id_User t·ª´ localStorage\
          if (id_User) {
            // Chuy·ªÉn h∆∞·ªõng ƒë·∫øn trang infome v√† truy·ªÅn id_User trong URL
            window.location.href = `/infome/${id_User}`;
          } else {
            alert("Kh√¥ng t√¨m th·∫•y id_User trong localStorage.");
          }
        });
    </script>

    <script>
      document.addEventListener("DOMContentLoaded", () => {
        const role = localStorage.getItem("userRole");
        const isKhoa = localStorage.getItem("isKhoa");

        // ·∫®n button import ƒë·ªì √°n
        const importDoAn = document.getElementById("importDoAn");
        const suaHD = document.getElementById("suaHD");

        if (isKhoa == 0 && (role == APP_ROLES.troLy_phong || role == APP_ROLES.lanhDao_phong)) {
          importDoAn.style.display = "block";
          suaHD.style.display = "block";
        }

        // ·∫®n button ngay khi trang ƒë∆∞·ª£c t·∫£i
        const actionButton = document.getElementById("changeMessage");
        //·∫®n site th√™m th√¥ng b√°o
        if (role === APP_ROLES.troLy_phong || role === APP_ROLES.lanhDao_phong) {
          actionButton.style.display = "";
        } else {
          actionButton.style.display = "none";
        }
      });
    </script>
    <script>
      document
        .getElementById("changeMessage")
        .addEventListener("click", function (event) {
          event.preventDefault(); // NgƒÉn ch·∫∑n h√†nh vi m·∫∑c ƒë·ªãnh c·ªßa th·∫ª a
          const MaPhongBan = localStorage.getItem("MaPhongBan"); // L·∫•y MaPhongBan t·ª´ localStorage

          if (MaPhongBan) {
            // Chuy·ªÉn h∆∞·ªõng ƒë·∫øn trang changeMessage v√† truy·ªÅn MaPhongBan trong URL
            window.location.href = `/changeMessage/${MaPhongBan}`;
          } else {
            alert("Kh√¥ng t√¨m th·∫•y MaPhongBan trong localStorage.");
          }
        });
    </script>
  </body>
</html>
