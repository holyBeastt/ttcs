<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Học Viện Kỹ Thuật Mật Mã</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
  <link rel="stylesheet" href="/css/forminput.css">
  <link rel="stylesheet" href="/css/styles.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css">
    <!-- <link rel="stylesheet" href="public/css/styles.css"> -->

</head>
<body>
   
    <nav class="navbar-top ">
        <div class="container-fluid">
          <a class="navbar-brand" href="#">
            <img src="/Logo-Hoc-Vien-Ky-Thuat-Mat-Ma-ACTVN.webp" alt="Logo">
            <div class="navbar-title">
              <img src="/dongchu_banner.png" alt="banner">
            </div>
          </a>
        </div>
      </nav>
    
      <!-- Phần dưới của navbar chứa các mục nằm ngang -->
      <nav class="navbar navbar-expand-lg navbar-bottom sticky-top">
        <div class="" style="width: 100%;">
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
          </button>
          <div class="collapse navbar-collapse" style="width: 100%;" id="navbarNav">
            <ul class="navbar-nav">
              <li class="nav-item">
                <a class="nav-link" id="Home" href=""><i class="fa-solid fa-house"></i></a>
              </li>
              <div class="navbar-nav">
                <div class="nav-item dropdown">
                  <a class="nav-link dropdown-toggle" href="/login" id="navbarDropdownUser" data-bs-toggle="dropdown"
                    aria-expanded="false">
                    Giảng Viên Mời
                  </a>
                  <div class="dropdown-menu" aria-labelledby="dropdownMenuButton">
                    <a class="nav-link" href="/gvmList">Danh sách giảng viên mời</a>
                    <a class="nav-link" id="actionButton1" href="/importGvmList" style="width: 100%;">Thêm giảng viên mời bằng file</a>
                  </div>
                </div>
              </div>
              <div class="navbar-nav">
                <div class="nav-item dropdown">
                  <a class="nav-link dropdown-toggle" href="/login" id="navbarDropdownUser" data-bs-toggle="dropdown"
                    aria-expanded="false">
                    Bảng Quy Chuẩn
                  </a>
                  <div class="dropdown-menu" aria-labelledby="dropdownMenuButton">
                    <a class="nav-link" href="/import" id="actionButton2" style="width: 100%;">Thêm file quy chuẩn</a>
                <a class="nav-link" href="/tableTam">Bảng quy chuẩn dự kiến</a>
                    <a class="nav-link" href="/tableQC">Bảng quy chuẩn chính thức</a>
                    <a class="nav-link" id="ThongTinGD" href="">Thông tin giảng viên theo lớp</a>
                  </div>
                </div>
              </div>
              <div class="navbar-nav">
                <div class="nav-item dropdown">
                  <a class="nav-link dropdown-toggle" href="/login" id="navbarDropdownUser" data-bs-toggle="dropdown"
                    aria-expanded="false">
                    Mời Giảng
                  </a>
                  <div class="dropdown-menu" aria-labelledby="dropdownMenuButton">
                    <a class="nav-link" href="/xemCacLopGvm">Xem các lớp mời</a>
                    <a class="nav-link" href="/classInfoGvm">Thông tin lớp giảng viên mời</a>
                    <a class="nav-link" href="/hopDongDuKien" role="button">Hợp đồng dự kiến</a>

                    <a  class="nav-link " href="/infoHDGvm" role="button">Thông tin hợp đồng</a>   
                    <li class="nav-item"></li>
                      <a class="nav-link " href="/phuLucHD" >Phụ lục hợp đồng</a>
                    </li>
                    <a class="nav-link " href="/exportHD">Hợp Đồng</a>

                  </div>
                </div>
              </div>
              <div class="navbar-nav">
                <div class="nav-item dropdown">
                  <a class="nav-link dropdown-toggle active" href="/login" id="navbarDropdownUser" data-bs-toggle="dropdown"
                    aria-expanded="false">
                    Vượt Giờ
                  </a>
                  <div class="dropdown-menu" aria-labelledby="dropdownMenuButton">
                    <a class="nav-link " id="" href="/addclass">Thêm lớp giảng dạy</a>              
                    <a class="nav-link" id="" href="/addclassgiuaky">Thêm lớp kiểm tra giữa kỳ</a>
                    <a class="nav-link" id="actionButton3" href="/duyetgk">Duyệt lớp giữa kì</a>
                    <a class="nav-link active" id="" href="/vuotGioExport">Xuất thông tin vượt giờ</a>              

                  </div>
                </div>
              </div>
              <div class="navbar-nav">
                <div class="nav-item dropdown">
                  <a class="nav-link dropdown-toggle" href="/login" id="navbarDropdownUser" data-bs-toggle="dropdown"
                    aria-expanded="false">
                    Nghiên Cứu Khoa Học
                  </a>
                  <div class="dropdown-menu" aria-labelledby="dropdownMenuButton">
                    <a class="nav-link" id="" href="#">COMING SOON</a>              </div>
                </div>
              </div>
              <div class="navbar-nav">
                <div class="nav-item dropdown">
                  <a class="nav-link dropdown-toggle" href="/login" id="navbarDropdownUser" data-bs-toggle="dropdown"
                    aria-expanded="false">
                    Đồ Án
                  </a>
                  <div class="dropdown-menu" aria-labelledby="dropdownMenuButton">
                    <a class="nav-link" id="" href="#">COMING SOON</a>              </div>
                </div>
              </div>
              <div class="navbar-nav">
                <div class="nav-item dropdown">
                  <a class="nav-link dropdown-toggle" href="/login" id="navbarDropdownUser" data-bs-toggle="dropdown"
                    aria-expanded="false">
                    Thống Kê
                  </a>
                  <div class="dropdown-menu" aria-labelledby="dropdownMenuButton">
                    <a class="nav-link" id="" href="#">COMING SOON</a>
                  </div>
                </div>
             
              </div>
              <div class="navbar-nav">
                <div class="nav-item dropdown">
                  <a class="nav-link dropdown-toggle" href="#" id="navbarDropdownUser" data-bs-toggle="dropdown"
                    aria-expanded="false">
                     Hệ Thống
                  </a>
                  <div class="dropdown-menu" aria-labelledby="dropdownMenuButton">
                    <a class="nav-link" id="" href="log">Xem File Log</a>
                  </div>
                </div>
              </div>
            </ul>
              <div class="navbar-nav">
                <div class="nav-item dropdown">
                  <a class="nav-link dropdown-toggle fullname" href="/login" id="navbarDropdownUser" data-bs-toggle="dropdown"
                    aria-expanded="false">
                    Hi, Lê Đức Thuận
                  </a>
                  <div class="dropdown-menu" aria-labelledby="dropdownMenuButton">
                    <a class="dropdown-item"id="infome">Thông tin cá nhân</a>
                    <a class="dropdown-item" id="changePasswordLink">Đổi mật khẩu</a>
                    <a class="dropdown-item" href="/">Đăng xuất</a>
                  </div>
                </div>
              </div>
          </div>
        </div>
      </nav>
      <div class="container-fluid box m-4">
        <div class="d-flex justify-content-center">
          <!-- Main content -->
          <div class="gvmList">
            <div class="m-3">
              <h1>THÔNG TIN HỢP ĐỒNG VƯỢT GIỜ</h1>
    
              <div class="controls-container">
                <select class="form-select w-100px mx-2 selectop" id="combobox-dot">
                  <option value="">Đợt</option>
                </select>
    
                <select class="form-select w-100px mx-2 selectop" id="combobox-ki">
                  <option value="">Kỳ</option>
                </select>
    
                <select class="form-select w-100px mx-2 selectop" id="NamHoc">
                  <option value="">Năm học</option>
                </select>
                <select class="form-select w-100px mx-1 selectop" id="MaPhongBan">
                  <option value="">Chọn khoa</option>
                </select>
    
                <input type="text" class="form-control w-200px mx-2" id="search-teacher" oninput="showSuggestionsGvm(this)" onclick="showSuggestionsGvm(this)" placeholder="Tìm kiếm giảng viên">
                <button id="exportButton" class="btn export" onclick="exportData()">
                  <i class="fas fa-file-export me-2"></i>Xuất dữ liệu
                </button>
              </div>

  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const isKhoa = localStorage.getItem("isKhoa");

      // Ẩn button ngay khi trang được tải
      const actionButton = document.getElementById('actionButton');
      const actionButton1 = document.getElementById('actionButton1');
      const actionButton2 = document.getElementById('actionButton2');
      const actionButton3 = document.getElementById('actionButton3');

      if (isKhoa == 0) {
        actionButton1.style.display = 'none'; // Ẩn actionButton1 nếu isKhoa = 0
        actionButton2.style.display = 'inline-block'; // Hiện actionButton2
            
      } else {
          actionButton1.style.display = 'inline-block'; // Hiện actionButton1 nếu isKhoa khác 0
          actionButton2.style.display = 'none'; // Ẩn actionButton2
      }
      const MaPhongBan = localStorage.getItem("MaPhongBan");
    
      // Gán URL động vào thuộc tính action của form
      if (MaPhongBan) {
        document.getElementById("addClassForm").action = `/addclass/${MaPhongBan}`;
      } else {
        console.error("Không tìm thấy MaPhongBan trong localStorage");
      }

      //Ẩn site duyệt
      const Quyen = localStorage.getItem("userRole");
      if (Quyen === "Lãnh đạo khoa" || Quyen === "Duyệt") {
        actionButton3.style.display = '';
      } else {
        actionButton3.style.display = 'none';
      }
      });
</script>
<script>
    const Home = document.getElementById("Home");
    Home.addEventListener("click", function (event) {
        event.preventDefault(); // Ngăn chặn hành vi mặc định của liên kết

        const isKhoa = localStorage.getItem("isKhoa")

        if (isKhoa==0) { // Nếu là đào tạo hoặc tài chính
          window.location.href = "/maindt";
        } else {
          window.location.href = "/mainkhoa";
        }
    });
</script>
<script>
    window.onload = function () {
        const TenNhanVien = localStorage.getItem("TenNhanVien"); // Lấy tên người dùng từ localStorage
        let Role = localStorage.getItem("userRole");
        if (Role.toUpperCase() == 'LÃNH ĐẠO KHOA'){
          Role = 'LĐK';
        }      
        if (TenNhanVien) {
          document.getElementById("GiangVien").value = TenNhanVien;
            // Hiển thị tên người dùng trên phần tử HTML
          document.querySelector(".fullname").innerText = `${TenNhanVien} - ${Role}`;
        } else {
            document.querySelector('.fullname').innerText = 'Hi, Guest'; // Hiển thị nếu không có tên người dùng
        }      
        //document.querySelector('.role').innerText = `${Role}`;      
        };
</script>
<script>
    let counter = 2;
    function addInputFields() {
        const container = document.getElementById("add");
        const newDiv = document.createElement("div");
        newDiv.className = "row mb-3 d-flex";

        newDiv.innerHTML = `
              <h6>Nhập thông tin lớp:</h6>
              <div style="width: max-content;">
                  <div>
                    <label for="TenHocPhan${counter}">Tên học phần*</label>
                    <input required class="form-control" type="text" name="TenHocPhan${counter}" id="TenHocPhan${counter}">
                  </div>
                  <div>
                    <label for="HinhThucKTGiuaKy${counter}">Hình thức kiểm tra giữa kì</label>
                    <select class="form-control" name="HinhThucKTGiuaKy${counter}" id="HinhThucKTGiuaKy${counter}">
                      <option value="none">None</option>
                      <option value="Coi, chấm TN">Coi, chấm trắc nghiệm trên giấy</option>
                      <option value="Coi, chấm viết">Coi, chấm tự luận</option>
                      <option value="Coi, chấm VĐ">Coi, chấm vấn đáp</option>
                      <option value="Coi, chấm TH">Coi, chấm thực hành</option>
                    </select>
                  </div>
                </div>
                <div style="width: max-content;">
                  <div>
                    <label for="Lop${counter}">Lớp học phần*</label>
                    <input type="text" class="form-control" name="Lop${counter}" id="Lop${counter}" required>
                  </div>
                  <div>
                    <label for="LoaiHinhDaoTao${counter}">Loại hình đào tạo</label>
                    <input class="form-control" type="text" name="LoaiHinhDaoTao${counter}" id="LoaiHinhDaoTao${counter}">
                  </div>
                </div>
                <div style="width: max-content;">
                  <div>
                    <label for="SoTC${counter}">Số tín chỉ</label>
                    <input type="text" class="form-control" name="SoTC${counter}" style="width: 100px;" id="SoTC${counter}">
                  </div>
                  <div>
                    <label for="HeSoLopDong${counter}">Hệ số lớp đông</label>
                    <input type="text" class="form-control" name="HeSoLopDong${counter}" id="HeSoLopDong${counter}" style="width: 100px;">
                  </div>
                </div>
                <div style="width: max-content;">
                  <div>
                    <label for="SoTietCTDT${counter}">Số tiết TKB</label>
                    <input type="text" class="form-control" name="SoTietCTDT${counter}" id="SoTietCTDT${counter}" style="width: 100px;">
                  </div>
                  <div>
                    <label for="HeSoT7CN${counter}">Hệ số T7CN</label>
                    <select class="form-control" name="HeSoT7CN${counter}" id="HeSoT7CN${counter}">
                      <option value="Không">Không</option>
                      <option value="Cuối tuần">Cuối tuần</option>
                      <option value="Tối">Tối</option>
                    </select>                    
                  </div>
                </div>
                <div style="width: max-content;">
                  <div>
                    <label for="QuyChuan${counter}">Số tiết QC*</label>
                    <input type="text" class="form-control" name="QuyChuan${counter}" id="QuyChuan${counter}" style="width: 100px;" required>
                  </div>
                  <div>
                    <label for="SoSV${counter}">Số SV*</label>
                    <input type="text" class="form-control" name="SoSV${counter}" id="SoSV${counter}" style="width: 100px;" required>
                  </div>
                </div>
                <div style="width: max-content;">
                  <div>
                    <label for="HocKy${counter}">Học kì</label>
                    <select class="form-control" name="HocKy${counter}" id="HocKy${counter}" style="width: 100px;">
                      <option value="1">Học kỳ 1</option>
                      <option value="2">Học kỳ 2</option>
                    </select>
                  </div>
                  <div>
                    <label for="NamHoc${counter}">Năm học</label>
                    <select class="form-control" name="NamHoc${counter}" id="NamHoc${counter}">
                    </select>
                  </div>
                </div>
                <div style="width: max-content;">
                  <div>
                    <label for="SoDe${counter}">Số đề</label>
                    <input type="text" class="form-control" name="SoDe${counter}" id="SoDe${counter}" style="width: 100px;" required>
                  </div>
                </div>
              <button type="button" class="btn btn-danger" onclick="removeField(this)" style="margin-bottom: 0px; width: 100px;">Xóa</button>
        `;

        container.appendChild(newDiv);
        document.getElementById("index").value = counter;
        updateNamHocOptions(`NamHoc${counter}`);
        counter++;
    }
    function removeField(button) {
    // Tìm đến phần tử `newDiv` chứa các trường và nút "Xóa"
    const fieldDiv = button.parentElement;
    fieldDiv.remove();  // Xóa `newDiv` khỏi DOM
    }
    function updateNamHocOptions(id) {
    $.ajax({
      url: '/getNamHoc',
      method: 'GET',
      success: function (response) {
        if (response.success) {
          const currentYear = new Date().getFullYear();
          response.NamHoc.forEach(function (item) {
            const isSelected = currentYear === item.NamHoc ? 'selected' : '';
            $(`#${id}`).append(
              `<option value="${item.NamHoc}" ${isSelected}>${item.NamHoc}</option>`
            );
          });
        } else {
          console.error("Không lấy được dữ liệu năm học:", response.message);
        }
      },
      error: function (error) {
        console.error("Lỗi khi lấy dữ liệu năm học:", error);
      }
    });
  }

  // $(document).ready(function () {
  //   updateNamHocOptions('NamHoc1');
  // });
</script>
<script>
  $(document).ready(function () {
    $.ajax({
      url: '/getNamHoc',
      method: 'GET',
      success: function (response) {
        if (response.success) {
          const currentYear = new Date().getFullYear();
          response.NamHoc.forEach(function (item) {
            console.log(item.NamHoc);
            const isSelected = currentYear === item.NamHoc ? 'selected' : '';
            $(`#NamHoc1`).append(
              `<option value="${item.NamHoc}" ${isSelected}>${item.NamHoc}</option>`
            );
          });
        } else {
          console.error("Không lấy được dữ liệu năm học:", response.message);
        }
      },
      error: function (error) {
        console.error("Lỗi khi lấy dữ liệu năm học:", error);
      }
    });
  });
</script>
<script>
  document.getElementById("infome").addEventListener("click", function(event) {
    event.preventDefault(); // Ngăn chặn hành vi mặc định của thẻ a
    const id_User = localStorage.getItem("id_User"); // Lấy id_User từ localStorage\
    if (id_User) {
        // Chuyển hướng đến trang infome và truyền id_User trong URL
        window.location.href = `/infome/${id_User}`;
    } else {
        alert("Không tìm thấy id_User trong localStorage.");
    }
  });
</script>
<script>
    $(document).ready(function () {
      $('#NamHoc option[value=""]').remove();
      $('#combobox-ki option[value=""]').remove();
      $('#combobox-dot option[value=""]').remove();

      $.ajax({
        url: '/getNamHoc',
        method: 'GET',
        success: function (response) {
          if (response.success) {

            response.NamHoc.forEach(function (item) {
              console.log(item.NamHoc);
              $('#NamHoc').append(
                `<option value="${item.NamHoc}">${item.NamHoc}</option>`
              );
            });

            response.Ki.forEach(function (item) {
              console.log(item.Ki);
              $('#combobox-ki').append(
                `<option value="${item.value}">${item.Ki}</option>`
              );
            });
            response.Dot.forEach(function (item) {
              console.log(item.Dot);
              $('#combobox-dot').append(
                `<option value="${item.value}">${item.Dot}</option>`
              );
            });
          } else {
            console.error("Không lấy được dữ liệu năm học:", response.message);
          }
        },
        error: function (error) {
          console.error("Lỗi khi lấy dữ liệu năm học:", error);
        }
      });
    });
  </script>
  <script>
    $(document).ready(function () {
      $('#MaPhongBan option[value=""]').remove();
      // Gọi AJAX để lấy dữ liệu JSON từ API
      $.ajax({
        url: '/getPhongBan', // Đường dẫn tới API getPhongBan
        method: 'GET',
        success: function (response) {
          // Kiểm tra nếu response thành công
          const MaPhongBan = response.MaPhongBan;
          if (response.success) {
            $('#MaPhongBan').prepend('<option value="ALL">Tất cả khoa</option>');
            // Lặp qua từng mục trong mảng MaPhongBan
            response.MaPhongBan.forEach(function (item) {
              // Nếu item.MaPhongBan bằng boMon.MaPhongBan, hiển thị trước
              console.log(item);
              $('#MaPhongBan').append(
                `<option value="${item.MaPhongBan}">${item.MaPhongBan}</option>`
              );
            }
            );

            // Nếu không có phòng ban nào tương ứng, bạn có thể thêm tùy chọn mặc định ở đây
            if (!$('#MaPhongBan option:selected').length) {
              $('#MaPhongBan').prepend('<option value="">Chọn Phòng Ban</option>');
            }
          } else {
            console.error("Không lấy được dữ liệu phongBan:", response.message);
          }
        },
        error: function (error) {
          console.error("Lỗi khi lấy dữ liệu phongBan:", error);
        }
      });
    });
  </script>
   <script>

    // Hàm gợi ý bộ môn ở ô nhập 
    function showSuggestionsGvm(input) {
      const value = input.value.toLowerCase(); // Lấy giá trị nhập vào và chuyển thành chữ thường
      hideSuggestionsGvm(); // Ẩn gợi ý cũ trước khi hiển thị gợi ý mới

      // Tạo thẻ div chứa gợi ý
      const suggestionsContainer = document.createElement('div');
      suggestionsContainer.className = 'suggestions'; // Đặt class cho khung gợi ý

      // Đặt vị trí cho suggestionsContainer
      const { bottom, left, width } = input.getBoundingClientRect(); // Lấy vị trí của input
      suggestionsContainer.style.position = 'absolute'; // Để đè lên bảng
      suggestionsContainer.style.top = `${bottom + window.scrollY}px`; // Đặt vị trí ngay dưới input
      suggestionsContainer.style.left = `${left + window.scrollX}px`; // Căn trái với input
      suggestionsContainer.style.width = `${width}px`; // Chiều rộng bằng với input
      suggestionsContainer.style.zIndex = '1000'; // Đảm bảo luôn hiển thị trên các thành phần khác
      suggestionsContainer.style.maxHeight = '200px'; // Giới hạn chiều cao để không quá lớn
      suggestionsContainer.style.overflowY = 'auto';  // Cho phép cuộn dọc nếu quá nhiều gợi ý

      // Thêm suggestionsContainer vào DOM
      document.body.appendChild(suggestionsContainer); // Đặt suggestionsContainer vào body thay vì cha của input

      let suggestions = []; // Khởi tạo mảng gợi ý

      // Lấy dữ liệu từ localStorage
      const boMon = JSON.parse(localStorage.getItem("gvmList")) || []; // Giảng viên mời
      console.log(gvmList)

      suggestions = gvmList.map(item => `${item.HoTen} - ${item.MaPhongBan}`);


      // Nếu người dùng nhập dữ liệu, lọc kết quả theo tên giảng viên
      if (value) {
        suggestions = suggestions.filter(name => name.toLowerCase().includes(value));
      }

      // Nếu không có gợi ý, ẩn container
      if (suggestions.length === 0) {
        suggestionsContainer.remove();
        return; // Kết thúc hàm nếu không có gợi ý
      }

      // Tạo gợi ý dưới dạng danh sách (list)
      suggestions.forEach(name => {
        const suggestionItem = document.createElement('div'); // Tạo phần tử cho từng gợi ý
        suggestionItem.className = 'suggestion-item'; // Đặt class để tùy chỉnh giao diện
        suggestionItem.textContent = name; // Hiển thị tên giảng viên kèm theo khoa

        // Thêm sự kiện click để điền tên vào ô input
        // Thêm sự kiện click để điền tên vào ô input
        suggestionItem.onclick = function () {
          // Giả sử 'name' là giá trị gợi ý bạn nhận được từ suggestionItem
          const name = suggestionItem.innerText; // Hoặc có thể là suggestionItem.textContent

          // Tìm vị trí của dấu "-" trong chuỗi
          const dashIndex = name.indexOf("-");

          // Nếu không có dấu "-", sử dụng tên gợi ý gốc
          let processedName = name;

          if (dashIndex !== -1) {
            // Lấy phần sau dấu "-" và loại bỏ khoảng trắng
            //processedName = name.slice(dashIndex + 1).trim().replace(/\s+/g, '');
            processedName = name.slice(0, dashIndex).trim();

          }

          // Điền tên gợi ý đã xử lý vào ô input
          input.value = processedName;
          // filterBoMon();
          if (input.id == 'search-teacher') {
            filterKhoa();
          }
          hideSuggestionsGvm(); // Ẩn gợi ý sau khi chọn
        };


        suggestionsContainer.appendChild(suggestionItem); // Thêm mục vào danh sách gợi ý
      });

      // Ẩn gợi ý khi input không còn focus
      input.onblur = function () {
        setTimeout(() => {
          hideSuggestionsGvm();
        }, 100); // Thời gian chờ để nhận diện click
      };
    }

    // Hàm ẩn gợi ý
    function hideSuggestionsGvm() {
      const existingSuggestions = document.querySelectorAll('.suggestions');
      existingSuggestions.forEach(suggestion => suggestion.remove());
    }

     // calculateTotals();
  

  </script>
</body>
</html>

