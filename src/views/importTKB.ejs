<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>H·ªçc Vi·ªán K·ªπ Thu·∫≠t M·∫≠t M√£</title>
    <link rel="stylesheet" href="/css/table.css" />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css"
    />
    <link rel="stylesheet" href="/css/styles.css" />
    <link rel="stylesheet" href="/css/import.css" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css"
    />
  </head>
  <style>
    .btn {
      height: 45px;
      margin-bottom: 0px;
      text-wrap: nowrap;
    }
  </style>

  <body>
    <!-- Ph·∫ßn header -->
    <%- include('header') %>

    <!-- Ph·∫ßn n·ªôi dung -->

    <div class="container-fluid m-4 box d-flex justify-content-start">
      <div class="mx-2">
        <div class="d-flex align-items-center mb-3">
          <button class="btn mx-2" id="chooseFile">Ch·ªçn file</button>
          <!-- Combo box ƒê·ª£t -->
          <!-- Combo box ƒê·ª£t -->
          <select class="selectop mx-1" id="combobox-dot">
            <option value="">ƒê·ª£t</option>
          </select>

          <!-- Combo box k√¨ -->
          <select class="selectop mx-1" id="comboboxki">
            <option value="">K·ª≥</option>
          </select>

          <!-- Combo box NƒÉm -->
          <select class="selectop mx-1" id="NamHoc">
            <option value="">Ch·ªçn nƒÉm h·ªçc</option>
          </select>

          <!-- Combo box ƒê·ªãa ƒëi·ªÉm -->
          <select class="selectop mx-1" id="location">
            <option value="hvktmm" selected>H·ªçc vi·ªán K·ªπ thu·∫≠t m·∫≠t m√£</option>
            <option value="phhv">Ph√¢n hi·ªáu h·ªçc vi·ªán</option>
          </select>

          <!-- Combo box v·ªõi c√°c gi√° tr·ªã CNTT, ATTT, DTVT -->
          <!-- <select class="selectop" id="MaPhongBan">
            <option value="ALL">T·∫•t c·∫£ khoa</option>
          </select> -->
          <!-- <button class="btn mx-2" id="import">Th√™m</button> -->
          <button class="btn mx-2" id="viewTKB">B·∫£ng th·ªùi kh√≥a bi·ªÉu</button>
        </div>

        <div id="action-modal" style="display: none">
          <div
            style="
              position: fixed;
              top: 0;
              left: 0;
              width: 100%;
              height: 100%;
              background: rgba(0, 0, 0, 0.6);
              display: flex;
              justify-content: center;
              align-items: center;
              z-index: 10000000000;
            "
          >
            <div
              style="
                background: #ffffff;
                padding: 25px;
                border-radius: 12px;
                max-width: 450px;
                width: 90%;
                text-align: center;
                box-shadow: 0px 4px 12px rgba(0, 0, 0, 0.2);
              "
            >
              <p
                id="modal-message"
                style="font-size: 16px; color: #333; margin-bottom: 20px"
              >
                ƒê√¢y l√† n·ªôi dung c·ªßa modal.
              </p>
              <button
                id="btn-delete"
                style="
                  background-color: #e74c3c;
                  color: white;
                  border: none;
                  padding: 10px 20px;
                  margin: 5px;
                  border-radius: 6px;
                  cursor: pointer;
                  font-size: 14px;
                  transition: background-color 0.3s;
                "
                onmouseover="this.style.backgroundColor='#c0392b'"
                onmouseout="this.style.backgroundColor='#e74c3c'"
              >
                X√≥a
              </button>
              <button
                id="btn-append"
                style="
                  background-color: #3498db;
                  color: white;
                  border: none;
                  padding: 10px 20px;
                  margin: 5px;
                  border-radius: 6px;
                  cursor: pointer;
                  font-size: 14px;
                  transition: background-color 0.3s;
                "
                onmouseover="this.style.backgroundColor='#2980b9'"
                onmouseout="this.style.backgroundColor='#3498db'"
              >
                Ch√®n
              </button>
              <button
                id="btn-cancel"
                style="
                  background-color: #95a5a6;
                  color: white;
                  border: none;
                  padding: 10px 20px;
                  margin: 5px;
                  border-radius: 6px;
                  cursor: pointer;
                  font-size: 14px;
                  transition: background-color 0.3s;
                "
                onmouseover="this.style.backgroundColor='#7f8c8d'"
                onmouseout="this.style.backgroundColor='#95a5a6'"
              >
                H·ªßy
              </button>
            </div>
          </div>
        </div>

        <div id="dataTableContainer" class="h-75"></div>
      </div>
    </div>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Link script Sweet alert 2 -->
    <!-- SweetAlert2 CSS -->
    <link
      href="https://cdn.jsdelivr.net/npm/sweetalert2@11.6.16/dist/sweetalert2.min.css"
      rel="stylesheet"
    />

    <!-- SweetAlert2 JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.6.16/dist/sweetalert2.all.min.js"></script>

    <script>
      document.getElementById("viewTKB").onclick = function () {
        window.location.href = "/getTKBChinhThucSite"; // Thay URL b·∫±ng trang b·∫°n mu·ªën chuy·ªÉn h∆∞·ªõng ƒë·∫øn
      };

      // Th√™m event listener ƒë·ªÉ log khi select ƒë·ªãa ƒëi·ªÉm thay ƒë·ªïi
      document.getElementById("location").addEventListener("change", function() {
        const locationValue = this.value || "hvktmm";
        console.log("üìç ƒê·ªãa ƒëi·ªÉm ƒë√£ thay ƒë·ªïi th√†nh:", locationValue);
      });
    </script>
    <!-- ph·∫ßn ch·ªçn file -->
    <script>
      let dataTam = []; // Bi·∫øn l∆∞u d·ªØ li·ªáu t·∫°m

      // L·∫Øng nghe s·ª± ki·ªán click
      // G·∫Øn s·ª± ki·ªán cho n√∫t "import"
      document
        .getElementById("chooseFile")
        .addEventListener("click", async function () {
          const dotValue = document.getElementById("combobox-dot").value;
          const kiValue = document.getElementById("comboboxki").value;
          const namValue = document.getElementById("NamHoc").value;
          
          // L·∫•y location m·ªõi m·ªói l·∫ßn click (ƒë·∫£m b·∫£o l·∫•y gi√° tr·ªã m·ªõi nh·∫•t)
          const locationSelect = document.getElementById("location");
          const locationValue = (locationSelect.value || "hvktmm").trim(); // M·∫∑c ƒë·ªãnh l√† hvktmm

          console.log("üìç Frontend - Location selected:", locationValue); // Debug log
          console.log("üìç Frontend - Location select element value:", locationSelect.value); // Debug log chi ti·∫øt

          const semester = {
            dot: dotValue,
            ki: kiValue,
            nam: namValue,
          };

          // T·∫°o input file
          const fileInput = document.createElement("input");
          fileInput.type = "file";
          fileInput.accept = ".xlsx, .xls"; // Lo·∫°i file cho ph√©p

          // ƒê·ª£i file ƒë∆∞·ª£c ch·ªçn
          const selectedFile = await new Promise((resolve) => {
            fileInput.addEventListener("change", function () {
              resolve(fileInput.files[0]);
            });
            fileInput.click(); // M·ªü h·ªôp tho·∫°i ch·ªçn file
          });

          if (!selectedFile) {
            console.error("Ch∆∞a ch·ªçn file.");
            return;
          }

          // T·∫°o FormData
          const formData = new FormData();
          formData.append("file", selectedFile); // T√™n param "file"
          formData.append("semester", JSON.stringify(semester)); // Th√™m param "semester"
          formData.append("location", locationValue); // Th√™m param "location"
          
          console.log("üìç FormData - Location ƒë∆∞·ª£c append:", locationValue); // Debug log
          console.log("üìç FormData - T·∫•t c·∫£ keys:", Array.from(formData.keys())); // Debug log

          await checkDataExistence(semester, formData, locationValue);
        });

      async function checkDataExistence(semester, formData, location) {
        fetch("/api/check-data-TKB-exist", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify(semester),
        })
          .then((response) => {
            if (!response.ok) {
              throw new Error("Ki·ªÉm tra d·ªØ li·ªáu th·∫•t b·∫°i");
            }
            return response.json();
          })
          .then((data) => {
            if (data.exists) {
              formData.append("lastTTValue", JSON.stringify(data.lastTTValue));
              // Location ƒë√£ ƒë∆∞·ª£c append ·ªü tr√™n, kh√¥ng c·∫ßn append l·∫°i
              // Hi·ªÉn th·ªã modal ƒë·ªÉ x√°c nh·∫≠n x√≥a hay ch√®n
              showModal(semester, formData);
            } else {
              formData.append("lastTTValue", JSON.stringify(data.lastTTValue));
              // Location ƒë√£ ƒë∆∞·ª£c append ·ªü tr√™n, kh√¥ng c·∫ßn append l·∫°i
              // N·∫øu kh√¥ng t·ªìn t·∫°i, tr·ª±c ti·∫øp g·ªçi h√†m importFileTKB
              importFileTKB(semester, formData);
            }
          })
          .catch((error) => {
            alert("Ki·ªÉm tra d·ªØ li·ªáu file quy chu·∫©n th·∫•t b·∫°i!");
            console.error("Error:", error);
          });
      }

      // H√†m hi·ªÉn th·ªã modal v√† x·ª≠ l√Ω s·ª± ki·ªán "X√≥a" v√† "Ch√®n"
      function showModal(semester, formData) {
        const {dot, ki, nam} = semester;
        const modal = document.getElementById("action-modal");
        const message = `ƒê√£ t·ªìn t·∫°i d·ªØ li·ªáu ƒê·ª£t ${dot}, ${ki}, ${nam}. Th·ª±c hi·ªán X√ìA file c≈© hay CH√àN th√™m file m·ªõi?
        L∆∞u √Ω : X√ìA s·∫Ω lo·∫°i b·ªè file c≈© v√† ch√®n th√™m, CH√àN s·∫Ω kh√¥ng lo·∫°i b·ªè file c≈© v√† ch√®n th√™m`;
        document.getElementById("modal-message").innerText = message;
        modal.style.display = "block";

        // X·ª≠ l√Ω s·ª± ki·ªán "X√≥a"
        const deleteButton = document.getElementById("btn-delete");
        deleteButton.onclick = function handleDeleteClick() {
          modal.style.display = "none";
          deleteFile(semester, formData);
        };

        // X·ª≠ l√Ω s·ª± ki·ªán "Ch√®n"
        const appendButton = document.getElementById("btn-append");
        appendButton.onclick = function handleAppendClick() {
          modal.style.display = "none";
          importFileTKB(semester, formData);
        };

        // X·ª≠ l√Ω s·ª± ki·ªán "H·ªßy"
        document.getElementById("btn-cancel").onclick = function () {
          modal.style.display = "none";
        };
      }

      // H√†m g·ª≠i y√™u c·∫ßu x√≥a d·ªØ li·ªáu
      function deleteFile(semester, formData) {
        const { dot, ki, nam } = semester;
        const major = "ALL";

        fetch(`/api/v1/tkb/all?major=${major}&dot=${dot}&ki_hoc=${ki}&nam_hoc=${nam}`, {
          method: "DELETE",
          headers: {
            "Content-Type": "application/json",
          },
        })
          .then((response) => {
            if (!response.ok) {
              throw new Error("X√≥a d·ªØ li·ªáu th·∫•t b·∫°i");
            }
            importFileTKB(semester, formData);
          })
          .catch((error) => {
            Swal.fire({
              title: "Th√¥ng b√°o",
              html: "X√≥a d·ªØ li·ªáu th·∫•t b·∫°i",
              icon: "error",
              confirmButtonText: "OK",
              width: "auto", // T·ª± ƒë·ªông ƒëi·ªÅu ch·ªânh chi·ªÅu r·ªông
              padding: "20px", // Gi·ªØ kho·∫£ng c√°ch cho n·ªôi dung
            });
            console.error("Error:", error);
          });
      }

      async function importFileTKB(semester, formData) {
        try {
          // Hi·ªán loading
          Swal.fire({
            title: "ƒêang x·ª≠ l√Ω...",
            html: "Vui l√≤ng ch·ªù trong gi√¢y l√°t",
            allowOutsideClick: false,
            allowEscapeKey: false,
            didOpen: () => {
              Swal.showLoading();
            },
          });

          const response = await fetch(`/api/v1/tkb/import`, {
            method: "POST",
            body: formData,
          });

          const contentType = response.headers.get("content-type");
          const data = contentType.includes("application/json")
            ? await response.json()
            : { success: false, message: await response.text() };

          Swal.close(); // ƒë√≥ng loading tr∆∞·ªõc khi show th√¥ng b√°o

          if (!response.ok || !data.success) {
            throw new Error(data.message || "L·ªói x·ª≠ l√Ω file");
          }

          // ‚úÖ Sau khi import th√†nh c√¥ng, c·∫≠p nh·∫≠t tr·∫°ng th√°i nƒÉm h·ªçc
          await updateYearStatus(semester);

          Swal.fire({
            title: "Th√¥ng b√°o",
            html: data.message,
            icon: "success",
            confirmButtonText: "OK",
            width: "auto",
            padding: "20px",
          });

        } catch (error) {
          console.error("L·ªói khi t·∫£i file:", error.message);
          Swal.fire({
            title: "L·ªói",
            html: error.message,
            icon: "error",
            confirmButtonText: "OK",
          });
        }
      }

      // ‚úÖ H√†m c·∫≠p nh·∫≠t tr·∫°ng th√°i nƒÉm h·ªçc (t∆∞∆°ng t·ª± ban h√†nh)
      async function updateYearStatus(semester) {
        try {
          const response = await fetch(`/update/${semester.nam}/${semester.ki}/${semester.dot}`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            }
          });

          if (!response.ok) {
            console.error("‚ùå L·ªói c·∫≠p nh·∫≠t tr·∫°ng th√°i nƒÉm h·ªçc");
          } else {
            console.log("‚úÖ ƒê√£ c·∫≠p nh·∫≠t tr·∫°ng th√°i nƒÉm h·ªçc th√†nh c√¥ng");
          }
        } catch (error) {
          console.error("‚ùå L·ªói k·∫øt n·ªëi khi c·∫≠p nh·∫≠t tr·∫°ng th√°i:", error);
        }
      }

      // H√†m t·∫°o b·∫£ng t·ª´ d·ªØ li·ªáu JSON
      function createTable(data) {
        let tableHtml = '<table class="table table-bordered"><thead><tr>';

        // L·∫•y ti√™u ƒë·ªÅ t·ª´ JSON (b·ªè qua c·ªôt "Ghi ch√∫")
        const headers = Object.keys(data[0]).filter((key) => key !== "Ghi ch√∫");
        headers.forEach((header) => {
          tableHtml += `<th>${header}</th>`;
        });
        tableHtml += "</tr></thead><tbody>";

        // Duy·ªát qua t·ª´ng m·ª•c trong d·ªØ li·ªáu
        data.forEach((item) => {
          tableHtml += "<tr>";
          headers.forEach((key) => {
            tableHtml += `<td>${item[key] !== null ? item[key] : ""}</td>`;
          });
          tableHtml += "</tr>";
        });
        tableHtml += "</tbody></table>";

        // Ch√®n b·∫£ng v√†o div v·ªõi id="dataTableContainer"
        document.getElementById("dataTableContainer").innerHTML = tableHtml;
      }
    </script>

    <script>
      document
        .getElementById("changePasswordLink")
        .addEventListener("click", function (event) {
          event.preventDefault(); // NgƒÉn ch·∫∑n h√†nh vi m·∫∑c ƒë·ªãnh c·ªßa th·∫ª a
          const tenDangNhap = localStorage.getItem("TenDangNhap"); // L·∫•y TenDangNhap t·ª´ localStorage

          if (tenDangNhap) {
            // Chuy·ªÉn h∆∞·ªõng ƒë·∫øn trang changePassword v√† truy·ªÅn TenDangNhap trong URL
            window.location.href = `/changePassword?tenDangNhap=${encodeURIComponent(
              tenDangNhap
            )}`;
          } else {
            alert("Kh√¥ng t√¨m th·∫•y TenDangNhap trong localStorage.");
          }
        });
    </script>
    <script>
      $(document).ready(function () {
        $('#NamHoc option[value=""]').remove();
        $('#comboboxki option[value=""]').remove();
        $('#combobox-dot option[value=""]').remove();

        // T√≠nh to√°n nƒÉm h·ªçc hi·ªán t·∫°i theo ƒë·ªãnh d·∫°ng Vi·ªát Nam
        const currentYear = new Date().getFullYear();
        const currentAcademicYear = `${currentYear} - ${currentYear + 1}`;

        $.ajax({
          url: "/getNamHoc",
          method: "GET",
          success: function (response) {
            if (response.success) {
              response.NamHoc.forEach(function (item) {
                console.log(item.NamHoc);
                $("#NamHoc").append(
                  `<option value="${item.NamHoc}">${item.NamHoc}</option>`
                );
              });

              // ‚úÖ T·ª± ƒë·ªông ch·ªçn nƒÉm h·ªçc ƒëang ho·∫°t ƒë·ªông (trangthai = 1 - hi·ªÉn th·ªã ƒë·∫ßu ti√™n)
              if (response.NamHoc.length > 0) {
                $("#NamHoc").val(response.NamHoc[0].NamHoc);
              }
              
              // Fallback: N·∫øu kh√¥ng c√≥ nƒÉm n√†o, th·ª≠ ch·ªçn nƒÉm hi·ªán t·∫°i
              if (!$("#NamHoc").val() && $("#NamHoc option[value='" + currentAcademicYear + "']").length > 0) {
                $("#NamHoc").val(currentAcademicYear);
              }

              response.Ki.forEach(function (item) {
                console.log(item.Ki);
                $("#comboboxki").append(
                  `<option value="${item.value}">${item.Ki}</option>`
                );
              });
              response.Dot.forEach(function (item) {
                console.log(item.Dot);
                $("#combobox-dot").append(
                  `<option value="${item.value}">${item.Dot}</option>`
                );
              });
            } else {
              console.error(
                "Kh√¥ng l·∫•y ƒë∆∞·ª£c d·ªØ li·ªáu nƒÉm h·ªçc:",
                response.message
              );
            }
          },
          error: function (error) {
            console.error("L·ªói khi l·∫•y d·ªØ li·ªáu nƒÉm h·ªçc:", error);
          },
        });
      });
    </script>
    <script>
      $(document).ready(function () {
        $('#MaPhongBan option[value=""]').remove();
        // G·ªçi AJAX ƒë·ªÉ l·∫•y d·ªØ li·ªáu JSON t·ª´ API
        $.ajax({
          url: "/getPhongBan", // ƒê∆∞·ªùng d·∫´n t·ªõi API getPhongBan
          method: "GET",
          success: function (response) {
            // Ki·ªÉm tra n·∫øu response th√†nh c√¥ng
            const MaPhongBan = response.MaPhongBan;
            if (response.success) {
              // $('#MaPhongBan').prepend('<option value="ALL">T·∫•t c·∫£ khoa</option>');
              // L·∫∑p qua t·ª´ng m·ª•c trong m·∫£ng MaPhongBan
              response.MaPhongBan.forEach(function (item) {
                // N·∫øu item.MaPhongBan b·∫±ng boMon.MaPhongBan, hi·ªÉn th·ªã tr∆∞·ªõc
                console.log(item);
                $("#MaPhongBan").append(
                  `<option value="${item.MaPhongBan}">${item.MaPhongBan}</option>`
                );
              });

              // N·∫øu kh√¥ng c√≥ ph√≤ng ban n√†o t∆∞∆°ng ·ª©ng, b·∫°n c√≥ th·ªÉ th√™m t√πy ch·ªçn m·∫∑c ƒë·ªãnh ·ªü ƒë√¢y
              if (!$("#MaPhongBan option:selected").length) {
                $("#MaPhongBan").prepend(
                  '<option value="">Ch·ªçn Ph√≤ng Ban</option>'
                );
              }
            } else {
              console.error(
                "Kh√¥ng l·∫•y ƒë∆∞·ª£c d·ªØ li·ªáu phongBan:",
                response.message
              );
            }
          },
          error: function (error) {
            console.error("L·ªói khi l·∫•y d·ªØ li·ªáu phongBan:", error);
          },
        });
      });
    </script>
    <script>
      document
        .getElementById("infome")
        .addEventListener("click", function (event) {
          event.preventDefault(); // NgƒÉn ch·∫∑n h√†nh vi m·∫∑c ƒë·ªãnh c·ªßa th·∫ª a
          const id_User = localStorage.getItem("id_User"); // L·∫•y id_User t·ª´ localStorage\
          if (id_User) {
            // Chuy·ªÉn h∆∞·ªõng ƒë·∫øn trang infome v√† truy·ªÅn id_User trong URL
            window.location.href = `/infome/${id_User}`;
          } else {
            alert("Kh√¥ng t√¨m th·∫•y id_User trong localStorage.");
          }
        });
    </script>
    <script>
      document
        .getElementById("changeMessage")
        .addEventListener("click", function (event) {
          event.preventDefault(); // NgƒÉn ch·∫∑n h√†nh vi m·∫∑c ƒë·ªãnh c·ªßa th·∫ª a
          const MaPhongBan = localStorage.getItem("MaPhongBan"); // L·∫•y MaPhongBan t·ª´ localStorage

          if (MaPhongBan) {
            // Chuy·ªÉn h∆∞·ªõng ƒë·∫øn trang changeMessage v√† truy·ªÅn MaPhongBan trong URL
            window.location.href = `/changeMessage/${MaPhongBan}`;
          } else {
            alert("Kh√¥ng t√¨m th·∫•y MaPhongBan trong localStorage.");
          }
        });
    </script>
  </body>
</html>
