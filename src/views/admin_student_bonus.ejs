<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <title>Học Viện Kỹ Thuật Mật Mã</title>
    <link
      rel="stylesheet"
      href="https://code.jquery.com/ui/1.13.2/themes/base/jquery-ui.css"
    />
    <link rel="stylesheet" href="/css/admin.css" />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css"
    />
    <link rel="stylesheet" href="/css/styles.css" />
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

  </head>
  <body>
    <%- include('adminHeader') %>

    <div class="container mt-4">
      <h3>Hệ số lớp đông</h3>
      <div id="myGrid" class="ag-theme-alpine" style="height: 400px; width: 600px;"></div>
      <div class="mb-3 d-flex gap-2">
      <button id="btnAdd" class="btn btn-primary">
          <i class="bi bi-plus-circle"></i> Thêm dòng
      </button>
    </div>

    </div>

    <!-- AG Grid Styles -->
    <link
      rel="stylesheet"
      href="https://unpkg.com/ag-grid-community/styles/ag-grid.css"
    />
    <link
      rel="stylesheet"
      href="https://unpkg.com/ag-grid-community/styles/ag-theme-alpine.css"
    />

    <!-- AG Grid Script -->
    <!-- <script src="https://unpkg.com/ag-grid-community@29.3.2/dist/ag-grid-community.min.js"></script> -->

    <script src="/js/TKB/ag-grid-community.min.js"></script>

    <!-- jQuery và jQuery UI -->
    <script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
    <script src="https://code.jquery.com/ui/1.13.2/jquery-ui.min.js"></script>

    <!-- Link script Sweet alert 2 -->
    <!-- SweetAlert2 CSS -->
    <link
      href="https://cdn.jsdelivr.net/npm/sweetalert2@11.6.16/dist/sweetalert2.min.css"
      rel="stylesheet"
    />

    <!-- SweetAlert2 JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.6.16/dist/sweetalert2.all.min.js"></script>

    <!-- Toastify  -->
    <script src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css"
    />

<script>
    let gridOptions; 

    document.addEventListener('DOMContentLoaded', () => {
        loadData();
    });

    // --- 1. LẤY DỮ LIỆU ---
    async function loadData() {
        try {
            const response = await fetch('/api/v1/admin/he-so-lop-dong-data');
            if (!response.ok) throw new Error("Lỗi kết nối");
            const json = await response.json();
            if (!json.success) throw new Error(json.message);

            renderTable(json.data);
        } catch (error) {
            console.error(error);
            Swal.fire({ icon: 'error', text: "Không thể tải dữ liệu" });
        }
    }

    // --- 2. HIỂN THỊ BẢNG ---
    function renderTable(renderData) {
        // 1. Sắp xếp giảm dần (Lớn nhất nằm trên cùng)
        renderData.sort((a, b) => b.student_quantity - a.student_quantity);

        // --- XỬ LÝ DỮ LIỆU RỖNG KHI LOAD LẦN ĐẦU ---
        // Nếu DB trả về ít hơn 2 dòng, ta phải tạo giả lập để đảm bảo logic không vỡ
        // (Lưu ý: Tốt nhất backend nên seed data sẵn 2 dòng này)
        if (renderData.length < 2) {
             console.warn("Dữ liệu ít hơn 2 dòng, logic có thể hiển thị chưa đẹp mắt.");
             // Bạn có thể gọi API tạo tự động 2 dòng mặc định ở đây nếu muốn
        }

        const columnDefs = [
            { 
                headerName: 'Từ số sinh viên (Min)',
                field: 'student_quantity',
                
                // 1. CHẶN KHÔNG CHO SỬA DÒNG CUỐI (Vì nó luôn bắt đầu từ 0)
                editable: params => {
                    const rowIndex = params.node.rowIndex;
                    const rowCount = params.api.getDisplayedRowCount();
                    // Nếu là dòng cuối cùng -> Không cho sửa
                    return rowIndex !== rowCount - 1;
                },
                
                cellEditor: 'agNumberCellEditor',
                
                // --- LOGIC VALIDATE (Giữ nguyên, chỉ chạy cho các dòng trên) ---
                valueSetter: params => {
                    const newValue = Number(params.newValue);
                    if (isNaN(newValue) || newValue < 0) return false;

                    const rowIndex = params.node.rowIndex;
                    const rowCount = params.api.getDisplayedRowCount();
                    
                    // Logic kiểm tra dòng trên/dưới giữ nguyên...
                    // ... (Code validation cũ của bạn) ...
                    
                    if (rowIndex < rowCount - 1) {
                         const nextNode = params.api.getDisplayedRowAtIndex(rowIndex + 1);
                         if (nextNode) {
                             const lowerNeighbor = Number(nextNode.data.student_quantity);
                             if (newValue <= lowerNeighbor) {
                                 Swal.fire('Lỗi', `Phải lớn hơn ${lowerNeighbor}`, 'error');
                                 return false;
                             }
                         }
                    }
                    if (rowIndex > 0) {
                         const prevNode = params.api.getDisplayedRowAtIndex(rowIndex - 1);
                         if (prevNode) {
                             const upperNeighbor = Number(prevNode.data.student_quantity);
                             if (newValue >= upperNeighbor) {
                                 Swal.fire('Lỗi', `Phải nhỏ hơn ${upperNeighbor}`, 'error');
                                 return false;
                             }
                         }
                    }

                    params.data.student_quantity = newValue;
                    return true;
                },

                // --- 2. LOGIC HIỂN THỊ MỚI (QUAN TRỌNG) ---
                valueFormatter: params => {
                    const rowIndex = params.node.rowIndex;
                    const rowCount = params.api.getDisplayedRowCount();
                    const currentMin = params.data.student_quantity;

                    // TRƯỜNG HỢP 1: DÒNG ĐẦU TIÊN (TOP) -> N đến vô cùng
                    if (rowIndex === 0) {
                        return `${currentMin} - vô cùng`;
                    }

                    // TRƯỜNG HỢP 2: DÒNG CUỐI CÙNG (BOTTOM) -> Luôn là 0 - N
                    if (rowIndex === rowCount - 1) {
                        // Lấy dòng bên trên nó
                        const prevNode = params.api.getDisplayedRowAtIndex(rowIndex - 1);
                        if (prevNode && prevNode.data) {
                            // Max của dòng cuối = (Min dòng trên) - 1
                            const maxOfLast = Number(prevNode.data.student_quantity) - 1;
                            // ÉP CỨNG SỐ 0 Ở ĐẦU
                            return `0 - ${maxOfLast}`;
                        }
                        return `0 - 0`;
                    }

                    // TRƯỜNG HỢP 3: CÁC DÒNG Ở GIỮA -> Min - Max
                    const prevNode = params.api.getDisplayedRowAtIndex(rowIndex - 1);
                    if (prevNode && prevNode.data) {
                        const max = Number(prevNode.data.student_quantity) - 1;
                        return `${currentMin} - ${max}`;
                    }
                    
                    return `${currentMin} - ?`;
                }
            },
            // ... các cột khác ...
            { 
                headerName: 'Hệ số lớp đông',
                field: 'student_bonus',
                editable: true
            },
            {
                headerName: 'Hành động',
                field: 'actions',
                width: 120,
                cellRenderer: params => `
                    <button class="btn btn-danger btn-sm delete-row">
                        <i class="bi bi-trash"></i>
                    </button>
                `
            }
        ];

        gridOptions = {
            columnDefs,
            rowData: renderData,
            defaultColDef: { resizable: true, sortable: true, flex: 1 },
            rowHeight: 50,
            singleClickEdit: true,
            onCellValueChanged: function(params) {
                // Refresh để vẽ lại số Max của dòng dưới ngay khi dòng trên thay đổi
                params.api.refreshCells({ force: true });
                if (params.oldValue === params.newValue) return;
                saveRowToDatabase(params);
            }
        };

        const eGridDiv = document.getElementById('myGrid');
        new agGrid.Grid(eGridDiv, gridOptions);
    }
    
    // --- 3. SỬA LẠI HÀM LƯU (Tránh lặp vô hạn) ---
    function saveRowToDatabase(params) {
        const recordId = params.data.id;
        const fieldName = params.colDef.field;
        const newValue = params.newValue;
        const oldValue = params.oldValue;

        fetch('/api/v1/admin/bonus-time-row', {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ id: recordId, field: fieldName, value: newValue })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                Toastify({
                    text: "Cập nhật thành công!",
                    duration: 1000, // Hiển thị trong 3 giây
                    gravity: "top", // Đưa thông báo lên trên
                    position: "right", // Căn lề bên phải
                    backgroundColor: "#4CAF50", // Màu xanh lá (thành công)
                }).showToast();
            } else {
                throw new Error(data.message || "Lỗi Server");
            }
        })
        .catch(error => {
            console.error('Lỗi lưu data:', error);
            Swal.fire('Lỗi!', 'Không thể lưu. Dữ liệu sẽ hoàn tác.', 'error');

            // [QUAN TRỌNG] Cách hoàn tác không gây lặp vô hạn:
            // 1. Gán trực tiếp vào data gốc (không qua setDataValue)
            params.data[fieldName] = oldValue;
            // 2. Yêu cầu vẽ lại ô đó
            params.api.refreshCells({ force: true });
        });
    }

    // --- 4. SỬA LẠI NÚT THÊM (Đồng bộ DB) ---
    document.getElementById('btnAdd').addEventListener('click', () => {
        const topNode = gridOptions.api.getDisplayedRowAtIndex(0);
        let newMin = 0;

        // VÍ DỤ: Dòng đầu đang là 10.
        // Muốn thêm dòng mới là 21. => newMin = 10 + 11.
        if (topNode) {
            const currentTopMin = Number(topNode.data.student_quantity);
            newMin = currentTopMin + 11; 
        } else {
            // Trường hợp database rỗng (nên tránh để xảy ra)
            newMin = 10; 
        }

        const newRowData = {
            student_quantity: newMin, 
            student_bonus: 0
        };

        fetch('/api/v1/admin/bonus-time-row', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(newRowData)
        })
        .then(res => res.json())
        .then(data => {
            if(data.success) {
                newRowData.id = data.new_id;
                // Thêm vào đầu bảng (index 0)
                gridOptions.api.applyTransaction({ add: [newRowData], addIndex: 0 });
                // Refresh để dòng cũ (đang là vô cùng) cập nhật lại thành số cụ thể
                gridOptions.api.refreshCells({ force: true });
                
                Toastify({ text: "Thêm thành công", backgroundColor: "green" }).showToast();
            } else {
                Swal.fire('Lỗi', data.message, 'error');
            }
        });
    });

    // --- 5. SỬA LẠI NÚT XÓA (Đồng bộ DB) ---
    document.addEventListener('click', function (e) {
            const btn = e.target.closest('.delete-row');
            if (!btn) return;

            // --- KIỂM TRA SỐ LƯỢNG DÒNG ---
            const rowCount = gridOptions.api.getDisplayedRowCount();
            
            // YÊU CẦU: Phải luôn có >= 2 dòng. Nếu đang có 2 dòng thì không cho xóa nữa.
            if (rowCount <= 2) {
                Swal.fire({
                    icon: 'warning',
                    title: 'Không thể xóa',
                    text: 'Hệ thống yêu cầu tối thiểu 2 mức cấu hình!',
                    confirmButtonText: 'Đã hiểu'
                });
                return;
            }
            // -------------------------------

            const rowElement = btn.closest('.ag-row');
            const rowIndex = rowElement.getAttribute('row-index');
            const rowNode = gridOptions.api.getDisplayedRowAtIndex(Number(rowIndex));

            if (!rowNode) return;

            Swal.fire({
                icon: 'warning',
                text: 'Bạn có chắc muốn xóa dòng này?',
                showCancelButton: true,
                confirmButtonText: 'Xóa',
                cancelButtonText: 'Hủy'
            }).then(result => {
                if (result.isConfirmed) {
                    const idToDelete = rowNode.data.id;
                    fetch(`/api/v1/admin/bonus-time-row/${idToDelete}`, { method: 'DELETE' })
                    .then(res => res.json())
                    .then(data => {
                        if(data.success) {
                            gridOptions.api.applyTransaction({ remove: [rowNode.data] });
                            // Refresh để dòng liền kề cập nhật lại hiển thị Max/Vô cùng
                            gridOptions.api.refreshCells({ force: true });

                            Toastify({
                                text: "Xóa thành công!",
                                duration: 1000,
                                gravity: "top",
                                position: "right",
                                backgroundColor: "#4CAF50",
                            }).showToast();
                        } else {
                            swal.fire('Lỗi', data.message, 'error');
                        }
                    })
                    .catch(error => {
                        console.error('Lỗi xóa:', error);
                        Swal.fire('Lỗi', 'Không thể xóa dòng này.', 'error');
                    });
                }
            });
        });

</script>
</body>
</html>
