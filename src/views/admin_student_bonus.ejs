<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <title>Hệ số lớp đông</title>
    <link
      rel="stylesheet"
      href="https://code.jquery.com/ui/1.13.2/themes/base/jquery-ui.css"
    />
    <link rel="stylesheet" href="/css/admin.css" />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css"
    />
    <link rel="stylesheet" href="/css/styles.css" />
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

  </head>
  <body>
    <%- include('adminHeader') %>

    <div class="container mt-4">
      <h3>Hệ số lớp đông</h3>
      <div id="myGrid" class="ag-theme-alpine" style="height: 400px; width: 600px;"></div>
      <div class="mb-3 d-flex gap-2">
      <button id="btnAdd" class="btn btn-primary">
          <i class="bi bi-plus-circle"></i> Thêm dòng
      </button>
    </div>

    </div>

    <!-- AG Grid Styles -->
    <link
      rel="stylesheet"
      href="https://unpkg.com/ag-grid-community/styles/ag-grid.css"
    />
    <link
      rel="stylesheet"
      href="https://unpkg.com/ag-grid-community/styles/ag-theme-alpine.css"
    />

    <!-- AG Grid Script -->
    <!-- <script src="https://unpkg.com/ag-grid-community@29.3.2/dist/ag-grid-community.min.js"></script> -->

    <script src="/js/TKB/ag-grid-community.min.js"></script>

    <!-- jQuery và jQuery UI -->
    <script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
    <script src="https://code.jquery.com/ui/1.13.2/jquery-ui.min.js"></script>

    <!-- Link script Sweet alert 2 -->
    <!-- SweetAlert2 CSS -->
    <link
      href="https://cdn.jsdelivr.net/npm/sweetalert2@11.6.16/dist/sweetalert2.min.css"
      rel="stylesheet"
    />

    <!-- SweetAlert2 JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.6.16/dist/sweetalert2.all.min.js"></script>

<script>
let gridOptions;  // <<< Quan trọng

document.addEventListener('DOMContentLoaded', () => {
    loadData();
});

// Lấy dữ liệu
async function loadData() {
    try {
        const response = await fetch('/api/v1/admin/he-so-lop-dong-data');
        if (!response.ok) throw new Error("Lỗi khi tải dữ liệu từ server");

        const json = await response.json();
        if (!json.success) throw new Error(json.message || "Lỗi dữ liệu");

        renderTable(json.data);
    } catch (error) {
        console.error("Lỗi khi tải dữ liệu:", error);
        Swal.fire({ icon: 'error', text: "Không thể tải dữ liệu từ server" });
    }
}

// Render AG Grid
function renderTable(renderData) {
const columnDefs = [
    { 
        headerName: 'Số sinh viên',
        field: 'student_to',
        editable: true,
        cellEditor: 'agNumberCellEditor',
        valueFormatter: params => {
            const to = params.data.student_to ?? 0;
            const from = params.data.student_from ?? 0;
            return `${from} - ${to}`;
        }
    },
    { 
        headerName: 'Hệ số lớp đông',
        field: 'student_bonus',
        editable: true
    },
    {
        headerName: 'Hành động',
        field: 'actions',
        width: 120,
        cellRenderer: params => `
            <button class="btn btn-danger btn-sm delete-row">
                <i class="bi bi-trash"></i>
            </button>
        `
    }
];


    gridOptions = {    // <<< GÁN vào biến global
        columnDefs,
        rowData: renderData,
        defaultColDef: { resizable: true, sortable: true, flex: 1 },
        rowHeight: 50,
        singleClickEdit: true,
    };

    const eGridDiv = document.getElementById('myGrid');
    new agGrid.Grid(eGridDiv, gridOptions);
}

// Nút thêm dòng
document.getElementById('btnAdd').addEventListener('click', () => {

    const rowCount = gridOptions.api.getDisplayedRowCount();

    let newFrom = 0;
    let newTo = 0;

    if (rowCount > 0) {
        const top = gridOptions.api.getDisplayedRowAtIndex(0).data;
        const curFrom = Number(top.student_from);
        const curTo = Number(top.student_to);

        newFrom = curTo + 1;
        newTo = curTo + 10;

    } else {
        newFrom = 0;
        newTo = 10;
    }

    const newRow = {
        student_from: newFrom,
        student_to: newTo,
        student_bonus: 0
    };

    gridOptions.api.applyTransaction({ add: [newRow], addIndex: 0 });
});




// Nút xóa từng dòng
document.addEventListener('click', function (e) {
    if (e.target.closest('.delete-row')) {

        const rowElement = e.target.closest('.ag-row');
        const rowIndex = rowElement.getAttribute('row-id');

        const rowNode = gridOptions.api.getDisplayedRowAtIndex(rowIndex);

        Swal.fire({
            icon: 'warning',
            text: 'Bạn có chắc muốn xóa dòng này?',
            showCancelButton: true,
            confirmButtonText: 'Xóa',
            cancelButtonText: 'Hủy'
        }).then(result => {
            if (result.isConfirmed) {
                gridOptions.api.applyTransaction({ remove: [rowNode.data] });
            }
        });
    }
});
</script>



</body>
</html>
