<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>H·ªçc Vi·ªán K·ªπ Thu·∫≠t M·∫≠t M√£</title>
  <link rel="stylesheet" href="/css/table.css" />
  <link rel="stylesheet" href="/css/teachingInfo.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" />
  <link rel="stylesheet" href="/css/styles.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css" />
  <style>
    /* .suggestions {
      position: absolute;
      background-color: white;
      border: 1px solid #ccc;
      border-radius: 4px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      z-index: 1000;
      max-height: 200px;
      overflow-y: auto;
    }

    .suggestion-item {
      padding: 10px;
      cursor: pointer;
    }

    .suggestion-item:hover {
      background-color: #f0f0f0;
    } */

    /* ph·∫ßn css cho label t·ªïng s·ªë ti·∫øt  ki*/
    .search {
      /* C√°c style chung cho c√°c √¥ t√¨m ki·∫øm */
      width: 200px;
      /* Ho·∫∑c b·∫•t k·ª≥ chi·ªÅu r·ªông n√†o b·∫°n mu·ªën */
      padding: 8px;
      /* Padding cho √¥ input */
      border: 1px solid #ccc;
      /* ƒê∆∞·ªùng vi·ªÅn cho √¥ input */
      border-radius: 4px;
      /* Bo g√≥c cho √¥ input */
      font-size: 14px;
      /* K√≠ch th∆∞·ªõc ch·ªØ */
      height: 50px;
    }

    .total-label {
      margin-left: auto;
      /* CƒÉn ph·∫£i cho th·∫ª total-label */
      margin-right: 0;
      font-family: Arial, sans-serif;
      font-size: 16px;
      background-color: #f4f4f4;
      padding: 10px;
      border-radius: 8px;
      width: fit-content;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      display: block;
      /* ƒê·∫£m b·∫£o th·∫ª div l√† kh·ªëi ƒë·ªÉ cƒÉn ph·∫£i ho·∫°t ƒë·ªông */
    }

    .total-label label {
      font-weight: bold;
      /* Gi·ªØ ch·ªØ in ƒë·∫≠m */
      color: #000;
      /* M√†u ch·ªØ ƒëen */
      margin-right: 8px;
      /* Th√™m kho·∫£ng c√°ch b√™n ph·∫£i */
      cursor: pointer;
      /* T·∫°o hi·ªáu ·ª©ng chuy·ªÉn m√†u n·ªÅn v√† m√†u ch·ªØ m·ªÅm m·∫°i */
      padding: 5px 10px;
      /* Th√™m padding cho label ƒë·ªÉ t·∫°o kh√¥ng gian */
      border: 1px solid #ccc;
      /* Khung cho label */
      border-radius: 4px;
      /* Bo g√≥c cho khung */
    }

    .total-label label:hover,
    .total-label label:hover span {
      background-color: #007BFF;
      /* M√†u n·ªÅn khi hover */
      color: #fff;
      /* M√†u ch·ªØ tr·∫Øng khi hover */
    }

    .total-label span {
      font-weight: bold;
      /* Gi·ªØ ch·ªØ trong span c≈©ng in ƒë·∫≠m */
      color: #333;
      /* M√†u ch·ªØ ƒë·∫≠m cho gi√° tr·ªã */
    }

    .suggestions {
      position: absolute;
      /* ƒê·∫£m b·∫£o g·ª£i √Ω n·∫±m b√™n tr√™n c√°c th√†nh ph·∫ßn kh√°c */
      top: calc(100% + 5px);
      /* ƒê·∫∑t g·ª£i √Ω ph√≠a tr√™n input v·ªõi m·ªôt kho·∫£ng c√°ch */
      left: 0;
      font-size: 12px;
      background-color: #f0f0f0;
      color: #000;
      border: 1px solid #ccc;
      box-shadow: 0px 4px 8px rgba(0, 0, 0, 0.1);
      z-index: 1000;
      /* ƒê·∫£m b·∫£o g·ª£i √Ω n·∫±m tr√™n c√°c th√†nh ph·∫ßn kh√°c */
      border-radius: 4px;
      max-height: 300px;
      overflow-y: auto;
    }

    /* Hi·ªáu ·ª©ng lung linh khi hover */
    .suggestions:hover {
      background-color: #e0e0e0;
      /* Thay ƒë·ªïi m√†u n·ªÅn khi hover */
      box-shadow: 0px 8px 16px rgba(0, 0, 0, 0.2);
      /* TƒÉng ƒë·ªô b√≥ng khi hover */
    }


    /* CSS cho t·ª´ng m·ª•c g·ª£i √Ω */
    .suggestion-item {
      padding: 8px 12px;
      /* Kho·∫£ng c√°ch b√™n trong t·ª´ng m·ª•c */
      cursor: pointer;
      /* Con tr·ªè chu·ªôt thay ƒë·ªïi khi hover */
      transition: background-color 0.2s ease;
      /* T·∫°o hi·ªáu ·ª©ng chuy·ªÉn ƒë·ªïi m∆∞·ª£t m√† khi hover */
    }

    /* Hi·ªáu ·ª©ng khi ng∆∞·ªùi d√πng di chu·ªôt v√†o m·ª•c g·ª£i √Ω */
    .suggestion-item:hover {
      background-color: #f0f0f0;
      /* M√†u n·ªÅn khi hover */
    }

    /* ƒê·∫∑t l·∫°i m·ªôt s·ªë thu·ªôc t√≠nh khi input m·∫•t focus */
    input:focus+.suggestions {
      display: block;
      /* ƒê·∫£m b·∫£o khung hi·ªÉn th·ªã khi input ƒë∆∞·ª£c focus */
    }

    /* ƒê·∫£m b·∫£o container g·ª£i √Ω kh√¥ng b·ªã tr√†n ra ngo√†i khung n·∫øu c√≥ */
    .suggestions {
      overflow: hidden;
    }

    /* ph·∫ßn css cho label t·ªïng s·ªë ti·∫øt  ki*/
    .total-label {
      margin-left: auto;
      /* CƒÉn ph·∫£i cho th·∫ª total-label */
      margin-right: 0;
      font-family: Arial, sans-serif;
      font-size: 16px;
      background-color: #f4f4f4;
      padding: 10px;
      border-radius: 8px;
      width: fit-content;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      display: block;
      /* ƒê·∫£m b·∫£o th·∫ª div l√† kh·ªëi ƒë·ªÉ cƒÉn ph·∫£i ho·∫°t ƒë·ªông */
    }

    .total-label label {
      font-weight: bold;
      /* Gi·ªØ ch·ªØ in ƒë·∫≠m */
      color: #000;
      /* M√†u ch·ªØ ƒëen */
      margin-right: 8px;
      /* Th√™m kho·∫£ng c√°ch b√™n ph·∫£i */
      cursor: pointer;
      /* T·∫°o hi·ªáu ·ª©ng chuy·ªÉn m√†u n·ªÅn v√† m√†u ch·ªØ m·ªÅm m·∫°i */
      padding: 5px 10px;
      /* Th√™m padding cho label ƒë·ªÉ t·∫°o kh√¥ng gian */
      border: 1px solid #ccc;
      /* Khung cho label */
      border-radius: 4px;
      /* Bo g√≥c cho khung */
    }

    .total-label label,
    .total-label label span {
      background-color: #007BFF;
      /* M√†u n·ªÅn khi hover */
      color: #fff;
      /* M√†u ch·ªØ tr·∫Øng khi hover */
    }

    .total-label span {
      font-weight: bold;
      /* Gi·ªØ ch·ªØ trong span c≈©ng in ƒë·∫≠m */
      color: #333;
      /* M√†u ch·ªØ ƒë·∫≠m cho gi√° tr·ªã */
    }

    .btn {
      margin-bottom: 20px;
    }
  </style>
  <style>
    /* T√πy ch·ªânh danh s√°ch g·ª£i √Ω */
    .ui-autocomplete {
      background: white;
      border: 1px solid #ccc;
      max-height: 200px;
      overflow-y: auto;
      box-shadow: 0px 4px 6px rgba(0, 0, 0, 0.1);
      font-size: 14px;
      padding: 5px;
      width: 200px ; /* Gi·∫£m ƒë·ªô r·ªông */
      font-size: 12px !important;
  }
  
  
    /* Hi·ªÉn th·ªã ƒë·∫πp h∆°n, kh√¥ng c·∫ßn hover */
    .ui-menu-item {
        padding: 8px;
        cursor: default;
    }
  </style>
    <style>
    .summary-container {
      font-size: 12px;
      position: fixed;
      bottom: 20px;
      right: 10px; /* gi·∫£m kho·∫£ng c√°ch b√™n ph·∫£i */
      z-index: 1050;
      display: flex;
      align-items: flex-end;
    }

    .floating-box {
      width: 200px;
      background-color: white;
      border: 1px solid #ddd;
      border-radius: 12px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
      padding: 15px;
      display: none;
      transition: all 0.3s ease;
    }

    .detail-popup {
      position: absolute;
      bottom: 60px;
      right: 0;
      width: 100%;
      max-height: 200px;
      overflow-y: auto;
      background-color: #f8f9fa;
      border: 1px solid #ccc;
      border-radius: 8px;
      padding: 10px;
      display: none;
    }

    .toggle-btn {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background-color: #0d6efd;
      color: white;
      border: none;
      font-size: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-left: 8px;
      cursor: pointer;
    }

    .toggle-btn svg {
      width: 20px;
      height: 20px;
      transition: transform 0.3s ease;
    }

    .detail-item {
      font-size: 12px;
      margin-bottom: 4px;
    }

    .xem-chi-tiet {
      font-style: italic;
      text-decoration: underline;
      font-size: 12px;
      color: #007bff;
      cursor: pointer;
      margin-top: 6px;
      display: inline-block;
    }
  </style>
</head>

<body>
  <!-- Ph·∫ßn header -->
  <%- include('header') %>

    <!-- Ph·∫ßn n·ªôi dung -->

    <div class="container-fluid box m-4">
      <div class="">
        <div class="d-flex justify-content-between">
          <div class="d-flex align-items-end">
            <select class="form-select w-100px mx-1 selectop custom-select" id="combobox-dot">
              <option value="">ƒê·ª£t</option>
            </select>

            <!-- Combo box ƒê·ª£t -->
            <select class="form-select w-100px mx-1 selectop custom-select" id="comboboxki">
              <option value="">K√¨</option>
            </select>

            <!-- Combo box NƒÉm -->
            <select class="form-select mx-1 selectop custom-select" id="NamHoc" style="width: 150px;">
              <option value="">NƒÉm h·ªçc</option>
            </select>

            <button id="infoGvm" class="btn text-nowrap mx-2" style="height: 45px;">Xem d·ªØ li·ªáu</button>
            <button onclick="submitData()" class="btn mx-2" id="update-qc" style="display: none; height: 45px;">
              C·∫≠p nh·∫≠t
            </button>
            <!-- <button onclick="submitData2()" class="button mx-2" id="update-qc" display="none">C·∫≠p nh·∫≠t</button> -->
            <button onclick="submitData2()" class="btn mx-2" id="save-data-all" style="display: none; height: 45px;">
              L∆∞u d·ªØ li·ªáu h·ª£p ƒë·ªìng
            </button>
          </div>
        </div>

        <div class="d-flex my-3" style="height: 70px">
          <input type="text" id="filterName" placeholder="T√¨m theo t√™n gi·∫£ng vi√™n" class="form-control m-2 search" />
          <input type="text" id="filterClass" placeholder="T√¨m theo t√™n h·ªçc ph·∫ßn" class="form-control m-2 search" />
          <!-- <input type="text" id="filterKhoa" placeholder="T√¨m theo khoa" onclick="showSuggestionsKhoa(this)"
            class="form-control m-2 search" /> -->
          <input type="text" placeholder="T√¨m ki·∫øm theo Khoa" class="filterKhoa form-control m-2 search" id="filterKhoa" />

          <input type="text" id="filterBoMon" placeholder="T√¨m theo t√™n b·ªô m√¥n" class="form-control m-2 search" />
        </div>
        <script>
          // H√†m l·ªçc chung
          function filterTable() {
            const nameInput = document.getElementById("filterName").value.toLowerCase();
            const classInput = document.getElementById("filterClass").value.toLowerCase();
            const departmentInput = document.getElementById("filterKhoa").value.toLowerCase();
            const boMonInput = document.getElementById("filterBoMon").value.toLowerCase();

            const tableRows = document.querySelectorAll("#tableBody tr");

            tableRows.forEach(row => {
              const nameCell = row.querySelector("td:nth-child(3)"); // T√™n gi·∫£ng vi√™n
              const classCell = row.querySelector("td:nth-child(1)"); // T√™n h·ªçc ph·∫ßn
              const departmentCell = row.querySelector("td:nth-child(6)"); // Khoa
              const boMonCell = row.querySelector("td:nth-child(7)"); // B·ªô m√¥n

              // L·∫•y gi√° tr·ªã t·ª´ c√°c √¥
              const nameValue = nameCell ? nameCell.textContent.toLowerCase() : '';
              const classValue = classCell ? classCell.textContent.toLowerCase() : '';
              const departmentValue = departmentCell ? departmentCell.textContent.toLowerCase() : '';
              const boMonValue = boMonCell ? boMonCell.textContent.toLowerCase() : '';

              // Ki·ªÉm tra ƒëi·ªÅu ki·ªán l·ªçc
              const nameMatch = nameValue.includes(nameInput);
              const classMatch = classValue.includes(classInput);
              const departmentMatch = departmentValue.includes(departmentInput);
              const boMonMatch = boMonValue.includes(boMonInput);

              // Hi·ªán ho·∫∑c ·∫©n h√†ng d·ª±a tr√™n c√°c ƒëi·ªÅu ki·ªán
              if (nameMatch && classMatch && departmentMatch && boMonMatch) {
                row.style.display = ""; // Hi·ªán h√†ng n·∫øu t·∫•t c·∫£ c√°c ƒëi·ªÅu ki·ªán ƒë·ªÅu kh·ªõp
              } else {
                row.style.display = "none"; // ·∫®n h√†ng n·∫øu kh√¥ng kh·ªõp
              }
            });

            calculateTotals(); // C·∫≠p nh·∫≠t t·ªïng s·ªë ti·∫øt
          }

          // G·ªçi h√†m l·ªçc khi c√≥ thay ƒë·ªïi trong c√°c √¥ t√¨m ki·∫øm
          document.getElementById("filterName").addEventListener("input", filterTable);
          document.getElementById("filterClass").addEventListener("input", filterTable);
          document.getElementById("filterKhoa").addEventListener("input", filterTable);
          document.getElementById("filterBoMon").addEventListener("input", filterTable);
        </script>
        <div id="renderInfo" class="fixed-section">
          <table class="text-center" style="width: 100%">
            <thead>
              <tr>
                <th style="width: 200px">H·ªçc ph·∫ßn</th>
                <th style="width: 50px">S·ªë TC</th>
                <th style="width: 200px">GV theo TKB</th>
                <th style="width: 50px">M·ªùi gi·∫£ng?</th>
                <th style="width: 100px">GV gi·∫£ng d·∫°y</th>
                <th style="width: 50px">Khoa</th>
                <th style="width: 100px">B·ªô m√¥n</th>
                <th style="width: 100px">H·ªá ƒë√†o t·∫°o</th>
                <th style="width: 50px">S·ªë ti·∫øt LL</th>
                <th style="width: 50px">S·ªë ti·∫øt QC</th>
                <th style="width: 70px">Ng√†y b·∫Øt ƒë·∫ßu</th>
                <th style="width: 70px">Ng√†y k·∫øt th√∫c</th>
                <th style="width: 50px">Ghi ch√∫</th>
                <th style="width: 50px" id="khoaColumn">
                  <div class="form-check d-flex">
                    <input class="check" type="checkbox" id="checkAllKhoa" onclick="checkAll('khoa')" />
                    <label class="form-check-label" for="checkAllKhoa">Khoa</label>
                  </div>
                </th>
                <th style="width: 50px" id="daoTaoColumn">
                  <div class="form-check d-flex">
                    <input class="check" type="checkbox" id="checkAllDaoTao" onclick="checkAll('daoTao')" />
                    <label class="form-check-label text-nowrap" for="checkAllDaoTao">ƒê√†o T·∫°o</label>
                  </div>
                </th>
                <th style="width: 50px" id="VPColumn">
                  <div class="form-check d-flex">
                    <input class="check" type="checkbox" id="checkAllVP" onclick="checkAll('VP')" />
                    <label class="form-check-label text-nowrap" for="checkAllVP">VƒÉn ph√≤ng</label>
                  </div>
                </th>
              </tr>
            </thead>
            <tbody id="tableBody">
             <!-- D·ªØ li·ªáu s·∫Ω ƒë∆∞·ª£c ch√®n v√†o ƒë√¢y -->
            </tbody>
          </table>
          <!-- Floating Summary Container -->
          <div class="summary-container">
            <div class="floating-box" id="summaryBox">
              <div>
                <strong>T·ªïng ti·∫øt m·ªùi gi·∫£ng:</strong>
                <span id="tietMoi">0</span>
              </div>
              <div>
                <strong>T·ªïng ti·∫øt c∆° h·ªØu:</strong>
                <span id="tietCoHuu">0</span>
              </div>
              <div>
                <strong>T·ªïng s·ªë ti·∫øt:</strong>
                <span id="tongTiet">0</span>
              </div>

              <!-- Link xem chi ti·∫øt -->
              <div>
                <span id="xemChiTiet" class="xem-chi-tiet popup-font-size"
                  >Xem chi ti·∫øt</span
                >
              </div>

              <div class="detail-popup" id="popupChiTiet"></div>
            </div>

            <button class="toggle-btn" id="toggleBtn">
              <!-- M≈©i t√™n SVG -->
              <svg
                id="arrowIcon"
                xmlns="http://www.w3.org/2000/svg"
                fill="none"
                stroke="currentColor"
                stroke-width="3"
                viewBox="0 0 24 24"
              >
                <path d="M15 6l-6 6 6 6" />
              </svg>
            </button>
          </div>
        </div>
        <!-- Label t·ªïng s·ªë ti·∫øt t√°ch ri√™ng v·ªõi b·∫£ng -->
        <div class="total-label">
          <label>T·ªïng s·ªë ti·∫øt L√™n L·ªõp: <span class="value" id="totalLL">0</span></label>
          <label>T·ªïng s·ªë ti·∫øt Quy Chu·∫©n: <span class="value" id="totalQC">0</span></label>
        </div>
      </div>
    </div>
    <!-- Modal form -->
    <div id="modalBackdrop" style="display: none;"></div> <!-- N·ªÅn t·ªëi -->
    <div id="noteForm" style="display: none;">
      <h3>Ghi ch√∫</h3>
      <label for="noteInput">N·ªôi dung:</label>
      <textarea id="noteInput"></textarea> <!-- S·ª≠ d·ª•ng textarea cho ghi ch√∫ d√†i -->
      <br />
      <label for="deadlineInput">H·∫°n:</label>
      <input type="date" id="deadlineInput"
        style="width: 100%; padding: 5px; border: 1px solid #ccc; border-radius: 4px;" />
      <br />
      <div class="d-flex text-nowrap" style="text-align: right;">
        <button onclick="saveNote()">L∆∞u</button>
        <button onclick="doneNote()">Ho√†n Th√†nh</button>
        <button class="cancel" onclick="closeNoteForm()">ƒê√≥ng</button>
      </div>
    </div>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Link script Sweet alert 2 -->
    <!-- SweetAlert2 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/sweetalert2@11.6.16/dist/sweetalert2.min.css" rel="stylesheet">

    <!-- SweetAlert2 JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.6.16/dist/sweetalert2.all.min.js"></script>

    <!-- Th√™m jQuery v√† jQuery UI -->
    <link
      rel="stylesheet"
      href="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css"
    />
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>

    <!-- jQuery UI CSS -->
    <link
      rel="stylesheet"
      href="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css"
    />

    <script>
      document.addEventListener("DOMContentLoaded", function () {
        //const duyet = process.env.DUYET;
        //const thuong = process.end.THUONG;
        const check = localStorage.getItem("check");
        const role = localStorage.getItem("userRole");
        const MaPhongBan = localStorage.getItem("MaPhongBan");

        if ((MaPhongBan == "BGƒê" || MaPhongBan == "DAOTAO") && role == "Duy·ªát") {
          document.getElementById("update-qc").style.display = "inline-block"; // S·ª≠ d·ª•ng 'inline-block' ƒë·ªÉ hi·ªÉn th·ªã n√∫t


        } else if (MaPhongBan == "VP" && role == "Duy·ªát") {
          // ·∫®n c·ªôt 'khoaColumn'
          // document.getElementById("khoaColumn").style.display = "none";

          // Hi·ªÉn th·ªã n√∫t 'C·∫≠p nh·∫≠t'
          document.getElementById("update-qc").style.display = "inline-block"; // S·ª≠ d·ª•ng 'inline-block' ƒë·ªÉ hi·ªÉn th·ªã n√∫t

          document.getElementById("save-data-all").style.display =
            "inline-block"; // S·ª≠ d·ª•ng 'inline-block' ƒë·ªÉ hi·ªÉn th·ªã n√∫t
        }
      });
    </script>

    <script>
      let globalData = []; // Bi·∫øn to√†n c·ª•c ƒë·ªÉ l∆∞u d·ªØ li·ªáu t·ª´ server
      let nameGv = []; // Bi·∫øn to√†n c·ª•c ƒë·ªÉ l∆∞u t·∫•t c·∫£ t√™n gi·∫£ng vi√™n
      let nameGvm = []; // Bi·∫øn to√†n c·ª•c ƒë·ªÉ l∆∞u t√™n gi·∫£ng vi√™n theo khoa
      let rs = [];
      var boMon = [];
      let phongBanList = [];
      let tongTiet;

      //  H√†m kh·ªüi ƒë·ªông ·ª©ng d·ª•ng
      function init() {
        document.getElementById("infoGvm").addEventListener("click", loadData);
      }

      async function loadData() {

        const MaPhongBan = localStorage.getItem("MaPhongBan");

        // L·∫•y d·ªØ li·ªáu b·ªô m√¥n
        try {
          const response = await fetch('/bo-mon', {
            method: 'POST', // Thay ƒë·ªïi th√†nh POST
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({ MaPhongBan }) // G·ª≠i MaPhongBan trong th√¢n y√™u c·∫ßu
          });

          if (!response.ok) {
            throw new Error(`Error: ${response.status} - ${response.statusText}`);
          }

          const data = await response.json(); // Chuy·ªÉn ƒë·ªïi d·ªØ li·ªáu JSON
          boMon = data;

        } catch (error) {
          console.error('C√≥ l·ªói x·∫£y ra khi l·∫•y d·ªØ li·ªáu b·ªô m√¥n:', error);
        }

        try {
          const response = await fetch('/api/get-khoa-list', {
            method: 'GET', // Thay ƒë·ªïi th√†nh POST
          });

          if (!response.ok) {
            throw new Error(`Error: ${response.status} - ${response.statusText}`);
          }

          const data = await response.json(); // Chuy·ªÉn ƒë·ªïi d·ªØ li·ªáu JSON
          phongBanList = data;

        } catch (error) {
          console.error('C√≥ l·ªói x·∫£y ra khi l·∫•y d·ªØ li·ªáu b·ªô m√¥n:', error);
        }

        try {
          // L·∫•y gi√° tr·ªã t·ª´ c√°c combobox
          const dotValue = document.getElementById("combobox-dot").value;
          const kiValue = document.getElementById("comboboxki").value;
          const namValue = document.getElementById("NamHoc").value;

          // T·∫°o ƒë·ªëi t∆∞·ª£ng d·ªØ li·ªáu ƒë·ªÉ g·ª≠i
          const requestData = {
            Dot: dotValue,
            Ki: kiValue,
            Nam: namValue,
          };

          // Fetch t√™n gi·∫£ng vi√™n m·ªùi
          const [gvmResponse, khoaResponse, teachingResponse] =
            await Promise.all([
              fetch("/gv-cohuu"),
              fetch("/gv-moi"),
              fetch("/thong-tin-giang-day", {
                method: "POST", // S·ª≠ d·ª•ng ph∆∞∆°ng th·ª©c POST
                headers: {
                  "Content-Type": "application/json", // ƒê·∫∑t Content-Type l√† application/json
                },
                body: JSON.stringify(requestData), // Chuy·ªÉn ƒë·ªïi ƒë·ªëi t∆∞·ª£ng th√†nh chu·ªói JSON
              }),
            ]);

          if (!teachingResponse.ok) {
            Swal.fire({
              title: 'Th√¥ng b√°o',
              html: "Kh√¥ng t√¨m th·∫•y d·ªØ li·ªáu",
              icon: 'info',
              confirmButtonText: 'OK',
              width: 'auto',
              padding: '20px',
              timer: 3000, // T·ª± ƒë·ªông ƒë√≥ng sau 3 gi√¢y
              timerProgressBar: true, // Hi·ªÉn th·ªã thanh ƒë·∫øm th·ªùi gian
              didClose: () => {
                location.reload(); // Reload trang khi ƒë√≥ng
              }
            }).then((result) => {
              if (result.isDismissed || result.isConfirmed) {
                location.reload(); // Reload trang n·∫øu b·∫•m "OK" ho·∫∑c "X"
              }
            });

            return; // D·ª´ng l·∫°i n·∫øu c√≥ l·ªói
          }
          // ƒë·∫©y code cho P
          // L∆∞u d·ªØ li·ªáu gi·∫£ng vi√™n c√πng v·ªõi m√£ ph√≤ng ban
          nameGv = await gvmResponse.json();

          nameGvm = await khoaResponse.json();

          rs = await teachingResponse.json();

          // Th√™m check

          globalData = rs.results.map(item => ({
            ...item,
            ghiChu: "", // Kh·ªüi t·∫°o ghi ch√∫ r·ªóng
          }));
          const check = rs.check; // D·ªØ li·ªáu check
          const DaoTaoCheck = rs.DaoTaoCheck;
          const VPCheck = rs.VPCheck;
          tongTiet = rs.tongTiet;

          loadDataPopup();


          localStorage.setItem("check", check);
          localStorage.setItem("DaoTaoCheck", DaoTaoCheck);
          localStorage.setItem("VPCheck", VPCheck);


          renderTable(globalData); // G·ªçi h√†m renderTable sau khi ƒë√£ c√≥ ƒë·ªß d·ªØ li·ªáu

          calculateTotals();
        } catch (error) {
          console.error("ƒê√£ c√≥ l·ªói x·∫£y ra:", error);
        }
      }

      const loadDataPopup = async () => {
        // Ph·∫ßn popup hi·ªÉn th·ªã t·ªïng s·ªë ti·∫øt
        const tietMapMoi = tongTiet.detailMoiGiang;
        const tietMapCoHuu = tongTiet.detailCoHuu;

        document.getElementById("tietMoi").innerText =
          tongTiet.tongTietMoiGiang;
        document.getElementById("tietCoHuu").innerText = tongTiet.tongTietCoHuu;
        document.getElementById("tongTiet").innerText = tongTiet.tongTietAll;

        const popup = document.getElementById("popupChiTiet");
        const xemChiTiet = document.getElementById("xemChiTiet");

        xemChiTiet.addEventListener("click", (e) => {
          e.stopPropagation();
          popup.innerHTML = "";

          // --- Ph·∫ßn M·ªùi Gi·∫£ng ---
          const titleMoi = document.createElement("h6");
          titleMoi.innerText = "Gi·∫£ng vi√™n m·ªùi:";
          popup.appendChild(titleMoi);

          for (let gv in tietMapMoi) {
            const div = document.createElement("div");
            div.className = "detail-item";
            div.innerText = `${gv}: ${tietMapMoi[gv]} ti·∫øt`;
            popup.appendChild(div);
          }

          // --- Ph·∫ßn C∆° H·ªØu ---
          const titleCoHuu = document.createElement("h6");
          titleCoHuu.innerText = "Gi·∫£ng vi√™n c∆° h·ªØu:";
          titleCoHuu.style.marginTop = "10px";
          popup.appendChild(titleCoHuu);

          for (let gv in tietMapCoHuu) {
            const div = document.createElement("div");
            div.className = "detail-item";
            div.innerText = `${gv}: ${tietMapCoHuu[gv]} ti·∫øt`;
            popup.appendChild(div);
          }

          popup.style.display = "block";
        });

        document.addEventListener("click", () => {
          popup.style.display = "none";
        });

        popup.addEventListener("click", (e) => e.stopPropagation());

        const toggleBtn = document.getElementById("toggleBtn");
        const arrowIcon = document.getElementById("arrowIcon");
        const summaryBox = document.getElementById("summaryBox");

        let isVisible = false;
        toggleBtn.addEventListener("click", () => {
          isVisible = !isVisible;
          summaryBox.style.display = isVisible ? "block" : "none";
          arrowIcon.style.transform = isVisible
            ? "rotate(180deg)"
            : "rotate(0deg)";
        });
      };


      // H√†m render b·∫£ng
      function renderTable(data) {
        const tableBody = document.getElementById("tableBody");
        tableBody.innerHTML = ""; // X√≥a n·ªôi dung c≈©

        data.forEach((row) => {
          const tableRow = document.createElement("tr");
          tableRow.setAttribute("data-id", row.ID);

          const lopHocPhanTd = document.createElement("td");
          lopHocPhanTd.textContent = `${row.LopHocPhan} (${row.TenLop})` || "";
          tableRow.appendChild(lopHocPhanTd);

          const soTcTd = document.createElement("td");
          soTcTd.textContent = row.SoTinChi || "";
          tableRow.appendChild(soTcTd);

          const giaoVienTd = document.createElement("td");
          giaoVienTd.textContent = row.GiaoVien || "";
          tableRow.appendChild(giaoVienTd);

          const moiGiangTd = document.createElement("td");
          // Thay th·∫ø checkbox b·∫±ng vƒÉn b·∫£n "C√≥" ho·∫∑c "Kh√¥ng"
          const inviteText = document.createElement("span");
          inviteText.textContent = row.MoiGiang ? "C√≥" : "Kh√¥ng";
          moiGiangTd.appendChild(inviteText);
          tableRow.appendChild(moiGiangTd);

          const giaoVienGiangDayTd = document.createElement("td");
          // Chuy·ªÉn √¥ input gi·∫£ng vi√™n th√†nh d·∫°ng xem
          const giaoVienGiangDayView = document.createElement("span");
          giaoVienGiangDayView.textContent = row.GiaoVienGiangDay || "";
          giaoVienGiangDayTd.appendChild(giaoVienGiangDayView);
          tableRow.appendChild(giaoVienGiangDayTd);

          const khoaTd = document.createElement("td");
          khoaTd.textContent = row.Khoa || ""; // L·∫•y gi√° tr·ªã Khoa tr·ª±c ti·∫øp t·ª´ row
          tableRow.appendChild(khoaTd);

          const boMonTd = document.createElement("td"); // T·∫°o √¥ B·ªô m√¥n
          const boMonInput = document.createElement("span"); // T·∫°o span cho B·ªô m√¥n
          boMonInput.textContent = row.BoMon || ""; // L·∫•y gi√° tr·ªã t·ª´ row
          boMonInput.name = "bomon"; // L·∫•y gi√° tr·ªã t·ª´ row
          boMonTd.appendChild(boMonInput); // Th√™m span v√†o √¥
          tableRow.appendChild(boMonTd);

          const he_dao_taoTd = document.createElement("td"); // T·∫°o √¥ B·ªô m√¥n
          const he_dao_taoInput = document.createElement("span"); // T·∫°o span cho B·ªô m√¥n
          he_dao_taoInput.textContent = row.he_dao_tao || ""; // L·∫•y gi√° tr·ªã t·ª´ row
          he_dao_taoInput.name = "he_dao_tao"; // L·∫•y gi√° tr·ªã t·ª´ row
          he_dao_taoTd.appendChild(he_dao_taoInput); // Th√™m span v√†o √¥
          tableRow.appendChild(he_dao_taoTd);

          const soTietLLTd = document.createElement("td");
          soTietLLTd.textContent = row.LL || "";
          tableRow.appendChild(soTietLLTd);

          const soTietQCTd = document.createElement("td");
          soTietQCTd.textContent = row.QuyChuan || "";
          tableRow.appendChild(soTietQCTd);

          const ngayBatDauTd = document.createElement("td");
          // Chuy·ªÉn ƒë·ªïi ng√†y t·ª´ chu·ªói ISO sang ƒë·ªãnh d·∫°ng d·ªÖ ƒë·ªçc
          ngayBatDauTd.textContent = row.NgayBatDau ? new Date(row.NgayBatDau).toLocaleDateString("vi-VN") : "";
          tableRow.appendChild(ngayBatDauTd);

          const ngayKetThucTd = document.createElement("td");
          ngayKetThucTd.textContent = row.NgayKetThuc ? new Date(row.NgayKetThuc).toLocaleDateString("vi-VN") : "";
          tableRow.appendChild(ngayKetThucTd);

          // ƒêi·ªÅu ki·ªán ƒë·ªÉ ·∫©n checkbox c·ªßa "Khoa" n·∫øu role kh√¥ng ph·∫£i l√† "CNTT_ALL"
          const role = localStorage.getItem("userRole");
          const MaPhongBan = localStorage.getItem("MaPhongBan");

          const ghiChuTd = document.createElement("td");
          const ghiChuValue = row.GhiChu && row.GhiChu.trim() !== "" ? row.GhiChu : false;
          const deadlineValue = row.Deadline || ""; // L·∫•y gi√° tr·ªã Deadline
          const hoanThanh = row.HoanThanh;
          if (role === 'GV' || role === 'Th∆∞·ªùng') {
            ghiChuTd.innerHTML = "üìú"; // Hi·ªÉn th·ªã bi·ªÉu t∆∞·ª£ng ghi ch√∫ n·∫øu role l√† GV ho·∫∑c Th∆∞·ªùng
            ghiChuTd.style.cursor = "not-allowed"; // Thay ƒë·ªïi con tr·ªè chu·ªôt th√†nh 'not-allowed' ƒë·ªÉ b√°o hi·ªáu kh√¥ng th·ªÉ t∆∞∆°ng t√°c
            ghiChuTd.title = "B·∫°n kh√¥ng c√≥ quy·ªÅn truy c·∫≠p"; // Th√™m tooltip ƒë·ªÉ gi·∫£i th√≠ch l√Ω do kh√¥ng th·ªÉ nh·∫•n
          } else {

            if (ghiChuValue) {
              if (hoanThanh) {
                ghiChuTd.innerHTML = `üìú <span class="bi bi-check2-circle" style="color: green;"></span>`; // Hi·ªÉn th·ªã bi·ªÉu t∆∞·ª£ng ghi ch√∫ v√† ch·∫•m xanh
              } else {
                ghiChuTd.innerHTML = `üìú <span class="bi bi-circle" style="color: red;"></span>`; // Hi·ªÉn th·ªã bi·ªÉu t∆∞·ª£ng ghi ch√∫ v√† ch·∫•m ƒë·ªè
              }

            } else {
              ghiChuTd.innerHTML = "üìú"; // Hi·ªÉn th·ªã bi·ªÉu t∆∞·ª£ng ghi ch√∫ n·∫øu kh√¥ng c√≥ ghi ch√∫
            }
            ghiChuTd.style.cursor = "pointer"; // Thay ƒë·ªïi con tr·ªè chu·ªôt khi di chu·ªôt qua bi·ªÉu t∆∞·ª£ng
            ghiChuTd.onclick = () => openNoteForm(tableRow, ghiChuValue, deadlineValue); // G·ªçi h√†m m·ªü form khi nh·∫•n v√†o bi·ªÉu t∆∞·ª£ng
          }
          tableRow.appendChild(ghiChuTd); // Th√™m √¥ ghi ch√∫ v√†o h√†ng


          // Checkbox cho khoa
          let khoaCheckboxTd, khoaCheckbox;
          khoaCheckboxTd = document.createElement("td");
          khoaCheckbox = document.createElement("input");
          khoaCheckbox.type = "checkbox";
          khoaCheckbox.name = "khoa"; // Th√™m thu·ªôc t√≠nh name
          khoaCheckbox.checked = row.KhoaDuyet || false; // D√πng m·ªôt tr∆∞·ªùng cho checkbox
          khoaCheckbox.onchange = () => updateCheckAll("khoa"); // G·ªçi h√†m khi checkbox thay ƒë·ªïi
          khoaCheckboxTd.appendChild(khoaCheckbox);
          tableRow.appendChild(khoaCheckboxTd);

          // Checkbox cho ƒë√†o t·∫°o
          let daoTaoCheckboxTd, daoTaoCheckbox;
          daoTaoCheckboxTd = document.createElement("td");
          daoTaoCheckbox = document.createElement("input");
          daoTaoCheckbox.type = "checkbox";
          daoTaoCheckbox.name = "daoTao"; // Th√™m thu·ªôc t√≠nh name
          daoTaoCheckbox.checked = row.DaoTaoDuyet || false; // D√πng m·ªôt tr∆∞·ªùng cho checkbox
          daoTaoCheckbox.onchange = () => updateCheckAll("daoTao"); // G·ªçi h√†m khi checkbox thay ƒë·ªïi
          daoTaoCheckboxTd.appendChild(daoTaoCheckbox);
          tableRow.appendChild(daoTaoCheckboxTd);

          // Checkbox cho t√†i ch√≠nh 
          let VPCheckboxTd, VPCheckbox;
          VPCheckboxTd = document.createElement("td");
          VPCheckbox = document.createElement("input");
          VPCheckbox.type = "checkbox";
          VPCheckbox.name = "VP"; // Th√™m thu·ªôc t√≠nh name
          VPCheckbox.checked = row.TaiChinhDuyet || false; // D√πng m·ªôt tr∆∞·ªùng cho checkbox
          VPCheckbox.onchange = () => updateCheckAll("VP"); // G·ªçi h√†m khi checkbox thay ƒë·ªïi
          VPCheckboxTd.appendChild(VPCheckbox);
          tableRow.appendChild(VPCheckboxTd);

          // Hi·ªÉn th·ªã `td` khi ƒëi·ªÅu ki·ªán th·ªèa m√£n
          if (MaPhongBan == "DAOTAO") {
            // VPCheckboxTd.style.display = 'none';
            VPCheckbox.disabled = true;

          } else if (MaPhongBan == "VP") {
            // Thu nh·ªè √¥ <td> ch·ª©a checkbox Khoa
            // khoaCheckboxTd.style.display = 'none';
            khoaCheckbox.disabled = true;

          }
          /*
          if (MaPhongBan == "DAOTAO" && role == "Duy·ªát") {
            // Checkbox cho Khoa
            khoaCheckbox.style.display = 'inline-block';
            // Checkbox cho ƒê√†o T·∫°o
            daoTaoCheckbox.style.display = 'inline-block';
          } else if (MaPhongBan == "VP" && role == "Duy·ªát") {
            // Checkbox cho ƒê√†o T·∫°o
            daoTaoCheckbox.style.display = 'inline-block';
            // Checkbox cho T√†i Ch√≠nh
            VPCheckbox.style.display = 'inline-block';
          }
          */
          const check = localStorage.getItem("check");
          const DaoTaoCheck = localStorage.getItem("DaoTaoCheck");
          const VPCheck = localStorage.getItem("VPCheck");

          if (MaPhongBan.toLowerCase() === "daotao" && role.toLowerCase() !== "th∆∞·ªùng") {
            // N·∫øu khoa ƒë√£ check th√¨ hi·ªán check b√™n ƒë√†o t·∫°o
            if (!check.includes(row.Khoa)) {
              // NgƒÉn thay ƒë·ªïi tr·∫°ng th√°i check box khoa
              khoaCheckbox.disabled = true
              daoTaoCheckbox.disabled = true
            }

            // N·∫øu ƒë√†o t·∫°o ƒë√£ check th√¨ disable check ƒë√†o t·∫°o
            if (DaoTaoCheck.includes(row.Khoa)) {
              // NgƒÉn thay ƒë·ªïi tr·∫°ng th√°i check box khoa
              khoaCheckbox.disabled = true
              daoTaoCheckbox.disabled = true;
            }
          }

          if (MaPhongBan.toLowerCase() === "vp" && role.toLowerCase() !== "th∆∞·ªùng") {
            // N·∫øu khoa ƒë√£ check th√¨ hi·ªán check b√™n ƒë√†o t·∫°o
            if (!DaoTaoCheck.includes(row.Khoa)) {
              // NgƒÉn thay ƒë·ªïi tr·∫°ng th√°i check box khoa
              daoTaoCheckbox.disabled = true
              VPCheckbox.disabled = true;
            }

            // N·∫øu ƒë√†o t·∫°o ƒë√£ check th√¨ disable check ƒë√†o t·∫°o
            if (VPCheck.includes(row.Khoa)) {
              // NgƒÉn thay ƒë·ªïi tr·∫°ng th√°i check box khoa
              daoTaoCheckbox.disabled = true
              VPCheckbox.disabled = true;
            }
          }
          
          if (role.toLowerCase() === "th∆∞·ªùng") {
            khoaCheckbox.disabled = true;
            daoTaoCheckbox.disabled = true;
            VPCheckbox.disabled = true;
          }

          if (MaPhongBan === "BGƒê" && role.toLocaleLowerCase() === "duy·ªát") {
            khoaCheckbox.disabled = false;
            daoTaoCheckbox.disabled = false;
            VPCheckbox.disabled = false;
          }

          tableBody.appendChild(tableRow); // Th√™m h√†ng v√†o b·∫£ng
        });
      }

      async function submitData() {
        const role = localStorage.getItem("userRole");
        const MaPhongBan = localStorage.getItem("MaPhongBan");
        const rows = document.querySelectorAll("#tableBody tr"); // L·∫•y t·∫•t c·∫£ c√°c h√†ng trong b·∫£ng

        rows.forEach((row, index) => {
          // B·ªè qua c√°c h√†ng ƒëang b·ªã ·∫©n
          if (row.style.display === "none") {
            return;
          }

          const MaPhongBan = localStorage.getItem("MaPhongBan");
          const role = localStorage.getItem("userRole");
          // L·∫•y gi√° tr·ªã c·ªßa checkbox "Khoa", "ƒê√†o T·∫°o", v√† "T√†i Ch√≠nh"
          const khoaCheckbox = row.querySelector(
            'input[type="checkbox"][name="khoa"]'
          );
          const daoTaoCheckbox = row.querySelector(
            'input[type="checkbox"][name="daoTao"]'
          );
          const VPCheckbox = row.querySelector(
            'input[type="checkbox"][name="VP"]'
          );
          // L·∫•y tr·∫°ng th√°i c·ªßa checkbox "ƒê√†o T·∫°o"
          const daoTaoDuyet = daoTaoCheckbox ? daoTaoCheckbox.checked : false;

          // Bi·∫øn ƒë·ªÉ l∆∞u tr·∫°ng th√°i
          let khoaDuyet = khoaCheckbox ? khoaCheckbox.checked : false; // C·∫≠p nh·∫≠t Khoa
          let VPDuyet = VPCheckbox ? VPCheckbox.checked : false; // C·∫≠p nh·∫≠t T√†i Ch√≠nh
          /*
                  if (MaPhongBan == "DAOTAO" && role == "Duy·ªát") {
                    // Khi role l√† DAOTAO_ALL
                    khoaDuyet = khoaCheckbox ? khoaCheckbox.checked : false; // C·∫≠p nh·∫≠t Khoa
                  } else if (MaPhongBan == "VP" && role == "Duy·ªát") {
                    // Khi role l√† VP_ALL
                    khoaDuyet = globalData[index].KhoaDuyet; // Gi·ªØ nguy√™n gi√° tr·ªã c≈© c·ªßa Khoa
                    VPDuyet = VPCheckbox ? VPCheckbox.checked : false; // C·∫≠p nh·∫≠t T√†i Ch√≠nh
                  }
          */
          // C·∫≠p nh·∫≠t v√†o m·∫£ng globalData t∆∞∆°ng ·ª©ng v·ªõi ch·ªâ m·ª•c h√†ng (index)
          globalData[index].KhoaDuyet = khoaDuyet; // C·∫≠p nh·∫≠t Khoa
          globalData[index].DaoTaoDuyet = daoTaoDuyet; // C·∫≠p nh·∫≠t ƒê√†o T·∫°o
          globalData[index].TaiChinhDuyet = VPDuyet; // C·∫≠p nh·∫≠t T√†i Ch√≠nh

        });

        // G·ª≠i d·ªØ li·ªáu l√™n server
        fetch("/phong-ban-duyet", {
          method: "POST", // Ph∆∞∆°ng th·ª©c POST
          headers: {
            "Content-Type": "application/json", // ƒê·ªãnh d·∫°ng g·ª≠i l√† JSON
          },
          body: JSON.stringify(globalData), // Chuy·ªÉn ƒë·ªïi globalData th√†nh chu·ªói JSON
        })
          .then((response) => {
            if (!response.ok) {
              throw new Error("L·ªói khi g·ª≠i d·ªØ li·ªáu");
            }
            return response.json(); // Chuy·ªÉn ƒë·ªïi ph·∫£n h·ªìi th√†nh JSON
          })
          .then((data) => {
            // console.log('D·ªØ li·ªáu ph·∫£n h·ªìi t·ª´ server:', data);
            Swal.fire({
              title: 'Th√¥ng b√°o',
              html: data.message,
              icon: 'success',
              confirmButtonText: 'OK',
              width: 'auto', // T·ª± ƒë·ªông ƒëi·ªÅu ch·ªânh chi·ªÅu r·ªông
              padding: '20px', // Gi·ªØ kho·∫£ng c√°ch cho n·ªôi dung
            });
          })
          .catch((error) => {
            console.error("C√≥ l·ªói x·∫£y ra:", error);
            Swal.fire({
              title: 'Th√¥ng b√°o',
              html: "C√≥ l·ªói x·∫£y ra khi c·∫≠p nh·∫≠t d·ªØ li·ªáu",
              icon: 'error',
              confirmButtonText: 'OK',
              width: 'auto', // T·ª± ƒë·ªông ƒëi·ªÅu ch·ªânh chi·ªÅu r·ªông
              padding: '20px', // Gi·ªØ kho·∫£ng c√°ch cho n·ªôi dung
            });
          });
      }

      async function submitData2() {

        // L·∫•y gi√° tr·ªã t·ª´ c√°c combo box
        const dot = document.getElementById('combobox-dot').value;  // Gi√° tr·ªã t·ª´ combo box ƒê·ª£t
        const ki = document.getElementById('comboboxki').value;    // Gi√° tr·ªã t·ª´ combo box K√¨
        const namHoc = document.getElementById('NamHoc').value;      // Gi√° tr·ªã t·ª´ combo box NƒÉm h·ªçc

        // T·∫°o ƒë·ªëi t∆∞·ª£ng ch·ª©a d·ªØ li·ªáu c·∫ßn g·ª≠i
        const duLieu = {
          dot: dot,
          ki: ki,
          namHoc: namHoc
        };

        try {
          const response = await fetch("/submitData2", {
            method: "POST", // D√πng POST n·∫øu b·∫°n mu·ªën g·ª≠i t√≠n hi·ªáu theo y√™u c·∫ßu HTTP POST
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify(duLieu) // Chuy·ªÉn ƒë·ªëi t∆∞·ª£ng d·ªØ li·ªáu th√†nh chu·ªói JSON
          });

          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }

          const data = await response.json();

          // Hi·ªÉn th·ªã th√¥ng b√°o theo message t·ª´ server
          Swal.fire({
            title: 'Th√¥ng b√°o',
            html: data.message,
            icon: 'success',
            confirmButtonText: 'OK',
            width: 'auto', // T·ª± ƒë·ªông ƒëi·ªÅu ch·ªânh chi·ªÅu r·ªông
            padding: '20px', // Gi·ªØ kho·∫£ng c√°ch cho n·ªôi dung
          });

        } catch (error) {
          console.error("Error sending signal:", error);
          alert("ƒê√£ x·∫£y ra l·ªói trong qu√° tr√¨nh l∆∞u d·ªØ li·ªáu."); // Hi·ªÉn th·ªã th√¥ng b√°o l·ªói
        }
      }

      function calculateTotals() {
        let totalLL = 0; // Reset t·ªïng s·ªë ti·∫øt LL
        let totalQC = 0; // Reset t·ªïng s·ªë ti·∫øt QC

        const rows = document.querySelectorAll('#tableBody tr'); // L·∫•y t·∫•t c·∫£ c√°c h√†ng trong b·∫£ng

        rows.forEach((row) => {
          // B·ªè qua c√°c h√†ng ƒëang b·ªã ·∫©n
          if (row.style.display === 'none') {
            return;
          }

          // Gi·∫£ s·ª≠ c·ªôt LL l√† c·ªôt th·ª© 2 v√† c·ªôt QuyChuan l√† c·ªôt th·ª© 3
          const LLCell = row.querySelector('td:nth-child(9)'); // L·∫•y √¥ c·ªßa c·ªôt LL
          const QuyChuanCell = row.querySelector('td:nth-child(10)'); // L·∫•y √¥ c·ªßa c·ªôt QuyChuan

          // Chuy·ªÉn ƒë·ªïi gi√° tr·ªã c·ªßa c√°c √¥ th√†nh s·ªë v√† c·ªông d·ªìn
          const LL = parseFloat(LLCell.textContent) || 0; // N·∫øu kh√¥ng ph·∫£i s·ªë, m·∫∑c ƒë·ªãnh l√† 0
          const QuyChuan = parseFloat(QuyChuanCell.textContent) || 0;

          totalLL += LL; // C·ªông d·ªìn s·ªë ti·∫øt LL
          totalQC += QuyChuan; // C·ªông d·ªìn s·ªë ti·∫øt QC
        });

        // C·∫≠p nh·∫≠t t·ªïng s·ªë ti·∫øt v√†o HTML
        document.getElementById('totalLL').textContent = totalLL.toFixed(2);
        document.getElementById('totalQC').textContent = totalQC.toFixed(2);
      }

      function checkAll(type) {
        const checkboxes = document.querySelectorAll(
          `input[type="checkbox"][name="${type}"]`
        );
        const checkAllCheckbox = document.getElementById(
          `checkAll${type.charAt(0).toUpperCase() + type.slice(1)}`
        );

        for (const checkbox of checkboxes) {
          if (checkbox.disabled || !checkbox.offsetParent) {
            continue; // B·ªè qua checkbox b·ªã v√¥ hi·ªáu h√≥a ho·∫∑c b·ªã ·∫©n ho√†n to√†n
          }

          checkbox.checked = checkAllCheckbox.checked; // G√°n tr·∫°ng th√°i checked cho checkbox hi·ªÉn th·ªã v√† kh√¥ng b·ªã v√¥ hi·ªáu h√≥a
        }
      }


      // H√†m ƒë·ªÉ c·∫≠p nh·∫≠t tr·∫°ng th√°i c·ªßa checkbox "Check All" khi checkbox c√° nh√¢n ƒë∆∞·ª£c ch·ªçn
      function updateCheckAll(type) {
        const checkboxes = document.querySelectorAll(
          `input[type="checkbox"][name="${type}"]`
        );
        const checkAllCheckbox = document.getElementById(
          `checkAll${type.charAt(0).toUpperCase() + type.slice(1)}`
        );

        // Ki·ªÉm tra n·∫øu t·∫•t c·∫£ checkbox c√° nh√¢n ƒë·ªÅu ƒë∆∞·ª£c ch·ªçn
        const allChecked = Array.from(checkboxes).every(
          (checkbox) => checkbox.checked
        );
        checkAllCheckbox.checked = allChecked; // C·∫≠p nh·∫≠t tr·∫°ng th√°i c·ªßa checkbox "Check All"
      }

      // H√†m kh·ªüi ƒë·ªông ·ª©ng d·ª•ng
      document.addEventListener('DOMContentLoaded', function () {
        init();
      });

      // H√†m g·ª£i √Ω khoa
      $(document).ready(function () {
        // C·∫•u h√¨nh autocomplete
        $("#filterKhoa").autocomplete({
            source: function (request, response) {
                const value = request.term.toLowerCase();

                let suggestions = phongBanList
                    .map(item => `${item.MaPhongBan} - ${item.TenPhongBan}`);
    
                // N·∫øu c√≥ gi√° tr·ªã nh·∫≠p v√†o th√¨ l·ªçc
                if (value) {
                    suggestions = suggestions.filter(name => name.toLowerCase().includes(value));
                }
    
                response(suggestions);
            },
            minLength: 0, // Cho ph√©p hi·ªÉn th·ªã ngay khi nh·∫•n v√†o √¥ input
            select: function (event, ui) {
                let parts = ui.item.value.split("-");
                let processedName = parts[0].trim();
                $("#filterKhoa").val(processedName);
                filterTable();
                return false;
            }
        });
    
        // Khi click v√†o √¥ input, hi·ªÉn th·ªã danh s√°ch g·ª£i √Ω ngay l·∫≠p t·ª©c
        $("#filterKhoa").on("focus", function () {
            $(this).autocomplete("search", ""); // G·ªçi autocomplete v·ªõi chu·ªói r·ªóng ƒë·ªÉ hi·ªÉn th·ªã to√†n b·ªô
        });
    });
    

      // H√†m g·ª£i √Ω b·ªô m√¥n
      $(document).ready(function () {
        // C·∫•u h√¨nh autocomplete
        $("#filterBoMon").autocomplete({
            source: function (request, response) {
                const value = request.term.toLowerCase();

                const khoaValue = $("#filterKhoa").val().toLowerCase() || "all";

                let suggestions = boMon
                    .filter(item => khoaValue === 'all' || item.MaPhongBan.toLowerCase() === khoaValue.toLowerCase())
                    .map(item => `${item.MaPhongBan} - ${item.TenBoMon} - ${item.MaBoMon}`);
    
                // N·∫øu c√≥ gi√° tr·ªã nh·∫≠p v√†o th√¨ l·ªçc
                if (value) {
                    suggestions = suggestions.filter(name => name.toLowerCase().includes(value));
                }
    
                response(suggestions);
            },
            minLength: 0, // Cho ph√©p hi·ªÉn th·ªã ngay khi nh·∫•n v√†o √¥ input
            select: function (event, ui) {
                let parts = ui.item.value.split("-");
                let processedName = parts.slice(2).join("-").trim();
                $("#filterBoMon").val(processedName);
                filterTable();
                return false;
            }
        });
    
        // Khi click v√†o √¥ input, hi·ªÉn th·ªã danh s√°ch g·ª£i √Ω ngay l·∫≠p t·ª©c
        $("#filterBoMon").on("focus", function () {
            $(this).autocomplete("search", ""); // G·ªçi autocomplete v·ªõi chu·ªói r·ªóng ƒë·ªÉ hi·ªÉn th·ªã to√†n b·ªô
        });
    });
    
    </script>

    <!-- Ph·∫ßn ph√¢n quy·ªÅn -->
    <script>
      document.addEventListener("DOMContentLoaded", () => {

        // Th√™m s·ª± ki·ªán click cho ph·∫ßn t·ª≠ c√≥ id="ThongTinGD"
        const ThongTinGD = document.getElementById("ThongTinGD");

        ThongTinGD.addEventListener("click", function (event) {
          event.preventDefault(); // NgƒÉn ch·∫∑n h√†nh vi m·∫∑c ƒë·ªãnh c·ªßa li√™n k·∫øt


          const isKhoa = localStorage.getItem("isKhoa"); // L·∫•y role t·ª´ localStorage

          if (isKhoa == 0) {
            // N·∫øu l√† ƒë√†o t·∫°o ho·∫∑c t√†i ch√≠nh
            window.location.href = "/info2";
          } else {
            window.location.href = "/info";
          }
        });

        // Th√™m s·ª± ki·ªán click cho ph·∫ßn t·ª≠ c√≥ id="Home"

        const Home = document.getElementById("Home");

        Home.addEventListener("click", function (event) {
          event.preventDefault(); // NgƒÉn ch·∫∑n h√†nh vi m·∫∑c ƒë·ªãnh c·ªßa li√™n k·∫øt

          const isKhoa = localStorage.getItem("isKhoa");

          if (isKhoa == 0) {
            // N·∫øu l√† ƒë√†o t·∫°o ho·∫∑c t√†i ch√≠nh
            window.location.href = "/maindt";
          } else {
            window.location.href = "/mainkhoa";
          }
        });
      });
    </script>

    <script>
      let currentRow; // Bi·∫øn to√†n c·ª•c ƒë·ªÉ l∆∞u h√†ng hi·ªán t·∫°i

      function openNoteForm(row, GhiChu, Deadline) {
        currentRow = row; // L∆∞u h√†ng hi·ªán t·∫°i
        document.getElementById("noteForm").style.display = "block"; // Hi·ªÉn th·ªã form
        document.getElementById("modalBackdrop").style.display = "block"; // Hi·ªÉn th·ªã n·ªÅn t·ªëi

        // Hi·ªÉn th·ªã gi√° tr·ªã ghi ch√∫ v√† h·∫°n
        document.getElementById("noteInput").value = GhiChu || ""; // Hi·ªÉn th·ªã ghi ch√∫
        document.getElementById("deadlineInput").value = formatInputDate(Deadline) || ""; // Hi·ªÉn th·ªã h·∫°n
      }


      function closeNoteForm() {
        document.getElementById("noteForm").style.display = "none"; // ·∫®n form
        document.getElementById("modalBackdrop").style.display = "none"; // ·∫®n n·ªÅn t·ªëi
      }
      window.onclick = function (event) {
        const modal = document.getElementById("noteForm");
        const modalBackdrop = document.getElementById("modalBackdrop");
        if (event.target === modalBackdrop) {
          closeNoteForm();
        }
      }
      async function saveNote() {
        const note = document.getElementById("noteInput").value;
        const deadline = document.getElementById("deadlineInput").value;

        if (currentRow) {
          const id = currentRow.getAttribute("data-id"); // L·∫•y ID t·ª´ thu·ªôc t√≠nh `data-id` c·ªßa h√†ng

          // Ki·ªÉm tra ID c√≥ t·ªìn t·∫°i
          if (id) {


            // G·ª≠i d·ªØ li·ªáu ƒë·∫øn API ƒë·ªÉ l∆∞u v√†o CSDL
            try {
              const response = await fetch('/savenote', {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json',
                },
                body: JSON.stringify({ id, ghiChu: note, deadline }),
              });
              const result = await response.json();
              if (!result.success) {
                Swal.fire({
                  title: 'Th√¥ng b√°o',
                  html: "L·ªói khi l∆∞u ghi ch√∫ v√†o CSDL: " + result.message,
                  icon: 'error',
                  confirmButtonText: 'OK',
                  width: 'auto', // T·ª± ƒë·ªông ƒëi·ªÅu ch·ªânh chi·ªÅu r·ªông
                  padding: '20px', // Gi·ªØ kho·∫£ng c√°ch cho n·ªôi dung
                });
              } else {
                Swal.fire({
                  title: 'Th√¥ng b√°o',
                  html: "C·∫≠p nh·∫≠t th√†nh c√¥ng",
                  icon: 'success',
                  confirmButtonText: 'OK',
                  width: 'auto', // T·ª± ƒë·ªông ƒëi·ªÅu ch·ªânh chi·ªÅu r·ªông
                  padding: '20px', // Gi·ªØ kho·∫£ng c√°ch cho n·ªôi dung
                });
              }
            } catch (error) {
              alert("L·ªói khi g·ª≠i y√™u c·∫ßu ƒë·∫øn server: " + error);
            }
          } else {
            alert("ID c·ªßa h√†ng hi·ªán t·∫°i kh√¥ng t·ªìn t·∫°i.");
          }
        } else {
          alert("currentRow kh√¥ng ƒë∆∞·ª£c x√°c ƒë·ªãnh.");
        }

        closeNoteForm();
      }
      async function doneNote() {
        const note = document.getElementById("noteInput").value;
        const deadline = document.getElementById("deadlineInput").value;

        if (currentRow) {
          const id = currentRow.getAttribute("data-id"); // L·∫•y ID t·ª´ thu·ªôc t√≠nh `data-id` c·ªßa h√†ng

          // Ki·ªÉm tra ID c√≥ t·ªìn t·∫°i
          if (id) {


            // G·ª≠i d·ªØ li·ªáu ƒë·∫øn API ƒë·ªÉ l∆∞u v√†o CSDL
            try {
              const response = await fetch('/donenote', {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json',
                },
                body: JSON.stringify({ id, ghiChu: note, deadline }),
              });
              const result = await response.json();
              if (!result.success) {
                Swal.fire({
                  title: 'Th√¥ng b√°o',
                  html: "L·ªói khi l∆∞u ghi ch√∫ v√†o CSDL: " + result.message,
                  icon: 'error',
                  confirmButtonText: 'OK',
                  width: 'auto', // T·ª± ƒë·ªông ƒëi·ªÅu ch·ªânh chi·ªÅu r·ªông
                  padding: '20px', // Gi·ªØ kho·∫£ng c√°ch cho n·ªôi dung
                });
              } else {
                Swal.fire({
                  title: 'Th√¥ng b√°o',
                  html: "C·∫≠p nh·∫≠t th√†nh c√¥ng",
                  icon: 'success',
                  confirmButtonText: 'OK',
                  width: 'auto', // T·ª± ƒë·ªông ƒëi·ªÅu ch·ªânh chi·ªÅu r·ªông
                  padding: '20px', // Gi·ªØ kho·∫£ng c√°ch cho n·ªôi dung
                });
              }
            } catch (error) {
              alert("L·ªói khi g·ª≠i y√™u c·∫ßu ƒë·∫øn server: " + error);
            }
          } else {
            alert("ID c·ªßa h√†ng hi·ªán t·∫°i kh√¥ng t·ªìn t·∫°i.");
          }
        } else {
          alert("currentRow kh√¥ng ƒë∆∞·ª£c x√°c ƒë·ªãnh.");
        }

        closeNoteForm();
      }


      // H√†m ƒë·ªÉ chuy·ªÉn ƒë·ªïi ƒë·ªãnh d·∫°ng ng√†y
      function formatInputDate(dateString) {
        const date = new Date(dateString);
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0'); // L·∫•y th√°ng (0-11) v√† ƒë·∫£m b·∫£o c√≥ 2 ch·ªØ s·ªë
        const day = String(date.getDate()).padStart(2, '0'); // L·∫•y ng√†y v√† ƒë·∫£m b·∫£o c√≥ 2 ch·ªØ s·ªë

        return `${year}-${month}-${day}`; // Tr·∫£ v·ªÅ ƒë·ªãnh d·∫°ng yyyy-mm-dd cho input
      }



      // S·ª± ki·ªán click ngo√†i modal ƒë·ªÉ ƒë√≥ng modal
      window.onclick = function (event) {
        const modal = document.getElementById("noteForm");
        const modalBackdrop = document.getElementById("modalBackdrop");
        if (event.target === modalBackdrop) {
          closeNoteForm();
        }
      }
    </script>

    <script>
      // H√†m x·ª≠ l√Ω t√¨m ki·∫øm theo t√™n b·ªô m√¥n
      function filterKhoa() {
        const input = document.getElementById("filterKhoa");
        const filter = input.value.toLowerCase();
        const tableRows = document.querySelectorAll("#tableBody tr");

        // N·∫øu √¥ t√¨m ki·∫øm tr·ªëng, hi·ªÉn th·ªã t·∫•t c·∫£ c√°c d√≤ng
        if (!filter) {
          tableRows.forEach((row) => {
            row.style.display = ""; // Hi·ªán t·∫•t c·∫£ c√°c d√≤ng
          });
          return;
        }

        // Ch·ªâ hi·ªán c√°c d√≤ng c√≥ t√™n gi·∫£ng vi√™n kh·ªõp v·ªõi gi√° tr·ªã t√¨m ki·∫øm
        tableRows.forEach((row) => {
          const nameCell = row.querySelector("td:nth-child(6)"); // Gi·∫£ s·ª≠ t√™n gi·∫£ng vi√™n n·∫±m ·ªü c·ªôt th·ª© 5
          const name = nameCell.textContent.toLowerCase();

          if (name.includes(filter)) {
            row.style.display = ""; // Hi·ªán h√†ng n·∫øu kh·ªõp
          } else {
            row.style.display = "none"; // ·∫®n h√†ng n·∫øu kh√¥ng kh·ªõp
          }
        });
        calculateTotals();
      }

      // H√†m x·ª≠ l√Ω t√¨m ki·∫øm theo t√™n b·ªô m√¥n
      function filterBoMon() {
        const input = document.getElementById("filterBoMon");
        const filter = input.value.toLowerCase();
        const tableRows = document.querySelectorAll("#tableBody tr");

        // N·∫øu √¥ t√¨m ki·∫øm tr·ªëng, hi·ªÉn th·ªã t·∫•t c·∫£ c√°c d√≤ng
        if (!filter) {
          tableRows.forEach((row) => {
            row.style.display = ""; // Hi·ªán t·∫•t c·∫£ c√°c d√≤ng
          });
          return;
        }

        // Ch·ªâ hi·ªán c√°c d√≤ng c√≥ t√™n gi·∫£ng vi√™n kh·ªõp v·ªõi gi√° tr·ªã t√¨m ki·∫øm
        tableRows.forEach((row) => {
          const nameCell = row.querySelector("td:nth-child(7)"); // Gi·∫£ s·ª≠ t√™n gi·∫£ng vi√™n n·∫±m ·ªü c·ªôt th·ª© 5
          const name = nameCell.textContent.toLowerCase();

          if (name.includes(filter)) {
            row.style.display = ""; // Hi·ªán h√†ng n·∫øu kh·ªõp
          } else {
            row.style.display = "none"; // ·∫®n h√†ng n·∫øu kh√¥ng kh·ªõp
          }
        });
        calculateTotals();
      }

    </script>
    <script>
      $(document).ready(function () {
        $('#NamHoc option[value=""]').remove();
        $('#comboboxki option[value=""]').remove();
        $('#combobox-dot option[value=""]').remove();

        $.ajax({
          url: '/getNamHoc',
          method: 'GET',
          success: function (response) {
            if (response.success) {

              response.NamHoc.forEach(function (item) {
                $('#NamHoc').append(
                  `<option value="${item.NamHoc}">${item.NamHoc}</option>`
                );
              });

              response.Ki.forEach(function (item) {
                $('#comboboxki').append(
                  `<option value="${item.value}">${item.Ki}</option>`
                );
              });
              response.Dot.forEach(function (item) {
                $('#combobox-dot').append(
                  `<option value="${item.value}">${item.Dot}</option>`
                );
              });
            } else {
              console.error("Kh√¥ng l·∫•y ƒë∆∞·ª£c d·ªØ li·ªáu nƒÉm h·ªçc:", response.message);
            }
          },
          error: function (error) {
            console.error("L·ªói khi l·∫•y d·ªØ li·ªáu nƒÉm h·ªçc:", error);
          }
        });
      });
    </script>
    <script>
      document.getElementById("infome").addEventListener("click", function (event) {
        event.preventDefault(); // NgƒÉn ch·∫∑n h√†nh vi m·∫∑c ƒë·ªãnh c·ªßa th·∫ª a
        const id_User = localStorage.getItem("id_User"); // L·∫•y id_User t·ª´ localStorage\
        if (id_User) {
          // Chuy·ªÉn h∆∞·ªõng ƒë·∫øn trang infome v√† truy·ªÅn id_User trong URL
          window.location.href = `/infome/${id_User}`;
        } else {
          alert("Kh√¥ng t√¨m th·∫•y id_User trong localStorage.");
        }
      });
    </script>

    <script>
      document.addEventListener("DOMContentLoaded", () => {
        const role = localStorage.getItem("userRole");

        // ·∫®n button ngay khi trang ƒë∆∞·ª£c t·∫£i
        const actionButton = document.getElementById('changeMessage');
        //·∫®n site th√™m th√¥ng b√°o
        if (role === "Duy·ªát") {
          actionButton.style.display = '';
        } else {
          actionButton.style.display = 'none';
        }
      });
    </script>
    <script>
      document.getElementById("changeMessage").addEventListener("click", function (event) {
        event.preventDefault(); // NgƒÉn ch·∫∑n h√†nh vi m·∫∑c ƒë·ªãnh c·ªßa th·∫ª a
        const MaPhongBan = localStorage.getItem("MaPhongBan"); // L·∫•y MaPhongBan t·ª´ localStorage

        if (MaPhongBan) {
          // Chuy·ªÉn h∆∞·ªõng ƒë·∫øn trang changeMessage v√† truy·ªÅn MaPhongBan trong URL
          window.location.href = `/changeMessage/${MaPhongBan}`;
        } else {
          alert("Kh√¥ng t√¨m th·∫•y MaPhongBan trong localStorage.");
        }
      });
    </script>
</body>

</html>

</html>