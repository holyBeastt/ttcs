<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Học Viện Kỹ Thuật Mật Mã</title>
  <link rel="stylesheet" href="/css/table.css">
  <link rel="stylesheet" href="/css/admin.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
  <link rel="stylesheet" href="/css/styles.css">
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</head>

<body>
    <nav class="navbar-top ">
        <div class="container-fluid">
          <a class="navbar-brand" href="#">
            <img src="/Logo-Hoc-Vien-Ky-Thuat-Mat-Ma-ACTVN.webp" alt="Logo">
            <div class="navbar-title">
              <img src="/dongchu_banner.png" alt="banner">
            </div>
          </a>
        </div>
      </nav>
    
      <!-- Phần dưới của navbar chứa các mục nằm ngang -->
      <nav class="navbar navbar-expand-lg navbar-bottom">
        <div class="" style="width: 100%;">
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" style="width: 100%;" id="navbarNav">
              <div>
                <ul class="navbar-nav">
                  <li class="nav-item">
                    <a class="nav-link" href="/admin"><i class="bi bi-house"></i></a>
                  </li>
                  <li class="nav-item">
                    <a class="nav-link" id="ThongTinTK" href="/thongTinTK">Thông Tin Tài Khoản </a>       
                   </li>
                    <li class="nav-item">
                      <a class="nav-link" id="NhanVien" href="/nhanVien">Nhân Viên </a>        
                     </li>
                     <li class="nav-item">
                      <a class="nav-link" id="PhongBan" href="/phongBan">Phòng Ban </a>        
                     </li>
                     <li class="nav-item">
                      <a class="nav-link" id="BoMon" href="/boMon">Bộ Môn </a>        
                     </li>
                     <li class="nav-item">
                      <a class="nav-link text-center" id="NamHoc" href="/namHoc" style="width: fit-content;">Năm học </a>        
                     </li>
                     <li class="nav-item">
                      <a class="nav-link" id="KyTuBD" href="/kytubatdau">Ký tự bắt đầu </a>        
                     </li>
                     <li class="nav-item">
                        <a class="nav-link active" id="TienLuong" href="/tienluong">Tiền Lương</a>
                     </li>
                </ul>
              </div>
                
              <div class="navbar-nav">
                <div class="nav-item dropdown">
                  <a class="nav-link dropdown-toggle" href="/login" id="navbarDropdownUser" data-bs-toggle="dropdown" aria-expanded="false">
                    Hi, ADMIN
                    </a>
                  <div class="dropdown-menu" aria-labelledby="dropdownMenuButton" style="right: 0; left: auto; z-index: 1000;">
                    <a class="dropdown-item" href="#">Thông tin cá nhân</a>
                    <a class="dropdown-item" id="changePasswordLink">Đổi mật khẩu</a>
                    <a class="dropdown-item" href="/">Đăng xuất</a>
                  </div>
                </div>
            </div>
        </div>
      </nav>

  <div class="container my-5 box">
    <form id="tienluongForm" action="/tienluong" method="POST" class="row">
      <div class="col-md-4">
        <label for="HeDaoTao">Hệ Đào Tạo</label>
        <select name="HeDaoTao" id="HeDaoTao" class="form-control" required>
          <option value="Đại học (Đóng học phí)" selected>Đại học (Đóng học phí)</option>
          <option value="Đại học (Mật mã)">Đại học (Mật mã)</option>
          <option value="Cao học (Đóng học phí)">Cao học (Đóng học phí)</option>
          <option value="Nghiên cứu sinh (Đóng học phí)">Nghiên cứu sinh</option>
        </select>
      </div>
      <div class="col-md-4" id="hocViContainer">
        <label for="HocVi">Học Vị:</label>
        <select name="HocVi" id="HocVi" class="form-control" required>
            <option value="Thạc sĩ" selected>Thạc sĩ</option>
            <option value="Tiến sĩ">Tiến sĩ</option>
            <option value="Giáo sư">Giáo sư</option>
          </select>
      </div>
      <div class="col-md-4">
        <label for="SoTien">Số Tiền:</label>
        <input type="number" name="SoTien" id="SoTien" class="form-control" required>
      </div>
      <div class="col-md-12 mt-3">
        <button type="button" class="btn btn-primary" id="addButton">Thêm</button>
      </div>
    </form>

    <div class="pb-3">
      <table id="NamHocTable" class="table table-bordered">
        <thead>
          <tr>
            <th>STT</th>
            <th>Hệ Đào Tạo</th>
            <th>Học Vị</th>
            <th>Số Tiền</th>
            <th>Thao Tác</th>
          </tr>
        </thead>
        <tbody id="data-table-body">
          <% if (tienluong && tienluong.length > 0) { %>
            <% for (var i = 0; i < tienluong.length; i++) { %>
              <tr data-id="<%= tienluong[i].STT %>">
                <td><%= i + 1 %></td>
                <td class="editable HeDaoTao-cell"><%= tienluong[i].HeDaoTao %></td>
                <td class="editable HocVi-cell"><%= tienluong[i].HocVi %></td>
                <td class="editable SoTien-cell"><%= new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(tienluong[i].SoTien) %></td>
                <td class="d-flex justify-content-center">
                  <button class="bi bi-pencil action-button edit-btn"></button>
                  <button class="bi bi-trash3 action-button me-2" 
                      onclick="deleteTienLuong(this, '<%= tienluong[i].STT %>')">
                    </button>
                </td>
              </tr>
            <% } %>
          <% } %>
        </tbody>
      </table>
    </div>
  </div>

  <script>


    $(document).ready(function() {
        let originalValues = {};

        $('.edit-btn').click(function() {
            const row = $(this).closest('tr');
            const STT = row.data('id');

            // Lưu giá trị gốc
            originalValues[STT] = {
                HeDaoTao: row.find('.HeDaoTao-cell').text().trim(),
                HocVi: row.find('.HocVi-cell').text().trim(),
                SoTien: row.find('.SoTien-cell').text().trim()
            };

            // Chuyển text thành combobox cho HeDaoTao
            row.find('.HeDaoTao-cell').html(`
                <select class="form-control">
                    <option value="Đại học" ${originalValues[STT].HeDaoTao === 'Đại học (đóng học phí)' ? 'selected' : ''}>Đại học (đóng học phí)</option>
                    <option value="Đại học (mật mã)" ${originalValues[STT].HeDaoTao === 'Đại học (mật mã)' ? 'selected' : ''}>Đại học (mật mã)</option>
                    <option value="Cao học" ${originalValues[STT].HeDaoTao === 'Cao học' ? 'selected' : ''}>Cao học</option>
                    <option value="Nghiên cứu sinh" ${originalValues[STT].HeDaoTao === 'Nghiên cứu sinh' ? 'selected' : ''}>Nghiên cứu sinh</option>
                </select>
            `);

            // Chuyển text thành combobox cho HocVi
            row.find('.HocVi-cell').html(`
                <select class="form-control">
                    <option value="Thạc Sĩ" ${originalValues[STT].HocVi === 'Thạc Sĩ' ? 'selected' : ''}>Thạc Sĩ</option>
                    <option value="Tiến Sĩ" ${originalValues[STT].HocVi === 'Tiến Sĩ' ? 'selected' : ''}>Tiến Sĩ</option>
                    <option value="Giáo Sư" ${originalValues[STT].HocVi === 'Giáo Sư' ? 'selected' : ''}>Giáo Sư</option>
                </select>
            `);

            // Giữ nguyên input cho SoTien
            row.find('.SoTien-cell').html(`
                <input type="number" class="form-control" value="${originalValues[STT].SoTien}">
            `);

            // Thêm nút Save và Cancel vào cell cuối
            const actionCell = row.find('td:last-child');
            actionCell.html(`
                <button class="save-btn btn btn-success btn-sm">Lưu</button>
                <button class="cancel-btn btn btn-danger btn-sm ms-2">Hủy</button>
            `);

            // Ẩn nút Edit
            $(this).hide();
        });

        // Xử lý khi nhấn nút Save
        $(document).on('click', '.save-btn', function() {
            const row = $(this).closest('tr');
            const STT = row.data('id');
            const updatedData = {
                HeDaoTao: row.find('.HeDaoTao-cell select').val(),
                HocVi: row.find('.HocVi-cell select').val(),
                SoTien: row.find('.SoTien-cell input').val()
            };

            $.ajax({
                url: `/tienluong/${STT}`,
                method: 'PUT',
                contentType: 'application/json',
                data: JSON.stringify(updatedData),
                success: function(response) {
                    // Cập nhật giao diện
                    row.find('.HeDaoTao-cell').text(updatedData.HeDaoTao);
                    row.find('.HocVi-cell').text(updatedData.HocVi);
                    row.find('.SoTien-cell').text(updatedData.SoTien);

                    // Khôi phục nút Edit
                    const actionCell = row.find('td:last-child');
                    actionCell.html(`
                        <button class="bi bi-pencil action-button edit-btn"></button>
                        <button class="bi bi-trash3 action-button me-2" 
                            onclick="deleteTienLuong(this, '${STT}')">
                        </button>
                    `);

                    alert('Cập nhật thành công!');
                },
                error: function(error) {
                    alert('Có lỗi xảy ra khi cập nhật');
                }
            });
        });

        // Xử lý khi nhấn nút Cancel
        $(document).on('click', '.cancel-btn', function() {
            const row = $(this).closest('tr');
            const STT = row.data('id');

            // Khôi phục giá trị gốc
            row.find('.HeDaoTao-cell').text(originalValues[STT].HeDaoTao);
            row.find('.HocVi-cell').text(originalValues[STT].HocVi);
            row.find('.SoTien-cell').text(originalValues[STT].SoTien);

            // Khôi phục nút Edit
            const actionCell = row.find('td:last-child');
            actionCell.html(`
                <button class="bi bi-pencil action-button edit-btn"></button>
                <button class="bi bi-trash3 action-button me-2" 
                    onclick="deleteTienLuong(this, '${STT}')">
                </button>
            `);
        });

        $('#addButton').click(function(event) {
            event.preventDefault(); // Ngăn chặn hành động mặc định của nút

            const heDaoTao = $('#HeDaoTao').val();
            const hocVi = $('#HocVi').val();
            const soTien = $('#SoTien').val();

            // Kiểm tra sự tồn tại
            $.ajax({
                url: '/checkExistence',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({ HeDaoTao: heDaoTao, HocVi: hocVi }),
                success: function(response) {
                    // Nếu không tồn tại, tiếp tục thêm mới
                    addNewEntry(heDaoTao, hocVi, soTien);
                },
                error: function(xhr) {
                    if (xhr.status === 409) {
                        alert(xhr.responseJSON.message); // Hiển thị thông báo đã tồn tại
                    } else {
                        alert('Có lỗi xảy ra khi kiểm tra sự tồn tại.');
                    }
                }
            });
        });

        function addNewEntry(heDaoTao, hocVi, soTien) {
            // Logic để thêm mới vào cơ sở dữ liệu
            $.ajax({
                url: '/tienluong',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({ HeDaoTao: heDaoTao, HocVi: hocVi, SoTien: soTien }),
                success: function(response) {
                    alert('Thêm mới thành công!');
                    location.reload(); // Tải lại trang để cập nhật dữ liệu
                },
                error: function(error) {
                    alert('Có lỗi xảy ra khi thêm mới.');
                }
            });
        }
    });

    function deleteTienLuong(button, STT) {
    if (confirm(`Bạn có chắc chắn muốn xóa không?`)) {
      fetch(`/tienluong/${STT}`, {
    method: 'DELETE',
    headers: {
        'Content-Type': 'application/json',
    }
    })
    .then(response => {
        if (response.ok) {
            alert("Xóa thành công!");
            button.closest("tr").remove();
        } else {
            return response.text().then(text => {
                // Kiểm tra nếu phản hồi là HTML, thường là trang đăng nhập hoặc lỗi
                if (text.startsWith("<!DOCTYPE html>")) {
                    alert("Có lỗi xảy ra, có thể bạn cần đăng nhập lại hoặc endpoint không tồn tại.");
                } else {
                    const data = JSON.parse(text); // Xử lý JSON nếu không phải HTML
                    alert("Xóa thất bại: " + data.message);
                }
            });
        }
    })
    .catch(error => {
        alert("Có lỗi xảy ra: " + error.message);
    });
}};
  </script>
</body>

</html>