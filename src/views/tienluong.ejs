<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>H·ªçc Vi·ªán K·ªπ Thu·∫≠t M·∫≠t M√£</title>
  <link rel="stylesheet" href="/css/table.css" />
  <link rel="stylesheet" href="/css/admin.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" />
  <link rel="stylesheet" href="/css/styles.css" />
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/sweetalert2@11.6.16/dist/sweetalert2.min.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.6.16/dist/sweetalert2.all.min.js"></script>
  <style>
    /* Override global CSS - force remove blue background */
    .nav-tabs .nav-link {
      background-color: transparent !important;
      border: 1px solid #dee2e6 !important;
      color: #495057 !important;
    }

    .nav-tabs .nav-link:hover {
      border-color: #dee2e6 !important;
      background-color: #f8f9fa !important;
    }

    .nav-tabs .nav-link.active {
      background-color: #fff !important;
      border-color: #dee2e6 #dee2e6 #fff !important;
      color: #007bff !important;
      font-weight: 600 !important;
    }

    .tab-content {
      background-color: transparent !important;
    }

    /* Override for form inside tabs */
    .tab-pane.active {
      background-color: transparent !important;
      color: black !important;
    }
  </style>
</head>

<body>
  <%- include('adminHeader') %>

    <div class="container my-5 box">
      <!-- Bootstrap Tabs Navigation -->
      <ul class="nav nav-tabs mb-4" id="salaryTabs" role="tablist">
        <li class="nav-item" role="presentation">
          <button class="nav-link active" id="tab-moi-giang" data-bs-toggle="tab" data-bs-target="#content-moi-giang"
            type="button" role="tab" aria-controls="content-moi-giang" aria-selected="true">
            <i class="bi bi-person-badge me-2"></i>M·ªùi Gi·∫£ng
          </button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="tab-do-an" data-bs-toggle="tab" data-bs-target="#content-do-an" type="button"
            role="tab" aria-controls="content-do-an" aria-selected="false">
            <i class="bi bi-journal-text me-2"></i>ƒê·ªì √Ån
          </button>
        </li>
      </ul>

      <!-- Tab Contents -->
      <div class="tab-content" id="salaryTabContent">

        <!-- ============ TAB M·ªúI GI·∫¢NG ============ -->
        <div class="tab-pane fade show active" id="content-moi-giang" role="tabpanel" aria-labelledby="tab-moi-giang">
          <form id="formMoiGiang" class="row mb-4">
            <input type="hidden" name="loai_hinh" value="m·ªùi gi·∫£ng" />
            <div class="col-md-4">
              <label for="he_dao_tao_mg">H·ªá ƒê√†o T·∫°o</label>
              <select name="he_dao_tao" id="he_dao_tao_mg" class="form-control" required>
                <option value="">-- Ch·ªçn h·ªá ƒë√†o t·∫°o --</option>
              </select>
            </div>
            <div class="col-md-4">
              <label for="HocVi_mg">H·ªçc V·ªã:</label>
              <select name="HocVi" id="HocVi_mg" class="form-control" required>
                <option value="C·ª≠ nh√¢n">C·ª≠ nh√¢n</option>
                <option value="K·ªπ s∆∞">K·ªπ s∆∞</option>
                <option value="Th·∫°c sƒ©" selected>Th·∫°c sƒ©</option>
                <option value="Ti·∫øn sƒ©">Ti·∫øn sƒ©</option>
                <option value="Ph√≥ gi√°o s∆∞">Ph√≥ gi√°o s∆∞</option>
                <option value="Gi√°o s∆∞">Gi√°o s∆∞</option>
                <option value="Ti·∫øng kh∆°-me">Ti·∫øng kh∆°-me</option>
                <option value="V√µ s∆∞">V√µ s∆∞</option>
              </select>
            </div>
            <div class="col-md-4">
              <label for="SoTien_mg">S·ªë Ti·ªÅn:</label>
              <input type="number" name="SoTien" id="SoTien_mg" class="form-control" required />
            </div>
            <div style="margin-top: 15px;"></div>
            <div class="col-md-4">
              <label for="do_uu_tien_mg">ƒê·ªô ∆∞u ti√™n</label>
              <select name="do_uu_tien" id="do_uu_tien_mg" class="form-control" required></select>
            </div>
            <div class="col-md-4">
              <label for="chuc_danh_mg">Ch·ª©c danh</label>
              <select name="chuc_danh" id="chuc_danh_mg" class="form-control" required></select>
            </div>
            <div class="col-md-4">
              <label for="hsl_mg">H·ªá s·ªë l∆∞∆°ng:</label>
              <input type="number" name="hsl" id="hsl_mg" class="form-control" value="0" required />
            </div>

            <div class="col-md-12 mt-3">
              <div class="d-flex justify-content-between align-items-center">
                <button type="button" class="btn btn-primary" id="addButtonMoiGiang">Th√™m</button>
                <span class="text-muted small d-flex align-items-center" style="cursor: pointer"
                  data-bs-toggle="tooltip" data-bs-html="true"
                  title="<b>Nguy√™n t·∫Øc x√°c ƒë·ªãnh S·ªë ti·ªÅn:</b><br>1Ô∏è‚É£ ∆Øu ti√™n theo <b>ƒë·ªô ∆∞u ti√™n</b> (cao tr∆∞·ªõc)<br>2Ô∏è‚É£ X√©t <b>H·ªá ƒë√†o t·∫°o</b> & <b>H·ªçc v·ªã</b><br>3Ô∏è‚É£ <b>HSL gi·∫£ng vi√™n ‚â• HSL c·∫•u h√¨nh</b><br>4Ô∏è‚É£ <b>Ch·ª©c danh</b> t∆∞∆°ng ·ª©ng ho·∫∑c √°p d·ª•ng chung<br>5Ô∏è‚É£ N·∫øu c√≥ nhi·ªÅu b·∫£n ghi ph√π h·ª£p -> Ch·ªçn b·∫£n ghi c√≥ <b>S·ªë ti·ªÅn cao nh·∫•t</b><br>‚ùó Kh√¥ng c√≥ b·∫£n ghi ph√π h·ª£p ‚Üí S·ªë ti·ªÅn = 0">
                  <i class="bi bi-info-circle me-1"></i>Quy t·∫Øc √°p d·ª•ng s·ªë ti·ªÅn
                </span>
              </div>
            </div>
          </form>

          <div class="pb-3">
            <table class="table table-bordered">
              <thead>
                <tr>
                  <th>STT</th>
                  <th>H·ªá ƒê√†o T·∫°o</th>
                  <th>H·ªçc V·ªã</th>
                  <th>S·ªë Ti·ªÅn</th>
                  <th>ƒê·ªô ∆∞u ti√™n</th>
                  <th>H·ªá s·ªë l∆∞∆°ng</th>
                  <th>Ch·ª©c danh</th>
                  <th>Thao T√°c</th>
                </tr>
              </thead>
              <tbody id="tableMoiGiang">
                <!-- Data will be populated by JavaScript -->
              </tbody>
            </table>
          </div>
        </div>

        <!-- ============ TAB ƒê·ªí √ÅN ============ -->
        <div class="tab-pane fade" id="content-do-an" role="tabpanel" aria-labelledby="tab-do-an">
          <form id="formDoAn" class="row mb-4">
            <input type="hidden" name="loai_hinh" value="ƒë·ªì √°n" />
            <div class="col-md-4">
              <label for="he_dao_tao_da">H·ªá ƒê√†o T·∫°o</label>
              <select name="he_dao_tao" id="he_dao_tao_da" class="form-control" required>
                <option value="">-- Ch·ªçn h·ªá ƒë√†o t·∫°o --</option>
              </select>
            </div>
            <div class="col-md-4">
              <label for="HocVi_da">H·ªçc V·ªã:</label>
              <select name="HocVi" id="HocVi_da" class="form-control" required>
                <option value="C·ª≠ nh√¢n">C·ª≠ nh√¢n</option>
                <option value="K·ªπ s∆∞">K·ªπ s∆∞</option>
                <option value="Th·∫°c sƒ©" selected>Th·∫°c sƒ©</option>
                <option value="Ti·∫øn sƒ©">Ti·∫øn sƒ©</option>
                <option value="Ph√≥ gi√°o s∆∞">Ph√≥ gi√°o s∆∞</option>
                <option value="Gi√°o s∆∞">Gi√°o s∆∞</option>
                <option value="Ti·∫øng kh∆°-me">Ti·∫øng kh∆°-me</option>
                <option value="V√µ s∆∞">V√µ s∆∞</option>
              </select>
            </div>
            <div class="col-md-4">
              <label for="SoTien_da">S·ªë Ti·ªÅn:</label>
              <input type="number" name="SoTien" id="SoTien_da" class="form-control" required />
            </div>
            <div style="margin-top: 15px;"></div>
            <div class="col-md-4">
              <label for="do_uu_tien_da">ƒê·ªô ∆∞u ti√™n</label>
              <select name="do_uu_tien" id="do_uu_tien_da" class="form-control" required></select>
            </div>
            <div class="col-md-4">
              <label for="chuc_danh_da">Ch·ª©c danh</label>
              <select name="chuc_danh" id="chuc_danh_da" class="form-control" required></select>
            </div>
            <div class="col-md-4">
              <label for="hsl_da">H·ªá s·ªë l∆∞∆°ng:</label>
              <input type="number" name="hsl" id="hsl_da" class="form-control" value="0" required />
            </div>

            <div class="col-md-12 mt-3">
              <div class="d-flex justify-content-between align-items-center">
                <button type="button" class="btn btn-primary" id="addButtonDoAn">Th√™m</button>
                <span class="text-muted small d-flex align-items-center" style="cursor: pointer"
                  data-bs-toggle="tooltip" data-bs-html="true"
                  title="<b>Nguy√™n t·∫Øc x√°c ƒë·ªãnh S·ªë ti·ªÅn:</b><br>1Ô∏è‚É£ ∆Øu ti√™n theo <b>ƒë·ªô ∆∞u ti√™n</b> (cao tr∆∞·ªõc)<br>2Ô∏è‚É£ X√©t <b>H·ªá ƒë√†o t·∫°o</b> & <b>H·ªçc v·ªã</b><br>3Ô∏è‚É£ <b>HSL gi·∫£ng vi√™n ‚â• HSL c·∫•u h√¨nh</b><br>4Ô∏è‚É£ <b>Ch·ª©c danh</b> t∆∞∆°ng ·ª©ng ho·∫∑c √°p d·ª•ng chung<br>5Ô∏è‚É£ N·∫øu c√≥ nhi·ªÅu b·∫£n ghi ph√π h·ª£p -> Ch·ªçn b·∫£n ghi c√≥ <b>S·ªë ti·ªÅn cao nh·∫•t</b><br>‚ùó Kh√¥ng c√≥ b·∫£n ghi ph√π h·ª£p ‚Üí S·ªë ti·ªÅn = 0">
                  <i class="bi bi-info-circle me-1"></i>Quy t·∫Øc √°p d·ª•ng s·ªë ti·ªÅn
                </span>
              </div>
            </div>
          </form>

          <div class="pb-3">
            <table class="table table-bordered">
              <thead>
                <tr>
                  <th>STT</th>
                  <th>H·ªá ƒê√†o T·∫°o</th>
                  <th>H·ªçc V·ªã</th>
                  <th>S·ªë Ti·ªÅn</th>
                  <th>ƒê·ªô ∆∞u ti√™n</th>
                  <th>H·ªá s·ªë l∆∞∆°ng</th>
                  <th>Ch·ª©c danh</th>
                  <th>Thao T√°c</th>
                </tr>
              </thead>
              <tbody id="tableDoAn">
                <!-- Data will be populated by JavaScript -->
              </tbody>
            </table>
          </div>
        </div>

      </div>
    </div>

    <script>
      // ========== GLOBAL DATA ==========
      let allTienLuongData = <%-JSON.stringify(tienluong) %>;

      const loadDoUuTienList = (selectId) => {
        const select = $(selectId);
        select.empty();
        for (let i = 0; i <= 5; i++) {
          select.append(`<option value="${i}">${i}</option>`);
        }
      };

      const populateTable = (tableId, data) => {
        const tbody = $(tableId);
        tbody.empty();
        data.forEach((item, index) => {
          const row = `
            <tr data-id="${item.STT}" data-he-dao-tao-id="${item.he_dao_tao}" data-chuc-danh-id="${item.chuc_danh_id}">
              <td>${index + 1}</td>
              <td class="editable he_dao_tao-cell">${item.he_dao_tao_name || item.he_dao_tao}</td>
              <td class="editable HocVi-cell">${item.HocVi}</td>
              <td class="editable SoTien-cell">${new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(item.SoTien)}</td>
              <td class="editable do_uu_tien-cell">${item.do_uu_tien ?? 0}</td>
              <td class="editable HSL-cell">${item.HSL ?? 0}</td>
              <td class="editable chuc_danh-cell">${item.chuc_danh_text ?? ''}</td>
              <td class="d-flex justify-content-center" style="border: none">
                <button class="bi bi-pencil action-button edit-btn"></button>
                <button class="bi bi-trash3 action-button me-2" onclick="deleteTienLuong(this, '${item.STT}')"></button>
              </td>
            </tr>
          `;
          tbody.append(row);
        });
      };

      document.addEventListener("DOMContentLoaded", function () {
        document
          .querySelectorAll('[data-bs-toggle="tooltip"]')
          .forEach(el => new bootstrap.Tooltip(el));
      });



      $(document).ready(function () {
        // Load for both tabs' dropdowns
        loadDoUuTienList('#do_uu_tien_mg');
        loadDoUuTienList('#do_uu_tien_da');

        // Load ch·ª©c danh for both tabs
        $.ajax({
          url: '/api/gvm/v1/chuc-danh-nghe-nghiep-admin',
          method: 'GET',
          success: function (response) {
            if (response.success && response.data) {
              $('#chuc_danh_mg, #chuc_danh_da').each(function () {
                const select = $(this);
                select.empty();
                response.data.forEach(function (item) {
                  select.append(`<option value="${item.id}">${item.chuc_danh}</option>`);
                });
              });
            }
          }
        });

        // Load danh s√°ch h·ªá ƒë√†o t·∫°o m·ªùi gi·∫£ng t·ª´ API
        $.ajax({
          url: "/api/gvm/v1/he-moi-giang",
          method: "GET",
          success: function (response) {
            if (response.success && response.data) {
              // Populate only M·ªùi Gi·∫£ng dropdown
              const select = $('#he_dao_tao_mg');
              select.empty();
              response.data.forEach(function (item) {
                select.append(`<option value="${item.id}">${item.he_dao_tao}</option>`);
              });

              // Filter and populate M·ªùi Gi·∫£ng table
              const moiGiangData = allTienLuongData.filter(item => {
                const loaiHinh = (item.loai_hinh || '').toLowerCase().trim();
                console.log('M·ªùi Gi·∫£ng - Item loai_hinh:', item.loai_hinh, '-> filtered:', loaiHinh);
                return loaiHinh === 'm·ªùi gi·∫£ng';
              });
              populateTable('#tableMoiGiang', moiGiangData);
            }
          },
          error: function (error) {
            console.error("L·ªói khi t·∫£i danh s√°ch h·ªá ƒë√†o t·∫°o m·ªùi gi·∫£ng:", error);
            Swal.fire({
              title: "Th√¥ng b√°o",
              html: "Kh√¥ng th·ªÉ t·∫£i danh s√°ch h·ªá ƒë√†o t·∫°o m·ªùi gi·∫£ng",
              icon: "error",
              width: "auto",
              padding: "20px",
              timer: 2000,
              timerProgressBar: true,
              showConfirmButton: false,
            });
          }
        });

        // Load danh s√°ch h·ªá ƒë√†o t·∫°o ƒë·ªì √°n t·ª´ API
        $.ajax({
          url: "/api/gvm/v1/he-do-an",
          method: "GET",
          success: function (response) {
            if (response.success && response.data) {
              // Populate only ƒê·ªì √Ån dropdown
              const select = $('#he_dao_tao_da');
              select.empty();
              response.data.forEach(function (item) {
                select.append(`<option value="${item.id}">${item.he_dao_tao}</option>`);
              });

              // Filter and populate ƒê·ªì √Ån table
              const doAnData = allTienLuongData.filter(item => {
                const loaiHinh = (item.loai_hinh || '').toLowerCase().trim();
                console.log('ƒê·ªì √Ån - Item loai_hinh:', item.loai_hinh, '-> filtered:', loaiHinh);
                return loaiHinh === 'ƒë·ªì √°n';
              });
              populateTable('#tableDoAn', doAnData);
            }
          },
          error: function (error) {
            console.error("L·ªói khi t·∫£i danh s√°ch h·ªá ƒë√†o t·∫°o ƒë·ªì √°n:", error);
            Swal.fire({
              title: "Th√¥ng b√°o",
              html: "Kh√¥ng th·ªÉ t·∫£i danh s√°ch h·ªá ƒë√†o t·∫°o ƒë·ªì √°n",
              icon: "error",
              width: "auto",
              padding: "20px",
              timer: 2000,
              timerProgressBar: true,
              showConfirmButton: false,
            });
          }
        });

        let originalValues = {};

        // G√°n s·ª± ki·ªán cho n√∫t Edit
        $(document).on("click", ".edit-btn", function () {
          const row = $(this).closest("tr");
          const STT = row.data("id");

          // üîç X√°c ƒë·ªãnh tab hi·ªán t·∫°i d·ª±a v√†o tbody parent
          const isDoAnTab = row.closest('tbody').attr('id') === 'tableDoAn';
          const apiEndpoint = isDoAnTab ? '/api/gvm/v1/he-do-an' : '/api/gvm/v1/he-moi-giang';

          // L∆∞u gi√° tr·ªã g·ªëc
          originalValues[STT] = {
            he_dao_tao: row.find(".he_dao_tao-cell").text().trim(),
            he_dao_tao_id: row.data('he-dao-tao-id'),

            HocVi: row.find(".HocVi-cell").text().trim(),

            SoTien: row.find(".SoTien-cell").text().trim(),

            do_uu_tien: row.find(".do_uu_tien-cell").text().trim(),

            HSL: row.find(".HSL-cell").text().trim(),

            chuc_danh_id: row.data('chuc-danh-id'),
            chuc_danh_text: row.find(".chuc_danh-cell").text().trim() // ‚≠ê QUAN TR·ªåNG
          };


          // Chuy·ªÉn text th√†nh combobox cho he_dao_tao v·ªõi API ph√π h·ª£p
          $.ajax({
            url: apiEndpoint,
            method: "GET",
            success: function (response) {
              if (response.success && response.data) {
                let options = '';
                response.data.forEach(function (item) {
                  const selected = item.id == originalValues[STT].he_dao_tao_id ? 'selected' : '';
                  options += `<option value="${item.id}" ${selected}>${item.he_dao_tao}</option>`;
                });
                row.find(".he_dao_tao-cell").html(`<select class="form-control">${options}</select>`);
              }
            },
            error: function (error) {
              console.error("L·ªói khi t·∫£i danh s√°ch h·ªá ƒë√†o t·∫°o:", error);
            }
          });

          // Chuy·ªÉn text th√†nh combobox cho HocVi
          row.find(".HocVi-cell").html(`
            <select class="form-control">
              <option value="C·ª≠ nh√¢n" ${originalValues[STT].HocVi === "C·ª≠ nh√¢n" ? "selected" : ""
            }>C·ª≠ nh√¢n</option>

              <option value="K·ªπ s∆∞" ${originalValues[STT].HocVi === "K·ªπ s∆∞" ? "selected" : ""
            }>K·ªπ s∆∞</option>

              <option value="Th·∫°c sƒ©" ${originalValues[STT].HocVi === "Th·∫°c sƒ©" ? "selected" : ""
            }>Th·∫°c sƒ©</option>

              <option value="Ti·∫øn sƒ©" ${originalValues[STT].HocVi === "Ti·∫øn sƒ©" ? "selected" : ""
            }>Ti·∫øn sƒ©</option>

              <option value="Ph√≥ gi√°o s∆∞" ${originalValues[STT].HocVi === "Ph√≥ gi√°o s∆∞" ? "selected" : ""
            }>Ph√≥ gi√°o s∆∞</option>

              <option value="Gi√°o s∆∞" ${originalValues[STT].HocVi === "Gi√°o s∆∞" ? "selected" : ""
            }>Gi√°o s∆∞</option>

              <option value="Ti·∫øng kh∆°-me" ${originalValues[STT].HocVi === "Ti·∫øng kh∆°-me" ? "selected" : ""
            }>Ti·∫øng kh∆°-me</option>

              <option value="V√µ s∆∞" ${originalValues[STT].HocVi === "V√µ s∆∞" ? "selected" : ""
            }>V√µ s∆∞</option>
            </select>
          `);


          // Gi·ªØ nguy√™n input cho SoTien
          row.find(".SoTien-cell").html(`
                <input type="number" class="form-control" value="${parseFloat(
            originalValues[STT].SoTien.replace(/[^0-9-]+/g, "")
          )}">
            `);

          // Chuy·ªÉn text th√†nh combobox cho ƒê·ªô ∆∞u ti√™n
          let uuTienOptions = '';
          for (let i = 0; i <= 5; i++) {
            const selected =
              Number(originalValues[STT].do_uu_tien) === i ? 'selected' : '';
            uuTienOptions += `<option value="${i}" ${selected}>${i}</option>`;
          }
          row
            .find(".do_uu_tien-cell")
            .html(`<select class="form-control">${uuTienOptions}</select>`);

          // Chuy·ªÉn text th√†nh input cho HSL
          row.find(".HSL-cell").html(`
            <input
              type="number"
              step="0.01"
              min="0"
              class="form-control"
              value="${parseFloat(originalValues[STT].HSL) || 0}"
            />
          `);


          // Chuy·ªÉn text th√†nh combobox cho Ch·ª©c danh
          $.ajax({
            url: "/api/gvm/v1/chuc-danh-nghe-nghiep-admin",
            method: "GET",
            success: function (response) {
              if (response.success && response.data) {
                let options = '';

                response.data.forEach(function (item) {
                  const selected =
                    item.id == originalValues[STT].chuc_danh_id ? 'selected' : '';

                  options += `
                    <option value="${item.id}" ${selected}>
                      ${item.chuc_danh}
                    </option>
                  `;
                });

                row
                  .find(".chuc_danh-cell")
                  .html(`<select class="form-control">${options}</select>`);
              }
            },
            error: function (err) {
              console.error("L·ªói khi t·∫£i danh s√°ch ch·ª©c danh:", err);
            },
          });


          // Th√™m n√∫t Save v√† Cancel v√†o cell cu·ªëi
          const actionCell = row.find("td:last-child");
          actionCell.html(`
                <button class="save-btn btn btn-success btn-sm">L∆∞u</button>
                <button class="cancel-btn btn btn-danger btn-sm ms-2">H·ªßy</button>
            `);

          // ·∫®n n√∫t Edit
          $(this).hide();
        });

        // X·ª≠ l√Ω khi nh·∫•n n√∫t Save
        $(document).on("click", ".save-btn", function () {
          const row = $(this).closest("tr");
          const STT = row.data("id");

          const updatedData = {
            he_dao_tao: row.find(".he_dao_tao-cell select").val(),
            HocVi: row.find(".HocVi-cell select").val(),
            SoTien: row.find(".SoTien-cell input").val(),
            do_uu_tien: row.find(".do_uu_tien-cell select").val(),
            hsl: row.find(".HSL-cell input").val(),
            chuc_danh_id: row.find(".chuc_danh-cell select").val(),
          };

          debugger
          console.log(updatedData)

          const he_dao_tao_text =
            row.find(".he_dao_tao-cell select option:selected").text();

          const chuc_danh_text =
            row.find(".chuc_danh-cell select option:selected").text();

          $.ajax({
            url: `/tienluong/${STT}`,
            method: "PUT",
            contentType: "application/json",
            data: JSON.stringify(updatedData),
            success: function (response) {
              // C·∫≠p nh·∫≠t giao di·ªán
              row.find(".he_dao_tao-cell").text(he_dao_tao_text);
              row.find(".HocVi-cell").text(updatedData.HocVi);
              row.find(".SoTien-cell").text(
                new Intl.NumberFormat("vi-VN", {
                  style: "currency",
                  currency: "VND",
                }).format(updatedData.SoTien)
              );
              row.find(".do_uu_tien-cell").text(updatedData.do_uu_tien);
              row.find(".HSL-cell").text(updatedData.hsl);
              row.find(".chuc_danh-cell").text(chuc_danh_text);

              // üëâ ƒê·∫∂T ·ªû ƒê√ÇY
              row.data("he-dao-tao-id", updatedData.he_dao_tao);
              row.data("chuc-danh-id", updatedData.chuc_danh_id);

              const actionCell = row.find("td:last-child");
              actionCell.html(`
                        <button class="bi bi-pencil action-button edit-btn"></button>
                        <button class="bi bi-trash3 action-button me-2" onclick="deleteTienLuong(this, '${STT}')"></button>
                    `);

              Swal.fire({
                title: "Th√¥ng b√°o",
                html: "C·∫≠p nh·∫≠t th√†nh c√¥ng!",
                icon: "success",
                width: "auto",
                padding: "20px",
                timer: 2000,
                timerProgressBar: true,
                showConfirmButton: false,
              });
            },
            error: function (error) {
              Swal.fire({
                title: "Th√¥ng b√°o",
                html: "C√≥ l·ªói x·∫£y ra khi c·∫≠p nh·∫≠t",
                icon: "error",
                width: "auto",
                padding: "20px",
                timer: 2000,
                timerProgressBar: true,
                showConfirmButton: false,
              });
            },
          });
        });

        // X·ª≠ l√Ω khi nh·∫•n n√∫t Cancel
        $(document).on("click", ".cancel-btn", function () {
          const row = $(this).closest("tr");
          const STT = row.data("id");

          // Kh√¥i ph·ª•c gi√° tr·ªã g·ªëc
          row.find(".he_dao_tao-cell").text(originalValues[STT].he_dao_tao);
          row.find(".HocVi-cell").text(originalValues[STT].HocVi);
          row.find(".SoTien-cell").text(originalValues[STT].SoTien);
          row.find(".he_dao_tao-cell").text(originalValues[STT].he_dao_tao);
          row.find(".do_uu_tien-cell").text(originalValues[STT].do_uu_tien);
          row.find(".HSL-cell").text(originalValues[STT].HSL);
          row.find(".chuc_danh-cell").text(originalValues[STT].chuc_danh_text);


          // Kh√¥i ph·ª•c n√∫t Edit
          const actionCell = row.find("td:last-child");
          actionCell.html(`
                <button class="bi bi-pencil action-button edit-btn"></button>
                <button class="bi bi-trash3 action-button me-2" 
                    onclick="deleteTienLuong(this, '${STT}')">
                </button>
            `);
        });

        // Handler for M·ªùi Gi·∫£ng tab
        $("#addButtonMoiGiang").click(function (event) {
          event.preventDefault();
          const he_dao_tao = $("#he_dao_tao_mg").val();
          const hocVi = $("#HocVi_mg").val();
          const soTien = $("#SoTien_mg").val();
          const hsl = $("#hsl_mg").val();
          const do_uu_tien = $("#do_uu_tien_mg").val();
          const chuc_danh_id = $("#chuc_danh_mg").val();
          addNewEntry(he_dao_tao, hocVi, soTien, do_uu_tien, hsl, chuc_danh_id, 'm·ªùi gi·∫£ng');
        });

        // Handler for ƒê·ªì √Ån tab
        $("#addButtonDoAn").click(function (event) {
          event.preventDefault();
          const he_dao_tao = $("#he_dao_tao_da").val();
          const hocVi = $("#HocVi_da").val();
          const soTien = $("#SoTien_da").val();
          const hsl = $("#hsl_da").val();
          const do_uu_tien = $("#do_uu_tien_da").val();
          const chuc_danh_id = $("#chuc_danh_da").val();
          addNewEntry(he_dao_tao, hocVi, soTien, do_uu_tien, hsl, chuc_danh_id, 'ƒë·ªì √°n');
        });

        function addNewEntry(he_dao_tao, hocVi, soTien, do_uu_tien, hsl, chuc_danh_id, loai_hinh) {
          const khoa = 'ALL';
          $.ajax({
            url: "/tienluong",
            method: "POST",
            contentType: "application/json",
            data: JSON.stringify({
              he_dao_tao,
              HocVi: hocVi,
              SoTien: soTien,
              do_uu_tien,
              khoa,
              hsl,
              chuc_danh_id,
              loai_hinh
            }),
            success: function (response) {
              Swal.fire({
                title: "Th√¥ng b√°o",
                html: "Th√™m m·ªõi th√†nh c√¥ng!",
                icon: "success",
                width: "auto",
                padding: "20px",
                timer: 2000,
                timerProgressBar: true,
                showConfirmButton: false,
              }).then(() => {
                location.reload();
              });
            },
            error: function (error) {
              Swal.fire({
                title: "Th√¥ng b√°o",
                html: "C√≥ l·ªói x·∫£y ra khi th√™m m·ªõi",
                icon: "error",
                width: "auto",
                padding: "20px",
                timer: 2000,
                timerProgressBar: true,
                showConfirmButton: false,
              });
            },
          });
        }

        let sortAsc = true;
        $("#sortHeDaoTao").click(function () {
          let rows = $("#data-table-body tr").get();
          rows.sort(function (a, b) {
            let keyA = $(a).find(".he_dao_tao-cell").text().toUpperCase();
            let keyB = $(b).find(".he_dao_tao-cell").text().toUpperCase();
            if (keyA < keyB) return sortAsc ? -1 : 1;
            if (keyA > keyB) return sortAsc ? 1 : -1;
            return 0;
          });
          $.each(rows, function (index, row) {
            $("#data-table-body").append(row);
            $(row)
              .find("td:first")
              .text(index + 1); // c·∫≠p nh·∫≠t l·∫°i STT
          });
          sortAsc = !sortAsc;
          $("#sortIcon").text(sortAsc ? "‚áÖ" : "‚áµ");
        });
      });

      function deleteTienLuong(button, STT) {
        Swal.fire({
          title: "X√°c nh·∫≠n",
          html: "B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a kh√¥ng?",
          icon: "warning",
          showCancelButton: true,
          confirmButtonText: "ƒê·ªìng √Ω",
          cancelButtonText: "H·ªßy",
          width: "auto",
          padding: "20px",
        }).then((result) => {
          if (result.isConfirmed) {
            fetch(`/tienluong/${STT}`, {
              method: "DELETE",
              headers: {
                "Content-Type": "application/json",
              },
            })
              .then((response) => {
                if (response.ok) {
                  Swal.fire({
                    title: "Th√¥ng b√°o",
                    html: "X√≥a th√†nh c√¥ng!",
                    icon: "success",
                    width: "auto",
                    padding: "20px",
                    timer: 2000,
                    timerProgressBar: true,
                    showConfirmButton: false,
                  }).then(() => {
                    button.closest("tr").remove();
                  });
                } else {
                  return response.text().then((text) => {
                    Swal.fire({
                      title: "Th√¥ng b√°o",
                      html: "C√≥ l·ªói x·∫£y ra khi x√≥a",
                      icon: "error",
                      width: "auto",
                      padding: "20px",
                      timer: 2000,
                      timerProgressBar: true,
                      showConfirmButton: false,
                    });
                  });
                }
              })
              .catch((error) => {
                Swal.fire({
                  title: "Th√¥ng b√°o",
                  html: "C√≥ l·ªói x·∫£y ra: " + error.message,
                  icon: "error",
                  width: "auto",
                  padding: "20px",
                  timer: 2000,
                  timerProgressBar: true,
                  showConfirmButton: false,
                });
              });
          }
        });
      }
    </script>
</body>

</html>