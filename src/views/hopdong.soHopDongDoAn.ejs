<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Học Viện Kỹ Thuật Mật Mã</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" />
  <link rel="stylesheet" href="/css/styles.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css" />

  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <!-- SweetAlert2 CSS -->
  <link href="https://cdn.jsdelivr.net/npm/sweetalert2@11.6.16/dist/sweetalert2.min.css" rel="stylesheet" />
  <!-- SweetAlert2 JavaScript -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.6.16/dist/sweetalert2.all.min.js"></script>

  <!-- Link thư viện tabulator -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/tabulator/5.5.2/css/tabulator.min.css" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/tabulator/5.5.2/js/tabulator.min.js"></script>

  <!-- Custom CSS for better alignment -->
  <style>
    .loc {
      align-items: center;
      gap: 8px;
    }

    .selectop {
      height: 38px;
      vertical-align: middle;
    }

    .btn {
      vertical-align: middle;
    }

    #view {
      margin-top: 15px;
    }

    .doan-type-display {
      padding: 10px;
      border-radius: 8px;
      transition: all 0.3s ease;
    }
    
    #doanTypeIndicator {
      transition: all 0.3s ease;
      font-size: 1rem;
    }
  </style>
</head>

<body>
  <!-- Phần header -->
  <%- include('header') %>

    <div class="container-fluid my-4" style="padding-left: 20px">
      <div class="flex-grow-1">

        <!-- Filter Section -->
        <div class="header-actions">
          <div class="right" style="margin-top: 0px">
            <div class="loc d-flex align-items-center">
              <select class="selectop" id="combobox-dot" style="width: 70px">
                <option value="">Đợt</option>
              </select>
              <select class="selectop" id="comboboxki" style="width: 70px">
                <option value="">Kì</option>
              </select>
              <select class="selectop" id="NamHoc">
                <option value="">Chọn năm học</option>
              </select>
              <select class="selectop" id="MaPhongBan">
                <option value="ALL">Tất cả khoa</option>
              </select>
              <button type="button" class="btn btn-primary btn-sm" id="view" onclick="loadDoAnContracts()">
                <i class="fas fa-search"></i> Hiển thị
              </button>
            </div>
          </div>
        </div>

        <!-- Thesis Project Summary Section -->
        <div class="content-section mt-4">
          <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
              <h5 class="mb-0">
                <i class="fas fa-chart-bar me-2"></i>Tổng hợp số quyết định đồ án
              </h5>
              <div>
                <button type="button" class="btn btn-primary btn-sm" onclick="loadDoAnUnifiedSummary()">
                  <i class="fas fa-sync me-2"></i>Xem tổng hợp
                </button>
              </div>
            </div>
            <div class="card-body">
              <!-- Unified Summary Table for Thesis Projects -->
              <div id="doanUnifiedSummaryDiv" style="display: none;">
                <div class="table-responsive">
                  <table class="table table-striped table-hover table-sm" id="doanUnifiedSummaryTable">
                    <thead class="table-dark">
                      <tr>
                        <th>STT</th>
                        <th>Khoa</th>
                        <th>Số lượng</th>
                        <th>Số QĐ đầu tiên</th>
                        <th>Số QĐ cuối cùng</th>
                        <th>TT đầu tiên</th>
                        <th>TT cuối cùng</th>
                      </tr>
                    </thead>
                    <tbody id="doanUnifiedSummaryTableBody">
                    </tbody>
                  </table>
                </div>
              </div>

              <!-- No summary data message -->
              <div id="noDoAnSummaryMessage" class="text-center py-4" style="display: block;">
                <i class="fas fa-info-circle fa-3x text-muted mb-3"></i>
                <h5 class="text-muted">Nhấn nút "Xem tổng hợp" để xem thống kê số quyết định đồ án theo khoa</h5>
              </div>
            </div>
          </div>
        </div>

        <!-- Thesis Project Setup Section -->
        <div class="content-section mt-4" id="doanSetupOptions">
          <div class="card">
            <div class="card-header">
              <h5 class="mb-0">
                <i class="fas fa-cog me-2"></i>Tạo số quyết định đồ án
              </h5>
            </div>
            <div class="card-body">
              <!-- Instruction message -->
              <div id="doanSetupInstruction" class="alert alert-info">
                <i class="fas fa-info-circle me-2"></i>
                <strong>Hướng dẫn:</strong> Vui lòng chọn điều kiện lọc (Đợt, Kì, Năm) ở phần trên và nhấn "Hiển thị" để
                xem danh sách đồ án trước khi tạo số quyết định.
              </div>

              <!-- Preview Examples -->
              <div class="row mb-3">
                <div class="col-12">
                  <div class="alert alert-success">
                    <div class="row">
                      <div class="col-md-6">
                        <div class="d-flex align-items-center">
                          <i class="fas fa-file-alt text-primary me-2"></i>
                          <span><strong>Số quyết định (ví dụ):</strong> <span id="doanDecisionPreview">001/QĐ-ĐA</span></span>
                        </div>
                      </div>
                      <div class="col-md-6">
                        <div class="d-flex align-items-center">
                          <i class="fas fa-sort-numeric-up text-info me-2"></i>
                          <span><strong>Thứ tự tương ứng:</strong> <span id="doanTTPreview">1</span></span>
                        </div>
                      </div>
                    </div>
                    <small class="text-muted mt-2 d-block">
                      <i class="fas fa-arrow-right me-1"></i>
                      Mỗi đồ án sẽ nhận được cùng một chỉ số (001, 002, 003...) cho cả số quyết định và thứ tự
                    </small>
                  </div>
                </div>
              </div>

              <!-- Setup Controls -->
              <div class="row">
                <div class="col-md-4">
                  <label for="doanUnifiedStartingNumber" class="form-label">
                    <i class="fas fa-play me-1"></i>Số bắt đầu:
                  </label>
                  <input type="number" class="form-control" id="doanUnifiedStartingNumber" value="1" min="1"
                    onchange="updateDoAnNumberPreview()">
                </div>
                <div class="col-md-8 d-flex align-items-end">
                  <div class="btn-group" role="group">
                    <button type="button" class="btn btn-outline-primary" onclick="previewDoAnSynchronizedSetup()">
                      <i class="fas fa-eye me-2"></i>Xem trước
                    </button>
                    <button type="button" class="btn btn-success" onclick="executeDoAnSynchronizedSetup()">
                      <i class="fas fa-cog me-2"></i>Thực hiện tạo số
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Main content area -->
        <div class="content-section mt-4">
          <div class="card">
            <div class="card-header">
              <h5 class="mb-0">
                <i class="fas fa-graduation-cap me-2"></i>Danh sách đồ án
              </h5>
            </div>
            <div class="card-body">
              <!-- Results Table -->
              <div id="doanResultsDiv" style="display: none;">
                <div class="table-responsive">
                  <table class="table table-striped table-hover" id="doanTable">
                    <thead class="table-dark">
                      <tr>
                        <th>STT</th>
                        <th>Sinh viên</th>
                        <th>Mã SV</th>
                        <th>Khoa</th>
                        <th>Giảng viên</th>
                        <th>Tên đề tài</th>
                        <th>Số QĐ</th>
                        <th>TT</th>
                        <th>Số tiết</th>
                        <th>HD chính</th>
                      </tr>
                    </thead>
                    <tbody id="doanTableBody">
                    </tbody>
                  </table>
                </div>
              </div>

              <!-- No data message -->
              <div id="noDoanDataMessage" class="text-center py-4" style="display: block;">
                <i class="fas fa-info-circle fa-3x text-muted mb-3"></i>
                <h5 class="text-muted">Chọn điều kiện lọc và nhấn "Hiển thị" để xem danh sách đồ án</h5>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Success/Error Messages -->
    <div class="toast-container position-fixed bottom-0 end-0 p-3">
      <div id="successToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="toast-header bg-success text-white">
          <strong class="me-auto">Thành công</strong>
        </div>
        <div class="toast-body" id="successMessage"></div>
      </div>

      <div id="errorToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="toast-header bg-danger text-white">
          <strong class="me-auto">Lỗi</strong>
        </div>
        <div class="toast-body" id="errorMessage"></div>
      </div>
    </div>

    <!-- Common scripts -->
    <script src="/js/moigiang/href.js"></script>
    <script src="/js/moigiang/getdata.js"></script>
    <script src="/js/moigiang/hideBtn.js"></script>

    <!-- Thesis project specific script -->
    <script>
      // Update the number format preview for thesis projects
      function updateDoAnNumberPreview() {
        const startingNumber = parseInt($('#doanUnifiedStartingNumber').val()) || 1;
        const decisionNumber = String(startingNumber).padStart(3, '0') + '/QĐ-ĐA';
        const ttNumber = startingNumber;

        // Update preview examples
        $('#doanDecisionPreview').text(decisionNumber);
        $('#doanTTPreview').text(ttNumber);
      }

      // Load thesis projects based on filter criteria
      function loadDoAnContracts() {
        const dot = $('#combobox-dot').val();
        const ki = $('#comboboxki').val();
        const nam = $('#NamHoc').val();
        const khoa = $('#MaPhongBan').val();

        if (!dot || !ki || !nam) {
          Swal.fire({
            title: 'Thiếu thông tin',
            text: 'Vui lòng chọn đầy đủ đợt, kì và năm học',
            icon: 'warning'
          });
          return;
        }

        showLoading(true);

        $.ajax({
          url: '/api/doan-list',
          method: 'GET',
          data: { dot, ki, nam, khoa },
          success: function(response) {
            if (response.success) {
              displayDoAnContracts(response.data);
              $('#doanSetupInstruction').hide();
            } else {
              showError(response.message);
            }
          },
          error: function() {
            showError('Lỗi khi tải danh sách đồ án');
          },
          complete: function() {
            showLoading(false);
          }
        });
      }

      // Display thesis projects in table
      function displayDoAnContracts(contracts) {
        $('#doanResultsDiv').show();
        $('#noDoanDataMessage').hide();

        const tbody = $('#doanTableBody');
        tbody.empty();

        if (contracts.length === 0) {
          tbody.append(`
            <tr>
              <td colspan="10" class="text-center text-muted">
                <i class="fas fa-inbox"></i> Không có dữ liệu đồ án nào
              </td>
            </tr>
          `);
          return;
        }

        contracts.forEach((contract, index) => {
          const row = `
            <tr>
              <td>${index + 1}</td>
              <td>${contract.SinhVien || 'N/A'}</td>
              <td>${contract.MaSV || 'N/A'}</td>
              <td>${contract.Khoa || 'N/A'}</td>
              <td>${contract.GiangVien || 'N/A'}</td>
              <td>${contract.TenDeTai || 'N/A'}</td>
              <td>${contract.SoQD || '<span class="text-muted">Chưa có</span>'}</td>
              <td>${contract.TT || '<span class="text-muted">Chưa có</span>'}</td>
              <td>${contract.SoTiet || 'N/A'}</td>
              <td>${contract.isHDChinh ? '<span class="badge bg-success">Có</span>' : '<span class="badge bg-secondary">Không</span>'}</td>
            </tr>
          `;
          tbody.append(row);
        });
      }

      // Load thesis project unified summary
      function loadDoAnUnifiedSummary() {
        const dot = $('#combobox-dot').val();
        const ki = $('#comboboxki').val();
        const nam = $('#NamHoc').val();
        const khoa = $('#MaPhongBan').val();

        showLoading(true);

        $.ajax({
          url: '/api/doan-unified-summary',
          method: 'GET',
          data: { dot, ki, nam, khoa },
          success: function(response) {
            if (response.success) {
              displayDoAnUnifiedSummary(response.data);
            } else {
              showError(response.message);
            }
          },
          error: function() {
            showError('Lỗi khi tải tổng hợp đồ án');
          },
          complete: function() {
            showLoading(false);
          }
        });
      }

      // Display thesis project unified summary
      function displayDoAnUnifiedSummary(summaryData) {
        $('#doanUnifiedSummaryDiv').show();
        $('#noDoAnSummaryMessage').hide();

        const tbody = $('#doanUnifiedSummaryTableBody');
        tbody.empty();

        if (summaryData.length === 0) {
          tbody.append(`
            <tr>
              <td colspan="7" class="text-center text-muted">
                <i class="fas fa-inbox"></i> Không có dữ liệu tổng hợp
              </td>
            </tr>
          `);
          return;
        }

        summaryData.forEach((item, index) => {
          const row = `
            <tr>
              <td>${index + 1}</td>
              <td>${item.khoa}</td>
              <td>${item.count}</td>
              <td>${item.firstDecision || '<span class="text-muted">Chưa có</span>'}</td>
              <td>${item.lastDecision || '<span class="text-muted">Chưa có</span>'}</td>
              <td>${item.firstTT || '<span class="text-muted">Chưa có</span>'}</td>
              <td>${item.lastTT || '<span class="text-muted">Chưa có</span>'}</td>
            </tr>
          `;
          tbody.append(row);
        });
      }

      // Preview thesis project synchronized setup
      function previewDoAnSynchronizedSetup() {
        const dot = $('#combobox-dot').val();
        const ki = $('#comboboxki').val();
        const nam = $('#NamHoc').val();
        const khoa = $('#MaPhongBan').val();
        const startingNumber = parseInt($('#doanUnifiedStartingNumber').val()) || 1;

        if (!dot || !ki || !nam) {
          Swal.fire({
            title: 'Thiếu thông tin',
            text: 'Vui lòng chọn đầy đủ đợt, kì và năm học',
            icon: 'warning'
          });
          return;
        }

        if (!startingNumber || startingNumber < 1) {
          Swal.fire({
            title: 'Số bắt đầu không hợp lệ',
            text: 'Vui lòng nhập số bắt đầu lớn hơn 0',
            icon: 'warning'
          });
          return;
        }

        showLoading(true);

        $.ajax({
          url: '/api/preview-doan-synchronized-setup',
          method: 'POST',
          contentType: 'application/json',
          data: JSON.stringify({ dot, ki, nam, khoa, startingNumber }),
          success: function(response) {
            if (response.success) {
              displayDoAnSynchronizedPreviewResults(response.data);
            } else {
              showError(response.message);
            }
          },
          error: function() {
            showError('Lỗi khi xem trước setup đồ án');
          },
          complete: function() {
            showLoading(false);
          }
        });
      }

      // Display thesis project synchronized preview results
      function displayDoAnSynchronizedPreviewResults(contracts) {
        if (contracts.length === 0) {
          Swal.fire({
            title: 'Không có dữ liệu',
            text: 'Không tìm thấy đồ án nào phù hợp điều kiện',
            icon: 'info'
          });
          return;
        }

        let previewHtml = `
          <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
            <table class="table table-sm table-striped">
              <thead class="table-dark sticky-top">
                <tr>
                  <th>STT</th>
                  <th>Sinh viên</th>
                  <th>Khoa</th>
                  <th>Giảng viên</th>
                  <th>Số QĐ mới</th>
                  <th>TT mới</th>
                </tr>
              </thead>
              <tbody>
        `;

        contracts.forEach((contract, index) => {
          previewHtml += `
            <tr>
              <td>${index + 1}</td>
              <td>${contract.SinhVien}</td>
              <td>${contract.Khoa}</td>
              <td>${contract.GiangVien}</td>
              <td><strong class="text-success">${contract.newSoQD}</strong></td>
              <td><strong class="text-info">${contract.newTT}</strong></td>
            </tr>
          `;
        });

        previewHtml += `
              </tbody>
            </table>
          </div>
        `;

        Swal.fire({
          title: `Xem trước tạo số cho ${contracts.length} đồ án`,
          html: previewHtml,
          width: '80%',
          showCancelButton: true,
          confirmButtonText: 'Thực hiện tạo số',
          cancelButtonText: 'Hủy',
          confirmButtonColor: '#28a745'
        }).then((result) => {
          if (result.isConfirmed) {
            performDoAnSynchronizedSetup();
          }
        });
      }

      // Execute thesis project synchronized setup
      function executeDoAnSynchronizedSetup() {
        const dot = $('#combobox-dot').val();
        const ki = $('#comboboxki').val();
        const nam = $('#NamHoc').val();
        const khoa = $('#MaPhongBan').val();
        const startingNumber = parseInt($('#doanUnifiedStartingNumber').val()) || 1;

        if (!dot || !ki || !nam) {
          Swal.fire({
            title: 'Thiếu thông tin',
            text: 'Vui lòng chọn đầy đủ đợt, kì và năm học',
            icon: 'warning'
          });
          return;
        }

        Swal.fire({
          title: 'Xác nhận tạo số',
          text: 'Bạn có chắc chắn muốn tạo số quyết định cho các đồ án đã chọn?',
          icon: 'question',
          showCancelButton: true,
          confirmButtonText: 'Có, tạo số',
          cancelButtonText: 'Hủy'
        }).then((result) => {
          if (result.isConfirmed) {
            performDoAnSynchronizedSetup();
          }
        });
      }

      // Perform the actual thesis project synchronized setup
      function performDoAnSynchronizedSetup() {
        const dot = $('#combobox-dot').val();
        const ki = $('#comboboxki').val();
        const nam = $('#NamHoc').val();
        const khoa = $('#MaPhongBan').val();
        const startingNumber = parseInt($('#doanUnifiedStartingNumber').val()) || 1;

        showLoading(true);

        $.ajax({
          url: '/api/setup-doan-synchronized-numbers',
          method: 'POST',
          contentType: 'application/json',
          data: JSON.stringify({ dot, ki, nam, khoa, startingNumber }),
          success: function(response) {
            if (response.success) {
              showSuccess(response.message);
              // Reload the contracts list to show updated numbers
              loadDoAnContracts();
            } else {
              showError(response.message);
            }
          },
          error: function() {
            showError('Lỗi khi tạo số quyết định đồ án');
          },
          complete: function() {
            showLoading(false);
          }
        });
      }

      // Utility functions
      function showLoading(show) {
        if (show) {
          $('body').append('<div id="loadingOverlay" class="position-fixed top-0 start-0 w-100 h-100 bg-dark bg-opacity-50 d-flex justify-content-center align-items-center" style="z-index: 9999;"><div class="spinner-border text-light" role="status"><span class="visually-hidden">Loading...</span></div></div>');
        } else {
          $('#loadingOverlay').remove();
        }
      }

      function showSuccess(message) {
        $('#successMessage').text(message);
        const toast = new bootstrap.Toast($('#successToast')[0]);
        toast.show();
      }

      function showError(message) {
        $('#errorMessage').text(message);
        const toast = new bootstrap.Toast($('#errorToast')[0]);
        toast.show();
      }

      // Initialize on page load
      $(document).ready(function() {
        updateDoAnNumberPreview();
        
        // Update preview when starting number changes
        $('#doanUnifiedStartingNumber').on('input', updateDoAnNumberPreview);
      });
    </script>
</body>

</html>
