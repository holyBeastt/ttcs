<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Học Viện Kỹ Thuật Mật Mã</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" />
  <link rel="stylesheet" href="/css/styles.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css" />

  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <!-- SweetAlert2 CSS -->
  <link href="https://cdn.jsdelivr.net/npm/sweetalert2@11.6.16/dist/sweetalert2.min.css" rel="stylesheet" />
  <!-- SweetAlert2 JavaScript -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.6.16/dist/sweetalert2.all.min.js"></script>

  <!-- Link thư viện tabulator -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/tabulator/5.5.2/css/tabulator.min.css" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/tabulator/5.5.2/js/tabulator.min.js"></script>

  <!-- Custom CSS for better alignment -->
  <style>
    .loc {
      align-items: center;
      gap: 8px;
    }

    .selectop {
      height: 38px;
      vertical-align: middle;
    }

    .btn {
      vertical-align: middle;
    }

    #view {
      margin-top: 15px;
    }

    .doan-type-display {
      padding: 10px;
      border-radius: 8px;
      transition: all 0.3s ease;
    }

    #doanTypeIndicator {
      transition: all 0.3s ease;
      font-size: 1rem;
    }
  </style>
</head>

<body>
  <!-- Phần header -->
  <%- include('header') %>

    <div class="container-fluid my-4" style="padding-left: 20px">
      <div class="flex-grow-1"> <!-- Filter Section -->
        <div class="header-actions">
          <div class="right" style="margin-top: 0px">            <div class="loc d-flex align-items-center">
              <select class="selectop" id="combobox-dot" style="width: 70px">
                <option value="">Đợt</option>
              </select>
              <select class="selectop" id="comboboxki" style="width: 70px">
                <option value="">Kì</option>
              </select>
              <select class="selectop" id="NamHoc">
                <option value="">Chọn năm học</option>
              </select>
              <select class="selectop" id="MaPhongBan">
                <option value="ALL">Tất cả khoa</option>
              </select>
              <button type="button" class="btn btn-primary btn-sm" id="view" onclick="loadDoAnContracts()">
                <i class="fas fa-search"></i> Hiển thị
              </button>
            </div>
          </div>
        </div> <!-- Unified Contract & Termination Numbers Summary Section -->
        <div class="content-section mt-4">
          <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
              <h5 class="mb-0">
                <i class="fas fa-chart-bar me-2"></i>Tổng hợp số hợp đồng & thanh lý đồ án
              </h5>
              <div>
                <button type="button" class="btn btn-primary btn-sm" onclick="loadDoAnUnifiedSummary()">
                  <i class="fas fa-sync me-2"></i>Xem tổng hợp
                </button>
              </div>
            </div>
            <div class="card-body">
              <!-- Unified Summary Table for Thesis Projects -->
              <div id="doanUnifiedSummaryDiv" style="display: none;">
                <div class="table-responsive">
                  <table class="table table-striped table-hover table-sm" id="doanUnifiedSummaryTable">
                    <thead class="table-dark">
                      <tr>
                        <th>STT</th>
                        <th>Khoa</th>
                        <th>Số HĐ đầu tiên</th>
                        <th>Số HĐ cuối cùng</th>
                        <th>Số TLHĐ đầu tiên</th>
                        <th>Số TLHĐ cuối cùng</th>
                      </tr>
                    </thead>
                    <tbody id="doanUnifiedSummaryTableBody">
                    </tbody>
                  </table>
                </div>
              </div>

              <!-- No summary data message -->
              <div id="noDoAnSummaryMessage" class="text-center py-4" style="display: block;">
                <i class="fas fa-info-circle fa-3x text-muted mb-3"></i>
                <h5 class="text-muted">Nhấn nút "Xem tổng hợp" để xem thống kê số hợp đồng & thanh lý đồ án theo khoa
                </h5>
              </div>
            </div>
          </div>
        </div> <!-- Unified Setup Section -->
        <div class="content-section mt-4" id="doanSetupOptions">
          <div class="card">
            <div class="card-header">
              <h5 class="mb-0">
                <i class="fas fa-cog me-2"></i>Tạo số hợp đồng & thanh lý đồ án
              </h5>
            </div>
            <div class="card-body">
              <!-- Instruction message -->              <div id="doanSetupInstruction" class="alert alert-info">
                <i class="fas fa-info-circle me-2"></i>
                <strong>Hướng dẫn:</strong> Vui lòng chọn điều kiện lọc (Đợt, Kì, Năm) ở phần trên và nhấn "Hiển thị" để
                xem danh sách đồ án trước khi tạo số hợp đồng.
              </div>

              <!-- Preview Examples -->
              <div class="row mb-3">
                <div class="col-12">
                  <div class="alert alert-success">
                    <div class="row">
                      <div class="col-md-6">
                        <div class="d-flex align-items-center">
                          <i class="fas fa-file-contract text-primary me-2"></i>
                          <span><strong>Số hợp đồng (ví dụ):</strong> <span
                              id="doanContractPreview">001/HĐ-ĐA</span></span>
                        </div>
                      </div>
                      <div class="col-md-6">
                        <div class="d-flex align-items-center">
                          <i class="fas fa-file-invoice text-info me-2"></i>
                          <span><strong>Số thanh lý (ví dụ):</strong> <span
                              id="doanTerminationPreview">001/TLHĐ-ĐA</span></span>
                        </div>
                      </div>
                    </div>
                    <small class="text-muted mt-2 d-block">
                      <i class="fas fa-arrow-right me-1"></i>
                      Mỗi đồ án sẽ nhận được cùng một chỉ số (001, 002, 003...) cho cả số hợp đồng và số thanh lý
                    </small>
                  </div>
                </div>
              </div>

              <!-- Setup Controls -->
              <div class="row">
                <div class="col-md-4">
                  <label for="doanUnifiedStartingNumber" class="form-label">
                    <i class="fas fa-play me-1"></i>Số bắt đầu:
                  </label>
                  <input type="number" class="form-control" id="doanUnifiedStartingNumber" value="1" min="1"
                    onchange="updateDoAnNumberPreview()">
                </div>
                <div class="col-md-8 d-flex align-items-end">
                  <div class="btn-group" role="group">
                    <button type="button" class="btn btn-outline-primary" onclick="previewDoAnSynchronizedSetup()">
                      <i class="fas fa-eye me-2"></i>Xem trước khi tạo
                    </button>
                    <button type="button" class="btn btn-success" onclick="executeDoAnSynchronizedSetup()">
                      <i class="fas fa-cog me-2"></i>Tạo
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Main content area -->
        <div class="content-section mt-4">
          <div class="card">
            <div class="card-header">
              <h5 class="mb-0">
                <i class="fas fa-graduation-cap me-2"></i>Danh sách đồ án
              </h5>
            </div>
            <div class="card-body">
              <!-- Results Table -->
              <div id="doanResultsDiv" style="display: none;">
                <div class="table-responsive">
                  <table class="table table-striped table-hover" id="doanTable">
                    <thead class="table-dark" id="doanTableHeader">
                      <tr>
                        <th>STT</th>
                        <th>Họ tên GV</th>
                        <th>Khoa - Hệ đào tạo</th>
                        <th>Số HĐ hiện tại</th>
                        <th>Số TLHĐ hiện tại</th>
                        <th>Số HĐ mới</th>
                        <th>Số TLHĐ mới</th>
                        <th>Số tiết</th>
                      </tr>
                    </thead>
                    <tbody id="doanTableBody">
                    </tbody>
                  </table>
                </div>
              </div>

              <!-- No data message -->              <div id="noDoanDataMessage" class="text-center py-4" style="display: block;">
                <i class="fas fa-info-circle fa-3x text-muted mb-3"></i>
                <h5 class="text-muted">Chọn điều kiện lọc và nhấn "Hiển thị" để xem danh sách đồ án</h5>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Success/Error Messages -->
    <div class="toast-container position-fixed bottom-0 end-0 p-3">
      <div id="successToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="toast-header bg-success text-white">
          <strong class="me-auto">Thành công</strong>
        </div>
        <div class="toast-body" id="successMessage"></div>
      </div>

      <div id="errorToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="toast-header bg-danger text-white">
          <strong class="me-auto">Lỗi</strong>
        </div>
        <div class="toast-body" id="errorMessage"></div>
      </div>
    </div>

    <!-- Common scripts -->
    <script src="/js/moigiang/href.js"></script>
    <script src="/js/moigiang/getdata.js"></script>
    <script src="/js/moigiang/hideBtn.js"></script>    <!-- Thesis project specific script -->
    <script>
      // Update the number format preview for thesis projects
      function updateDoAnNumberPreview() {
        const startingNumber = parseInt($('#doanUnifiedStartingNumber').val()) || 1;
        const contractNumber = String(startingNumber).padStart(3, '0') + '/HĐ-ĐA';
        const terminationNumber = String(startingNumber).padStart(3, '0') + '/TLHĐ-ĐA';

        // Update preview examples
        $('#doanContractPreview').text(contractNumber);
        $('#doanTerminationPreview').text(terminationNumber);
      }

      // Handle thesis project operations (similar to contract site)
      function handleDoAnOperation(operation) {
        switch (operation) {
          case 'load':
            loadDoAnContracts();
            break;
          case 'summary':
            loadDoAnUnifiedSummary();
            break;
          case 'preview':
            previewDoAnSynchronizedSetup();
            break;
          case 'execute':
            executeDoAnSynchronizedSetup();
            break;
        }
      }

      // Load thesis projects based on filter criteria
      function loadDoAnContracts() {
        const dot = $('#combobox-dot').val();
        const ki = $('#comboboxki').val();
        const nam = $('#NamHoc').val();
        const khoa = $('#MaPhongBan').val();

        if (!dot || !ki || !nam) {
          Swal.fire({
            title: 'Thiếu thông tin',
            text: 'Vui lòng chọn đầy đủ đợt, kì và năm học',
            icon: 'warning'
          });
          return;
        }

        showLoading(true);

        $.ajax({
          url: '/api/doan-list',
          method: 'GET',
          data: { dot, ki, nam, khoa },
          success: function (response) {
            if (response.success) {
              displayDoAnContracts(response.data);
              $('#doanSetupInstruction').hide();
            } else {
              showError(response.message);
            }
          },
          error: function () {
            showError('Lỗi khi tải danh sách đồ án');
          },
          complete: function () {
            showLoading(false);
          }
        });
      }

      // Display thesis projects in table (enhanced with proper structure)
      function displayDoAnContracts(contracts) {
        $('#doanResultsDiv').show();
        $('#noDoanDataMessage').hide();

        // Update table header to match the standard format with grouped columns
        const thead = $('#doanTableHeader');
        thead.html(`
          <tr>
            <th>STT</th>
            <th>Họ tên GV</th>
            <th>Khoa - Hệ đào tạo</th>
            <th>Số HĐ hiện tại</th>
            <th>Số TLHĐ hiện tại</th>
            <th>Số HĐ mới</th>
            <th>Số TLHĐ mới</th>
            <th>Số tiết</th>
          </tr>
        `);

        const tbody = $('#doanTableBody');
        tbody.empty();

        if (contracts.length === 0) {
          tbody.append(`
            <tr>
              <td colspan="8" class="text-center text-muted">
                <i class="fas fa-inbox"></i> Không có dữ liệu giảng viên nào
              </td>
            </tr>
          `);
          return;
        }

        // Group contracts by faculty for better display (similar to contract site)
        let currentGroup = '';
        let groupRowSpan = 0;

        contracts.forEach((contract, index) => {
          const groupKey = contract.MaPhongBan || 'Không xác định';
          const groupInfo = `${groupKey} - Đồ án tốt nghiệp`;
          const isNewGroup = groupInfo !== currentGroup;

          if (isNewGroup) {
            currentGroup = groupInfo;
            // Count how many contracts in this group
            groupRowSpan = contracts.filter((c, i) => i >= index &&
              `${(c.MaPhongBan || 'Không xác định')} - Đồ án tốt nghiệp` === groupInfo).length;
          }

          // Current numbers from database - display existing values if they exist
          const currentContractNumber = contract.SoHopDong && contract.SoHopDong !== '' 
            ? `<span class="text-primary">${contract.SoHopDong}</span>` 
            : '<span class="text-muted">Chưa có</span>';

          const currentTerminationNumber = contract.SoThanhLyHopDong && contract.SoThanhLyHopDong !== ''
            ? `<span class="text-info">${contract.SoThanhLyHopDong}</span>`
            : '<span class="text-muted">Chưa có</span>';

          // New numbers: Will be updated during preview
          const newContractNumber = '<span class="text-muted">Chưa tạo</span>';
          const newTerminationNumber = '<span class="text-muted">Chưa tạo</span>';

          const row = `
            <tr ${isNewGroup ? 'class="table-warning"' : ''}>
              <td>${index + 1}</td>
              <td>${contract.HoTen || 'N/A'}</td>
              ${isNewGroup ? `<td rowspan="${groupRowSpan}" class="text-center align-middle bg-light"><strong>${groupInfo}</strong></td>` : ''}
              <td>${currentContractNumber}</td>
              <td>${currentTerminationNumber}</td>
              <td>${newContractNumber}</td>
              <td>${newTerminationNumber}</td>
              <td>${contract.SoTiet || 'N/A'}</td>
            </tr>
          `;
          tbody.append(row);
        });
      }

      // Load thesis project unified summary
      function loadDoAnUnifiedSummary() {
        const dot = $('#combobox-dot').val();
        const ki = $('#comboboxki').val();
        const nam = $('#NamHoc').val();
        const khoa = $('#MaPhongBan').val();

        showLoading(true);

        $.ajax({
          url: '/api/doan-unified-summary',
          method: 'GET',
          data: { dot, ki, nam, khoa },
          success: function (response) {
            if (response.success) {
              displayDoAnUnifiedSummary(response.data);
            } else {
              showError(response.message);
            }
          },
          error: function () {
            showError('Lỗi khi tải tổng hợp đồ án');
          },
          complete: function () {
            showLoading(false);
          }        });
      }

      // Display thesis project unified summary
      function displayDoAnUnifiedSummary(summaryData) {
        $('#doanUnifiedSummaryDiv').show();
        $('#noDoAnSummaryMessage').hide();

        const tbody = $('#doanUnifiedSummaryTableBody');
        tbody.empty();

        if (summaryData.length === 0) {
          tbody.append(`
            <tr>
              <td colspan="6" class="text-center text-muted">
                <i class="fas fa-inbox"></i> Không có dữ liệu tổng hợp
              </td>
            </tr>
          `);
          return;
        }

        summaryData.forEach((item, index) => {
          const row = `
            <tr>
              <td>${index + 1}</td>
              <td>${item.khoa}</td>
              <td>${item.firstContract || '<span class="text-muted">Chưa có</span>'}</td>
              <td>${item.lastContract || '<span class="text-muted">Chưa có</span>'}</td>
              <td>${item.firstTermination || '<span class="text-muted">Chưa có</span>'}</td>
              <td>${item.lastTermination || '<span class="text-muted">Chưa có</span>'}</td>
            </tr>
          `;
          tbody.append(row);        });
      }

      // Preview thesis project synchronized setup (enhanced like contract site)
      function previewDoAnSynchronizedSetup() {
        const dot = $('#combobox-dot').val();
        const ki = $('#comboboxki').val();
        const nam = $('#NamHoc').val();
        const khoa = $('#MaPhongBan').val();
        const startingNumber = parseInt($('#doanUnifiedStartingNumber').val()) || 1;

        if (!dot || !ki || !nam) {
          Swal.fire({
            title: 'Thiếu thông tin',
            text: 'Vui lòng chọn đầy đủ đợt, kì và năm học',
            icon: 'warning'
          });
          return;
        }

        if (!startingNumber || startingNumber < 1) {
          Swal.fire({
            title: 'Số bắt đầu không hợp lệ',
            text: 'Vui lòng nhập số bắt đầu lớn hơn 0',
            icon: 'warning'
          });
          return;
        }

        showLoading(true);
        showSuccess('Đang xem trước cài đặt đồng bộ số hợp đồng & thanh lý đồ án...');

        const data = {
          dot: dot,
          ki: ki,
          nam: nam,
          khoa: khoa,
          startingNumber: startingNumber
        };

        $.post('/api/preview-doan-synchronized-setup', data)
          .done(function (response) {
            if (response.success) {
              displayDoAnSynchronizedPreviewResults(response.data);
              showSuccess('Xem trước đồng bộ thành công. Kiểm tra kết quả bên dưới.');
            } else {
              showError(response.message);
            }
          })
          .fail(function () {
            showError('Lỗi khi xem trước cài đặt đồ án');
          })
          .always(function () {
            showLoading(false);
          });
      }

      // Execute thesis project synchronized setup (enhanced confirmation like contract site)
      function executeDoAnSynchronizedSetup() {
        const dot = $('#combobox-dot').val();
        const ki = $('#comboboxki').val();
        const nam = $('#NamHoc').val();
        const khoa = $('#MaPhongBan').val();
        const startingNumber = parseInt($('#doanUnifiedStartingNumber').val()) || 1;

        if (!dot || !ki || !nam) {
          Swal.fire({
            title: 'Thiếu thông tin',
            text: 'Vui lòng chọn đầy đủ đợt, kì và năm học',
            icon: 'warning'
          });
          return;
        }

        if (!startingNumber || startingNumber < 1) {
          Swal.fire({
            title: 'Số bắt đầu không hợp lệ',
            text: 'Vui lòng nhập số bắt đầu lớn hơn 0',
            icon: 'warning'
          });
          return;
        }

        // Enhanced confirmation dialog (similar to contract site)
        const contractExample = String(startingNumber).padStart(3, '0') + '/HĐ-ĐA';
        const terminationExample = String(startingNumber).padStart(3, '0') + '/TLHĐ-ĐA';

        Swal.fire({
          title: 'Xác nhận tạo số đồng bộ đồ án',
          html: `
            <div class="text-start">
              <p><strong>Thông tin cài đặt:</strong></p>
              <ul class="list-unstyled">
                <li><i class="fas fa-calendar-alt text-primary"></i> Đợt: <strong>${dot}</strong></li>
                <li><i class="fas fa-bookmark text-info"></i> Kì: <strong>${ki}</strong></li>
                <li><i class="fas fa-graduation-cap text-success"></i> Năm: <strong>${nam}</strong></li>
                <li><i class="fas fa-building text-warning"></i> Khoa: <strong>${khoa === 'ALL' ? 'Tất cả khoa' : khoa}</strong></li>
              </ul>
              <p><strong>Ví dụ số sẽ được tạo:</strong></p>
              <div class="row">
                <div class="col-6">
                  <div class="d-flex align-items-center">
                    <i class="fas fa-file-contract text-primary me-2"></i>
                    <span>Hợp đồng: <strong class="text-primary">${contractExample}</strong></span>
                  </div>
                </div>
                <div class="col-6">
                  <div class="d-flex align-items-center">
                    <i class="fas fa-file-invoice text-info me-2"></i>
                    <span>Thanh lý: <strong class="text-info">${terminationExample}</strong></span>
                  </div>
                </div>
              </div>
              <div class="alert alert-warning mt-3">
                <i class="fas fa-exclamation-triangle"></i> 
                <strong>Cảnh báo:</strong> Thao tác này sẽ tạo đồng thời cả số hợp đồng và số thanh lý!
              </div>
            </div>
          `,
          icon: 'question',
          showCancelButton: true,
          confirmButtonText: 'Thực hiện đồng bộ',
          cancelButtonText: 'Hủy',
          confirmButtonColor: '#28a745',
          cancelButtonColor: '#dc3545',
          width: '600px'
        }).then((result) => {
          if (result.isConfirmed) {
            performDoAnSynchronizedSetup();
          }
        });
      }

      // Perform the actual synchronized setup (similar to contract site)
      function performDoAnSynchronizedSetup() {
        showLoading(true);

        const data = {
          dot: $('#combobox-dot').val(),
          ki: $('#comboboxki').val(),
          nam: $('#NamHoc').val(),
          khoa: $('#MaPhongBan').val(),
          startingNumber: parseInt($('#doanUnifiedStartingNumber').val()) || 1
        };

        $.post('/api/setup-doan-synchronized-numbers', data)
          .done(function (response) {
            if (response.success) {
              // Enhanced success message (similar to contract site)
              Swal.fire({
                title: 'Thành công!',
                html: `
                  <div class="text-start">
                    <p>Đã cài đặt đồng bộ thành công cho <strong>${response.updatedCount}</strong> đồ án</p>
                    <div class="row mt-3">
                      <div class="col-6">
                        <div class="d-flex align-items-center">
                          <i class="fas fa-file-contract text-primary me-2"></i>
                          <span>Số hợp đồng: <strong class="text-success">${response.updatedCount}</strong></span>
                        </div>
                      </div>
                      <div class="col-6">
                        <div class="d-flex align-items-center">
                          <i class="fas fa-file-invoice text-info me-2"></i>
                          <span>Số thanh lý: <strong class="text-success">${response.updatedCount}</strong></span>
                        </div>
                      </div>
                    </div>
                  </div>
                `,
                icon: 'success',
                confirmButtonText: 'OK'
              }).then(() => {
                // Reload the contracts list to show updated numbers
                loadDoAnContracts();
                // Also reload summary if it was displayed
                if ($('#doanUnifiedSummaryDiv').is(':visible')) {
                  loadDoAnUnifiedSummary();
                }
              });
            } else {
              showError(response.message);
            }
          })
          .fail(function () {
            showError('Lỗi khi tạo số hợp đồng & thanh lý đồ án');
          })
          .always(function () {
            showLoading(false);
          });
      }

      // Display synchronized preview results (enhanced like contract site)
      function displayDoAnSynchronizedPreviewResults(contracts) {
        const thead = $('#doanTableHeader');
        thead.html(`
          <tr>
            <th>STT</th>
            <th>Họ tên GV</th>
            <th>Khoa - Hệ đào tạo</th>
            <th>Số HĐ hiện tại</th>
            <th>Số TLHĐ hiện tại</th>
            <th>Số HĐ mới</th>
            <th>Số TLHĐ mới</th>
            <th>Số tiết</th>
          </tr>
        `);

        const tbody = $('#doanTableBody');
        tbody.empty();

        if (contracts.length === 0) {
          tbody.append(`
            <tr>
              <td colspan="8" class="text-center text-muted">
                <i class="fas fa-inbox"></i> Không có dữ liệu giảng viên nào để xem trước
              </td>
            </tr>
          `);
          return;
        }

        // Group contracts by faculty for better display with rowspan
        let currentGroup = '';
        let groupRowSpan = 0;

        contracts.forEach((contract, index) => {
          const groupKey = contract.Khoa || 'Không xác định';
          const groupInfo = `${groupKey} - Đồ án tốt nghiệp`;
          const isNewGroup = groupInfo !== currentGroup;

          if (isNewGroup) {
            currentGroup = groupInfo;
            // Count how many contracts in this group
            groupRowSpan = contracts.filter((c, i) => i >= index &&
              `${(c.Khoa || 'Không xác định')} - Đồ án tốt nghiệp` === groupInfo).length;
          }

          // Old numbers: Current database values - display existing values if they exist
          const oldContractNumber = contract.SoHopDong && contract.SoHopDong !== ''
            ? `<span class="text-primary">${contract.SoHopDong}</span>`
            : '<span class="text-muted">Chưa có</span>';

          const oldTerminationNumber = contract.SoThanhLyHopDong && contract.SoThanhLyHopDong !== ''
            ? `<span class="text-info">${contract.SoThanhLyHopDong}</span>`
            : '<span class="text-muted">Chưa có</span>';

          // New numbers: Preview values with highlight
          const newContractNumber = contract.newSoHopDong
            ? `<strong class="text-success">${contract.newSoHopDong}</strong>`
            : '<span class="text-muted">Chưa tạo</span>';

          const newTerminationNumber = contract.newSoThanhLyHopDong
            ? `<strong class="text-info">${contract.newSoThanhLyHopDong}</strong>`
            : '<span class="text-muted">Chưa tạo</span>';

          const row = `
            <tr ${isNewGroup ? 'class="table-warning"' : ''}>
              <td>${index + 1}</td>
              <td>${contract.HoTen || 'N/A'}</td>
              ${isNewGroup ? `<td rowspan="${groupRowSpan}" class="text-center align-middle bg-light"><strong>${groupInfo}</strong></td>` : ''}
              <td>${oldContractNumber}</td>
              <td>${oldTerminationNumber}</td>
              <td>${newContractNumber}</td>
              <td>${newTerminationNumber}</td>
              <td>${contract.SoTiet || 'N/A'}</td>
            </tr>
          `;
          tbody.append(row);
        });
        
        $('#doanResultsDiv').show();
      }

      // Utility functions
      function showLoading(show) {
        if (show) {
          $('body').append('<div id="loadingOverlay" class="position-fixed top-0 start-0 w-100 h-100 bg-dark bg-opacity-50 d-flex justify-content-center align-items-center" style="z-index: 9999;"><div class="spinner-border text-light" role="status"><span class="visually-hidden">Loading...</span></div></div>');
        } else {
          $('#loadingOverlay').remove();
        }
      }

      function showSuccess(message) {
        $('#successMessage').text(message);
        const toast = new bootstrap.Toast($('#successToast')[0]);
        toast.show();
      }

      function showError(message) {
        $('#errorMessage').text(message);
        const toast = new bootstrap.Toast($('#errorToast')[0]);
        toast.show();
      }

      // Initialize on page load (similar to contract site)
      $(document).ready(function () {
        updateDoAnNumberPreview();

        // Update preview when starting number changes
        $('#doanUnifiedStartingNumber').on('input', updateDoAnNumberPreview);

        // Update button text to match unified approach
        $('button[onclick="previewDoAnSynchronizedSetup()"]').html('<i class="fas fa-eye me-2"></i>Xem trước khi tạo');
        $('button[onclick="executeDoAnSynchronizedSetup()"]').html('<i class="fas fa-cog me-2"></i>Tạo');
      });
    </script>
</body>

</html>